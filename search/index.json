[{"content":"å‰è¨€ Kubernetesï¼ˆK8sï¼‰å·²ç»æˆä¸ºäº‘åŸç”Ÿæ—¶ä»£å®¹å™¨ç¼–æ’çš„äº‹å®æ ‡å‡†ã€‚æ— è®ºæ˜¯å¼€å‘ã€æµ‹è¯•è¿˜æ˜¯ç”Ÿäº§ç¯å¢ƒï¼ŒæŒæ¡ K8s çš„æ ¸å¿ƒå‘½ä»¤éƒ½æ˜¯å¿…å¤‡æŠ€èƒ½ã€‚\næœ¬æ–‡å°†ä»åŸºç¡€æ¦‚å¿µå…¥æ‰‹ï¼Œç³»ç»Ÿåœ°è®²è§£ kubectl å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•ï¼Œæ¶µç›–èµ„æºç®¡ç†ã€è°ƒè¯•æ’æŸ¥ã€ç›‘æ§ä¼˜åŒ–ç­‰å®æˆ˜åœºæ™¯ï¼Œå¸®åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹ Kubernetesã€‚\nä¸€ã€Kubernetes æ˜¯ä»€ä¹ˆï¼Ÿ 1.1 æ ¸å¿ƒæ¦‚å¿µ Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚\næ ¸å¿ƒç»„ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Kubernetes æ¶æ„ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Master Node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ API â”‚ â”‚ Controller â”‚ â”‚ Scheduler â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ Server â”‚ â”‚ Manager â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ etcd (æ•°æ®å­˜å‚¨) â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Worker Node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ Kubelet â”‚ â”‚ kube- â”‚ â”‚ Containerâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ proxy â”‚ â”‚ Runtime â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ Pods (å®¹å™¨ç»„) â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒèµ„æºå¯¹è±¡ï¼š\nèµ„æº è¯´æ˜ ç”¨é€” Pod æœ€å°éƒ¨ç½²å•å…ƒï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ è¿è¡Œåº”ç”¨ Deployment ç®¡ç† Pod çš„å‰¯æœ¬æ•°é‡å’Œæ›´æ–°ç­–ç•¥ æ— çŠ¶æ€åº”ç”¨éƒ¨ç½² Service ä¸º Pod æä¾›ç¨³å®šçš„ç½‘ç»œè®¿é—®å…¥å£ æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ ConfigMap å­˜å‚¨é…ç½®ä¿¡æ¯ åº”ç”¨é…ç½®ç®¡ç† Secret å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¯†é’¥ï¼‰ æ•æ„Ÿæ•°æ®ç®¡ç† StatefulSet ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨ æ•°æ®åº“ç­‰æœ‰çŠ¶æ€æœåŠ¡ DaemonSet åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Pod å‰¯æœ¬ æ—¥å¿—é‡‡é›†ã€ç›‘æ§ Namespace èµ„æºéš”ç¦»çš„è™šæ‹Ÿé›†ç¾¤ å¤šç§Ÿæˆ·ç¯å¢ƒ 1.2 K8s vs Docker ç‰¹æ€§ Docker Kubernetes å®šä½ å®¹å™¨å¼•æ“ å®¹å™¨ç¼–æ’å¹³å° å•æœº/é›†ç¾¤ å•æœº é›†ç¾¤ è´Ÿè½½å‡è¡¡ æ‰‹åŠ¨é…ç½® è‡ªåŠ¨è´Ÿè½½å‡è¡¡ è‡ªæ„ˆèƒ½åŠ› æ—  è‡ªåŠ¨é‡å¯å¤±è´¥å®¹å™¨ æ‰©ç¼©å®¹ æ‰‹åŠ¨ è‡ªåŠ¨/æ‰‹åŠ¨ æœåŠ¡å‘ç° éœ€é¢å¤–é…ç½® å†…ç½® Service äºŒã€kubectl åŸºç¡€å‘½ä»¤ 2.1 å®‰è£… kubectl Linux å®‰è£… 1 2 3 4 5 6 7 8 9 10 11 # ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ curl -LO \u0026#34;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\u0026#34; # æ·»åŠ æ‰§è¡Œæƒé™ chmod +x kubectl # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„ sudo mv kubectl /usr/local/bin/ # éªŒè¯å®‰è£… kubectl version --client macOS å®‰è£… 1 2 3 4 5 6 7 # ä½¿ç”¨ Homebrew brew install kubectl # æˆ–è€…ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ curl -LO \u0026#34;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/darwin/amd64/kubectl\u0026#34; chmod +x kubectl sudo mv kubectl /usr/local/bin/ 2.2 é…ç½® kubeconfig 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æŸ¥çœ‹å½“å‰é…ç½® kubectl config view # æŸ¥çœ‹æ‰€æœ‰ä¸Šä¸‹æ–‡ kubectl config get-contexts # åˆ‡æ¢ä¸Šä¸‹æ–‡ kubectl config use-context \u0026lt;context-name\u0026gt; # è®¾ç½®é»˜è®¤å‘½åç©ºé—´ kubectl config set-context --current --namespace=\u0026lt;namespace\u0026gt; # æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡ kubectl config current-context 2.3 é›†ç¾¤ä¿¡æ¯æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ kubectl cluster-info # æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ kubectl get nodes kubectl get nodes -o wide # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆIPã€OSç­‰ï¼‰ kubectl describe node \u0026lt;node-name\u0026gt; # æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ… # æŸ¥çœ‹é›†ç¾¤ç»„ä»¶çŠ¶æ€ kubectl get componentstatuses # æŸ¥çœ‹æ‰€æœ‰ API èµ„æº kubectl api-resources # æŸ¥çœ‹ API ç‰ˆæœ¬ kubectl api-versions ä¸‰ã€Pod ç®¡ç†å‘½ä»¤ 3.1 åˆ›å»ºå’Œè¿è¡Œ Pod 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # å¿«é€Ÿåˆ›å»ºä¸€ä¸ª Podï¼ˆè°ƒè¯•ç”¨ï¼‰ kubectl run nginx --image=nginx # åˆ›å»º Pod å¹¶æš´éœ²ç«¯å£ kubectl run nginx --image=nginx --port=80 # åˆ›å»º Pod å¹¶æŒ‡å®šç¯å¢ƒå˜é‡ kubectl run mysql --image=mysql:8.0 --env=\u0026#34;MYSQL_ROOT_PASSWORD=123456\u0026#34; # ä½¿ç”¨ YAML æ–‡ä»¶åˆ›å»º kubectl apply -f pod.yaml # åˆ›å»ºä¸´æ—¶æµ‹è¯• Podï¼ˆé€€å‡ºè‡ªåŠ¨åˆ é™¤ï¼‰ kubectl run test --image=busybox --rm -it -- sh 3.2 æŸ¥çœ‹ Pod 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # æŸ¥çœ‹æ‰€æœ‰ Pod kubectl get pods kubectl get pods -A # æ‰€æœ‰å‘½åç©ºé—´ kubectl get pods -n \u0026lt;namespace\u0026gt; # æŒ‡å®šå‘½åç©ºé—´ kubectl get pods -o wide # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆèŠ‚ç‚¹ã€IPï¼‰ kubectl get pods -o yaml # YAML æ ¼å¼è¾“å‡º kubectl get pods -o json # JSON æ ¼å¼è¾“å‡º # æŸ¥çœ‹ Pod è¯¦æƒ… kubectl describe pod \u0026lt;pod-name\u0026gt; # å®æ—¶ç›‘æ§ Pod çŠ¶æ€ kubectl get pods --watch kubectl get pods -w # æŒ‰æ ‡ç­¾ç­›é€‰ kubectl get pods -l app=nginx kubectl get pods -l environment=prod,tier=frontend 3.3 Pod æ—¥å¿—æŸ¥çœ‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # æŸ¥çœ‹ Pod æ—¥å¿— kubectl logs \u0026lt;pod-name\u0026gt; # å®æ—¶è·Ÿè¸ªæ—¥å¿— kubectl logs -f \u0026lt;pod-name\u0026gt; # æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿— kubectl logs --tail=100 \u0026lt;pod-name\u0026gt; # æŸ¥çœ‹æœ€è¿‘ 1 å°æ—¶çš„æ—¥å¿— kubectl logs --since=1h \u0026lt;pod-name\u0026gt; # å¤šå®¹å™¨ Pod æŒ‡å®šå®¹å™¨å kubectl logs \u0026lt;pod-name\u0026gt; -c \u0026lt;container-name\u0026gt; # æŸ¥çœ‹ä¸Šä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—ï¼ˆPod é‡å¯åï¼‰ kubectl logs \u0026lt;pod-name\u0026gt; --previous 3.4 è¿›å…¥ Pod å®¹å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 # è¿›å…¥ Podï¼ˆå•å®¹å™¨ï¼‰ kubectl exec -it \u0026lt;pod-name\u0026gt; -- sh kubectl exec -it \u0026lt;pod-name\u0026gt; -- bash # è¿›å…¥ Podï¼ˆå¤šå®¹å™¨ï¼ŒæŒ‡å®šå®¹å™¨åï¼‰ kubectl exec -it \u0026lt;pod-name\u0026gt; -c \u0026lt;container-name\u0026gt; -- sh # åœ¨ Pod ä¸­æ‰§è¡Œå‘½ä»¤ kubectl exec \u0026lt;pod-name\u0026gt; -- ls /app kubectl exec \u0026lt;pod-name\u0026gt; -- cat /etc/hosts # åœ¨ Pod ä¸­æ‰§è¡Œå¤šä¸ªå‘½ä»¤ kubectl exec -it \u0026lt;pod-name\u0026gt; -- sh -c \u0026#34;pwd \u0026amp;\u0026amp; ls -la\u0026#34; 3.5 Pod æ–‡ä»¶æ“ä½œ 1 2 3 4 5 6 7 8 # ä» Pod å¤åˆ¶æ–‡ä»¶åˆ°æœ¬åœ° kubectl cp \u0026lt;pod-name\u0026gt;:/path/to/file ./local-path # ä»æœ¬åœ°å¤åˆ¶æ–‡ä»¶åˆ° Pod kubectl cp ./local-file \u0026lt;pod-name\u0026gt;:/path/to/destination # å¤šå®¹å™¨ Pod æŒ‡å®šå®¹å™¨ kubectl cp \u0026lt;pod-name\u0026gt;:/path/to/file ./local-path -c \u0026lt;container-name\u0026gt; 3.6 åˆ é™¤ Pod 1 2 3 4 5 6 7 8 9 10 11 # åˆ é™¤å•ä¸ª Pod kubectl delete pod \u0026lt;pod-name\u0026gt; # å¼ºåˆ¶åˆ é™¤ï¼ˆç«‹å³åˆ é™¤ï¼Œä¸ç­‰å¾…ä¼˜é›…å…³é—­ï¼‰ kubectl delete pod \u0026lt;pod-name\u0026gt; --force --grace-period=0 # åˆ é™¤æ‰€æœ‰ Pod kubectl delete pods --all # æŒ‰æ ‡ç­¾åˆ é™¤ kubectl delete pods -l app=nginx å››ã€Deployment ç®¡ç† 4.1 åˆ›å»º Deployment 1 2 3 4 5 6 7 8 9 10 11 # å¿«é€Ÿåˆ›å»º Deployment kubectl create deployment nginx --image=nginx # åˆ›å»ºå¹¶æŒ‡å®šå‰¯æœ¬æ•° kubectl create deployment nginx --image=nginx --replicas=3 # ä½¿ç”¨ YAML åˆ›å»º kubectl apply -f deployment.yaml # ä» URL åˆ›å»º kubectl apply -f https://k8s.io/examples/application/deployment.yaml deployment.yaml ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.24 ports: - containerPort: 80 resources: limits: cpu: \u0026#34;500m\u0026#34; memory: \u0026#34;512Mi\u0026#34; requests: cpu: \u0026#34;250m\u0026#34; memory: \u0026#34;256Mi\u0026#34; 4.2 æŸ¥çœ‹ Deployment 1 2 3 4 5 6 7 8 9 # æŸ¥çœ‹æ‰€æœ‰ Deployment kubectl get deployments kubectl get deploy # æŸ¥çœ‹è¯¦æƒ… kubectl describe deployment \u0026lt;deployment-name\u0026gt; # æŸ¥çœ‹ Deployment çŠ¶æ€ kubectl rollout status deployment/\u0026lt;deployment-name\u0026gt; 4.3 æ‰©ç¼©å®¹ 1 2 3 4 5 # æ‰‹åŠ¨æ‰©ç¼©å®¹ kubectl scale deployment \u0026lt;deployment-name\u0026gt; --replicas=5 # åŸºäº CPU è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰ kubectl autoscale deployment \u0026lt;deployment-name\u0026gt; --min=2 --max=10 --cpu-percent=80 4.4 æ›´æ–°é•œåƒ 1 2 3 4 5 6 7 8 9 10 11 # æ›´æ–°é•œåƒ kubectl set image deployment/\u0026lt;deployment-name\u0026gt; \u0026lt;container-name\u0026gt;=\u0026lt;new-image\u0026gt; # ç¤ºä¾‹ kubectl set image deployment/nginx-deployment nginx=nginx:1.25 # ä½¿ç”¨ YAML æ›´æ–° kubectl apply -f deployment.yaml # ç¼–è¾‘ Deployment kubectl edit deployment \u0026lt;deployment-name\u0026gt; 4.5 å›æ»šæ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # æŸ¥çœ‹å†å²ç‰ˆæœ¬ kubectl rollout history deployment/\u0026lt;deployment-name\u0026gt; # æŸ¥çœ‹æŒ‡å®šç‰ˆæœ¬è¯¦æƒ… kubectl rollout history deployment/\u0026lt;deployment-name\u0026gt; --revision=2 # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ kubectl rollout undo deployment/\u0026lt;deployment-name\u0026gt; # å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ kubectl rollout undo deployment/\u0026lt;deployment-name\u0026gt; --to-revision=2 # æš‚åœæ›´æ–° kubectl rollout pause deployment/\u0026lt;deployment-name\u0026gt; # æ¢å¤æ›´æ–° kubectl rollout resume deployment/\u0026lt;deployment-name\u0026gt; 4.6 åˆ é™¤ Deployment 1 2 3 4 5 # åˆ é™¤ Deploymentï¼ˆä¼šåŒæ—¶åˆ é™¤æ‰€æœ‰ Podï¼‰ kubectl delete deployment \u0026lt;deployment-name\u0026gt; # ä½¿ç”¨ YAML åˆ é™¤ kubectl delete -f deployment.yaml äº”ã€Service æœåŠ¡ç®¡ç† 5.1 åˆ›å»º Service 1 2 3 4 5 6 7 8 9 # æš´éœ² Deployment ä¸º Service kubectl expose deployment \u0026lt;deployment-name\u0026gt; --port=80 --target-port=8080 # æŒ‡å®š Service ç±»å‹ kubectl expose deployment nginx --port=80 --type=NodePort kubectl expose deployment nginx --port=80 --type=LoadBalancer # ä½¿ç”¨ YAML åˆ›å»º kubectl apply -f service.yaml service.yaml ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 kind: Service metadata: name: nginx-service spec: type: ClusterIP # ClusterIP / NodePort / LoadBalancer selector: app: nginx ports: - protocol: TCP port: 80 # Service ç«¯å£ targetPort: 80 # Pod ç«¯å£ 5.2 Service ç±»å‹è¯´æ˜ ç±»å‹ è¯´æ˜ ä½¿ç”¨åœºæ™¯ ClusterIP é›†ç¾¤å†…éƒ¨è®¿é—®ï¼ˆé»˜è®¤ï¼‰ å¾®æœåŠ¡é—´é€šä¿¡ NodePort é€šè¿‡èŠ‚ç‚¹ IP + ç«¯å£è®¿é—® æµ‹è¯•ç¯å¢ƒå¤–éƒ¨è®¿é—® LoadBalancer äº‘å‚å•†è´Ÿè½½å‡è¡¡å™¨ ç”Ÿäº§ç¯å¢ƒå¤–éƒ¨è®¿é—® ExternalName æ˜ å°„åˆ°å¤–éƒ¨ DNS è®¿é—®å¤–éƒ¨æœåŠ¡ 5.3 æŸ¥çœ‹ Service 1 2 3 4 5 6 7 8 9 # æŸ¥çœ‹æ‰€æœ‰ Service kubectl get services kubectl get svc # æŸ¥çœ‹è¯¦æƒ… kubectl describe service \u0026lt;service-name\u0026gt; # æŸ¥çœ‹ Service çš„ Endpointsï¼ˆåç«¯ Podï¼‰ kubectl get endpoints \u0026lt;service-name\u0026gt; 5.4 è®¿é—® Service 1 2 3 4 5 6 7 8 9 # ClusterIP ç±»å‹ï¼ˆé›†ç¾¤å†…è®¿é—®ï¼‰ kubectl run test --image=busybox --rm -it -- wget -O- http://\u0026lt;service-name\u0026gt; # NodePort ç±»å‹ï¼ˆå¤–éƒ¨è®¿é—®ï¼‰ curl http://\u0026lt;node-ip\u0026gt;:\u0026lt;node-port\u0026gt; # ç«¯å£è½¬å‘åˆ°æœ¬åœ°ï¼ˆè°ƒè¯•ç”¨ï¼‰ kubectl port-forward service/\u0026lt;service-name\u0026gt; 8080:80 # ç„¶åè®¿é—® http://localhost:8080 å…­ã€é…ç½®ç®¡ç†ï¼šConfigMap å’Œ Secret 6.1 ConfigMap ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 # ä»å­—é¢å€¼åˆ›å»º kubectl create configmap app-config --from-literal=key1=value1 --from-literal=key2=value2 # ä»æ–‡ä»¶åˆ›å»º kubectl create configmap app-config --from-file=config.properties # ä»ç›®å½•åˆ›å»º kubectl create configmap app-config --from-file=./configs/ # ä½¿ç”¨ YAML åˆ›å»º kubectl apply -f configmap.yaml configmap.yaml ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: ConfigMap metadata: name: app-config data: database_url: \u0026#34;mysql://localhost:3306/mydb\u0026#34; log_level: \u0026#34;INFO\u0026#34; config.json: | { \u0026#34;server\u0026#34;: { \u0026#34;port\u0026#34;: 8080, \u0026#34;host\u0026#34;: \u0026#34;0.0.0.0\u0026#34; } } åœ¨ Pod ä¸­ä½¿ç”¨ ConfigMapï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 apiVersion: v1 kind: Pod metadata: name: myapp spec: containers: - name: app image: myapp:latest env: # æ–¹å¼1ï¼šç¯å¢ƒå˜é‡ - name: DATABASE_URL valueFrom: configMapKeyRef: name: app-config key: database_url volumeMounts: # æ–¹å¼2ï¼šæ–‡ä»¶æŒ‚è½½ - name: config-volume mountPath: /etc/config volumes: - name: config-volume configMap: name: app-config 6.2 Secret ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # ä»å­—é¢å€¼åˆ›å»º kubectl create secret generic db-secret \\ --from-literal=username=admin \\ --from-literal=password=123456 # ä»æ–‡ä»¶åˆ›å»º kubectl create secret generic tls-secret \\ --from-file=tls.crt \\ --from-file=tls.key # åˆ›å»º Docker ä»“åº“è®¤è¯ Secret kubectl create secret docker-registry my-registry \\ --docker-server=registry.example.com \\ --docker-username=user \\ --docker-password=password \\ --docker-email=user@example.com # æŸ¥çœ‹ Secret kubectl get secrets kubectl describe secret \u0026lt;secret-name\u0026gt; # æŸ¥çœ‹ Secret å†…å®¹ï¼ˆBase64 è§£ç ï¼‰ kubectl get secret \u0026lt;secret-name\u0026gt; -o jsonpath=\u0026#39;{.data.password}\u0026#39; | base64 --decode secret.yaml ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 apiVersion: v1 kind: Secret metadata: name: db-secret type: Opaque data: username: YWRtaW4= # admin (base64) password: MTIzNDU2 # 123456 (base64) åœ¨ Pod ä¸­ä½¿ç”¨ Secretï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: v1 kind: Pod metadata: name: myapp spec: containers: - name: app image: myapp:latest env: - name: DB_USERNAME valueFrom: secretKeyRef: name: db-secret key: username - name: DB_PASSWORD valueFrom: secretKeyRef: name: db-secret key: password ä¸ƒã€å‘½åç©ºé—´ç®¡ç† 7.1 å‘½åç©ºé—´æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´ kubectl get namespaces kubectl get ns # åˆ›å»ºå‘½åç©ºé—´ kubectl create namespace dev kubectl create ns prod # ä½¿ç”¨ YAML åˆ›å»º kubectl apply -f namespace.yaml # åˆ é™¤å‘½åç©ºé—´ï¼ˆä¼šåˆ é™¤å…¶ä¸­æ‰€æœ‰èµ„æºï¼‰ kubectl delete namespace dev namespace.yaml ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 apiVersion: v1 kind: Namespace metadata: name: dev labels: environment: development 7.2 åœ¨å‘½åç©ºé—´ä¸­æ“ä½œèµ„æº 1 2 3 4 5 6 7 8 9 10 11 12 13 # åœ¨æŒ‡å®šå‘½åç©ºé—´åˆ›å»ºèµ„æº kubectl apply -f deployment.yaml -n dev # æŸ¥çœ‹æŒ‡å®šå‘½åç©ºé—´çš„èµ„æº kubectl get pods -n dev kubectl get all -n dev # åˆ‡æ¢é»˜è®¤å‘½åç©ºé—´ kubectl config set-context --current --namespace=dev # æŸ¥è¯¢æ‰€æœ‰å‘½åç©ºé—´çš„èµ„æº kubectl get pods -A kubectl get pods --all-namespaces å…«ã€èµ„æºç®¡ç†ä¸ç›‘æ§ 8.1 æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ 1 2 3 4 5 6 7 8 9 10 # æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨ kubectl top nodes # æŸ¥çœ‹ Pod èµ„æºä½¿ç”¨ kubectl top pods kubectl top pods -n \u0026lt;namespace\u0026gt; kubectl top pods --all-namespaces # æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨ kubectl top pod \u0026lt;pod-name\u0026gt; --containers ğŸ’¡ æ³¨æ„ï¼škubectl top å‘½ä»¤éœ€è¦é›†ç¾¤å®‰è£… Metrics Serverã€‚\nå®‰è£… Metrics Serverï¼š\n1 kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml 8.2 èµ„æºé…é¢ï¼ˆResourceQuotaï¼‰ 1 2 3 4 5 6 # åˆ›å»ºèµ„æºé…é¢ kubectl create quota my-quota --hard=cpu=2,memory=4Gi,pods=10 -n dev # æŸ¥çœ‹é…é¢ kubectl get resourcequota -n dev kubectl describe resourcequota my-quota -n dev resourcequota.yaml ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: v1 kind: ResourceQuota metadata: name: dev-quota namespace: dev spec: hard: requests.cpu: \u0026#34;4\u0026#34; requests.memory: \u0026#34;8Gi\u0026#34; limits.cpu: \u0026#34;8\u0026#34; limits.memory: \u0026#34;16Gi\u0026#34; pods: \u0026#34;20\u0026#34; services: \u0026#34;10\u0026#34; 8.3 èµ„æºé™åˆ¶ï¼ˆLimitRangeï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 apiVersion: v1 kind: LimitRange metadata: name: limit-range namespace: dev spec: limits: - max: cpu: \u0026#34;2\u0026#34; memory: \u0026#34;2Gi\u0026#34; min: cpu: \u0026#34;100m\u0026#34; memory: \u0026#34;128Mi\u0026#34; default: cpu: \u0026#34;500m\u0026#34; memory: \u0026#34;512Mi\u0026#34; defaultRequest: cpu: \u0026#34;250m\u0026#34; memory: \u0026#34;256Mi\u0026#34; type: Container ä¹ã€æ•…éšœæ’æŸ¥ä¸è°ƒè¯• 9.1 Pod æ•…éšœæ’æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # æŸ¥çœ‹ Pod çŠ¶æ€ kubectl get pods kubectl describe pod \u0026lt;pod-name\u0026gt; # æŸ¥çœ‹ Pod äº‹ä»¶ kubectl get events --sort-by=\u0026#39;.lastTimestamp\u0026#39; kubectl get events --field-selector involvedObject.name=\u0026lt;pod-name\u0026gt; # æŸ¥çœ‹å®¹å™¨æ—¥å¿— kubectl logs \u0026lt;pod-name\u0026gt; kubectl logs \u0026lt;pod-name\u0026gt; --previous # æŸ¥çœ‹ä¸Šä¸€ä¸ªå®¹å™¨æ—¥å¿—ï¼ˆé‡å¯åï¼‰ # è¿›å…¥å®¹å™¨è°ƒè¯• kubectl exec -it \u0026lt;pod-name\u0026gt; -- sh # ä¸´æ—¶è°ƒè¯• Pod kubectl debug \u0026lt;pod-name\u0026gt; -it --image=busybox 9.2 å¸¸è§ Pod çŠ¶æ€åŠåŸå›  çŠ¶æ€ è¯´æ˜ å¸¸è§åŸå›  Pending ç­‰å¾…è°ƒåº¦ èµ„æºä¸è¶³ã€èŠ‚ç‚¹é€‰æ‹©å™¨ä¸åŒ¹é…ã€PVC æœªç»‘å®š ImagePullBackOff é•œåƒæ‹‰å–å¤±è´¥ é•œåƒä¸å­˜åœ¨ã€ç§æœ‰ä»“åº“è®¤è¯å¤±è´¥ã€ç½‘ç»œé—®é¢˜ CrashLoopBackOff å®¹å™¨åå¤å´©æºƒ åº”ç”¨å¯åŠ¨å¤±è´¥ã€é…ç½®é”™è¯¯ã€å¥åº·æ£€æŸ¥å¤±è´¥ Error å®¹å™¨é€€å‡ºå¼‚å¸¸ åº”ç”¨é”™è¯¯ã€OOMã€æƒé™é—®é¢˜ Evicted è¢«é©±é€ èŠ‚ç‚¹èµ„æºä¸è¶³ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰ 9.3 ç½‘ç»œè°ƒè¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # åˆ›å»ºæµ‹è¯• Pod kubectl run test --image=busybox --rm -it -- sh # æµ‹è¯• DNS nslookup kubernetes.default.svc.cluster.local # æµ‹è¯• Service è¿é€šæ€§ wget -O- http://nginx-service.default.svc.cluster.local # æµ‹è¯• Pod IP ping \u0026lt;pod-ip\u0026gt; # æŸ¥çœ‹ Service Endpoints kubectl get endpoints \u0026lt;service-name\u0026gt; # æŸ¥çœ‹ NetworkPolicy kubectl get networkpolicies 9.4 æŸ¥çœ‹é›†ç¾¤äº‹ä»¶ 1 2 3 4 5 6 7 8 9 10 11 # æŸ¥çœ‹æ‰€æœ‰äº‹ä»¶ kubectl get events -A --sort-by=\u0026#39;.lastTimestamp\u0026#39; # æŸ¥çœ‹æœ€è¿‘ 10 åˆ†é’Ÿçš„äº‹ä»¶ kubectl get events --since=10m # ç›‘æ§äº‹ä»¶ kubectl get events --watch # æŒ‰ç±»å‹ç­›é€‰ kubectl get events --field-selector type=Warning åã€YAML é…ç½®æŠ€å·§ 10.1 å¿«é€Ÿç”Ÿæˆ YAML 1 2 3 4 5 6 7 8 9 10 11 # ç”Ÿæˆ Pod YAMLï¼ˆä¸åˆ›å»ºï¼‰ kubectl run nginx --image=nginx --dry-run=client -o yaml \u0026gt; pod.yaml # ç”Ÿæˆ Deployment YAML kubectl create deployment nginx --image=nginx --replicas=3 --dry-run=client -o yaml \u0026gt; deployment.yaml # ç”Ÿæˆ Service YAML kubectl expose deployment nginx --port=80 --type=NodePort --dry-run=client -o yaml \u0026gt; service.yaml # ç”Ÿæˆ ConfigMap YAML kubectl create configmap app-config --from-literal=key=value --dry-run=client -o yaml \u0026gt; configmap.yaml 10.2 YAML éªŒè¯ä¸æ ¼å¼åŒ– 1 2 3 4 5 6 7 8 # éªŒè¯ YAML è¯­æ³• kubectl apply -f deployment.yaml --dry-run=client # éªŒè¯æœåŠ¡ç«¯ kubectl apply -f deployment.yaml --dry-run=server # æŸ¥çœ‹ YAML å·®å¼‚ï¼ˆéœ€è¦å®‰è£… kubectl diffï¼‰ kubectl diff -f deployment.yaml 10.3 æ ‡ç­¾ä¸é€‰æ‹©å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # æ·»åŠ æ ‡ç­¾ kubectl label pod \u0026lt;pod-name\u0026gt; environment=prod kubectl label pod \u0026lt;pod-name\u0026gt; version=v1.0.0 # åˆ é™¤æ ‡ç­¾ kubectl label pod \u0026lt;pod-name\u0026gt; environment- # è¦†ç›–æ ‡ç­¾ kubectl label pod \u0026lt;pod-name\u0026gt; environment=staging --overwrite # æŒ‰æ ‡ç­¾ç­›é€‰ kubectl get pods -l environment=prod kubectl get pods -l \u0026#39;environment in (prod,staging)\u0026#39; kubectl get pods -l environment!=dev # æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾ kubectl get pods --show-labels åä¸€ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 11.1 å¥åº·æ£€æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 apiVersion: v1 kind: Pod metadata: name: myapp spec: containers: - name: app image: myapp:latest # å­˜æ´»æ¢é’ˆï¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜æ´» livenessProbe: httpGet: path: /health port: 8080 initialDelaySeconds: 30 periodSeconds: 10 timeoutSeconds: 5 failureThreshold: 3 # å°±ç»ªæ¢é’ˆï¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡ readinessProbe: httpGet: path: /ready port: 8080 initialDelaySeconds: 10 periodSeconds: 5 timeoutSeconds: 3 failureThreshold: 3 # å¯åŠ¨æ¢é’ˆï¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦å¯åŠ¨æˆåŠŸ startupProbe: httpGet: path: /startup port: 8080 initialDelaySeconds: 0 periodSeconds: 5 failureThreshold: 30 11.2 èµ„æºé™åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: v1 kind: Pod metadata: name: myapp spec: containers: - name: app image: myapp:latest resources: # èµ„æºè¯·æ±‚ï¼ˆè°ƒåº¦ä¾æ®ï¼‰ requests: cpu: \u0026#34;250m\u0026#34; # 0.25 æ ¸ memory: \u0026#34;256Mi\u0026#34; # èµ„æºé™åˆ¶ï¼ˆç¡¬é™åˆ¶ï¼‰ limits: cpu: \u0026#34;1000m\u0026#34; # 1 æ ¸ memory: \u0026#34;1Gi\u0026#34; 11.3 æ»šåŠ¨æ›´æ–°ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment spec: replicas: 5 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 # æœ€å¤šè¶…å‡ºæœŸæœ›å‰¯æœ¬æ•° 1 ä¸ª maxUnavailable: 1 # æœ€å¤šä¸å¯ç”¨å‰¯æœ¬æ•° 1 ä¸ª template: # ... Pod æ¨¡æ¿ ... 11.4 ä¼˜é›…ç»ˆæ­¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Pod metadata: name: myapp spec: terminationGracePeriodSeconds: 30 # ä¼˜é›…ç»ˆæ­¢ç­‰å¾…æ—¶é—´ containers: - name: app image: myapp:latest lifecycle: # å®¹å™¨å¯åŠ¨åé’©å­ postStart: exec: command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo \u0026#39;Container started\u0026#39;\u0026#34;] # å®¹å™¨ç»ˆæ­¢å‰é’©å­ preStop: exec: command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;sleep 15\u0026#34;] 11.5 å®‰å…¨é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Pod metadata: name: secure-pod spec: securityContext: runAsNonRoot: true runAsUser: 1000 fsGroup: 2000 containers: - name: app image: myapp:latest securityContext: allowPrivilegeEscalation: false readOnlyRootFilesystem: true capabilities: drop: - ALL åäºŒã€kubectl å®ç”¨æŠ€å·§ 12.1 å‘½ä»¤è¡¥å…¨ 1 2 3 4 5 6 7 8 9 10 11 # Bash echo \u0026#39;source \u0026lt;(kubectl completion bash)\u0026#39; \u0026gt;\u0026gt; ~/.bashrc source ~/.bashrc # Zsh echo \u0026#39;source \u0026lt;(kubectl completion zsh)\u0026#39; \u0026gt;\u0026gt; ~/.zshrc source ~/.zshrc # è®¾ç½®åˆ«å alias k=kubectl complete -F __start_kubectl k 12.2 å¸¸ç”¨åˆ«å 1 2 3 4 5 6 7 8 9 10 11 # æ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrc alias k=\u0026#39;kubectl\u0026#39; alias kg=\u0026#39;kubectl get\u0026#39; alias kd=\u0026#39;kubectl describe\u0026#39; alias kdel=\u0026#39;kubectl delete\u0026#39; alias kl=\u0026#39;kubectl logs\u0026#39; alias kex=\u0026#39;kubectl exec -it\u0026#39; alias kaf=\u0026#39;kubectl apply -f\u0026#39; alias kgp=\u0026#39;kubectl get pods\u0026#39; alias kgs=\u0026#39;kubectl get svc\u0026#39; alias kgn=\u0026#39;kubectl get nodes\u0026#39; 12.3 è¾“å‡ºæ ¼å¼åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # JSON æ ¼å¼ kubectl get pod \u0026lt;pod-name\u0026gt; -o json # YAML æ ¼å¼ kubectl get pod \u0026lt;pod-name\u0026gt; -o yaml # è‡ªå®šä¹‰åˆ— kubectl get pods -o custom-columns=NAME:.metadata.name,STATUS:.status.phase,NODE:.spec.nodeName # JSONPath æå–å­—æ®µ kubectl get pods -o jsonpath=\u0026#39;{.items[*].metadata.name}\u0026#39; kubectl get pods -o jsonpath=\u0026#39;{.items[*].status.podIP}\u0026#39; # è¡¨æ ¼å®½åº¦è¾“å‡º kubectl get pods -o wide # åªæ˜¾ç¤ºåç§° kubectl get pods -o name 12.4 æ‰¹é‡æ“ä½œ 1 2 3 4 5 6 7 8 # æ‰¹é‡åˆ é™¤ Pod kubectl get pods -l app=nginx -o name | xargs kubectl delete # æ‰¹é‡é‡å¯ Deployment kubectl get deployments -o name | xargs -I {} kubectl rollout restart {} # æ‰¹é‡æŸ¥çœ‹æ—¥å¿— kubectl get pods -l app=nginx -o name | xargs -I {} kubectl logs {} åä¸‰ã€å¸¸ç”¨å®Œæ•´ç¤ºä¾‹ 13.1 éƒ¨ç½²ä¸€ä¸ªå®Œæ•´çš„ Web åº”ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 # deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: webapp namespace: production spec: replicas: 3 selector: matchLabels: app: webapp template: metadata: labels: app: webapp version: v1.0.0 spec: containers: - name: webapp image: myregistry.com/webapp:v1.0.0 ports: - containerPort: 8080 env: - name: DATABASE_URL valueFrom: configMapKeyRef: name: app-config key: database_url - name: DB_PASSWORD valueFrom: secretKeyRef: name: db-secret key: password resources: requests: cpu: \u0026#34;250m\u0026#34; memory: \u0026#34;256Mi\u0026#34; limits: cpu: \u0026#34;1000m\u0026#34; memory: \u0026#34;1Gi\u0026#34; livenessProbe: httpGet: path: /health port: 8080 initialDelaySeconds: 30 periodSeconds: 10 readinessProbe: httpGet: path: /ready port: 8080 initialDelaySeconds: 10 periodSeconds: 5 --- # service.yaml apiVersion: v1 kind: Service metadata: name: webapp-service namespace: production spec: type: LoadBalancer selector: app: webapp ports: - protocol: TCP port: 80 targetPort: 8080 --- # configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: app-config namespace: production data: database_url: \u0026#34;mysql://db.example.com:3306/mydb\u0026#34; log_level: \u0026#34;INFO\u0026#34; --- # secret.yaml apiVersion: v1 kind: Secret metadata: name: db-secret namespace: production type: Opaque data: password: cGFzc3dvcmQxMjM= # password123 (base64) éƒ¨ç½²å‘½ä»¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åˆ›å»ºå‘½åç©ºé—´ kubectl create namespace production # åº”ç”¨æ‰€æœ‰èµ„æº kubectl apply -f deployment.yaml # æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€ kubectl rollout status deployment/webapp -n production # æŸ¥çœ‹æ‰€æœ‰èµ„æº kubectl get all -n production # è®¿é—®æœåŠ¡ kubectl get service webapp-service -n production åå››ã€å¸¸è§é—®é¢˜æ’æŸ¥ 14.1 Pod æ— æ³•å¯åŠ¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 # 1. æŸ¥çœ‹ Pod çŠ¶æ€å’Œäº‹ä»¶ kubectl describe pod \u0026lt;pod-name\u0026gt; # 2. æŸ¥çœ‹æ—¥å¿— kubectl logs \u0026lt;pod-name\u0026gt; kubectl logs \u0026lt;pod-name\u0026gt; --previous # 3. æ£€æŸ¥é•œåƒ docker pull \u0026lt;image-name\u0026gt; # åœ¨æœ¬åœ°æµ‹è¯•èƒ½å¦æ‹‰å– # 4. æ£€æŸ¥èµ„æºé…é¢ kubectl describe node kubectl top nodes 14.2 Service æ— æ³•è®¿é—® 1 2 3 4 5 6 7 8 9 10 11 # 1. æ£€æŸ¥ Service é…ç½® kubectl describe service \u0026lt;service-name\u0026gt; # 2. æ£€æŸ¥ Endpoints kubectl get endpoints \u0026lt;service-name\u0026gt; # 3. æµ‹è¯• Pod è¿é€šæ€§ kubectl run test --image=busybox --rm -it -- wget -O- http://\u0026lt;service-name\u0026gt; # 4. æ£€æŸ¥ç½‘ç»œç­–ç•¥ kubectl get networkpolicies 14.3 ç£ç›˜æ¸…ç† 1 2 3 4 5 6 7 8 # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ kubectl get pods --all-namespaces -o jsonpath=\u0026#39;{range .items[*]}{.spec.containers[*].image}{\u0026#34;\\n\u0026#34;}{end}\u0026#39; | sort -u # åˆ é™¤ Evicted çŠ¶æ€çš„ Pod kubectl get pods -A | grep Evicted | awk \u0026#39;{print $2 \u0026#34; -n \u0026#34; $1}\u0026#39; | xargs -L1 kubectl delete pod # åˆ é™¤ Completed çŠ¶æ€çš„ Pod kubectl get pods -A | grep Completed | awk \u0026#39;{print $2 \u0026#34; -n \u0026#34; $1}\u0026#39; | xargs -L1 kubectl delete pod æ€»ç»“ Kubernetes ä½œä¸ºäº‘åŸç”Ÿçš„æ ¸å¿ƒæŠ€æœ¯ï¼ŒæŒæ¡ kubectl å‘½ä»¤æ˜¯å¿…å¤‡æŠ€èƒ½ã€‚æœ¬æ–‡æ¶µç›–äº†ä»åŸºç¡€åˆ°è¿›é˜¶çš„ä¸»è¦å†…å®¹ï¼š\næ ¸å¿ƒæ¦‚å¿µï¼šPodã€Deploymentã€Service ç­‰èµ„æºå¯¹è±¡ åŸºç¡€æ“ä½œï¼šèµ„æºçš„åˆ›å»ºã€æŸ¥çœ‹ã€æ›´æ–°ã€åˆ é™¤ é…ç½®ç®¡ç†ï¼šConfigMap å’Œ Secret çš„ä½¿ç”¨ è°ƒè¯•æ’æŸ¥ï¼šæ—¥å¿—æŸ¥çœ‹ã€é—®é¢˜è¯Šæ–­ã€ç½‘ç»œè°ƒè¯• æœ€ä½³å®è·µï¼šå¥åº·æ£€æŸ¥ã€èµ„æºé™åˆ¶ã€å®‰å…¨é…ç½® å»ºè®®æŒ‰ç…§ä»¥ä¸‹è·¯å¾„å­¦ä¹ ï¼š\næ­å»ºæœ¬åœ° Minikube æˆ– Kind é›†ç¾¤ ç»ƒä¹ åŸºç¡€çš„ Pod å’Œ Deployment æ“ä½œ å­¦ä¹  Service å’Œç½‘ç»œè®¿é—® æŒæ¡ ConfigMap/Secret é…ç½®ç®¡ç† æ·±å…¥å­¦ä¹ è°ƒåº¦ã€å­˜å‚¨ã€ç½‘ç»œç­‰é«˜çº§ç‰¹æ€§ ä¸‹ä¸€æ­¥å¯ä»¥ç»§ç»­å­¦ä¹  Helm åŒ…ç®¡ç†ã€Ingress ç½‘å…³ã€StatefulSet æœ‰çŠ¶æ€åº”ç”¨ç­‰è¿›é˜¶å†…å®¹ã€‚\nå‚è€ƒèµ„æº èµ„æº é“¾æ¥ Kubernetes å®˜æ–¹æ–‡æ¡£ https://kubernetes.io/docs/ Kubernetes ä¸­æ–‡æ–‡æ¡£ https://kubernetes.io/zh-cn/docs/ kubectl é€ŸæŸ¥è¡¨ https://kubernetes.io/docs/reference/kubectl/cheatsheet/ Kubernetes API å‚è€ƒ https://kubernetes.io/docs/reference/kubernetes-api/ å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è—ï¼Œä¹Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµè®¨è®ºï¼\n","date":"2025-12-15T00:00:00Z","image":"https://zpf-zero.github.io/p/kubernetes-command-guide/k8s_hu_d9fdfb18f0aaf71.png","permalink":"https://zpf-zero.github.io/p/kubernetes-command-guide/","title":"Kubernetes ä»å…¥é—¨åˆ°ç²¾é€šï¼šæ ¸å¿ƒå‘½ä»¤ä¸å®æˆ˜æŒ‡å—"},{"content":"å‰è¨€ åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼ŒDocker å·²ç»æˆä¸ºæ¯ä¸ªå¼€å‘è€…å’Œè¿ç»´å·¥ç¨‹å¸ˆçš„å¿…å¤‡æŠ€èƒ½ã€‚å®ƒå½»åº•æ”¹å˜äº†è½¯ä»¶çš„å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²æ–¹å¼ï¼Œè®©\u0026quot;åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘\u0026quot;ä¸å†æ˜¯ä¸€ä¸ªå€Ÿå£ã€‚\næœ¬æ–‡å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œç³»ç»Ÿæ€§åœ°æŒæ¡ Docker çš„æ ¸å¿ƒæ¦‚å¿µå’Œå®æˆ˜æŠ€å·§ã€‚\nä¸€ã€Docker æ˜¯ä»€ä¹ˆï¼Ÿ 1.1 å®¹å™¨ vs è™šæ‹Ÿæœº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ä¼ ç»Ÿè™šæ‹Ÿæœºæ¶æ„ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ App A â”‚ â”‚ App B â”‚ â”‚ App C â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ Bins/ â”‚ â”‚ Bins/ â”‚ â”‚ Bins/ â”‚ â”‚ â”‚ â”‚ Libs â”‚ â”‚ Libs â”‚ â”‚ Libs â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ Guest â”‚ â”‚ Guest â”‚ â”‚ Guest â”‚ â† æ¯ä¸ªVMä¸€ä¸ªå®Œæ•´OS â”‚ â”‚ â”‚ OS â”‚ â”‚ OS â”‚ â”‚ OS â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Hypervisor â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Host OS â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Infrastructure â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Docker å®¹å™¨æ¶æ„ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ App A â”‚ â”‚ App B â”‚ â”‚ App C â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ Bins/ â”‚ â”‚ Bins/ â”‚ â”‚ Bins/ â”‚ â† å…±äº«å®¿ä¸»æœºå†…æ ¸ â”‚ â”‚ â”‚ Libs â”‚ â”‚ Libs â”‚ â”‚ Libs â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Docker Engine â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Host OS â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Infrastructure â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ç‰¹æ€§ è™šæ‹Ÿæœº Docker å®¹å™¨ å¯åŠ¨é€Ÿåº¦ åˆ†é’Ÿçº§ ç§’çº§ æ€§èƒ½æŸè€— è¾ƒå¤§ï¼ˆ15-20%ï¼‰ å¾ˆå°ï¼ˆæ¥è¿‘åŸç”Ÿï¼‰ ç£ç›˜å ç”¨ GB çº§åˆ« MB çº§åˆ« éš”ç¦»çº§åˆ« å®Œå…¨éš”ç¦» è¿›ç¨‹çº§éš”ç¦» ç³»ç»Ÿæ”¯æŒ å‡ ä¹æ‰€æœ‰ OS ä¸»è¦æ˜¯ Linux 1.2 Docker æ ¸å¿ƒæ¦‚å¿µ é•œåƒï¼ˆImageï¼‰ï¼šåªè¯»æ¨¡æ¿ï¼ŒåŒ…å«è¿è¡Œåº”ç”¨æ‰€éœ€çš„ä»£ç ã€è¿è¡Œæ—¶ã€åº“ã€é…ç½®æ–‡ä»¶ å®¹å™¨ï¼ˆContainerï¼‰ï¼šé•œåƒçš„è¿è¡Œå®ä¾‹ï¼Œå¯ä»¥è¢«åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ ä»“åº“ï¼ˆRegistryï¼‰ï¼šå­˜æ”¾é•œåƒçš„åœ°æ–¹ï¼Œå¦‚ Docker Hubã€é˜¿é‡Œäº‘é•œåƒæœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” docker pull â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Registry â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Image â”‚ â”‚ (Docker Hub)â”‚ â”‚ (æœ¬åœ°) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ docker run â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Container â”‚ â”‚ (è¿è¡Œä¸­) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ äºŒã€Docker å®‰è£…ä¸é…ç½® 2.1 Linuxï¼ˆUbuntu/Debianï¼‰å®‰è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # 1. å¸è½½æ—§ç‰ˆæœ¬ sudo apt-get remove docker docker-engine docker.io containerd runc # 2. å®‰è£…ä¾èµ– sudo apt-get update sudo apt-get install -y \\ ca-certificates \\ curl \\ gnupg \\ lsb-release # 3. æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥ sudo mkdir -p /etc/apt/keyrings curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg # 4. è®¾ç½®ä»“åº“ echo \\ \u0026#34;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\ $(lsb_release -cs) stable\u0026#34; | sudo tee /etc/apt/sources.list.d/docker.list \u0026gt; /dev/null # 5. å®‰è£… Docker Engine sudo apt-get update sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin # 6. éªŒè¯å®‰è£… sudo docker run hello-world 2.2 é…ç½®å›½å†…é•œåƒåŠ é€Ÿ åˆ›å»ºæˆ–ä¿®æ”¹ /etc/docker/daemon.jsonï¼š\n1 2 3 4 5 6 7 8 9 10 11 { \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;https://docker.1ms.run\u0026#34;, \u0026#34;https://docker.xuanyuan.me\u0026#34; ], \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; } } é‡å¯ Docker æœåŠ¡ï¼š\n1 2 sudo systemctl daemon-reload sudo systemctl restart docker 2.3 å… sudo æ‰§è¡Œ Docker å‘½ä»¤ 1 2 3 4 5 # å°†å½“å‰ç”¨æˆ·åŠ å…¥ docker ç»„ sudo usermod -aG docker $USER # é‡æ–°ç™»å½•æˆ–æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿å…¶ç”Ÿæ•ˆ newgrp docker ä¸‰ã€Docker å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥ 3.1 é•œåƒæ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # æœç´¢é•œåƒ docker search nginx # æ‹‰å–é•œåƒï¼ˆé»˜è®¤ latest æ ‡ç­¾ï¼‰ docker pull nginx docker pull nginx:1.24-alpine # æŒ‡å®šç‰ˆæœ¬ # æŸ¥çœ‹æœ¬åœ°é•œåƒ docker images docker images -a # åŒ…å«ä¸­é—´å±‚é•œåƒ # åˆ é™¤é•œåƒ docker rmi nginx docker rmi $(docker images -q) # åˆ é™¤æ‰€æœ‰é•œåƒ # æŸ¥çœ‹é•œåƒè¯¦æƒ… docker inspect nginx # é•œåƒå¯¼å‡º/å¯¼å…¥ docker save -o nginx.tar nginx:latest docker load -i nginx.tar 3.2 å®¹å™¨æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 # è¿è¡Œå®¹å™¨ docker run nginx # å‰å°è¿è¡Œ docker run -d nginx # åå°è¿è¡Œ docker run -d --name my-nginx nginx # æŒ‡å®šå®¹å™¨å docker run -d -p 8080:80 nginx # ç«¯å£æ˜ å°„ docker run -d -v /host/path:/container/path nginx # ç›®å½•æŒ‚è½½ docker run -it ubuntu /bin/bash # äº¤äº’å¼è¿è¡Œ # æŸ¥çœ‹å®¹å™¨ docker ps # è¿è¡Œä¸­çš„å®¹å™¨ docker ps -a # æ‰€æœ‰å®¹å™¨ docker ps -q # åªæ˜¾ç¤ºå®¹å™¨ ID # å®¹å™¨ç”Ÿå‘½å‘¨æœŸ docker start \u0026lt;container\u0026gt; docker stop \u0026lt;container\u0026gt; docker restart \u0026lt;container\u0026gt; docker kill \u0026lt;container\u0026gt; # å¼ºåˆ¶åœæ­¢ # åˆ é™¤å®¹å™¨ docker rm \u0026lt;container\u0026gt; docker rm -f \u0026lt;container\u0026gt; # å¼ºåˆ¶åˆ é™¤è¿è¡Œä¸­çš„å®¹å™¨ docker rm $(docker ps -aq) # åˆ é™¤æ‰€æœ‰å®¹å™¨ docker container prune # åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨ # è¿›å…¥å®¹å™¨ docker exec -it \u0026lt;container\u0026gt; /bin/bash docker exec -it \u0026lt;container\u0026gt; sh # Alpine é•œåƒç”¨ sh # æŸ¥çœ‹å®¹å™¨æ—¥å¿— docker logs \u0026lt;container\u0026gt; docker logs -f \u0026lt;container\u0026gt; # å®æ—¶è·Ÿè¸ª docker logs --tail 100 \u0026lt;container\u0026gt; # æœ€å 100 è¡Œ # æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨ docker stats docker top \u0026lt;container\u0026gt; # å®¹å™¨ä¸å®¿ä¸»æœºæ–‡ä»¶å¤åˆ¶ docker cp \u0026lt;container\u0026gt;:/path/file ./local/path docker cp ./local/file \u0026lt;container\u0026gt;:/path/ 3.3 å¸¸ç”¨å‚æ•°é€ŸæŸ¥è¡¨ å‚æ•° è¯´æ˜ ç¤ºä¾‹ -d åå°è¿è¡Œ docker run -d nginx -p ç«¯å£æ˜ å°„ -p 8080:80 -v ç›®å½•æŒ‚è½½ -v /data:/app/data -e ç¯å¢ƒå˜é‡ -e MYSQL_ROOT_PASSWORD=123456 --name å®¹å™¨åç§° --name my-app --rm é€€å‡ºæ—¶è‡ªåŠ¨åˆ é™¤ docker run --rm nginx --network æŒ‡å®šç½‘ç»œ --network my-net --restart é‡å¯ç­–ç•¥ --restart=always -m å†…å­˜é™åˆ¶ -m 512m --cpus CPU é™åˆ¶ --cpus=1.5 å››ã€Dockerfile ç¼–å†™æŒ‡å— 4.1 Dockerfile åŸºç¡€è¯­æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 # åŸºç¡€é•œåƒ FROM golang:1.21-alpine AS builder # ç»´æŠ¤è€…ä¿¡æ¯ LABEL maintainer=\u0026#34;zhangpengfei\u0026#34; LABEL version=\u0026#34;1.0\u0026#34; LABEL description=\u0026#34;My Go Application\u0026#34; # è®¾ç½®å·¥ä½œç›®å½• WORKDIR /app # å¤åˆ¶ä¾èµ–æ–‡ä»¶ COPY go.mod go.sum ./ # ä¸‹è½½ä¾èµ– RUN go mod download # å¤åˆ¶æºä»£ç  COPY . . # æ„å»ºåº”ç”¨ RUN CGO_ENABLED=0 GOOS=linux go build -o main . # -------- å¤šé˜¶æ®µæ„å»º -------- FROM alpine:latest # å®‰è£…å¿…è¦çš„è¯ä¹¦ï¼ˆç”¨äº HTTPS è¯·æ±‚ï¼‰ RUN apk --no-cache add ca-certificates tzdata # è®¾ç½®æ—¶åŒº ENV TZ=Asia/Shanghai WORKDIR /app # ä» builder é˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ COPY --from=builder /app/main . # æš´éœ²ç«¯å£ EXPOSE 8080 # å¥åº·æ£€æŸ¥ HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\ CMD wget --quiet --tries=1 --spider http://localhost:8080/health || exit 1 # å¯åŠ¨å‘½ä»¤ CMD [\u0026#34;./main\u0026#34;] 4.2 Dockerfile æœ€ä½³å®è·µ âœ… ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒä½“ç§¯ 1 2 3 4 5 6 7 8 9 10 11 12 # æ„å»ºé˜¶æ®µ FROM node:18 AS builder WORKDIR /app COPY package*.json ./ RUN npm ci --only=production # è¿è¡Œé˜¶æ®µ FROM node:18-alpine WORKDIR /app COPY --from=builder /app/node_modules ./node_modules COPY . . CMD [\u0026#34;node\u0026#34;, \u0026#34;index.js\u0026#34;] âœ… åˆç†åˆ©ç”¨æ„å»ºç¼“å­˜ 1 2 3 4 5 6 7 8 # âŒ ä¸å¥½çš„å†™æ³•ï¼šæ¯æ¬¡ä»£ç å˜åŠ¨éƒ½è¦é‡æ–°å®‰è£…ä¾èµ– COPY . . RUN npm install # âœ… å¥½çš„å†™æ³•ï¼šä¾èµ–æ–‡ä»¶ä¸å˜æ—¶å¯å¤ç”¨ç¼“å­˜ COPY package*.json ./ RUN npm install COPY . . âœ… ä½¿ç”¨ .dockerignore åˆ›å»º .dockerignore æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 .git .gitignore node_modules *.log *.md Dockerfile docker-compose.yml .env .DS_Store âœ… å‡å°‘é•œåƒå±‚æ•° 1 2 3 4 5 6 7 8 9 10 # âŒ å¤šä¸ª RUN æŒ‡ä»¤äº§ç”Ÿå¤šå±‚ RUN apt-get update RUN apt-get install -y curl RUN apt-get install -y vim RUN rm -rf /var/lib/apt/lists/* # âœ… åˆå¹¶ä¸ºä¸€ä¸ª RUN æŒ‡ä»¤ RUN apt-get update \u0026amp;\u0026amp; \\ apt-get install -y curl vim \u0026amp;\u0026amp; \\ rm -rf /var/lib/apt/lists/* 4.3 æ„å»ºå’Œæ¨é€é•œåƒ 1 2 3 4 5 6 7 8 9 10 11 12 # æ„å»ºé•œåƒ docker build -t myapp:v1 . docker build -t myapp:v1 -f Dockerfile.prod . # æŒ‡å®š Dockerfile # ä¸ºé•œåƒæ‰“æ ‡ç­¾ docker tag myapp:v1 username/myapp:v1 # ç™»å½•é•œåƒä»“åº“ docker login # æ¨é€åˆ° Docker Hub docker push username/myapp:v1 äº”ã€Docker Compose å®¹å™¨ç¼–æ’ 5.1 docker-compose.yml ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 version: \u0026#39;3.8\u0026#39; services: # Web åº”ç”¨ web: build: context: . dockerfile: Dockerfile container_name: my-web ports: - \u0026#34;8080:8080\u0026#34; environment: - DB_HOST=mysql - DB_PORT=3306 - REDIS_HOST=redis depends_on: mysql: condition: service_healthy redis: condition: service_started networks: - app-network restart: unless-stopped # MySQL æ•°æ®åº“ mysql: image: mysql:8.0 container_name: my-mysql ports: - \u0026#34;3306:3306\u0026#34; environment: MYSQL_ROOT_PASSWORD: root123 MYSQL_DATABASE: myapp MYSQL_USER: appuser MYSQL_PASSWORD: apppass volumes: - mysql-data:/var/lib/mysql - ./init.sql:/docker-entrypoint-initdb.d/init.sql healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;mysqladmin\u0026#34;, \u0026#34;ping\u0026#34;, \u0026#34;-h\u0026#34;, \u0026#34;localhost\u0026#34;] interval: 10s timeout: 5s retries: 5 networks: - app-network restart: unless-stopped # Redis ç¼“å­˜ redis: image: redis:7-alpine container_name: my-redis ports: - \u0026#34;6379:6379\u0026#34; command: redis-server --appendonly yes --requirepass redis123 volumes: - redis-data:/data networks: - app-network restart: unless-stopped # Nginx åå‘ä»£ç† nginx: image: nginx:alpine container_name: my-nginx ports: - \u0026#34;80:80\u0026#34; - \u0026#34;443:443\u0026#34; volumes: - ./nginx.conf:/etc/nginx/nginx.conf:ro - ./ssl:/etc/nginx/ssl:ro depends_on: - web networks: - app-network restart: unless-stopped networks: app-network: driver: bridge volumes: mysql-data: redis-data: 5.2 Docker Compose å¸¸ç”¨å‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # å¯åŠ¨æ‰€æœ‰æœåŠ¡ docker compose up -d # æŸ¥çœ‹æœåŠ¡çŠ¶æ€ docker compose ps # æŸ¥çœ‹æœåŠ¡æ—¥å¿— docker compose logs -f web docker compose logs -f --tail 100 # åœæ­¢æ‰€æœ‰æœåŠ¡ docker compose stop # åœæ­¢å¹¶åˆ é™¤å®¹å™¨ã€ç½‘ç»œ docker compose down # åœæ­¢å¹¶åˆ é™¤å®¹å™¨ã€ç½‘ç»œã€å· docker compose down -v # é‡æ–°æ„å»ºæœåŠ¡ docker compose build docker compose up -d --build # è¿›å…¥å®¹å™¨ docker compose exec web sh # æ‰©ç¼©å®¹ docker compose up -d --scale web=3 å…­ã€Docker ç½‘ç»œè¯¦è§£ 6.1 ç½‘ç»œæ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨ docker network ls # åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ docker network create my-network docker network create --driver bridge --subnet 172.20.0.0/16 my-network # å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ docker run -d --network my-network --name app nginx # æŸ¥çœ‹ç½‘ç»œè¯¦æƒ… docker network inspect my-network # å®¹å™¨é—´é€šä¿¡ï¼ˆåŒä¸€ç½‘ç»œå†…å¯ç›´æ¥ç”¨å®¹å™¨åï¼‰ docker exec app ping mysql 6.2 ç½‘ç»œæ¨¡å¼å¯¹æ¯” æ¨¡å¼ è¯´æ˜ é€‚ç”¨åœºæ™¯ bridge é»˜è®¤æ¨¡å¼ï¼Œå®¹å™¨æœ‰ç‹¬ç«‹ç½‘ç»œå‘½åç©ºé—´ å¤§å¤šæ•°åœºæ™¯ host å®¹å™¨ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ é«˜æ€§èƒ½éœ€æ±‚ none ç¦ç”¨ç½‘ç»œ å®‰å…¨éš”ç¦» container ä¸å…¶ä»–å®¹å™¨å…±äº«ç½‘ç»œ Pod æ¨¡å¼ ä¸ƒã€Docker æ•°æ®æŒä¹…åŒ– 7.1 ä¸‰ç§æŒ‚è½½æ–¹å¼ 1 2 3 4 5 6 7 8 9 10 11 12 # 1. Volumeï¼ˆæ¨èï¼‰- Docker ç®¡ç†çš„å­˜å‚¨ docker run -v my-volume:/app/data nginx docker volume create my-volume docker volume ls docker volume inspect my-volume # 2. Bind Mount - æŒ‚è½½å®¿ä¸»æœºç›®å½• docker run -v /host/path:/container/path nginx docker run -v $(pwd)/data:/app/data nginx # 3. tmpfs - å†…å­˜å­˜å‚¨ï¼ˆä¸´æ—¶æ•°æ®ï¼‰ docker run --tmpfs /app/tmp nginx 7.2 æ•°æ®å¤‡ä»½ä¸æ¢å¤ 1 2 3 4 5 6 7 8 9 10 11 # å¤‡ä»½ Volume docker run --rm \\ -v my-volume:/data \\ -v $(pwd):/backup \\ alpine tar czf /backup/backup.tar.gz -C /data . # æ¢å¤ Volume docker run --rm \\ -v my-volume:/data \\ -v $(pwd):/backup \\ alpine tar xzf /backup/backup.tar.gz -C /data å…«ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 8.1 å®‰å…¨åŠ å›º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # 1. ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œ FROM node:18-alpine RUN addgroup -g 1001 appgroup \u0026amp;\u0026amp; \\ adduser -u 1001 -G appgroup -D appuser USER appuser WORKDIR /app COPY --chown=appuser:appgroup . . # 2. ä½¿ç”¨åªè¯»æ–‡ä»¶ç³»ç»Ÿ docker run --read-only -v /tmp:/tmp nginx # 3. é™åˆ¶èµ„æº docker run -m 512m --cpus=1 nginx # 4. ç¦æ­¢ç‰¹æƒæ¨¡å¼ docker run --security-opt=no-new-privileges nginx 8.2 æ—¥å¿—ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 # é…ç½®æ—¥å¿—é©±åŠ¨ï¼ˆdaemon.jsonï¼‰ { \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;10m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; } } # æŸ¥çœ‹å®¹å™¨æ—¥å¿— docker logs --since 1h \u0026lt;container\u0026gt; docker logs --until 2023-12-01T12:00:00 \u0026lt;container\u0026gt; 8.3 å¥åº·æ£€æŸ¥ 1 2 HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \\ CMD curl -f http://localhost:8080/health || exit 1 1 2 3 4 5 6 7 8 9 # docker-compose.yml services: web: healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;curl\u0026#34;, \u0026#34;-f\u0026#34;, \u0026#34;http://localhost:8080/health\u0026#34;] interval: 30s timeout: 10s retries: 3 start_period: 40s ä¹ã€å¸¸è§é—®é¢˜æ’æŸ¥ 9.1 å®¹å™¨æ— æ³•å¯åŠ¨ 1 2 3 4 5 6 7 8 # æŸ¥çœ‹å®¹å™¨æ—¥å¿— docker logs \u0026lt;container\u0026gt; # æŸ¥çœ‹å®¹å™¨è¯¦æƒ… docker inspect \u0026lt;container\u0026gt; # ä»¥äº¤äº’æ¨¡å¼è°ƒè¯• docker run -it --entrypoint /bin/sh \u0026lt;image\u0026gt; 9.2 ç£ç›˜ç©ºé—´æ¸…ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 # æŸ¥çœ‹ Docker ç£ç›˜ä½¿ç”¨ docker system df # æ¸…ç†æ— ç”¨èµ„æº docker system prune # æ¸…ç†åœæ­¢çš„å®¹å™¨ã€æ‚¬ç©ºé•œåƒã€æœªä½¿ç”¨ç½‘ç»œ docker system prune -a # åŒ…æ‹¬æœªä½¿ç”¨çš„é•œåƒ docker system prune -a --volumes # åŒ…æ‹¬æœªä½¿ç”¨çš„å· # å•ç‹¬æ¸…ç† docker container prune docker image prune -a docker volume prune docker network prune 9.3 ç½‘ç»œé—®é¢˜æ’æŸ¥ 1 2 3 4 5 6 7 8 9 # è¿›å…¥å®¹å™¨æ£€æŸ¥ç½‘ç»œ docker exec -it \u0026lt;container\u0026gt; sh ping \u0026lt;target\u0026gt; nslookup \u0026lt;domain\u0026gt; curl -v http://target:port # æ£€æŸ¥ç«¯å£æ˜ å°„ docker port \u0026lt;container\u0026gt; netstat -tlnp | grep \u0026lt;port\u0026gt; æ€»ç»“ Docker ä½œä¸ºå®¹å™¨åŒ–æŠ€æœ¯çš„ä»£è¡¨ï¼Œæå¤§åœ°ç®€åŒ–äº†åº”ç”¨çš„éƒ¨ç½²å’Œè¿ç»´å·¥ä½œã€‚æœ¬æ–‡æ¶µç›–äº†ä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§å®è·µçš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼š\næ ¸å¿ƒæ¦‚å¿µï¼šé•œåƒã€å®¹å™¨ã€ä»“åº“çš„å…³ç³» åŸºç¡€æ“ä½œï¼šé•œåƒç®¡ç†ã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€æ—¥å¿—æŸ¥çœ‹ Dockerfileï¼šç¼–å†™è§„èŒƒå’Œæœ€ä½³å®è·µ Docker Composeï¼šå¤šå®¹å™¨ç¼–æ’ ç½‘ç»œä¸å­˜å‚¨ï¼šç½‘ç»œæ¨¡å¼ã€æ•°æ®æŒä¹…åŒ– ç”Ÿäº§å®è·µï¼šå®‰å…¨åŠ å›ºã€æ—¥å¿—ç®¡ç†ã€é—®é¢˜æ’æŸ¥ æŒæ¡è¿™äº›çŸ¥è¯†ï¼Œä½ å°±èƒ½åœ¨å®é™…é¡¹ç›®ä¸­æ¸¸åˆƒæœ‰ä½™åœ°ä½¿ç”¨ Dockerã€‚ä¸‹ä¸€æ­¥ï¼Œå¯ä»¥ç»§ç»­å­¦ä¹  Kubernetesï¼Œè¿›ä¸€æ­¥æå‡å®¹å™¨ç¼–æ’èƒ½åŠ›ã€‚\nå¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è—ï¼Œä¹Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµè®¨è®ºï¼\n","date":"2025-12-14T00:00:00Z","image":"https://zpf-zero.github.io/p/docker-complete-guide/%E4%BB%99%E9%81%93%E6%9D%80%E6%8B%9B%E4%B8%87%E6%88%91_hu_76a3d652e449e414.jpg","permalink":"https://zpf-zero.github.io/p/docker-complete-guide/","title":"Docker ä»å…¥é—¨åˆ°å®è·µï¼šå®¹å™¨åŒ–æŠ€æœ¯å®Œå…¨æŒ‡å—"},{"content":"å‰è¨€ äºŒåˆ†æŸ¥æ‰¾æ˜¯ç®—æ³•å­¦ä¹ ä¸­æœ€åŸºç¡€ä¹Ÿæ˜¯æœ€é‡è¦çš„ç®—æ³•ä¹‹ä¸€ã€‚çœ‹ä¼¼ç®€å•ï¼Œä½†ç»†èŠ‚å¤„ç†ç¨æœ‰ä¸æ…å°±ä¼šå‡ºç°æ­»å¾ªç¯æˆ–æ¼æ‰è¾¹ç•Œæƒ…å†µã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£äºŒåˆ†æŸ¥æ‰¾çš„ä¸¤ç§æ ¸å¿ƒå†™æ³•ï¼šå·¦é—­å³é—­ [left, right] å’Œ å·¦é—­å³å¼€ [left, right)ï¼Œå¹¶é€šè¿‡ LeetCode ç»å…¸é¢˜ç›®è¿›è¡Œå®æˆ˜æ¼”ç»ƒã€‚\nä¸€ã€äºŒåˆ†æŸ¥æ‰¾æ ¸å¿ƒæ€æƒ³ 1.1 ä»€ä¹ˆæ˜¯äºŒåˆ†æŸ¥æ‰¾ï¼Ÿ äºŒåˆ†æŸ¥æ‰¾ï¼ˆBinary Searchï¼‰æ˜¯ä¸€ç§åœ¨æœ‰åºæ•°ç»„ä¸­æŸ¥æ‰¾ç‰¹å®šå…ƒç´ çš„é«˜æ•ˆç®—æ³•ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š\næ¯æ¬¡å–ä¸­é—´å…ƒç´ ä¸ç›®æ ‡å€¼æ¯”è¾ƒ å¦‚æœä¸­é—´å€¼ç­‰äºç›®æ ‡å€¼ï¼ŒæŸ¥æ‰¾æˆåŠŸ å¦‚æœä¸­é—´å€¼å¤§äºç›®æ ‡å€¼ï¼Œåœ¨å·¦åŠéƒ¨åˆ†ç»§ç»­æŸ¥æ‰¾ å¦‚æœä¸­é—´å€¼å°äºç›®æ ‡å€¼ï¼Œåœ¨å³åŠéƒ¨åˆ†ç»§ç»­æŸ¥æ‰¾ 1 2 3 4 5 6 7 8 9 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æœ‰åºæ•°ç»„ï¼š[1, 3, 5, 7, 9, 11, 13, 15, 17, 19] â”‚ â”‚ ç›®æ ‡å€¼ï¼š7 â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ ç¬¬1æ¬¡ï¼šmid=9 \u0026gt; 7 â†’ åœ¨å·¦åŠéƒ¨åˆ† [1,3,5,7] æŸ¥æ‰¾ â”‚ â”‚ ç¬¬2æ¬¡ï¼šmid=3 \u0026lt; 7 â†’ åœ¨å³åŠéƒ¨åˆ† [5,7] æŸ¥æ‰¾ â”‚ â”‚ ç¬¬3æ¬¡ï¼šmid=5 \u0026lt; 7 â†’ åœ¨å³åŠéƒ¨åˆ† [7] æŸ¥æ‰¾ â”‚ â”‚ ç¬¬4æ¬¡ï¼šmid=7 = 7 â†’ æ‰¾åˆ°ç›®æ ‡ï¼ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 1.2 æ—¶é—´å¤æ‚åº¦åˆ†æ ç®—æ³• æ—¶é—´å¤æ‚åº¦ ç©ºé—´å¤æ‚åº¦ çº¿æ€§æŸ¥æ‰¾ O(n) O(1) äºŒåˆ†æŸ¥æ‰¾ O(log n) O(1) å¯¹äºä¸€ä¸ªé•¿åº¦ä¸º 100 ä¸‡çš„æ•°ç»„ï¼š\nçº¿æ€§æŸ¥æ‰¾æœ€å¤šéœ€è¦ 100 ä¸‡æ¬¡ æ¯”è¾ƒ äºŒåˆ†æŸ¥æ‰¾æœ€å¤šåªéœ€è¦ 20 æ¬¡ æ¯”è¾ƒï¼ˆ2^20 â‰ˆ 100ä¸‡ï¼‰ äºŒã€ä¸¤ç§åŒºé—´å®šä¹‰è¯¦è§£ äºŒåˆ†æŸ¥æ‰¾æœ€å®¹æ˜“å‡ºé”™çš„åœ°æ–¹åœ¨äºåŒºé—´çš„å®šä¹‰ï¼Œä¸åŒçš„åŒºé—´å®šä¹‰ä¼šå½±å“ï¼š\nwhile å¾ªç¯çš„æ¡ä»¶ left å’Œ right çš„æ›´æ–°æ–¹å¼ 2.1 å·¦é—­å³é—­ [left, right] åŒºé—´å®šä¹‰ï¼šleft å’Œ right éƒ½æ˜¯æœ‰æ•ˆçš„æœç´¢è¾¹ç•Œï¼Œå³ nums[left] å’Œ nums[right] éƒ½å¯èƒ½æ˜¯ç›®æ ‡å€¼ã€‚\nå…³é”®ç‚¹ï¼š\nåˆå§‹åŒ–ï¼šright = len(nums) - 1ï¼ˆæœ€åä¸€ä¸ªæœ‰æ•ˆç´¢å¼•ï¼‰ å¾ªç¯æ¡ä»¶ï¼šleft \u0026lt;= rightï¼ˆå½“ left == right æ—¶åŒºé—´ä»æœ‰æ•ˆï¼‰ æ›´æ–°è¾¹ç•Œï¼šleft = mid + 1 æˆ– right = mid - 1ï¼ˆmid å·²ç»æ¯”è¾ƒè¿‡ï¼Œéœ€è¦æ’é™¤ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // å·¦é—­å³é—­å†™æ³• [left, right] func binarySearch(nums []int, target int) int { left, right := 0, len(nums)-1 // æ³¨æ„ï¼šright æ˜¯æœ€åä¸€ä¸ªæœ‰æ•ˆç´¢å¼• for left \u0026lt;= right { // æ³¨æ„ï¼šæ˜¯ \u0026lt;=ï¼Œå› ä¸º left == right æ—¶åŒºé—´ä»æœ‰ä¸€ä¸ªå…ƒç´  mid := left + (right-left)/2 // é˜²æ­¢æº¢å‡ºçš„å†™æ³• if nums[mid] == target { return mid } else if nums[mid] \u0026lt; target { left = mid + 1 // target åœ¨å³åŒºé—´ [mid+1, right] } else { right = mid - 1 // target åœ¨å·¦åŒºé—´ [left, mid-1] } } return -1 // æœªæ‰¾åˆ° } å›¾è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 åˆå§‹çŠ¶æ€ï¼š[1, 3, 5, 7, 9]ï¼Œtarget = 7 L R åŒºé—´ [0, 4] æœ‰æ•ˆ ç¬¬1æ¬¡ï¼šmid = 2ï¼Œnums[2] = 5 \u0026lt; 7 left = mid + 1 = 3 [1, 3, 5, 7, 9] L R åŒºé—´ [3, 4] æœ‰æ•ˆ ç¬¬2æ¬¡ï¼šmid = 3ï¼Œnums[3] = 7 == target è¿”å› 3ï¼Œæ‰¾åˆ°ç›®æ ‡ï¼ 2.2 å·¦é—­å³å¼€ [left, right) åŒºé—´å®šä¹‰ï¼šleft æ˜¯æœ‰æ•ˆè¾¹ç•Œï¼Œright æ˜¯æ— æ•ˆè¾¹ç•Œï¼ˆå¼€åŒºé—´ï¼‰ï¼Œå³ nums[right] ä¸åœ¨æœç´¢èŒƒå›´å†…ã€‚\nå…³é”®ç‚¹ï¼š\nåˆå§‹åŒ–ï¼šright = len(nums)ï¼ˆæ•°ç»„é•¿åº¦ï¼ŒæŒ‡å‘æœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹ä¸€ä½ï¼‰ å¾ªç¯æ¡ä»¶ï¼šleft \u0026lt; rightï¼ˆå½“ left == right æ—¶åŒºé—´ä¸ºç©ºï¼‰ æ›´æ–°è¾¹ç•Œï¼šleft = mid + 1 æˆ– right = midï¼ˆright æœ¬èº«å°±ä¸åŒ…å«ï¼Œæ‰€ä»¥ä¸ç”¨ -1ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // å·¦é—­å³å¼€å†™æ³• [left, right) func binarySearch(nums []int, target int) int { left, right := 0, len(nums) // æ³¨æ„ï¼šright æ˜¯æ•°ç»„é•¿åº¦ for left \u0026lt; right { // æ³¨æ„ï¼šæ˜¯ \u0026lt;ï¼Œå› ä¸º left == right æ—¶åŒºé—´ä¸ºç©º mid := left + (right-left)/2 if nums[mid] == target { return mid } else if nums[mid] \u0026lt; target { left = mid + 1 // target åœ¨å³åŒºé—´ [mid+1, right) } else { right = mid // target åœ¨å·¦åŒºé—´ [left, mid)ï¼Œæ³¨æ„ä¸æ˜¯ mid-1 } } return -1 } å›¾è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 åˆå§‹çŠ¶æ€ï¼š[1, 3, 5, 7, 9]ï¼Œtarget = 7 L R åŒºé—´ [0, 5) æœ‰æ•ˆï¼ˆä¸åŒ…å«ç´¢å¼•5ï¼‰ ç¬¬1æ¬¡ï¼šmid = 2ï¼Œnums[2] = 5 \u0026lt; 7 left = mid + 1 = 3 [1, 3, 5, 7, 9] L R åŒºé—´ [3, 5) æœ‰æ•ˆ ç¬¬2æ¬¡ï¼šmid = 4ï¼Œnums[4] = 9 \u0026gt; 7 right = mid = 4 [1, 3, 5, 7, 9] L R åŒºé—´ [3, 4) æœ‰æ•ˆ ç¬¬3æ¬¡ï¼šmid = 3ï¼Œnums[3] = 7 == target è¿”å› 3ï¼Œæ‰¾åˆ°ç›®æ ‡ï¼ 2.3 ä¸¤ç§å†™æ³•å¯¹æ¯” ç‰¹æ€§ å·¦é—­å³é—­ [left, right] å·¦é—­å³å¼€ [left, right) right åˆå§‹å€¼ len(nums) - 1 len(nums) å¾ªç¯æ¡ä»¶ left \u0026lt;= right left \u0026lt; right left æ›´æ–° left = mid + 1 left = mid + 1 right æ›´æ–° right = mid - 1 right = mid æ¨èç¨‹åº¦ â­â­â­â­â­ â­â­â­â­ ğŸ’¡ å»ºè®®ï¼šé€‰æ‹©ä¸€ç§å†™æ³•å¹¶åšæŒä½¿ç”¨ï¼Œé¿å…æ··æ·†ã€‚ä¸ªäººæ¨èå·¦é—­å³é—­å†™æ³•ï¼Œæ›´ç¬¦åˆç›´è§‰ã€‚\nä¸‰ã€LeetCode å®æˆ˜é¢˜ç›® 3.1 LeetCode 704. äºŒåˆ†æŸ¥æ‰¾ é¢˜ç›®é“¾æ¥ï¼š704. äºŒåˆ†æŸ¥æ‰¾\né¢˜ç›®æè¿°ï¼šç»™å®šä¸€ä¸ª n ä¸ªå…ƒç´ æœ‰åºçš„ï¼ˆå‡åºï¼‰æ•´å‹æ•°ç»„ nums å’Œä¸€ä¸ªç›®æ ‡å€¼ targetï¼Œå†™ä¸€ä¸ªå‡½æ•°æœç´¢ nums ä¸­çš„ targetï¼Œå¦‚æœç›®æ ‡å€¼å­˜åœ¨è¿”å›ä¸‹æ ‡ï¼Œå¦åˆ™è¿”å› -1ã€‚\nç¤ºä¾‹ï¼š\n1 2 3 è¾“å…¥: nums = [-1,0,3,5,9,12], target = 9 è¾“å‡º: 4 è§£é‡Š: 9 å‡ºç°åœ¨ nums ä¸­å¹¶ä¸”ä¸‹æ ‡ä¸º 4 è§£æ³•ä¸€ï¼šå·¦é—­å³é—­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func search(nums []int, target int) int { left, right := 0, len(nums)-1 for left \u0026lt;= right { mid := left + (right-left)/2 if nums[mid] == target { return mid } else if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid - 1 } } return -1 } è§£æ³•äºŒï¼šå·¦é—­å³å¼€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func search(nums []int, target int) int { left, right := 0, len(nums) for left \u0026lt; right { mid := left + (right-left)/2 if nums[mid] == target { return mid } else if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid } } return -1 } 3.2 LeetCode 35. æœç´¢æ’å…¥ä½ç½® é¢˜ç›®é“¾æ¥ï¼š35. æœç´¢æ’å…¥ä½ç½®\né¢˜ç›®æè¿°ï¼šç»™å®šä¸€ä¸ªæ’åºæ•°ç»„å’Œä¸€ä¸ªç›®æ ‡å€¼ï¼Œåœ¨æ•°ç»„ä¸­æ‰¾åˆ°ç›®æ ‡å€¼ï¼Œå¹¶è¿”å›å…¶ç´¢å¼•ã€‚å¦‚æœç›®æ ‡å€¼ä¸å­˜åœ¨äºæ•°ç»„ä¸­ï¼Œè¿”å›å®ƒå°†ä¼šè¢«æŒ‰é¡ºåºæ’å…¥çš„ä½ç½®ã€‚\nç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 è¾“å…¥: nums = [1,3,5,6], target = 5 è¾“å‡º: 2 è¾“å…¥: nums = [1,3,5,6], target = 2 è¾“å‡º: 1 è¾“å…¥: nums = [1,3,5,6], target = 7 è¾“å‡º: 4 æ€è·¯åˆ†æï¼š\nè¿™é“é¢˜æœ¬è´¨ä¸Šæ˜¯æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äº target çš„å…ƒç´ ä½ç½®ã€‚\nå¦‚æœ target å­˜åœ¨ï¼Œè¿”å›å…¶ä½ç½® å¦‚æœ target ä¸å­˜åœ¨ï¼Œè¿”å›å®ƒåº”è¯¥æ’å…¥çš„ä½ç½® è§£æ³•ä¸€ï¼šå·¦é—­å³é—­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func searchInsert(nums []int, target int) int { left, right := 0, len(nums)-1 for left \u0026lt;= right { mid := left + (right-left)/2 if nums[mid] == target { return mid } else if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid - 1 } } // å¾ªç¯ç»“æŸæ—¶ï¼Œleft å°±æ˜¯æ’å…¥ä½ç½® // å› ä¸º left \u0026gt; rightï¼Œè¯´æ˜ target åº”è¯¥æ’å…¥åˆ° left ä½ç½® return left } è§£æ³•äºŒï¼šå·¦é—­å³å¼€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func searchInsert(nums []int, target int) int { left, right := 0, len(nums) for left \u0026lt; right { mid := left + (right-left)/2 if nums[mid] == target { return mid } else if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid } } return left } è¾¹ç•Œæƒ…å†µåˆ†æï¼š\n1 2 3 4 5 nums = [1, 3, 5, 6] target = 0 â†’ è¿”å› 0ï¼ˆæ’å…¥åˆ°æœ€å‰é¢ï¼‰ target = 2 â†’ è¿”å› 1ï¼ˆæ’å…¥åˆ° 1 å’Œ 3 ä¹‹é—´ï¼‰ target = 7 â†’ è¿”å› 4ï¼ˆæ’å…¥åˆ°æœ€åé¢ï¼‰ 3.3 LeetCode 34. åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½® é¢˜ç›®é“¾æ¥ï¼š34. åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®\né¢˜ç›®æè¿°ï¼šç»™ä½ ä¸€ä¸ªæŒ‰ç…§éé€’å‡é¡ºåºæ’åˆ—çš„æ•´æ•°æ•°ç»„ numsï¼Œå’Œä¸€ä¸ªç›®æ ‡å€¼ targetã€‚è¯·ä½ æ‰¾å‡ºç»™å®šç›®æ ‡å€¼åœ¨æ•°ç»„ä¸­çš„å¼€å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚å¦‚æœæ•°ç»„ä¸­ä¸å­˜åœ¨ç›®æ ‡å€¼ targetï¼Œè¿”å› [-1, -1]ã€‚\nç¤ºä¾‹ï¼š\n1 2 3 4 5 è¾“å…¥ï¼šnums = [5,7,7,8,8,10], target = 8 è¾“å‡ºï¼š[3,4] è¾“å…¥ï¼šnums = [5,7,7,8,8,10], target = 6 è¾“å‡ºï¼š[-1,-1] æ€è·¯åˆ†æï¼š\nè¿™é“é¢˜éœ€è¦æ‰¾åˆ° target çš„å·¦è¾¹ç•Œå’Œå³è¾¹ç•Œï¼š\nå·¦è¾¹ç•Œï¼šç¬¬ä¸€ä¸ªç­‰äº target çš„ä½ç½® å³è¾¹ç•Œï¼šæœ€åä¸€ä¸ªç­‰äº target çš„ä½ç½® æˆ‘ä»¬å¯ä»¥åˆ†åˆ«ç”¨ä¸¤æ¬¡äºŒåˆ†æŸ¥æ‰¾æ¥è§£å†³ã€‚\nå®Œæ•´è§£æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 func searchRange(nums []int, target int) []int { if len(nums) == 0 { return []int{-1, -1} } // æŸ¥æ‰¾å·¦è¾¹ç•Œ leftBound := findLeftBound(nums, target) // æŸ¥æ‰¾å³è¾¹ç•Œ rightBound := findRightBound(nums, target) return []int{leftBound, rightBound} } // æŸ¥æ‰¾å·¦è¾¹ç•Œï¼šç¬¬ä¸€ä¸ªç­‰äº target çš„ä½ç½® func findLeftBound(nums []int, target int) int { left, right := 0, len(nums)-1 result := -1 for left \u0026lt;= right { mid := left + (right-left)/2 if nums[mid] == target { result = mid // è®°å½•å½“å‰ä½ç½® right = mid - 1 // ç»§ç»­å‘å·¦æŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦æœ‰æ›´é å·¦çš„ } else if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid - 1 } } return result } // æŸ¥æ‰¾å³è¾¹ç•Œï¼šæœ€åä¸€ä¸ªç­‰äº target çš„ä½ç½® func findRightBound(nums []int, target int) int { left, right := 0, len(nums)-1 result := -1 for left \u0026lt;= right { mid := left + (right-left)/2 if nums[mid] == target { result = mid // è®°å½•å½“å‰ä½ç½® left = mid + 1 // ç»§ç»­å‘å³æŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦æœ‰æ›´é å³çš„ } else if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid - 1 } } return result } å›¾è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 nums = [5, 7, 7, 8, 8, 10]ï¼Œtarget = 8 æŸ¥æ‰¾å·¦è¾¹ç•Œï¼š mid=2, nums[2]=7 \u0026lt; 8 â†’ left = 3 mid=4, nums[4]=8 == 8 â†’ result=4, right=3ï¼ˆç»§ç»­å‘å·¦æ‰¾ï¼‰ mid=3, nums[3]=8 == 8 â†’ result=3, right=2ï¼ˆç»§ç»­å‘å·¦æ‰¾ï¼‰ left \u0026gt; rightï¼Œç»“æŸï¼Œå·¦è¾¹ç•Œ = 3 æŸ¥æ‰¾å³è¾¹ç•Œï¼š mid=2, nums[2]=7 \u0026lt; 8 â†’ left = 3 mid=4, nums[4]=8 == 8 â†’ result=4, left=5ï¼ˆç»§ç»­å‘å³æ‰¾ï¼‰ mid=5, nums[5]=10 \u0026gt; 8 â†’ right = 4 left \u0026gt; rightï¼Œç»“æŸï¼Œå³è¾¹ç•Œ = 4 æœ€ç»ˆç»“æœï¼š[3, 4] è¿›é˜¶ï¼šä½¿ç”¨ç»Ÿä¸€æ¨¡æ¿ æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªç»Ÿä¸€çš„å‡½æ•°æ¥æŸ¥æ‰¾è¾¹ç•Œï¼Œé€šè¿‡å‚æ•°æ§åˆ¶æŸ¥æ‰¾å·¦è¾¹ç•Œè¿˜æ˜¯å³è¾¹ç•Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 func searchRange(nums []int, target int) []int { if len(nums) == 0 { return []int{-1, -1} } // å·¦è¾¹ç•Œ = ç¬¬ä¸€ä¸ª \u0026gt;= target çš„ä½ç½® leftBound := lowerBound(nums, target) // æ£€æŸ¥å·¦è¾¹ç•Œæ˜¯å¦æœ‰æ•ˆ if leftBound == len(nums) || nums[leftBound] != target { return []int{-1, -1} } // å³è¾¹ç•Œ = ç¬¬ä¸€ä¸ª \u0026gt; target çš„ä½ç½® - 1 rightBound := lowerBound(nums, target+1) - 1 return []int{leftBound, rightBound} } // lowerBound: æŸ¥æ‰¾ç¬¬ä¸€ä¸ª \u0026gt;= target çš„ä½ç½® func lowerBound(nums []int, target int) int { left, right := 0, len(nums) for left \u0026lt; right { mid := left + (right-left)/2 if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid } } return left } 3.4 LeetCode 27. ç§»é™¤å…ƒç´ ï¼ˆåŒæŒ‡é’ˆï¼‰ é¢˜ç›®é“¾æ¥ï¼š27. ç§»é™¤å…ƒç´ \né¢˜ç›®æè¿°ï¼šç»™ä½ ä¸€ä¸ªæ•°ç»„ nums å’Œä¸€ä¸ªå€¼ valï¼Œä½ éœ€è¦åŸåœ°ç§»é™¤æ‰€æœ‰æ•°å€¼ç­‰äº val çš„å…ƒç´ ï¼Œå¹¶è¿”å›ç§»é™¤åæ•°ç»„çš„æ–°é•¿åº¦ã€‚\nç¤ºä¾‹ï¼š\n1 2 3 4 5 è¾“å…¥ï¼šnums = [3,2,2,3], val = 3 è¾“å‡ºï¼š2, nums = [2,2,_,_] è¾“å…¥ï¼šnums = [0,1,2,2,3,0,4,2], val = 2 è¾“å‡ºï¼š5, nums = [0,1,4,0,3,_,_,_] ğŸ’¡ æ³¨æ„ï¼šè¿™é“é¢˜è™½ç„¶ä¸æ˜¯äºŒåˆ†æŸ¥æ‰¾ï¼Œä½†å®ƒæ˜¯æ•°ç»„æ“ä½œçš„ç»å…¸é¢˜ç›®ï¼Œå¸¸ä¸äºŒåˆ†æŸ¥æ‰¾ä¸€èµ·ä½œä¸ºæ•°ç»„åŸºç¡€ç»ƒä¹ ã€‚è¿™é‡Œä½¿ç”¨åŒæŒ‡é’ˆæŠ€å·§è§£å†³ã€‚\nè§£æ³•ä¸€ï¼šå¿«æ…¢æŒ‡é’ˆ 1 2 3 4 5 6 7 8 9 10 11 12 func removeElement(nums []int, val int) int { slow := 0 // æ…¢æŒ‡é’ˆï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªè¦å¡«å…¥çš„ä½ç½® for fast := 0; fast \u0026lt; len(nums); fast++ { // å¿«æŒ‡é’ˆéå†æ•°ç»„ï¼Œé‡åˆ°ä¸ç­‰äº val çš„å…ƒç´ å°±ä¿ç•™ if nums[fast] != val { nums[slow] = nums[fast] slow++ } } return slow } å›¾è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 nums = [3, 2, 2, 3], val = 3 åˆå§‹ï¼šslow = 0 fast = 0: nums[0] = 3 == valï¼Œè·³è¿‡ fast = 1: nums[1] = 2 != valï¼Œnums[0] = 2, slow = 1 fast = 2: nums[2] = 2 != valï¼Œnums[1] = 2, slow = 2 fast = 3: nums[3] = 3 == valï¼Œè·³è¿‡ ç»“æœï¼šnums = [2, 2, _, _]ï¼Œè¿”å› slow = 2 è§£æ³•äºŒï¼šåŒå‘æŒ‡é’ˆï¼ˆä¼˜åŒ–ç‰ˆï¼‰ å½“è¦åˆ é™¤çš„å…ƒç´ è¾ƒå°‘æ—¶ï¼Œå¯ä»¥ä»ä¸¤ç«¯å‘ä¸­é—´éå†ï¼Œå‡å°‘å…ƒç´ ç§»åŠ¨æ¬¡æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func removeElement(nums []int, val int) int { left, right := 0, len(nums)-1 for left \u0026lt;= right { if nums[left] == val { // ç”¨å³è¾¹çš„å…ƒç´ è¦†ç›–è¦åˆ é™¤çš„å…ƒç´  nums[left] = nums[right] right-- } else { left++ } } return left } å›¾è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 nums = [3, 2, 2, 3], val = 3 åˆå§‹ï¼šleft = 0, right = 3 left = 0: nums[0] = 3 == valï¼Œnums[0] = nums[3] = 3, right = 2 nums = [3, 2, 2, 3]ï¼ˆå®é™…ä¸Š nums[0] è¿˜æ˜¯ 3ï¼‰ left = 0: nums[0] = 3 == valï¼Œnums[0] = nums[2] = 2, right = 1 nums = [2, 2, 2, 3] left = 0: nums[0] = 2 != valï¼Œleft = 1 left = 1: nums[1] = 2 != valï¼Œleft = 2 left \u0026gt; rightï¼Œç»“æŸ ç»“æœï¼šè¿”å› left = 2 å››ã€äºŒåˆ†æŸ¥æ‰¾æ¨¡æ¿æ€»ç»“ 4.1 åŸºç¡€æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // æ¨¡æ¿1ï¼šæŸ¥æ‰¾ target æ˜¯å¦å­˜åœ¨ func binarySearch(nums []int, target int) int { left, right := 0, len(nums)-1 for left \u0026lt;= right { mid := left + (right-left)/2 if nums[mid] == target { return mid } else if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid - 1 } } return -1 } 4.2 æŸ¥æ‰¾è¾¹ç•Œæ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // æ¨¡æ¿2ï¼šæŸ¥æ‰¾ç¬¬ä¸€ä¸ª \u0026gt;= target çš„ä½ç½®ï¼ˆå·¦è¾¹ç•Œï¼‰ func lowerBound(nums []int, target int) int { left, right := 0, len(nums) for left \u0026lt; right { mid := left + (right-left)/2 if nums[mid] \u0026lt; target { left = mid + 1 } else { right = mid } } return left } // æ¨¡æ¿3ï¼šæŸ¥æ‰¾ç¬¬ä¸€ä¸ª \u0026gt; target çš„ä½ç½® func upperBound(nums []int, target int) int { left, right := 0, len(nums) for left \u0026lt; right { mid := left + (right-left)/2 if nums[mid] \u0026lt;= target { left = mid + 1 } else { right = mid } } return left } 4.3 å¸¸è§åº”ç”¨åœºæ™¯ åœºæ™¯ æ–¹æ³• æŸ¥æ‰¾ target æ˜¯å¦å­˜åœ¨ åŸºç¡€æ¨¡æ¿ æŸ¥æ‰¾æ’å…¥ä½ç½® lowerBound æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç­‰äº target lowerBound å¹¶éªŒè¯ æŸ¥æ‰¾æœ€åä¸€ä¸ªç­‰äº target upperBound - 1 å¹¶éªŒè¯ æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¤§äº target upperBound æŸ¥æ‰¾æœ€åä¸€ä¸ªå°äº target lowerBound - 1 äº”ã€æ˜“é”™ç‚¹ä¸æ³¨æ„äº‹é¡¹ 5.1 é˜²æ­¢æ•´æ•°æº¢å‡º 1 2 3 4 5 // âŒ å¯èƒ½æº¢å‡º mid := (left + right) / 2 // âœ… æ¨èå†™æ³• mid := left + (right-left)/2 5.2 åŒºé—´å®šä¹‰è¦ä¸€è‡´ é€‰æ‹©ä¸€ç§åŒºé—´å®šä¹‰åï¼Œå¾ªç¯æ¡ä»¶å’Œè¾¹ç•Œæ›´æ–°å¿…é¡»é…å¥—ï¼š\nåŒºé—´å®šä¹‰ å¾ªç¯æ¡ä»¶ right æ›´æ–° [left, right] left \u0026lt;= right right = mid - 1 [left, right) left \u0026lt; right right = mid 5.3 æ­»å¾ªç¯æ£€æŸ¥ å¦‚æœå‘ç°ä»£ç é™·å…¥æ­»å¾ªç¯ï¼Œæ£€æŸ¥ï¼š\nå¾ªç¯æ¡ä»¶æ˜¯å¦ä¸åŒºé—´å®šä¹‰åŒ¹é… left å’Œ right æ˜¯å¦éƒ½æœ‰æœºä¼šæ›´æ–° æ›´æ–°æ—¶æ˜¯å¦æ­£ç¡®ä½¿ç”¨ mid + 1 æˆ– mid - 1 æ€»ç»“ äºŒåˆ†æŸ¥æ‰¾çœ‹ä¼¼ç®€å•ï¼Œä½†ç»†èŠ‚å†³å®šæˆè´¥ã€‚æŒæ¡ä»¥ä¸‹è¦ç‚¹ï¼š\nç†è§£ä¸¤ç§åŒºé—´å®šä¹‰ï¼šå·¦é—­å³é—­ vs å·¦é—­å³å¼€ ä¿æŒä¸€è‡´æ€§ï¼šå¾ªç¯æ¡ä»¶ã€è¾¹ç•Œæ›´æ–°å¿…é¡»ä¸åŒºé—´å®šä¹‰é…å¥— é˜²æ­¢æº¢å‡ºï¼šä½¿ç”¨ left + (right-left)/2 å¤šåŠ ç»ƒä¹ ï¼šé€šè¿‡ LeetCode é¢˜ç›®å·©å›ºç†è§£ å»ºè®®é€‰æ‹©å·¦é—­å³é—­å†™æ³•ä½œä¸ºä¸»åŠ›ï¼Œç†Ÿç»ƒæŒæ¡åå†å­¦ä¹ å…¶ä»–å˜ç§ã€‚\nç»ƒä¹ é¢˜ç›®æ¨è éš¾åº¦ é¢˜ç›® é“¾æ¥ ç®€å• 704. äºŒåˆ†æŸ¥æ‰¾ é“¾æ¥ ç®€å• 35. æœç´¢æ’å…¥ä½ç½® é“¾æ¥ ä¸­ç­‰ 34. æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½® é“¾æ¥ ç®€å• 27. ç§»é™¤å…ƒç´  é“¾æ¥ ä¸­ç­‰ 33. æœç´¢æ—‹è½¬æ’åºæ•°ç»„ é“¾æ¥ å›°éš¾ 4. å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•° é“¾æ¥ ","date":"2025-12-14T00:00:00Z","image":"https://zpf-zero.github.io/p/binary-search-guide/manhua_hu_5c44492225c02f51.jpg","permalink":"https://zpf-zero.github.io/p/binary-search-guide/","title":"äºŒåˆ†æŸ¥æ‰¾ç®—æ³•è¯¦è§£ï¼šä¸¤ç§åŒºé—´å®šä¹‰ä¸ç»å…¸é¢˜ç›®å®æˆ˜"},{"content":"å‰è¨€ æ—¶é—´è½®ï¼ˆTiming Wheelï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å®šæ—¶ä»»åŠ¡è°ƒåº¦ç®—æ³•ï¼Œæœ€åˆç”± Varghese å’Œ Lauck åœ¨ 1987 å¹´æå‡ºã€‚å®ƒä»¥ O(1) çš„æ—¶é—´å¤æ‚åº¦å®Œæˆä»»åŠ¡çš„æ·»åŠ å’Œè§¦å‘ï¼Œå¹¿æ³›åº”ç”¨äº Nettyã€Kafkaã€Linux å†…æ ¸ç­‰ç³»ç»Ÿä¸­ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£æ—¶é—´è½®çš„åŸç†å’Œ Go è¯­è¨€å®ç°ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´è½®ï¼Ÿ 1.1 ä¼ ç»Ÿæ–¹æ¡ˆçš„é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 æ–¹æ¡ˆ1ï¼šæ’åºé“¾è¡¨ - æ·»åŠ ä»»åŠ¡ï¼šO(n)ï¼Œéœ€è¦æ‰¾åˆ°æ­£ç¡®ä½ç½® - è§¦å‘ä»»åŠ¡ï¼šO(1)ï¼Œå–å¤´éƒ¨å…ƒç´  - é—®é¢˜ï¼šæ·»åŠ æ•ˆç‡ä½ æ–¹æ¡ˆ2ï¼šæœ€å°å †ï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼‰ - æ·»åŠ ä»»åŠ¡ï¼šO(log n) - è§¦å‘ä»»åŠ¡ï¼šO(log n)ï¼Œéœ€è¦è°ƒæ•´å † - é—®é¢˜ï¼šå¤§é‡ä»»åŠ¡æ—¶æ•ˆç‡ä¸‹é™ æ–¹æ¡ˆ3ï¼šæ—¶é—´è½® - æ·»åŠ ä»»åŠ¡ï¼šO(1) - è§¦å‘ä»»åŠ¡ï¼šO(1) - ä¼˜åŠ¿ï¼šå¸¸æ•°æ—¶é—´å¤æ‚åº¦ 1.2 æ—¶é—´è½®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ç®€å•æ—¶é—´è½®ç¤ºæ„å›¾ï¼ˆslots=8ï¼Œtick=1sï¼‰ï¼š 0 â”Œâ”€â”€â”€â”€â”€â” 7 â”‚ â”‚ 1 â”Œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ *â”€â”€â”‚â”€â”€â”€â”‚â”€â”€\u0026gt; å½“å‰æŒ‡é’ˆ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜ 6 â”‚ â”‚ 2 â”œâ”€â”€â”€â”€â”€â”¤ 5 â”‚ â”‚ 3 â””â”€â”€â”€â”€â”€â”˜ 4 æ¯ä¸ªæ§½ä½ï¼ˆslotï¼‰æ˜¯ä¸€ä¸ªä»»åŠ¡é“¾è¡¨ï¼š slot[0]: Task A -\u0026gt; Task B -\u0026gt; nil slot[1]: Task C -\u0026gt; nil slot[2]: nil ... æ—¶é—´æ¨è¿›ï¼š - æ¯ä¸ª tickï¼ˆå¦‚1ç§’ï¼‰ï¼ŒæŒ‡é’ˆç§»åŠ¨ä¸€æ ¼ - æ‰§è¡Œå½“å‰æ§½ä½çš„æ‰€æœ‰ä»»åŠ¡ äºŒã€åŸºç¡€å®ç° 2.1 æ•°æ®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package timewheel import ( \u0026#34;container/list\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) // ä»»åŠ¡å®šä¹‰ type Task struct { ID string Delay time.Duration Callback func() circle int // éœ€è¦è½¬å¤šå°‘åœˆæ‰æ‰§è¡Œ } // æ—¶é—´è½® type TimeWheel struct { interval time.Duration // æ—¶é—´é—´éš”ï¼ˆtickï¼‰ slots int // æ§½ä½æ•°é‡ currentPos int // å½“å‰æŒ‡é’ˆä½ç½® buckets []*list.List // æ§½ä½æ•°ç»„ taskMap map[string]*TaskLocation // ä»»åŠ¡ä½ç½®ç´¢å¼• ticker *time.Ticker stopCh chan struct{} addCh chan *Task removeCh chan string mu sync.RWMutex } // ä»»åŠ¡ä½ç½® type TaskLocation struct { slot int element *list.Element } // åˆ›å»ºæ—¶é—´è½® func NewTimeWheel(interval time.Duration, slots int) *TimeWheel { tw := \u0026amp;TimeWheel{ interval: interval, slots: slots, currentPos: 0, buckets: make([]*list.List, slots), taskMap: make(map[string]*TaskLocation), stopCh: make(chan struct{}), addCh: make(chan *Task, 1000), removeCh: make(chan string, 1000), } // åˆå§‹åŒ–æ§½ä½ for i := 0; i \u0026lt; slots; i++ { tw.buckets[i] = list.New() } return tw } 2.2 æ ¸å¿ƒæ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 // å¯åŠ¨æ—¶é—´è½® func (tw *TimeWheel) Start() { tw.ticker = time.NewTicker(tw.interval) go tw.run() } // è¿è¡Œä¸»å¾ªç¯ func (tw *TimeWheel) run() { for { select { case \u0026lt;-tw.ticker.C: tw.tick() case task := \u0026lt;-tw.addCh: tw.addTask(task) case id := \u0026lt;-tw.removeCh: tw.removeTask(id) case \u0026lt;-tw.stopCh: tw.ticker.Stop() return } } } // æ—¶é—´æ¨è¿› func (tw *TimeWheel) tick() { tw.mu.Lock() defer tw.mu.Unlock() // è·å–å½“å‰æ§½ä½çš„ä»»åŠ¡åˆ—è¡¨ bucket := tw.buckets[tw.currentPos] // æ‰§è¡Œåˆ°æœŸä»»åŠ¡ for e := bucket.Front(); e != nil; { task := e.Value.(*Task) if task.circle \u0026gt; 0 { // è¿˜éœ€è¦ç»§ç»­ç­‰å¾… task.circle-- e = e.Next() continue } // æ‰§è¡Œä»»åŠ¡ next := e.Next() go task.Callback() // ä»é“¾è¡¨å’Œç´¢å¼•ä¸­ç§»é™¤ bucket.Remove(e) delete(tw.taskMap, task.ID) e = next } // ç§»åŠ¨æŒ‡é’ˆ tw.currentPos = (tw.currentPos + 1) % tw.slots } // æ·»åŠ ä»»åŠ¡ func (tw *TimeWheel) addTask(task *Task) { tw.mu.Lock() defer tw.mu.Unlock() // è®¡ç®—æ§½ä½å’Œåœˆæ•° delay := int(task.Delay / tw.interval) circle := delay / tw.slots pos := (tw.currentPos + delay) % tw.slots task.circle = circle // æ·»åŠ åˆ°æ§½ä½ element := tw.buckets[pos].PushBack(task) // è®°å½•ä½ç½® tw.taskMap[task.ID] = \u0026amp;TaskLocation{ slot: pos, element: element, } } // ç§»é™¤ä»»åŠ¡ func (tw *TimeWheel) removeTask(id string) { tw.mu.Lock() defer tw.mu.Unlock() if loc, ok := tw.taskMap[id]; ok { tw.buckets[loc.slot].Remove(loc.element) delete(tw.taskMap, id) } } // æ·»åŠ å»¶è¿Ÿä»»åŠ¡ï¼ˆå…¬å¼€æ–¹æ³•ï¼‰ func (tw *TimeWheel) AddTask(id string, delay time.Duration, callback func()) { tw.addCh \u0026lt;- \u0026amp;Task{ ID: id, Delay: delay, Callback: callback, } } // ç§»é™¤ä»»åŠ¡ï¼ˆå…¬å¼€æ–¹æ³•ï¼‰ func (tw *TimeWheel) RemoveTask(id string) { tw.removeCh \u0026lt;- id } // åœæ­¢æ—¶é—´è½® func (tw *TimeWheel) Stop() { close(tw.stopCh) } 2.3 ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func main() { // åˆ›å»ºæ—¶é—´è½®ï¼š100ms tickï¼Œ60 ä¸ªæ§½ä½ï¼ˆè¦†ç›– 6 ç§’ï¼‰ tw := NewTimeWheel(100*time.Millisecond, 60) tw.Start() defer tw.Stop() // æ·»åŠ å»¶è¿Ÿä»»åŠ¡ tw.AddTask(\u0026#34;task-1\u0026#34;, 1*time.Second, func() { fmt.Println(\u0026#34;Task 1 executed at\u0026#34;, time.Now()) }) tw.AddTask(\u0026#34;task-2\u0026#34;, 3*time.Second, func() { fmt.Println(\u0026#34;Task 2 executed at\u0026#34;, time.Now()) }) tw.AddTask(\u0026#34;task-3\u0026#34;, 5*time.Second, func() { fmt.Println(\u0026#34;Task 3 executed at\u0026#34;, time.Now()) }) // å–æ¶ˆä»»åŠ¡ tw.RemoveTask(\u0026#34;task-2\u0026#34;) time.Sleep(10 * time.Second) } ä¸‰ã€å±‚çº§æ—¶é—´è½® 3.1 é—®é¢˜èƒŒæ™¯ ç®€å•æ—¶é—´è½®çš„é—®é¢˜ï¼š\nå¦‚æœéœ€è¦æ”¯æŒå¾ˆé•¿çš„å»¶è¿Ÿæ—¶é—´ï¼ˆå¦‚ 1 å¹´ï¼‰ è¦ä¹ˆå¢åŠ æ§½ä½æ•°é‡ï¼ˆå†…å­˜å¼€é”€å¤§ï¼‰ è¦ä¹ˆå¢åŠ  tick é—´éš”ï¼ˆç²¾åº¦ä¸‹é™ï¼‰ è§£å†³æ–¹æ¡ˆï¼šå±‚çº§æ—¶é—´è½®ï¼ˆHierarchical Timing Wheelï¼‰\n3.2 å±‚çº§ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 å±‚çº§æ—¶é—´è½®ç¤ºä¾‹ï¼š æ”¯æŒèŒƒå›´ï¼š0 ~ 16777215 tickï¼ˆçº¦ 194 å¤©ï¼Œtick=1sï¼‰ Level 0: 256 slots, 1s/slot -\u0026gt; è¦†ç›– 256s Level 1: 256 slots, 256s/slot -\u0026gt; è¦†ç›– 18.2h Level 2: 256 slots, 18.2h/slot -\u0026gt; è¦†ç›– 194 å¤© ä»»åŠ¡æµè½¬ï¼š 1. å»¶è¿Ÿ 1000s çš„ä»»åŠ¡ -\u0026gt; Level 1, slot 3 (1000/256=3) 2. å½“ Level 1 æŒ‡é’ˆåˆ°è¾¾ slot 3 æ—¶ 3. ä»»åŠ¡é™çº§åˆ° Level 0, slot (1000%256)=232 4. å½“ Level 0 æŒ‡é’ˆåˆ°è¾¾ slot 232 æ—¶æ‰§è¡Œ 3.3 å±‚çº§æ—¶é—´è½®å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 package timewheel import ( \u0026#34;container/list\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) // å±‚çº§æ—¶é—´è½® type HierarchicalTimeWheel struct { levels []*TimeWheelLevel levelCount int tickMs int64 startMs int64 currentTime int64 taskMap map[string]*HierarchicalTaskLocation mu sync.Mutex ticker *time.Ticker stopCh chan struct{} } // å•å±‚æ—¶é—´è½® type TimeWheelLevel struct { slots []*list.List slotCount int tickMs int64 currentPos int } // ä»»åŠ¡ä½ç½® type HierarchicalTaskLocation struct { level int slot int element *list.Element task *Task } // åˆ›å»ºå±‚çº§æ—¶é—´è½® func NewHierarchicalTimeWheel(tickMs int64, wheelSize int, levelCount int) *HierarchicalTimeWheel { htw := \u0026amp;HierarchicalTimeWheel{ levels: make([]*TimeWheelLevel, levelCount), levelCount: levelCount, tickMs: tickMs, startMs: time.Now().UnixMilli(), currentTime: 0, taskMap: make(map[string]*HierarchicalTaskLocation), stopCh: make(chan struct{}), } // åˆå§‹åŒ–å„å±‚ levelTick := tickMs for i := 0; i \u0026lt; levelCount; i++ { htw.levels[i] = \u0026amp;TimeWheelLevel{ slots: make([]*list.List, wheelSize), slotCount: wheelSize, tickMs: levelTick, } for j := 0; j \u0026lt; wheelSize; j++ { htw.levels[i].slots[j] = list.New() } levelTick *= int64(wheelSize) } return htw } // æ·»åŠ ä»»åŠ¡ func (htw *HierarchicalTimeWheel) AddTask(id string, delayMs int64, callback func()) { htw.mu.Lock() defer htw.mu.Unlock() task := \u0026amp;Task{ ID: id, Delay: time.Duration(delayMs) * time.Millisecond, Callback: callback, } expireTime := htw.currentTime + delayMs htw.addTaskInternal(task, expireTime) } func (htw *HierarchicalTimeWheel) addTaskInternal(task *Task, expireTime int64) { // è®¡ç®—å»¶è¿Ÿ delay := expireTime - htw.currentTime // æ‰¾åˆ°åˆé€‚çš„å±‚çº§ for level := 0; level \u0026lt; htw.levelCount; level++ { levelWheel := htw.levels[level] levelRange := levelWheel.tickMs * int64(levelWheel.slotCount) if delay \u0026lt; levelRange || level == htw.levelCount-1 { // è®¡ç®—æ§½ä½ slot := int((expireTime / levelWheel.tickMs) % int64(levelWheel.slotCount)) // åˆ›å»ºä»»åŠ¡åŒ…è£… taskWrapper := \u0026amp;taskWrapper{ task: task, expireTime: expireTime, } // æ·»åŠ åˆ°æ§½ä½ element := levelWheel.slots[slot].PushBack(taskWrapper) // è®°å½•ä½ç½® htw.taskMap[task.ID] = \u0026amp;HierarchicalTaskLocation{ level: level, slot: slot, element: element, task: task, } return } } } type taskWrapper struct { task *Task expireTime int64 } // æ—¶é—´æ¨è¿› func (htw *HierarchicalTimeWheel) advanceTime(targetTime int64) { htw.mu.Lock() defer htw.mu.Unlock() for htw.currentTime \u0026lt; targetTime { htw.currentTime += htw.tickMs htw.processLevel(0) } } func (htw *HierarchicalTimeWheel) processLevel(level int) { if level \u0026gt;= htw.levelCount { return } levelWheel := htw.levels[level] currentSlot := int((htw.currentTime / levelWheel.tickMs) % int64(levelWheel.slotCount)) // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¨è¿›è¯¥å±‚ if currentSlot == levelWheel.currentPos { return } // å¤„ç†å½“å‰æ§½ä½ bucket := levelWheel.slots[levelWheel.currentPos] for e := bucket.Front(); e != nil; { tw := e.Value.(*taskWrapper) next := e.Next() if tw.expireTime \u0026lt;= htw.currentTime { // æ‰§è¡Œä»»åŠ¡ go tw.task.Callback() delete(htw.taskMap, tw.task.ID) } else if level \u0026gt; 0 { // é™çº§åˆ°ä¸‹ä¸€å±‚ bucket.Remove(e) delete(htw.taskMap, tw.task.ID) htw.addTaskInternal(tw.task, tw.expireTime) } e = next } levelWheel.currentPos = currentSlot // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†ä¸Šå±‚ if currentSlot == 0 \u0026amp;\u0026amp; level \u0026lt; htw.levelCount-1 { htw.processLevel(level + 1) } } // å¯åŠ¨ func (htw *HierarchicalTimeWheel) Start() { htw.ticker = time.NewTicker(time.Duration(htw.tickMs) * time.Millisecond) go func() { for { select { case \u0026lt;-htw.ticker.C: htw.advanceTime(time.Now().UnixMilli() - htw.startMs) case \u0026lt;-htw.stopCh: htw.ticker.Stop() return } } }() } func (htw *HierarchicalTimeWheel) Stop() { close(htw.stopCh) } å››ã€Kafka æ—¶é—´è½® 4.1 Kafka çš„è®¾è®¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // Kafka é£æ ¼çš„æ—¶é—´è½®ï¼ˆä½¿ç”¨ DelayQueue ä¼˜åŒ–ï¼‰ type KafkaStyleTimeWheel struct { tickMs int64 wheelSize int interval int64 currentTime int64 buckets []*TimerTaskList overflowWheel *KafkaStyleTimeWheel // æº¢å‡ºè½® taskCounter int64 delayQueue *DelayQueue mu sync.Mutex } // ä»»åŠ¡åˆ—è¡¨ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰ type TimerTaskList struct { expiration int64 tasks *list.List mu sync.Mutex } // å»¶è¿Ÿé˜Ÿåˆ— type DelayQueue struct { pq *PriorityQueue mu sync.Mutex cond *sync.Cond wakeupC chan struct{} } // æ·»åŠ ä»»åŠ¡æ—¶çš„å¤„ç† func (tw *KafkaStyleTimeWheel) Add(task *TimerTask) bool { currentTime := tw.currentTime if task.expiration \u0026lt; currentTime+tw.tickMs { // å·²è¿‡æœŸï¼Œç«‹å³æ‰§è¡Œ return false } else if task.expiration \u0026lt; currentTime+tw.interval { // åœ¨å½“å‰è½®èŒƒå›´å†… virtualId := task.expiration / tw.tickMs bucket := tw.buckets[virtualId%int64(tw.wheelSize)] bucket.Add(task) // è®¾ç½®è¿‡æœŸæ—¶é—´å¹¶åŠ å…¥å»¶è¿Ÿé˜Ÿåˆ— if bucket.SetExpiration(virtualId * tw.tickMs) { tw.delayQueue.Offer(bucket) } return true } else { // æº¢å‡ºåˆ°ä¸Šå±‚æ—¶é—´è½® if tw.overflowWheel == nil { tw.createOverflowWheel() } return tw.overflowWheel.Add(task) } } äº”ã€åº”ç”¨åœºæ™¯ 5.1 ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // ä»»åŠ¡è°ƒåº¦å™¨ type Scheduler struct { timeWheel *TimeWheel tasks map[string]*ScheduledTask mu sync.RWMutex } type ScheduledTask struct { ID string Cron string // Cron è¡¨è¾¾å¼ Handler func() NextRun time.Time } func (s *Scheduler) ScheduleTask(task *ScheduledTask) { s.mu.Lock() s.tasks[task.ID] = task s.mu.Unlock() s.scheduleNext(task) } func (s *Scheduler) scheduleNext(task *ScheduledTask) { next := calculateNextRun(task.Cron, time.Now()) delay := next.Sub(time.Now()) s.timeWheel.AddTask(task.ID, delay, func() { task.Handler() s.scheduleNext(task) // è°ƒåº¦ä¸‹ä¸€æ¬¡æ‰§è¡Œ }) } 5.2 è¿æ¥è¶…æ—¶ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // è¿æ¥ç®¡ç†å™¨ type ConnectionManager struct { timeWheel *TimeWheel connections map[string]*Connection timeout time.Duration } func (cm *ConnectionManager) OnConnect(conn *Connection) { cm.connections[conn.ID] = conn // è®¾ç½®è¶…æ—¶æ£€æŸ¥ cm.timeWheel.AddTask(conn.ID, cm.timeout, func() { cm.checkTimeout(conn) }) } func (cm *ConnectionManager) OnHeartbeat(connID string) { // é‡ç½®è¶…æ—¶ cm.timeWheel.RemoveTask(connID) cm.timeWheel.AddTask(connID, cm.timeout, func() { cm.checkTimeout(cm.connections[connID]) }) } func (cm *ConnectionManager) checkTimeout(conn *Connection) { if time.Since(conn.LastActivity) \u0026gt; cm.timeout { conn.Close() delete(cm.connections, conn.ID) } } æ€»ç»“ æ—¶é—´è½®æ˜¯ä¸€ç§é«˜æ•ˆçš„å®šæ—¶ä»»åŠ¡è°ƒåº¦ç®—æ³•ï¼Œä»¥ O(1) çš„æ—¶é—´å¤æ‚åº¦å®Œæˆä»»åŠ¡çš„æ·»åŠ å’Œè§¦å‘ã€‚\nå…³é”®è¦ç‚¹ï¼š\nåŸºæœ¬åŸç†ï¼šå¾ªç¯æ•°ç»„ + ä»»åŠ¡é“¾è¡¨ æ—¶é—´å¤æ‚åº¦ï¼šæ·»åŠ  O(1)ï¼Œè§¦å‘ O(1) å±‚çº§æ—¶é—´è½®ï¼šè§£å†³é•¿å»¶è¿Ÿä»»åŠ¡é—®é¢˜ åº”ç”¨åœºæ™¯ï¼šä»»åŠ¡è°ƒåº¦ã€è¶…æ—¶ç®¡ç†ã€å»¶è¿Ÿæ¶ˆæ¯ ç»§ç»­å­¦ä¹ ï¼š\nè®ºæ–‡ï¼šã€ŠHashed and Hierarchical Timing Wheelsã€‹ Netty HashedWheelTimer æºç  Kafka TimingWheel æºç  Incoming (Background Agent changes)\n","date":"2025-12-06T00:00:00Z","permalink":"https://zpf-zero.github.io/p/timewheel-algorithm/","title":"æ—¶é—´è½®ç®—æ³•è¯¦è§£ï¼šé«˜æ•ˆå®šæ—¶ä»»åŠ¡è°ƒåº¦"},{"content":"æ·±åº¦ç¡¬æ ¸ï¼šMySQL ç´¢å¼•å…¨å®¶æ¡¶ï¼Œä»åº•å±‚ B+ æ ‘åˆ°åƒä¸‡çº§è°ƒä¼˜ åœ¨åç«¯å¼€å‘ä¸­ï¼ŒMySQL ç´¢å¼•æ˜¯é¢è¯•çš„â€œé‡ç¾åŒºâ€ï¼Œä¹Ÿæ˜¯æ€§èƒ½è°ƒä¼˜çš„â€œæ€æ‰‹é”â€ã€‚å¾ˆå¤šäººçŸ¥é“ç´¢å¼•èƒ½è®©æŸ¥è¯¢å˜å¿«ï¼Œä½†ä¸çŸ¥é“å®ƒä¸ºä»€ä¹ˆå¿«ï¼Œæ›´ä¸çŸ¥é“å¦‚ä½•é¿å‘ã€‚æœ¬æ–‡å°†å¸¦ä½ æ·±åº¦å¤ç›˜ MySQL ç´¢å¼•çš„æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œä»åº•å±‚æ•°æ®ç»“æ„åˆ°åƒä¸‡çº§åœºæ™¯è°ƒä¼˜ã€‚\nä¸€ã€ ä¸ºä»€ä¹ˆé€‰ B+ æ ‘ï¼Ÿ MySQL çš„é»˜è®¤å­˜å‚¨å¼•æ“ InnoDB é€‰æ‹© B+ æ ‘ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¹¶éå¶ç„¶ï¼Œè€Œæ˜¯å¯¹ç£ç›˜ IO ç‰¹æ€§æƒè¡¡åçš„æœ€ä¼˜è§£ã€‚\n1. B+ æ ‘ vs B æ ‘ ç‰¹æ€§ B æ ‘ B+ æ ‘ èŠ‚ç‚¹å­˜å‚¨å†…å®¹ éå¶å­èŠ‚ç‚¹ã€å¶å­èŠ‚ç‚¹å‡å­˜å‚¨æ•´è¡Œæ•°æ® éå¶å­èŠ‚ç‚¹ä»…å­˜ç´¢å¼•é”®ï¼ˆKeyï¼‰ï¼Œå¶å­èŠ‚ç‚¹å­˜å®Œæ•´æ•°æ® ç©ºé—´åˆ©ç”¨ç‡ ä½ï¼Œç›¸åŒé¡µé¢èƒ½å­˜å‚¨çš„ç´¢å¼•æŒ‡é’ˆå°‘ é«˜ï¼Œé¡µé¢å®¹çº³æ›´å¤šæŒ‡é’ˆï¼Œæ ‘çš„â€œå‡ºåº¦â€æ›´å¤§ èŒƒå›´æŸ¥è¯¢æ•ˆç‡ éœ€ä¸­åºéå†ï¼Œæ•ˆç‡ä½ å¶å­èŠ‚ç‚¹ç»„æˆåŒå‘æœ‰åºé“¾è¡¨ï¼ŒèŒƒå›´æŸ¥è¯¢ç›´æ¥â€œå¹³æ¨â€ æ ¸å¿ƒå·®å¼‚ï¼šB+ æ ‘æŠŠæ•°æ®éƒ½æ”¾åˆ°å¶å­èŠ‚ç‚¹ï¼Œéå¶å­èŠ‚ç‚¹åªåšç´¢å¼•æŒ‡å¼•ï¼Œè¿™è®©æ ‘çš„é«˜åº¦å¤§å¹…é™ä½ã€‚\n2. ç£ç›˜ IO çš„è®¡ç®— ç£ç›˜ IO æ˜¯æ•°æ®åº“æŸ¥è¯¢çš„æ ¸å¿ƒæ€§èƒ½ç“¶é¢ˆï¼Œè€Œ B+ æ ‘çš„é«˜åº¦ç›´æ¥å†³å®š IO æ¬¡æ•°ã€‚\nå‡è®¾ä¸€ä¸ªé«˜åº¦ä¸º 3 çš„ B+ æ ‘ï¼š\næ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜ï¼Œæ— éœ€ IOï¼› ç¬¬ä¸€æ¬¡ IOï¼šè¯»å–äºŒçº§ç´¢å¼•èŠ‚ç‚¹ï¼Œå®šä½ç›®æ ‡å¶å­èŠ‚ç‚¹çš„ä½ç½®ï¼› ç¬¬äºŒæ¬¡ IOï¼šè¯»å–å¶å­èŠ‚ç‚¹ï¼Œè·å–å®Œæ•´æ•°æ®ã€‚ ç»“è®ºï¼šåƒä¸‡çº§æ•°æ®é‡ä¸‹ï¼ŒB+ æ ‘é€šå¸¸åªéœ€è¦ 2-3 æ¬¡ç£ç›˜ IO å³å¯è·å–æ•°æ®ï¼Œè€Œå…¨è¡¨æ‰«æå¯èƒ½éœ€è¦ç™¾ä¸‡æ¬¡ IOï¼Œæ€§èƒ½å·®è·è¾¾æ•°ä¸ªæ•°é‡çº§ã€‚\näºŒã€ ç´¢å¼•çš„åˆ†ç±»ä½“ç³» ä»ä¸åŒç»´åº¦æ‹†è§£ç´¢å¼•ï¼Œèƒ½æ›´æ¸…æ™°åœ°ç†è§£å…¶è®¾è®¡é€»è¾‘å’Œä½¿ç”¨åœºæ™¯ã€‚\n1. ç‰©ç†å­˜å‚¨ç»´åº¦ è¿™æ˜¯ç´¢å¼•çš„åº•å±‚åˆ†ç±»ï¼Œç›´æ¥å†³å®šæ•°æ®çš„å­˜å‚¨å’ŒæŸ¥è¯¢æ–¹å¼ã€‚\nèšç°‡ç´¢å¼•ï¼ˆClustered Indexï¼‰ æœ¬è´¨ï¼šæ•°æ®å³ç´¢å¼•ï¼Œç´¢å¼•å³æ•°æ®ã€‚è¡Œæ•°æ®ç›´æ¥å­˜å‚¨åœ¨ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šã€‚ ç‰¹æ€§ï¼šæ¯å¼  InnoDB è¡¨å¿…é¡»ä¸”åªèƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚ é€‰æ‹©è§„åˆ™ï¼š ä¼˜å…ˆä½¿ç”¨ä¸»é”®ä½œä¸ºèšç°‡ç´¢å¼•ï¼› æ— ä¸»é”®æ—¶ï¼Œé€‰æ‹©å”¯ä¸€éç©ºç´¢å¼•ï¼› æ— ä¸Šè¿°ç´¢å¼•æ—¶ï¼ŒInnoDB è‡ªåŠ¨ç”Ÿæˆéšè—çš„ row_id ä½œä¸ºèšç°‡ç´¢å¼•ã€‚ äºŒçº§ç´¢å¼•ï¼ˆSecondary Index / éèšç°‡ç´¢å¼•ï¼‰ æœ¬è´¨ï¼šå¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æ•´è¡Œæ•°æ®ï¼Œåªå­˜å‚¨èšç°‡ç´¢å¼•çš„é”®å€¼ï¼ˆé€šå¸¸æ˜¯ä¸»é”®å€¼ï¼‰ã€‚ å›è¡¨ï¼ˆLook-upï¼‰ï¼šé€šè¿‡äºŒçº§ç´¢å¼•æŸ¥åˆ°ä¸»é”®åï¼Œéœ€è¦å†å»èšç°‡ç´¢å¼•ä¸­æŸ¥è¯¢å®Œæ•´æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯å›è¡¨ã€‚ æ€§èƒ½å½±å“ï¼šå›è¡¨ä¼šå¢åŠ ä¸€æ¬¡ç£ç›˜ IOï¼Œæ˜¯äºŒçº§ç´¢å¼•æŸ¥è¯¢çš„æ€§èƒ½æŸè€—ç‚¹ã€‚ 2. å­—æ®µç‰¹æ€§ç»´åº¦ ä»ç´¢å¼•å­—æ®µçš„æ•°é‡å’Œçº¦æŸæ¡ä»¶åˆ’åˆ†ï¼Œå¯¹åº”ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚\nç´¢å¼•ç±»å‹ æ ¸å¿ƒç‰¹æ€§ é€‚ç”¨åœºæ™¯ ä¸»é”®ç´¢å¼• å”¯ä¸€ã€éç©ºï¼Œé»˜è®¤ä½œä¸ºèšç°‡ç´¢å¼• è¡¨çš„å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ç”¨æˆ· IDã€è®¢å• ID å”¯ä¸€ç´¢å¼• å€¼ä¸èƒ½é‡å¤ï¼Œå…è®¸ NULLï¼ˆå¤šä¸ª NULL ä¸å†²çªï¼‰ å”¯ä¸€æ ‡è¯†å­—æ®µï¼Œå¦‚æ‰‹æœºå·ã€èº«ä»½è¯å· è”åˆç´¢å¼• å¤šä¸ªå­—æ®µç»„åˆè€Œæˆçš„ç´¢å¼• å¤šå­—æ®µç»„åˆæŸ¥è¯¢ï¼Œå¦‚ name + ageã€user_id + create_time æ™®é€šç´¢å¼• æ— å”¯ä¸€æ€§çº¦æŸï¼Œæœ€åŸºç¡€çš„ç´¢å¼•ç±»å‹ æ™®é€šæŸ¥è¯¢å­—æ®µï¼Œå¦‚æ–‡ç« æ ‡é¢˜ã€å•†å“åˆ†ç±» ä¸‰ã€ çµé­‚æ³•åˆ™ï¼šæœ€å·¦åŒ¹é…åŸåˆ™ è”åˆç´¢å¼•çš„æ ¸å¿ƒä½¿ç”¨é€»è¾‘ï¼Œä¹Ÿæ˜¯ç´¢å¼•è°ƒä¼˜çš„â€œç¬¬ä¸€é“é—¨æ§›â€ã€‚\nå‡è®¾æˆ‘ä»¬åˆ›å»ºäº†è”åˆç´¢å¼• INDEX(a, b, c)ï¼Œå¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€æœ¬æŒ‰â€œå§“â†’åâ†’å¹´é¾„â€æ’åºçš„ç”µè¯ç°¿ï¼šæŸ¥äººæ—¶å¿…é¡»å…ˆæŒ‰å§“æ°æ‰¾ï¼Œå§“æ°ç¡®å®šåå†æ‰¾åå­—ï¼Œæœ€åæ‰¾å¹´é¾„ã€‚è·³è¿‡å‰é¢çš„å­—æ®µï¼Œç›´æ¥æŸ¥åé¢çš„å­—æ®µï¼Œç´¢å¼•å°±ä¼šå¤±æ•ˆã€‚\n1. åŒ¹é…è§„åˆ™å®æˆ˜ æŸ¥è¯¢æ¡ä»¶ ç´¢å¼•åŒ¹é…æƒ…å†µ åŸç†åˆ†æ WHERE a=1 AND b=2 AND c=3 å…¨åŒ¹é…ï¼ˆa,b,c å‡ç”Ÿæ•ˆï¼‰ å®Œå…¨ç¬¦åˆç´¢å¼•çš„å­—æ®µé¡ºåº WHERE a=1 AND b=2 éƒ¨åˆ†åŒ¹é…ï¼ˆa,b ç”Ÿæ•ˆï¼‰ åŒ¹é…æœ€å·¦å‰ç¼€ï¼Œc æœªä½¿ç”¨ä½†ä¸å½±å“å‰é¢å­—æ®µ WHERE a=1 AND c=3 éƒ¨åˆ†åŒ¹é…ï¼ˆä»… a ç”Ÿæ•ˆï¼‰ b å­—æ®µæ–­å±‚ï¼Œc æ— æ³•ä½¿ç”¨ç´¢å¼• WHERE a=1 AND b\u0026gt;2 AND c=3 éƒ¨åˆ†åŒ¹é…ï¼ˆa,b ç”Ÿæ•ˆï¼Œc å¤±æ•ˆï¼‰ èŒƒå›´é˜»æ–­ï¼šb æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œåé¢çš„å­—æ®µç´¢å¼•å¤±æ•ˆ WHERE b=2 AND c=3 å®Œå…¨å¤±æ•ˆ ç¼ºå°‘æœ€å·¦å‰ç¼€ aï¼Œæ— æ³•è§¦å‘ç´¢å¼• 2. å…³é”®è¡¥å…… ä¼˜åŒ–å™¨è‡ªåŠ¨æ’åºï¼šWHERE b=2 AND a=1 ä¼šè¢«ä¼˜åŒ–å™¨è°ƒæ•´ä¸º a=1 AND b=2ï¼Œä¸å½±å“ç´¢å¼•ç”Ÿæ•ˆã€‚ è¦†ç›–ç´¢å¼•ä¾‹å¤–ï¼šå¦‚æœæŸ¥è¯¢å­—æ®µä»…åŒ…å«ç´¢å¼•å­—æ®µï¼ˆå¦‚ SELECT a,c FROM t WHERE b=2ï¼‰ï¼Œä¸”ç´¢å¼•ä¸º (a,b,c)ï¼Œå¯èƒ½è§¦å‘è¦†ç›–ç´¢å¼•ï¼Œæ— éœ€éµå¾ªæœ€å·¦åŒ¹é…ã€‚ å››ã€ ç´¢å¼•å¤±æ•ˆçš„â€œé¿å‘æŒ‡å—â€ å¾ˆå¤šæ—¶å€™ç´¢å¼•â€œå½¢åŒè™šè®¾â€ï¼Œéƒ½æ˜¯å› ä¸ºè¸©äº†è¿™äº›å¸¸è§é™·é˜±ï¼š\nå¯¹ç´¢å¼•åˆ—åšè¿ç®—æˆ–å‡½æ•°æ“ä½œ\n1 2 3 4 -- é”™è¯¯ï¼šage å­—æ®µåšäº†åŠ æ³•è¿ç®—ï¼Œç´¢å¼•å¤±æ•ˆ WHERE age + 1 = 10 -- é”™è¯¯ï¼šä½¿ç”¨ SUBSTRING å‡½æ•°ï¼Œç´¢å¼•å¤±æ•ˆ WHERE SUBSTRING(name, 1, 3) = \u0026#39;Tom\u0026#39; ä¼˜åŒ–æ–¹æ¡ˆï¼šè¿ç®—é€»è¾‘æ”¾åˆ°ç­‰å·å³è¾¹ï¼Œæˆ–é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šç”¨å‡½æ•°ã€‚\néšå¼ç±»å‹è½¬æ¢\n1 2 -- é”™è¯¯ï¼šmobile æ˜¯ varchar ç±»å‹ï¼Œä¼ å…¥æ•°å€¼ä¼šè§¦å‘éšå¼è½¬æ¢ WHERE mobile = 13800138000 ä¼˜åŒ–æ–¹æ¡ˆï¼šå­—ç¬¦ä¸²å­—æ®µæŸ¥è¯¢å¿…é¡»åŠ å¼•å·ï¼Œå†™æˆ WHERE mobile = '13800138000'ã€‚\nå·¦æ¨¡ç³ŠæŸ¥è¯¢\n1 2 3 4 -- é”™è¯¯ï¼š% æ”¾åœ¨å·¦è¾¹ï¼Œç´¢å¼•å¤±æ•ˆ WHERE name LIKE \u0026#39;%Tom\u0026#39; -- æ­£ç¡®ï¼š% æ”¾åœ¨å³è¾¹ï¼Œç´¢å¼•ç”Ÿæ•ˆ WHERE name LIKE \u0026#39;Tom%\u0026#39; OR æ¡ä»¶çš„â€œå‘â€ OR ä¸¤è¾¹çš„å­—æ®µå¿…é¡»éƒ½æœ‰ç´¢å¼•ï¼Œå¦åˆ™æ•´ä¸ªæŸ¥è¯¢ä¼šèµ°å…¨è¡¨æ‰«æã€‚\n1 2 -- å‡è®¾åªæœ‰ a æœ‰ç´¢å¼•ï¼Œb æ— ç´¢å¼•ï¼Œç´¢å¼•å¤±æ•ˆ WHERE a=1 OR b=2 ä¸ç­‰äºå’Œ IS NOT NULL\n!=/\u0026lt;\u0026gt; å¯¹æ•°å€¼ç±»å‹å­—æ®µæŸ¥è¯¢æ—¶ï¼Œå¤§æ¦‚ç‡å¤±æ•ˆï¼› IS NOT NULL æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œè€Œ IS NULL å¯ä»¥ã€‚ äº”ã€ é«˜é˜¶ä¼˜åŒ–ï¼šå®ç°åƒä¸‡çº§æ•°æ®â€œä¸æ»‘â€æŸ¥è¯¢ 1. è¦†ç›–ç´¢å¼•ï¼šå‘Šåˆ«å›è¡¨çš„â€œç»ˆæä¼˜åŒ–â€ å®šä¹‰ï¼šå¦‚æœæŸ¥è¯¢çš„å­—æ®µå…¨éƒ¨åŒ…å«åœ¨ç´¢å¼•ä¸­ï¼ŒMySQL æ— éœ€å›è¡¨ï¼Œç›´æ¥ä»ç´¢å¼•ä¸­è¿”å›æ•°æ®ï¼Œè¿™å°±æ˜¯è¦†ç›–ç´¢å¼•ã€‚ åˆ¤æ–­æ ‡å¿—ï¼šEXPLAIN ç»“æœçš„ Extra åˆ—æ˜¾ç¤º Using indexã€‚\næ¡ˆä¾‹\n1 2 3 4 5 6 7 -- éœ€æ±‚ï¼šæŸ¥è¯¢ç”¨æˆ·å§“åå’Œå¹´é¾„ï¼Œæ¡ä»¶æ˜¯å§“å=å¼ ä¸‰ -- åŸå§‹è¡¨ç»“æ„ï¼šid(ä¸»é”®), name, age, address -- æ–¹æ¡ˆ1ï¼šæ— è¦†ç›–ç´¢å¼•ï¼Œéœ€è¦å›è¡¨ SELECT name, age FROM user WHERE name=\u0026#39;å¼ ä¸‰\u0026#39;; -- æ–¹æ¡ˆ2ï¼šåˆ›å»ºè”åˆç´¢å¼• INDEX(name, age)ï¼Œè§¦å‘è¦†ç›–ç´¢å¼• SELECT name, age FROM user WHERE name=\u0026#39;å¼ ä¸‰\u0026#39;; æ€§èƒ½æå‡ï¼šå‡å°‘ä¸€æ¬¡å›è¡¨ IOï¼ŒæŸ¥è¯¢æ•ˆç‡æå‡ 10 å€ä»¥ä¸Šã€‚\n2. ç´¢å¼•ä¸‹æ¨ï¼šå‡å°‘å›è¡¨æ¬¡æ•°çš„â€œåˆ©å™¨â€ MySQL 5.6 åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒç´¢å¼•ä¸‹æ¨ï¼ˆICPï¼‰ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯ï¼šåœ¨éå†äºŒçº§ç´¢å¼•æ—¶ï¼Œæå‰è¿‡æ»¤ä¸ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°ã€‚\næ¡ˆä¾‹ ç´¢å¼•ä¸º INDEX(name, age)ï¼ŒæŸ¥è¯¢ WHERE name='å¼ ä¸‰' AND age \u0026gt; 20ï¼š\næ— ç´¢å¼•ä¸‹æ¨ï¼šå…ˆé€šè¿‡ name æ‰¾åˆ°æ‰€æœ‰â€œå¼ ä¸‰â€çš„ä¸»é”®ï¼Œå›è¡¨åå†è¿‡æ»¤ age \u0026gt; 20ï¼› æœ‰ç´¢å¼•ä¸‹æ¨ï¼šéå†ç´¢å¼•æ—¶ï¼Œç›´æ¥è¿‡æ»¤ age \u0026gt; 20 çš„è®°å½•ï¼Œå†å›è¡¨æŸ¥è¯¢ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°ã€‚ 3. ç”¨ EXPLAIN åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ EXPLAIN æ˜¯åˆ†æç´¢å¼•çš„â€œç¥å…µåˆ©å™¨â€ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹ 4 åˆ—ï¼š\nåˆ—å æ ¸å¿ƒä½œç”¨ ä¼˜åŒ–ç›®æ ‡ type ç´¢å¼•åŒ¹é…ç±»å‹ è‡³å°‘è¾¾åˆ° range çº§åˆ«ï¼Œæœ€ä¼˜æ˜¯ const/eq_ref key å®é™…ä½¿ç”¨çš„ç´¢å¼• ä¸é¢„æœŸç´¢å¼•ä¸€è‡´ï¼Œå¦åˆ™è¯´æ˜ç´¢å¼•å¤±æ•ˆ rows é¢„ä¼°æ‰«æè¡Œæ•° æ•°å€¼è¶Šå°è¶Šå¥½ï¼Œæ¥è¿‘å®é™…ç»“æœæœ€ä½³ Extra é¢å¤–ä¿¡æ¯ å‡ºç° Using index æ˜¯æœ€ä¼˜ï¼›å‡ºç° Using filesort/Using temporary éœ€ä¼˜åŒ– type ä¼˜å…ˆçº§æ’åºï¼š system \u0026gt; const \u0026gt; eq_ref \u0026gt; ref \u0026gt; range \u0026gt; index \u0026gt; ALL\nå…­ã€ æ€»ç»“ä¸å»ºè®® 1. ç´¢å¼•å£è¯€ï¼ˆå¿…èƒŒï¼‰ 1 2 3 4 å¸¦å¤´å¤§å“¥ä¸èƒ½æ­»ï¼Œä¸­é—´å…„å¼Ÿä¸èƒ½æ–­ï¼› ç´¢å¼•åˆ—ä¸Šä¸è®¡ç®—ï¼Œlike ç™¾åˆ†åŠ å³è¾¹ï¼› èŒƒå›´åé¢å…¨å¤±æ•ˆï¼Œå­—ç¬¦ä¸²æŸ¥è¯¢å¸¦å¼•å·ï¼› OR ä¸¤è¾¹éƒ½æœ‰ç´¢å¼•ï¼Œè¦†ç›–ç´¢å¼•æ˜¾ç¥å¨ã€‚ 2. ä¸€èˆ¬æ€§å»ºè®® ç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼šæ–°å¢ç´¢å¼•ä¼šé™ä½æ’å…¥ã€æ›´æ–°ã€åˆ é™¤çš„æ€§èƒ½ï¼Œéœ€åœ¨æŸ¥è¯¢æ•ˆç‡å’Œå†™å…¥æ•ˆç‡ä¹‹é—´å¹³è¡¡ã€‚ è”åˆç´¢å¼•å­—æ®µé¡ºåºï¼šè¿‡æ»¤æ€§è¶Šå¼ºçš„å­—æ®µè¶Šé å‰ï¼ˆå¦‚æ€§åˆ«å­—æ®µè¿‡æ»¤æ€§å¼±ï¼Œåº”æ”¾åœ¨åé¢ï¼‰ã€‚ ä¼˜å…ˆä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼šå‡å°‘å›è¡¨æ“ä½œï¼Œæ˜¯æå‡æŸ¥è¯¢æ€§èƒ½çš„æœ€ä¼˜è§£ä¹‹ä¸€ã€‚ 3. SQL ä¼˜åŒ–æ­¥éª¤ ç›‘æ§æ…¢æŸ¥è¯¢ï¼šå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ŒæŠ“å–è¶…è¿‡é˜ˆå€¼çš„ SQLï¼ˆå¦‚æ‰§è¡Œæ—¶é—´ \u0026gt; 1sï¼‰ï¼› EXPLAIN åˆ†æï¼šé€šè¿‡ EXPLAIN åˆ¤æ–­ç´¢å¼•æ˜¯å¦ç”Ÿæ•ˆã€æ˜¯å¦æœ‰æ–‡ä»¶æ’åºï¼› Profile æ·±å…¥æ’æŸ¥ï¼šç”¨ SHOW PROFILE æŸ¥çœ‹ SQL æ‰§è¡Œçš„è¯¦ç»†ç”Ÿå‘½å‘¨æœŸï¼› å‚æ•°è°ƒä¼˜ï¼šç»“åˆä¸šåŠ¡åœºæ™¯è°ƒæ•´ MySQL é…ç½®ï¼ˆå¦‚ innodb_buffer_pool_sizeï¼‰ã€‚ ","date":"2025-11-25T00:00:00Z","permalink":"https://zpf-zero.github.io/p/mysql-guideindex/","title":"MySQL ç´¢å¼•"},{"content":"å‰è¨€ Grafana æ˜¯å¼€æºçš„æ•°æ®å¯è§†åŒ–å’Œç›‘æ§å¹³å°ï¼Œæ”¯æŒå¤šç§æ•°æ®æºï¼Œæä¾›ä¸°å¯Œçš„å›¾è¡¨ç±»å‹å’Œçµæ´»çš„ä»ªè¡¨ç›˜é…ç½®ã€‚å®ƒæ˜¯æ„å»ºç›‘æ§ç³»ç»Ÿçš„æ ‡å‡†å·¥å…·ä¹‹ä¸€ã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£…éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # docker-compose.yml version: \u0026#39;3.8\u0026#39; services: grafana: image: grafana/grafana:latest ports: - \u0026#34;3000:3000\u0026#34; volumes: - grafana_data:/var/lib/grafana - ./provisioning:/etc/grafana/provisioning environment: - GF_SECURITY_ADMIN_PASSWORD=admin - GF_USERS_ALLOW_SIGN_UP=false volumes: grafana_data: 1.2 æ•°æ®æºé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # provisioning/datasources/datasources.yml apiVersion: 1 datasources: - name: Prometheus type: prometheus access: proxy url: http://prometheus:9090 isDefault: true - name: MySQL type: mysql url: mysql:3306 database: mydb user: grafana secureJsonData: password: ${MYSQL_PASSWORD} - name: ClickHouse type: grafana-clickhouse-datasource url: http://clickhouse:8123 jsonData: defaultDatabase: default äºŒã€ä»ªè¡¨ç›˜é…ç½® 2.1 Panel ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 { \u0026#34;panels\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;timeseries\u0026#34;, \u0026#34;title\u0026#34;: \u0026#34;è¯·æ±‚é€Ÿç‡\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;rate(http_requests_total[5m])\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;{{method}} {{path}}\u0026#34; } ], \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;unit\u0026#34;: \u0026#34;reqps\u0026#34; } } }, { \u0026#34;type\u0026#34;: \u0026#34;stat\u0026#34;, \u0026#34;title\u0026#34;: \u0026#34;æ€»è¯·æ±‚æ•°\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;sum(http_requests_total)\u0026#34; } ], \u0026#34;options\u0026#34;: { \u0026#34;colorMode\u0026#34;: \u0026#34;value\u0026#34;, \u0026#34;graphMode\u0026#34;: \u0026#34;area\u0026#34; } }, { \u0026#34;type\u0026#34;: \u0026#34;gauge\u0026#34;, \u0026#34;title\u0026#34;: \u0026#34;CPU ä½¿ç”¨ç‡\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;100 - avg(rate(node_cpu_seconds_total{mode=\\\u0026#34;idle\\\u0026#34;}[5m])) * 100\u0026#34; } ], \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;unit\u0026#34;: \u0026#34;percent\u0026#34;, \u0026#34;max\u0026#34;: 100, \u0026#34;thresholds\u0026#34;: { \u0026#34;steps\u0026#34;: [ { \u0026#34;color\u0026#34;: \u0026#34;green\u0026#34;, \u0026#34;value\u0026#34;: null }, { \u0026#34;color\u0026#34;: \u0026#34;yellow\u0026#34;, \u0026#34;value\u0026#34;: 70 }, { \u0026#34;color\u0026#34;: \u0026#34;red\u0026#34;, \u0026#34;value\u0026#34;: 90 } ] } } } }, { \u0026#34;type\u0026#34;: \u0026#34;table\u0026#34;, \u0026#34;title\u0026#34;: \u0026#34;Top è¯·æ±‚è·¯å¾„\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;topk(10, sum by (path) (rate(http_requests_total[5m])))\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;table\u0026#34; } ] }, { \u0026#34;type\u0026#34;: \u0026#34;piechart\u0026#34;, \u0026#34;title\u0026#34;: \u0026#34;è¯·æ±‚åˆ†å¸ƒ\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;sum by (method) (http_requests_total)\u0026#34; } ] } ] } 2.2 å˜é‡æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 { \u0026#34;templating\u0026#34;: { \u0026#34;list\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;instance\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;query\u0026#34;, \u0026#34;datasource\u0026#34;: \u0026#34;Prometheus\u0026#34;, \u0026#34;query\u0026#34;: \u0026#34;label_values(up, instance)\u0026#34;, \u0026#34;refresh\u0026#34;: 1, \u0026#34;multi\u0026#34;: true, \u0026#34;includeAll\u0026#34;: true }, { \u0026#34;name\u0026#34;: \u0026#34;interval\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;interval\u0026#34;, \u0026#34;options\u0026#34;: [ { \u0026#34;text\u0026#34;: \u0026#34;1m\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;1m\u0026#34; }, { \u0026#34;text\u0026#34;: \u0026#34;5m\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;5m\u0026#34; }, { \u0026#34;text\u0026#34;: \u0026#34;15m\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;15m\u0026#34; } ], \u0026#34;current\u0026#34;: { \u0026#34;text\u0026#34;: \u0026#34;5m\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;5m\u0026#34; } } ] } } ä¸‰ã€å¸¸ç”¨ä»ªè¡¨ç›˜ 3.1 åº”ç”¨ç›‘æ§é¢æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 { \u0026#34;title\u0026#34;: \u0026#34;Application Dashboard\u0026#34;, \u0026#34;panels\u0026#34;: [ { \u0026#34;title\u0026#34;: \u0026#34;QPS\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;timeseries\u0026#34;, \u0026#34;gridPos\u0026#34;: { \u0026#34;x\u0026#34;: 0, \u0026#34;y\u0026#34;: 0, \u0026#34;w\u0026#34;: 12, \u0026#34;h\u0026#34;: 8 }, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;sum(rate(http_requests_total{instance=~\\\u0026#34;$instance\\\u0026#34;}[$interval]))\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;QPS\u0026#34; } ] }, { \u0026#34;title\u0026#34;: \u0026#34;é”™è¯¯ç‡\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;timeseries\u0026#34;, \u0026#34;gridPos\u0026#34;: { \u0026#34;x\u0026#34;: 12, \u0026#34;y\u0026#34;: 0, \u0026#34;w\u0026#34;: 12, \u0026#34;h\u0026#34;: 8 }, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;sum(rate(http_requests_total{status=~\\\u0026#34;5..\\\u0026#34;}[$interval])) / sum(rate(http_requests_total[$interval])) * 100\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;Error Rate %\u0026#34; } ], \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;unit\u0026#34;: \u0026#34;percent\u0026#34;, \u0026#34;thresholds\u0026#34;: { \u0026#34;steps\u0026#34;: [ { \u0026#34;color\u0026#34;: \u0026#34;green\u0026#34;, \u0026#34;value\u0026#34;: null }, { \u0026#34;color\u0026#34;: \u0026#34;yellow\u0026#34;, \u0026#34;value\u0026#34;: 1 }, { \u0026#34;color\u0026#34;: \u0026#34;red\u0026#34;, \u0026#34;value\u0026#34;: 5 } ] } } } }, { \u0026#34;title\u0026#34;: \u0026#34;P99 å»¶è¿Ÿ\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;timeseries\u0026#34;, \u0026#34;gridPos\u0026#34;: { \u0026#34;x\u0026#34;: 0, \u0026#34;y\u0026#34;: 8, \u0026#34;w\u0026#34;: 12, \u0026#34;h\u0026#34;: 8 }, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket[$interval])))\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;P99\u0026#34; } ], \u0026#34;fieldConfig\u0026#34;: { \u0026#34;defaults\u0026#34;: { \u0026#34;unit\u0026#34;: \u0026#34;s\u0026#34; } } } ] } 3.2 ç³»ç»Ÿç›‘æ§é¢æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 { \u0026#34;title\u0026#34;: \u0026#34;Node Metrics\u0026#34;, \u0026#34;panels\u0026#34;: [ { \u0026#34;title\u0026#34;: \u0026#34;CPU ä½¿ç”¨ç‡\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\\\u0026#34;idle\\\u0026#34;}[5m])) * 100)\u0026#34; } ] }, { \u0026#34;title\u0026#34;: \u0026#34;å†…å­˜ä½¿ç”¨ç‡\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100\u0026#34; } ] }, { \u0026#34;title\u0026#34;: \u0026#34;ç£ç›˜ä½¿ç”¨ç‡\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;(1 - node_filesystem_avail_bytes{mountpoint=\\\u0026#34;/\\\u0026#34;} / node_filesystem_size_bytes{mountpoint=\\\u0026#34;/\\\u0026#34;}) * 100\u0026#34; } ] }, { \u0026#34;title\u0026#34;: \u0026#34;ç½‘ç»œæµé‡\u0026#34;, \u0026#34;targets\u0026#34;: [ { \u0026#34;expr\u0026#34;: \u0026#34;rate(node_network_receive_bytes_total[5m])\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;æ¥æ”¶\u0026#34; }, { \u0026#34;expr\u0026#34;: \u0026#34;rate(node_network_transmit_bytes_total[5m])\u0026#34;, \u0026#34;legendFormat\u0026#34;: \u0026#34;å‘é€\u0026#34; } ] } ] } å››ã€å‘Šè­¦é…ç½® 4.1 å‘Šè­¦è§„åˆ™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 # provisioning/alerting/rules.yml apiVersion: 1 groups: - orgId: 1 name: Application Alerts folder: alerts interval: 1m rules: - uid: high-error-rate title: High Error Rate condition: C data: - refId: A relativeTimeRange: from: 300 to: 0 datasourceUid: prometheus model: expr: sum(rate(http_requests_total{status=~\u0026#34;5..\u0026#34;}[5m])) / sum(rate(http_requests_total[5m])) * 100 - refId: C datasourceUid: __expr__ model: type: threshold expression: A conditions: - evaluator: type: gt params: [1] for: 5m annotations: summary: \u0026#34;é”™è¯¯ç‡è¿‡é«˜\u0026#34; description: \u0026#34;å½“å‰é”™è¯¯ç‡: {{ $values.A }}%\u0026#34; labels: severity: critical 4.2 é€šçŸ¥æ¸ é“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # provisioning/alerting/contactpoints.yml apiVersion: 1 contactPoints: - orgId: 1 name: Slack receivers: - uid: slack-channel type: slack settings: url: https://hooks.slack.com/services/xxx recipient: \u0026#34;#alerts\u0026#34; - orgId: 1 name: Email receivers: - uid: email-team type: email settings: addresses: team@example.com äº”ã€é«˜çº§åŠŸèƒ½ 5.1 Annotations 1 2 3 4 5 6 7 8 9 10 11 12 13 14 { \u0026#34;annotations\u0026#34;: { \u0026#34;list\u0026#34;: [ { \u0026#34;datasource\u0026#34;: \u0026#34;Prometheus\u0026#34;, \u0026#34;enable\u0026#34;: true, \u0026#34;expr\u0026#34;: \u0026#34;changes(deployment_version[1m]) \u0026gt; 0\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Deployments\u0026#34;, \u0026#34;iconColor\u0026#34;: \u0026#34;blue\u0026#34;, \u0026#34;titleFormat\u0026#34;: \u0026#34;Deployment\u0026#34; } ] } } 5.2 Dashboard Links 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 { \u0026#34;links\u0026#34;: [ { \u0026#34;title\u0026#34;: \u0026#34;ç›¸å…³é¢æ¿\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;dashboards\u0026#34;, \u0026#34;tags\u0026#34;: [\u0026#34;app\u0026#34;] }, { \u0026#34;title\u0026#34;: \u0026#34;æŸ¥çœ‹æ—¥å¿—\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;link\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;/d/logs?var-instance=${instance}\u0026#34;, \u0026#34;targetBlank\u0026#34;: true } ] } å…­ã€API ä½¿ç”¨ 6.1 ä»ªè¡¨ç›˜ API 1 2 3 4 5 6 7 8 9 10 11 12 13 # è·å–æ‰€æœ‰ä»ªè¡¨ç›˜ curl -H \u0026#34;Authorization: Bearer $API_KEY\u0026#34; \\ http://grafana:3000/api/search # è·å–ä»ªè¡¨ç›˜è¯¦æƒ… curl -H \u0026#34;Authorization: Bearer $API_KEY\u0026#34; \\ http://grafana:3000/api/dashboards/uid/xxx # åˆ›å»º/æ›´æ–°ä»ªè¡¨ç›˜ curl -X POST -H \u0026#34;Content-Type: application/json\u0026#34; \\ -H \u0026#34;Authorization: Bearer $API_KEY\u0026#34; \\ -d @dashboard.json \\ http://grafana:3000/api/dashboards/db 6.2 Go å®¢æˆ·ç«¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import \u0026#34;github.com/grafana-tools/sdk\u0026#34; func main() { client := sdk.NewClient(\u0026#34;http://grafana:3000\u0026#34;, \u0026#34;api-key\u0026#34;, sdk.DefaultHTTPClient) // è·å–ä»ªè¡¨ç›˜ board, _, err := client.GetDashboardByUID(context.Background(), \u0026#34;uid\u0026#34;) // åˆ›å»ºä»ªè¡¨ç›˜ board := sdk.Board{ Title: \u0026#34;New Dashboard\u0026#34;, Panels: []sdk.Panel{ // ... }, } _, err = client.SetDashboard(context.Background(), board, sdk.SetDashboardParams{ Overwrite: true, }) } æ€»ç»“ Grafana æ˜¯å¼ºå¤§çš„æ•°æ®å¯è§†åŒ–å¹³å°ï¼Œé…åˆ Prometheus ç­‰æ•°æ®æºå¯ä»¥æ„å»ºå®Œæ•´çš„ç›‘æ§ç³»ç»Ÿã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“Š ä¸°å¯Œçš„å¯è§†åŒ–ç»„ä»¶ ğŸ”— å¤šæ•°æ®æºæ”¯æŒ ğŸš¨ çµæ´»çš„å‘Šè­¦ç³»ç»Ÿ ğŸ“± å“åº”å¼ä»ªè¡¨ç›˜ ğŸ”Œ å¼ºå¤§çš„ API æ‰©å±• ","date":"2025-11-10T00:00:00Z","permalink":"https://zpf-zero.github.io/p/grafana-guide/","title":"Grafana å®æˆ˜æŒ‡å—ï¼šæ•°æ®å¯è§†åŒ–ä¸ç›‘æ§é¢æ¿"},{"content":"å‰è¨€ TypeScript æ˜¯ JavaScript çš„è¶…é›†ï¼Œæ·»åŠ äº†å¯é€‰çš„é™æ€ç±»å‹å’ŒåŸºäºç±»çš„é¢å‘å¯¹è±¡ç¼–ç¨‹ã€‚å®ƒç”±å¾®è½¯å¼€å‘ï¼Œç°å·²æˆä¸ºå¤§å‹å‰ç«¯é¡¹ç›®çš„æ ‡å‡†é€‰æ‹©ï¼Œä¸º JavaScript å¼€å‘å¸¦æ¥äº†ç±»å‹å®‰å…¨å’Œæ›´å¥½çš„å¼€å‘ä½“éªŒã€‚\nä¸€ã€åŸºç¡€ç±»å‹ 1.1 åŸå§‹ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // å¸ƒå°”å€¼ let isDone: boolean = false // æ•°å­— let decimal: number = 6 let hex: number = 0xf00d let binary: number = 0b1010 // å­—ç¬¦ä¸² let name: string = \u0026#39;Alice\u0026#39; let greeting: string = `Hello, ${name}` // ç©ºå€¼ let unusable: void = undefined function log(msg: string): void { console.log(msg) } // Null å’Œ Undefined let u: undefined = undefined let n: null = null // Symbol let sym: symbol = Symbol(\u0026#39;key\u0026#39;) // BigInt let big: bigint = 100n 1.2 æ•°ç»„å’Œå…ƒç»„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // æ•°ç»„ let list1: number[] = [1, 2, 3] let list2: Array\u0026lt;number\u0026gt; = [1, 2, 3] let mixed: (string | number)[] = [1, \u0026#39;two\u0026#39;, 3] // åªè¯»æ•°ç»„ let readonlyArr: readonly number[] = [1, 2, 3] let readonlyArr2: ReadonlyArray\u0026lt;number\u0026gt; = [1, 2, 3] // å…ƒç»„ let tuple: [string, number] = [\u0026#39;Alice\u0026#39;, 25] let tuple2: [string, number, boolean?] = [\u0026#39;Bob\u0026#39;, 30] // å¯é€‰å…ƒç´  // å‘½åå…ƒç»„ type Point = [x: number, y: number] const point: Point = [10, 20] // è§£æ„ const [name, age] = tuple 1.3 æšä¸¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // æ•°å­—æšä¸¾ enum Direction { Up, // 0 Down, // 1 Left, // 2 Right // 3 } // æŒ‡å®šå€¼ enum Status { Active = 1, Inactive = 2, Pending = 3 } // å­—ç¬¦ä¸²æšä¸¾ enum Color { Red = \u0026#39;RED\u0026#39;, Green = \u0026#39;GREEN\u0026#39;, Blue = \u0026#39;BLUE\u0026#39; } // å¸¸é‡æšä¸¾ï¼ˆç¼–è¯‘æ—¶å†…è”ï¼‰ const enum HttpStatus { OK = 200, NotFound = 404, ServerError = 500 } // ä½¿ç”¨ let dir: Direction = Direction.Up let status: HttpStatus = HttpStatus.OK 1.4 ç‰¹æ®Šç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // anyï¼šä»»æ„ç±»å‹ let notSure: any = 4 notSure = \u0026#39;string\u0026#39; notSure.foo.bar // ä¸æŠ¥é”™ // unknownï¼šå®‰å…¨çš„ any let value: unknown = 4 value = \u0026#39;string\u0026#39; // value.foo // æŠ¥é”™ï¼Œéœ€è¦ç±»å‹æ£€æŸ¥ if (typeof value === \u0026#39;string\u0026#39;) { value.toUpperCase() // OK } // neverï¼šæ°¸ä¸è¿”å› function error(msg: string): never { throw new Error(msg) } function infiniteLoop(): never { while (true) {} } // object let obj: object = { name: \u0026#39;Alice\u0026#39; } let obj2: { name: string; age: number } = { name: \u0026#39;Bob\u0026#39;, age: 25 } äºŒã€æ¥å£ä¸ç±»å‹åˆ«å 2.1 æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 // åŸºæœ¬æ¥å£ interface User { id: number name: string email: string } // å¯é€‰å±æ€§ interface Config { host: string port?: number timeout?: number } // åªè¯»å±æ€§ interface Point { readonly x: number readonly y: number } // ç´¢å¼•ç­¾å interface StringMap { [key: string]: string } interface NumberArray { [index: number]: string } // å‡½æ•°ç±»å‹ interface SearchFunc { (source: string, subString: string): boolean } const search: SearchFunc = (src, sub) =\u0026gt; src.includes(sub) // æ¥å£ç»§æ‰¿ interface Animal { name: string } interface Dog extends Animal { breed: string } // å¤šç»§æ‰¿ interface Pet extends Animal, Walkable { owner: string } 2.2 ç±»å‹åˆ«å 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // åŸºæœ¬ç±»å‹åˆ«å type ID = number | string type Point = { x: number; y: number } type Callback = (data: string) =\u0026gt; void // è”åˆç±»å‹ type Status = \u0026#39;pending\u0026#39; | \u0026#39;approved\u0026#39; | \u0026#39;rejected\u0026#39; type Result = Success | Error // äº¤å‰ç±»å‹ type Employee = Person \u0026amp; { employeeId: string } // æ¡ä»¶ç±»å‹ type IsString\u0026lt;T\u0026gt; = T extends string ? true : false // æ˜ å°„ç±»å‹ type Readonly\u0026lt;T\u0026gt; = { readonly [P in keyof T]: T[P] } type Partial\u0026lt;T\u0026gt; = { [P in keyof T]?: T[P] } 2.3 æ¥å£ vs ç±»å‹åˆ«å 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // æ¥å£å¯ä»¥å£°æ˜åˆå¹¶ interface User { name: string } interface User { age: number } // User = { name: string; age: number } // ç±»å‹åˆ«åä¸èƒ½å£°æ˜åˆå¹¶ type User = { name: string } // type User = { age: number } // æŠ¥é”™ // æ¥å£åªèƒ½æè¿°å¯¹è±¡ç±»å‹ // ç±»å‹åˆ«åå¯ä»¥æè¿°ä»»ä½•ç±»å‹ type ID = string | number type Tuple = [number, string] ä¸‰ã€å‡½æ•° 3.1 å‡½æ•°ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // å‡½æ•°å£°æ˜ function add(x: number, y: number): number { return x + y } // å‡½æ•°è¡¨è¾¾å¼ const multiply: (x: number, y: number) =\u0026gt; number = (x, y) =\u0026gt; x * y // å¯é€‰å‚æ•° function greet(name: string, greeting?: string): string { return `${greeting || \u0026#39;Hello\u0026#39;}, ${name}` } // é»˜è®¤å‚æ•° function createUser(name: string, role: string = \u0026#39;user\u0026#39;): void { console.log(name, role) } // å‰©ä½™å‚æ•° function sum(...numbers: number[]): number { return numbers.reduce((a, b) =\u0026gt; a + b, 0) } // this ç±»å‹ interface Card { suit: string card: number } interface Deck { suits: string[] cards: number[] createCardPicker(this: Deck): () =\u0026gt; Card } 3.2 å‡½æ•°é‡è½½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // é‡è½½ç­¾å function reverse(x: string): string function reverse(x: number[]): number[] // å®ç°ç­¾å function reverse(x: string | number[]): string | number[] { if (typeof x === \u0026#39;string\u0026#39;) { return x.split(\u0026#39;\u0026#39;).reverse().join(\u0026#39;\u0026#39;) } return x.slice().reverse() } // ä½¿ç”¨ const str = reverse(\u0026#39;hello\u0026#39;) // string const arr = reverse([1, 2, 3]) // number[] å››ã€æ³›å‹ 4.1 æ³›å‹å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // åŸºæœ¬æ³›å‹ function identity\u0026lt;T\u0026gt;(arg: T): T { return arg } // ä½¿ç”¨ identity\u0026lt;string\u0026gt;(\u0026#39;hello\u0026#39;) // æ˜¾å¼æŒ‡å®š identity(\u0026#39;hello\u0026#39;) // ç±»å‹æ¨æ–­ // å¤šä¸ªç±»å‹å‚æ•° function pair\u0026lt;T, U\u0026gt;(first: T, second: U): [T, U] { return [first, second] } // æ³›å‹çº¦æŸ interface Lengthwise { length: number } function logLength\u0026lt;T extends Lengthwise\u0026gt;(arg: T): T { console.log(arg.length) return arg } logLength(\u0026#39;hello\u0026#39;) // OK logLength([1, 2, 3]) // OK // logLength(123) // æŠ¥é”™ 4.2 æ³›å‹æ¥å£å’Œç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // æ³›å‹æ¥å£ interface Repository\u0026lt;T\u0026gt; { getById(id: number): T getAll(): T[] create(item: T): T update(id: number, item: T): T delete(id: number): void } // æ³›å‹ç±» class GenericNumber\u0026lt;T\u0026gt; { zeroValue: T add: (x: T, y: T) =\u0026gt; T constructor(zero: T, addFn: (x: T, y: T) =\u0026gt; T) { this.zeroValue = zero this.add = addFn } } const numericCalc = new GenericNumber\u0026lt;number\u0026gt;(0, (x, y) =\u0026gt; x + y) const stringCalc = new GenericNumber\u0026lt;string\u0026gt;(\u0026#39;\u0026#39;, (x, y) =\u0026gt; x + y) // æ³›å‹çº¦æŸä¸­ä½¿ç”¨ç±»å‹å‚æ•° function getProperty\u0026lt;T, K extends keyof T\u0026gt;(obj: T, key: K): T[K] { return obj[key] } const user = { name: \u0026#39;Alice\u0026#39;, age: 25 } getProperty(user, \u0026#39;name\u0026#39;) // OK // getProperty(user, \u0026#39;email\u0026#39;) // æŠ¥é”™ 4.3 æ³›å‹å·¥å…·ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // Partialï¼šæ‰€æœ‰å±æ€§å¯é€‰ type PartialUser = Partial\u0026lt;User\u0026gt; // Requiredï¼šæ‰€æœ‰å±æ€§å¿…å¡« type RequiredUser = Required\u0026lt;User\u0026gt; // Readonlyï¼šæ‰€æœ‰å±æ€§åªè¯» type ReadonlyUser = Readonly\u0026lt;User\u0026gt; // Pickï¼šé€‰å–éƒ¨åˆ†å±æ€§ type UserName = Pick\u0026lt;User, \u0026#39;name\u0026#39; | \u0026#39;email\u0026#39;\u0026gt; // Omitï¼šæ’é™¤éƒ¨åˆ†å±æ€§ type UserWithoutId = Omit\u0026lt;User, \u0026#39;id\u0026#39;\u0026gt; // Recordï¼šæ„é€ å¯¹è±¡ç±»å‹ type StringMap = Record\u0026lt;string, string\u0026gt; type UserRecord = Record\u0026lt;number, User\u0026gt; // Excludeï¼šä»è”åˆç±»å‹ä¸­æ’é™¤ type T1 = Exclude\u0026lt;\u0026#39;a\u0026#39; | \u0026#39;b\u0026#39; | \u0026#39;c\u0026#39;, \u0026#39;a\u0026#39;\u0026gt; // \u0026#39;b\u0026#39; | \u0026#39;c\u0026#39; // Extractï¼šä»è”åˆç±»å‹ä¸­æå– type T2 = Extract\u0026lt;\u0026#39;a\u0026#39; | \u0026#39;b\u0026#39; | \u0026#39;c\u0026#39;, \u0026#39;a\u0026#39; | \u0026#39;f\u0026#39;\u0026gt; // \u0026#39;a\u0026#39; // NonNullableï¼šæ’é™¤ null å’Œ undefined type T3 = NonNullable\u0026lt;string | null | undefined\u0026gt; // string // ReturnTypeï¼šè·å–å‡½æ•°è¿”å›ç±»å‹ type T4 = ReturnType\u0026lt;() =\u0026gt; string\u0026gt; // string // Parametersï¼šè·å–å‡½æ•°å‚æ•°ç±»å‹ type T5 = Parameters\u0026lt;(a: string, b: number) =\u0026gt; void\u0026gt; // [string, number] äº”ã€é«˜çº§ç±»å‹ 5.1 æ¡ä»¶ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // åŸºæœ¬æ¡ä»¶ç±»å‹ type IsString\u0026lt;T\u0026gt; = T extends string ? \u0026#39;yes\u0026#39; : \u0026#39;no\u0026#39; type A = IsString\u0026lt;string\u0026gt; // \u0026#39;yes\u0026#39; type B = IsString\u0026lt;number\u0026gt; // \u0026#39;no\u0026#39; // infer å…³é”®å­— type ReturnType\u0026lt;T\u0026gt; = T extends (...args: any[]) =\u0026gt; infer R ? R : never type UnpackArray\u0026lt;T\u0026gt; = T extends (infer U)[] ? U : T type T1 = UnpackArray\u0026lt;string[]\u0026gt; // string type T2 = UnpackArray\u0026lt;number\u0026gt; // number // åˆ†å¸ƒå¼æ¡ä»¶ç±»å‹ type ToArray\u0026lt;T\u0026gt; = T extends any ? T[] : never type T3 = ToArray\u0026lt;string | number\u0026gt; // string[] | number[] 5.2 æ˜ å°„ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // åŸºæœ¬æ˜ å°„ç±»å‹ type Readonly\u0026lt;T\u0026gt; = { readonly [P in keyof T]: T[P] } type Optional\u0026lt;T\u0026gt; = { [P in keyof T]?: T[P] } // é”®é‡æ˜ å°„ type Getters\u0026lt;T\u0026gt; = { [P in keyof T as `get${Capitalize\u0026lt;string \u0026amp; P\u0026gt;}`]: () =\u0026gt; T[P] } interface Person { name: string age: number } type PersonGetters = Getters\u0026lt;Person\u0026gt; // { getName: () =\u0026gt; string; getAge: () =\u0026gt; number } // è¿‡æ»¤é”® type RemoveReadonly\u0026lt;T\u0026gt; = { -readonly [P in keyof T]: T[P] } type Mutable\u0026lt;T\u0026gt; = { -readonly [P in keyof T]: T[P] } 5.3 æ¨¡æ¿å­—é¢é‡ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 type EventName = \u0026#39;click\u0026#39; | \u0026#39;scroll\u0026#39; | \u0026#39;mousemove\u0026#39; type EventHandler = `on${Capitalize\u0026lt;EventName\u0026gt;}` // \u0026#39;onClick\u0026#39; | \u0026#39;onScroll\u0026#39; | \u0026#39;onMousemove\u0026#39; type HTTPMethod = \u0026#39;GET\u0026#39; | \u0026#39;POST\u0026#39; | \u0026#39;PUT\u0026#39; | \u0026#39;DELETE\u0026#39; type Endpoint = \u0026#39;/users\u0026#39; | \u0026#39;/posts\u0026#39; type Route = `${HTTPMethod} ${Endpoint}` // \u0026#39;GET /users\u0026#39; | \u0026#39;GET /posts\u0026#39; | \u0026#39;POST /users\u0026#39; | ... // å†…ç½®å­—ç¬¦ä¸²æ“ä½œç±»å‹ type T1 = Uppercase\u0026lt;\u0026#39;hello\u0026#39;\u0026gt; // \u0026#39;HELLO\u0026#39; type T2 = Lowercase\u0026lt;\u0026#39;HELLO\u0026#39;\u0026gt; // \u0026#39;hello\u0026#39; type T3 = Capitalize\u0026lt;\u0026#39;hello\u0026#39;\u0026gt; // \u0026#39;Hello\u0026#39; type T4 = Uncapitalize\u0026lt;\u0026#39;Hello\u0026#39;\u0026gt; // \u0026#39;hello\u0026#39; å…­ã€ç±» 6.1 ç±»çš„åŸºæœ¬ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 class Animal { // å±æ€§ name: string private age: number protected species: string readonly id: number // æ„é€ å‡½æ•° constructor(name: string, age: number) { this.name = name this.age = age this.species = \u0026#39;Unknown\u0026#39; this.id = Math.random() } // æ–¹æ³• speak(): void { console.log(`${this.name} makes a sound`) } // Getter/Setter get animalAge(): number { return this.age } set animalAge(value: number) { if (value \u0026gt;= 0) { this.age = value } } // é™æ€æˆå‘˜ static kingdom = \u0026#39;Animalia\u0026#39; static isAnimal(obj: any): obj is Animal { return obj instanceof Animal } } 6.2 ç»§æ‰¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 class Dog extends Animal { breed: string constructor(name: string, age: number, breed: string) { super(name, age) this.breed = breed this.species = \u0026#39;Canis lupus\u0026#39; } speak(): void { console.log(`${this.name} barks`) } fetch(): void { console.log(`${this.name} fetches the ball`) } } const dog = new Dog(\u0026#39;Buddy\u0026#39;, 3, \u0026#39;Labrador\u0026#39;) dog.speak() // Buddy barks 6.3 æŠ½è±¡ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 abstract class Shape { abstract getArea(): number abstract getPerimeter(): number describe(): string { return `Area: ${this.getArea()}, Perimeter: ${this.getPerimeter()}` } } class Circle extends Shape { constructor(private radius: number) { super() } getArea(): number { return Math.PI * this.radius ** 2 } getPerimeter(): number { return 2 * Math.PI * this.radius } } class Rectangle extends Shape { constructor(private width: number, private height: number) { super() } getArea(): number { return this.width * this.height } getPerimeter(): number { return 2 * (this.width + this.height) } } 6.4 æ¥å£å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 interface Printable { print(): void } interface Loggable { log(message: string): void } class Document implements Printable, Loggable { constructor(private content: string) {} print(): void { console.log(this.content) } log(message: string): void { console.log(`[LOG] ${message}: ${this.content}`) } } ä¸ƒã€æ¨¡å—ä¸å‘½åç©ºé—´ 7.1 ES æ¨¡å— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // user.ts export interface User { id: number name: string } export function createUser(name: string): User { return { id: Date.now(), name } } export default class UserService { // ... } // main.ts import UserService, { User, createUser } from \u0026#39;./user\u0026#39; import * as UserModule from \u0026#39;./user\u0026#39; // é‡å¯¼å‡º export { User } from \u0026#39;./user\u0026#39; export * from \u0026#39;./user\u0026#39; export * as UserAPI from \u0026#39;./user\u0026#39; 7.2 ç±»å‹å¯¼å…¥å¯¼å‡º 1 2 3 4 5 6 7 // ä»…å¯¼å…¥ç±»å‹ import type { User } from \u0026#39;./user\u0026#39; import { type User, createUser } from \u0026#39;./user\u0026#39; // ä»…å¯¼å‡ºç±»å‹ export type { User } export { type User, createUser } 7.3 å‘½åç©ºé—´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 namespace Validation { export interface StringValidator { isValid(s: string): boolean } export class EmailValidator implements StringValidator { isValid(s: string): boolean { return /^\\S+@\\S+\\.\\S+$/.test(s) } } export class PhoneValidator implements StringValidator { isValid(s: string): boolean { return /^\\d{10,11}$/.test(s) } } } const emailValidator = new Validation.EmailValidator() å…«ã€å£°æ˜æ–‡ä»¶ 8.1 å£°æ˜æ–‡ä»¶åŸºç¡€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // types/lodash.d.ts declare module \u0026#39;lodash\u0026#39; { export function chunk\u0026lt;T\u0026gt;(array: T[], size: number): T[][] export function debounce\u0026lt;T extends (...args: any[]) =\u0026gt; any\u0026gt;( func: T, wait: number ): T } // å…¨å±€å˜é‡ declare const VERSION: string declare function greet(name: string): void // å…¨å±€æ‰©å±• declare global { interface Window { myApp: { version: string init(): void } } } 8.2 æ¨¡å—å£°æ˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // ä¸º JS æ¨¡å—æ·»åŠ ç±»å‹ declare module \u0026#39;*.vue\u0026#39; { import { DefineComponent } from \u0026#39;vue\u0026#39; const component: DefineComponent\u0026lt;{}, {}, any\u0026gt; export default component } declare module \u0026#39;*.css\u0026#39; { const content: { [className: string]: string } export default content } declare module \u0026#39;*.png\u0026#39; { const value: string export default value } ä¹ã€é…ç½®ä¸æœ€ä½³å®è·µ 9.1 tsconfig.json 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 { \u0026#34;compilerOptions\u0026#34;: { \u0026#34;target\u0026#34;: \u0026#34;ES2020\u0026#34;, \u0026#34;module\u0026#34;: \u0026#34;ESNext\u0026#34;, \u0026#34;lib\u0026#34;: [\u0026#34;ES2020\u0026#34;, \u0026#34;DOM\u0026#34;, \u0026#34;DOM.Iterable\u0026#34;], \u0026#34;moduleResolution\u0026#34;: \u0026#34;bundler\u0026#34;, \u0026#34;strict\u0026#34;: true, \u0026#34;noImplicitAny\u0026#34;: true, \u0026#34;strictNullChecks\u0026#34;: true, \u0026#34;noUnusedLocals\u0026#34;: true, \u0026#34;noUnusedParameters\u0026#34;: true, \u0026#34;noFallthroughCasesInSwitch\u0026#34;: true, \u0026#34;esModuleInterop\u0026#34;: true, \u0026#34;skipLibCheck\u0026#34;: true, \u0026#34;forceConsistentCasingInFileNames\u0026#34;: true, \u0026#34;resolveJsonModule\u0026#34;: true, \u0026#34;isolatedModules\u0026#34;: true, \u0026#34;declaration\u0026#34;: true, \u0026#34;declarationMap\u0026#34;: true, \u0026#34;sourceMap\u0026#34;: true, \u0026#34;baseUrl\u0026#34;: \u0026#34;.\u0026#34;, \u0026#34;paths\u0026#34;: { \u0026#34;@/*\u0026#34;: [\u0026#34;src/*\u0026#34;] } }, \u0026#34;include\u0026#34;: [\u0026#34;src/**/*\u0026#34;], \u0026#34;exclude\u0026#34;: [\u0026#34;node_modules\u0026#34;] } 9.2 æœ€ä½³å®è·µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // 1. ä½¿ç”¨ unknown æ›¿ä»£ any function processValue(value: unknown) { if (typeof value === \u0026#39;string\u0026#39;) { return value.toUpperCase() } if (typeof value === \u0026#39;number\u0026#39;) { return value.toFixed(2) } throw new Error(\u0026#39;Invalid value type\u0026#39;) } // 2. ä½¿ç”¨ç±»å‹å®ˆå« function isUser(obj: any): obj is User { return obj \u0026amp;\u0026amp; typeof obj.name === \u0026#39;string\u0026#39; \u0026amp;\u0026amp; typeof obj.id === \u0026#39;number\u0026#39; } // 3. ä½¿ç”¨ const æ–­è¨€ const config = { endpoint: \u0026#39;/api\u0026#39;, timeout: 3000 } as const // 4. ä½¿ç”¨æšä¸¾æ›¿ä»£é­”æ³•å­—ç¬¦ä¸² enum UserRole { Admin = \u0026#39;ADMIN\u0026#39;, User = \u0026#39;USER\u0026#39;, Guest = \u0026#39;GUEST\u0026#39; } // 5. ä½¿ç”¨å¯è¾¨è¯†è”åˆ type Result\u0026lt;T\u0026gt; = | { success: true; data: T } | { success: false; error: string } function handleResult\u0026lt;T\u0026gt;(result: Result\u0026lt;T\u0026gt;) { if (result.success) { console.log(result.data) } else { console.error(result.error) } } æ€»ç»“ TypeScript ä¸º JavaScript æ·»åŠ äº†å¼ºå¤§çš„ç±»å‹ç³»ç»Ÿï¼Œæå¤§åœ°æå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¼€å‘ä½“éªŒã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“ é™æ€ç±»å‹æ£€æŸ¥å‡å°‘è¿è¡Œæ—¶é”™è¯¯ ğŸ”§ æ³›å‹å’Œé«˜çº§ç±»å‹æä¾›çµæ´»çš„æŠ½è±¡ ğŸ¯ ä¼˜ç§€çš„ IDE æ”¯æŒå’Œä»£ç è¡¥å…¨ ğŸ“¦ å£°æ˜æ–‡ä»¶æ”¯æŒ JavaScript ç”Ÿæ€ ğŸš€ æ¸è¿›å¼é‡‡ç”¨ï¼Œå…¼å®¹ JavaScript ","date":"2025-11-07T00:00:00Z","permalink":"https://zpf-zero.github.io/p/typescript-guide/","title":"TypeScript å®æˆ˜æŒ‡å—ï¼šç±»å‹å®‰å…¨çš„ JavaScript å¼€å‘"},{"content":"å‰è¨€ Apache Zookeeper æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæä¾›é…ç½®ç®¡ç†ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼é”ã€é›†ç¾¤ç®¡ç†ç­‰åŠŸèƒ½ã€‚å®ƒæ˜¯ Hadoopã€Kafkaã€HBase ç­‰å¤§æ•°æ®ç»„ä»¶çš„æ ¸å¿ƒä¾èµ–ã€‚\nä¸€ã€æ ¸å¿ƒæ¦‚å¿µ 1.1 æ•°æ®æ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 / # æ ¹èŠ‚ç‚¹ â”œâ”€â”€ /config # é…ç½®ä¸­å¿ƒ â”‚ â”œâ”€â”€ /config/database â”‚ â””â”€â”€ /config/redis â”œâ”€â”€ /services # æœåŠ¡æ³¨å†Œ â”‚ â”œâ”€â”€ /services/user-service â”‚ â”‚ â”œâ”€â”€ /services/user-service/node1 â”‚ â”‚ â””â”€â”€ /services/user-service/node2 â”‚ â””â”€â”€ /services/order-service â””â”€â”€ /locks # åˆ†å¸ƒå¼é” â””â”€â”€ /locks/order-lock 1.2 èŠ‚ç‚¹ç±»å‹ æŒä¹…èŠ‚ç‚¹ (PERSISTENT)ï¼šåˆ›å»ºåä¸€ç›´å­˜åœ¨ ä¸´æ—¶èŠ‚ç‚¹ (EPHEMERAL)ï¼šä¼šè¯ç»“æŸè‡ªåŠ¨åˆ é™¤ æŒä¹…é¡ºåºèŠ‚ç‚¹ (PERSISTENT_SEQUENTIAL)ï¼šå¸¦æœ‰åºå·çš„æŒä¹…èŠ‚ç‚¹ ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ (EPHEMERAL_SEQUENTIAL)ï¼šå¸¦æœ‰åºå·çš„ä¸´æ—¶èŠ‚ç‚¹ 1.3 Watch æœºåˆ¶ 1 2 3 4 5 6 7 Client Zookeeper Server | | |-- getData(/path, watch) --\u0026gt; |\u0026lt;-- data ------------------| | | |\u0026lt;-- WatchEvent (NodeDataChanged) | | äºŒã€å¿«é€Ÿéƒ¨ç½² 2.1 å•æœºéƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # docker-compose.yml version: \u0026#39;3.8\u0026#39; services: zookeeper: image: zookeeper:latest ports: - \u0026#34;2181:2181\u0026#34; environment: ZOO_MY_ID: 1 ZOO_SERVERS: server.1=zookeeper:2888:3888;2181 volumes: - zk_data:/data - zk_datalog:/datalog volumes: zk_data: zk_datalog: 2.2 é›†ç¾¤éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 version: \u0026#39;3.8\u0026#39; services: zoo1: image: zookeeper:latest hostname: zoo1 environment: ZOO_MY_ID: 1 ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181 ports: - \u0026#34;2181:2181\u0026#34; zoo2: image: zookeeper:latest hostname: zoo2 environment: ZOO_MY_ID: 2 ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181 ports: - \u0026#34;2182:2181\u0026#34; zoo3: image: zookeeper:latest hostname: zoo3 environment: ZOO_MY_ID: 3 ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181 ports: - \u0026#34;2183:2181\u0026#34; 2.3 CLI æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # è¿æ¥ Zookeeper zkCli.sh -server localhost:2181 # åŸºæœ¬æ“ä½œ ls / # åˆ—å‡ºå­èŠ‚ç‚¹ create /app \u0026#34;data\u0026#34; # åˆ›å»ºèŠ‚ç‚¹ get /app # è·å–æ•°æ® set /app \u0026#34;new data\u0026#34; # æ›´æ–°æ•°æ® delete /app # åˆ é™¤èŠ‚ç‚¹ # åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ create -e /temp \u0026#34;temp data\u0026#34; # åˆ›å»ºé¡ºåºèŠ‚ç‚¹ create -s /seq \u0026#34;seq data\u0026#34; # åˆ›å»º /seq0000000001 # è®¾ç½® Watch get -w /app # ç›‘å¬æ•°æ®å˜åŒ– ls -w /services # ç›‘å¬å­èŠ‚ç‚¹å˜åŒ– ä¸‰ã€Go åº”ç”¨é›†æˆ 3.1 å®‰è£…ä¾èµ– 1 go get github.com/go-zookeeper/zk 3.2 åŸºæœ¬æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package zookeeper import ( \u0026#34;time\u0026#34; \u0026#34;github.com/go-zookeeper/zk\u0026#34; ) type Client struct { conn *zk.Conn } func NewClient(servers []string) (*Client, error) { conn, _, err := zk.Connect(servers, 5*time.Second) if err != nil { return nil, err } return \u0026amp;Client{conn: conn}, nil } // åˆ›å»ºèŠ‚ç‚¹ func (c *Client) Create(path string, data []byte, flags int32) (string, error) { return c.conn.Create(path, data, flags, zk.WorldACL(zk.PermAll)) } // è·å–æ•°æ® func (c *Client) Get(path string) ([]byte, *zk.Stat, error) { return c.conn.Get(path) } // è®¾ç½®æ•°æ® func (c *Client) Set(path string, data []byte, version int32) (*zk.Stat, error) { return c.conn.Set(path, data, version) } // åˆ é™¤èŠ‚ç‚¹ func (c *Client) Delete(path string, version int32) error { return c.conn.Delete(path, version) } // è·å–å­èŠ‚ç‚¹ func (c *Client) Children(path string) ([]string, *zk.Stat, error) { return c.conn.Children(path) } // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ func (c *Client) Exists(path string) (bool, *zk.Stat, error) { return c.conn.Exists(path) } // å…³é—­è¿æ¥ func (c *Client) Close() { c.conn.Close() } 3.3 Watch æœºåˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 // ç›‘å¬æ•°æ®å˜åŒ– func (c *Client) WatchData(path string, callback func([]byte)) error { for { data, _, eventCh, err := c.conn.GetW(path) if err != nil { return err } callback(data) // ç­‰å¾…äº‹ä»¶ event := \u0026lt;-eventCh if event.Type == zk.EventNodeDeleted { return nil } } } // ç›‘å¬å­èŠ‚ç‚¹å˜åŒ– func (c *Client) WatchChildren(path string, callback func([]string)) error { for { children, _, eventCh, err := c.conn.ChildrenW(path) if err != nil { return err } callback(children) event := \u0026lt;-eventCh if event.Type == zk.EventNodeDeleted { return nil } } } // ä½¿ç”¨ç¤ºä¾‹ func main() { client, _ := NewClient([]string{\u0026#34;localhost:2181\u0026#34;}) defer client.Close() // ç›‘å¬é…ç½®å˜åŒ– go client.WatchData(\u0026#34;/config/database\u0026#34;, func(data []byte) { log.Printf(\u0026#34;Config updated: %s\u0026#34;, string(data)) // é‡æ–°åŠ è½½é…ç½® }) // ç›‘å¬æœåŠ¡èŠ‚ç‚¹ go client.WatchChildren(\u0026#34;/services/user-service\u0026#34;, func(nodes []string) { log.Printf(\u0026#34;Service nodes: %v\u0026#34;, nodes) // æ›´æ–°æœåŠ¡åˆ—è¡¨ }) } å››ã€åº”ç”¨åœºæ™¯ 4.1 é…ç½®ä¸­å¿ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 type ConfigCenter struct { client *Client cache sync.Map } func NewConfigCenter(servers []string) (*ConfigCenter, error) { client, err := NewClient(servers) if err != nil { return nil, err } return \u0026amp;ConfigCenter{client: client}, nil } func (cc *ConfigCenter) GetConfig(key string) (string, error) { // å…ˆæŸ¥ç¼“å­˜ if val, ok := cc.cache.Load(key); ok { return val.(string), nil } // ä» Zookeeper è·å– path := \u0026#34;/config/\u0026#34; + key data, _, err := cc.client.Get(path) if err != nil { return \u0026#34;\u0026#34;, err } value := string(data) cc.cache.Store(key, value) // å¯åŠ¨ç›‘å¬ go cc.watchConfig(key) return value, nil } func (cc *ConfigCenter) watchConfig(key string) { path := \u0026#34;/config/\u0026#34; + key cc.client.WatchData(path, func(data []byte) { cc.cache.Store(key, string(data)) log.Printf(\u0026#34;Config %s updated\u0026#34;, key) }) } 4.2 æœåŠ¡æ³¨å†Œå‘ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 type ServiceRegistry struct { client *Client servicePath string } func NewServiceRegistry(servers []string, serviceName string) (*ServiceRegistry, error) { client, err := NewClient(servers) if err != nil { return nil, err } servicePath := \u0026#34;/services/\u0026#34; + serviceName // ç¡®ä¿æœåŠ¡è·¯å¾„å­˜åœ¨ exists, _, _ := client.Exists(servicePath) if !exists { client.Create(servicePath, nil, 0) } return \u0026amp;ServiceRegistry{ client: client, servicePath: servicePath, }, nil } // æ³¨å†ŒæœåŠ¡å®ä¾‹ func (sr *ServiceRegistry) Register(instanceID, address string) error { path := sr.servicePath + \u0026#34;/\u0026#34; + instanceID data := []byte(address) // åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ _, err := sr.client.Create(path, data, zk.FlagEphemeral) return err } // è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨ func (sr *ServiceRegistry) GetInstances() ([]string, error) { children, _, err := sr.client.Children(sr.servicePath) if err != nil { return nil, err } var addresses []string for _, child := range children { path := sr.servicePath + \u0026#34;/\u0026#34; + child data, _, _ := sr.client.Get(path) addresses = append(addresses, string(data)) } return addresses, nil } // ç›‘å¬æœåŠ¡å˜åŒ– func (sr *ServiceRegistry) Watch(callback func([]string)) { go sr.client.WatchChildren(sr.servicePath, func(children []string) { var addresses []string for _, child := range children { path := sr.servicePath + \u0026#34;/\u0026#34; + child data, _, _ := sr.client.Get(path) addresses = append(addresses, string(data)) } callback(addresses) }) } 4.3 åˆ†å¸ƒå¼é” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 type DistributedLock struct { client *Client lockPath string nodePath string } func NewDistributedLock(client *Client, lockName string) *DistributedLock { return \u0026amp;DistributedLock{ client: client, lockPath: \u0026#34;/locks/\u0026#34; + lockName, } } func (dl *DistributedLock) Lock() error { // ç¡®ä¿é”ç›®å½•å­˜åœ¨ exists, _, _ := dl.client.Exists(dl.lockPath) if !exists { dl.client.Create(dl.lockPath, nil, 0) } // åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ path, err := dl.client.Create( dl.lockPath+\u0026#34;/lock-\u0026#34;, nil, zk.FlagEphemeral|zk.FlagSequence, ) if err != nil { return err } dl.nodePath = path for { // è·å–æ‰€æœ‰å­èŠ‚ç‚¹ children, _, err := dl.client.Children(dl.lockPath) if err != nil { return err } sort.Strings(children) // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€å°èŠ‚ç‚¹ myNode := path[len(dl.lockPath)+1:] if children[0] == myNode { return nil // è·å–åˆ°é” } // æ‰¾åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹å¹¶ç›‘å¬ var prevNode string for i, child := range children { if child == myNode { prevNode = children[i-1] break } } // ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ prevPath := dl.lockPath + \u0026#34;/\u0026#34; + prevNode exists, _, eventCh, _ := dl.client.conn.ExistsW(prevPath) if exists { \u0026lt;-eventCh // ç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤ } } } func (dl *DistributedLock) Unlock() error { if dl.nodePath == \u0026#34;\u0026#34; { return nil } return dl.client.Delete(dl.nodePath, -1) } // ä½¿ç”¨ç¤ºä¾‹ func main() { client, _ := NewClient([]string{\u0026#34;localhost:2181\u0026#34;}) defer client.Close() lock := NewDistributedLock(client, \u0026#34;order-process\u0026#34;) if err := lock.Lock(); err != nil { log.Fatal(err) } defer lock.Unlock() // æ‰§è¡Œéœ€è¦äº’æ–¥çš„æ“ä½œ processOrder() } 4.4 Leader é€‰ä¸¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 type LeaderElection struct { client *Client path string nodePath string isLeader bool onBecomeLeader func() onLoseLeader func() } func NewLeaderElection(client *Client, path string) *LeaderElection { return \u0026amp;LeaderElection{ client: client, path: path, } } func (le *LeaderElection) Start() error { // ç¡®ä¿é€‰ä¸¾è·¯å¾„å­˜åœ¨ exists, _, _ := le.client.Exists(le.path) if !exists { le.client.Create(le.path, nil, 0) } // åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ path, err := le.client.Create( le.path+\u0026#34;/node-\u0026#34;, nil, zk.FlagEphemeral|zk.FlagSequence, ) if err != nil { return err } le.nodePath = path go le.watchLeadership() return nil } func (le *LeaderElection) watchLeadership() { for { children, _, err := le.client.Children(le.path) if err != nil { continue } sort.Strings(children) myNode := le.nodePath[len(le.path)+1:] isLeader := children[0] == myNode if isLeader \u0026amp;\u0026amp; !le.isLeader { le.isLeader = true if le.onBecomeLeader != nil { le.onBecomeLeader() } } else if !isLeader \u0026amp;\u0026amp; le.isLeader { le.isLeader = false if le.onLoseLeader != nil { le.onLoseLeader() } } if !isLeader { // ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ var prevNode string for i, child := range children { if child == myNode { prevNode = children[i-1] break } } prevPath := le.path + \u0026#34;/\u0026#34; + prevNode _, _, eventCh, _ := le.client.conn.ExistsW(prevPath) \u0026lt;-eventCh } } } func (le *LeaderElection) IsLeader() bool { return le.isLeader } äº”ã€æœ€ä½³å®è·µ 5.1 è¿æ¥ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // ä½¿ç”¨è¿æ¥æ± å’Œé‡è¯• func NewClientWithRetry(servers []string, maxRetries int) (*Client, error) { var conn *zk.Conn var err error for i := 0; i \u0026lt; maxRetries; i++ { conn, _, err = zk.Connect(servers, 5*time.Second) if err == nil { break } time.Sleep(time.Second * time.Duration(i+1)) } if err != nil { return nil, err } return \u0026amp;Client{conn: conn}, nil } 5.2 Session ç®¡ç† 1 2 3 4 5 6 7 8 // ç›‘å¬ Session äº‹ä»¶ func (c *Client) WatchSession(callback func(zk.State)) { go func() { for event := range c.sessionEvents { callback(event.State) } }() } æ€»ç»“ Zookeeper æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒåè°ƒæœåŠ¡ï¼Œæä¾›äº†å¯é çš„åˆ†å¸ƒå¼åè°ƒèƒ½åŠ›ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“ æ ‘å½¢æ•°æ®æ¨¡å‹ ğŸ‘ï¸ Watch é€šçŸ¥æœºåˆ¶ ğŸ”’ åˆ†å¸ƒå¼é”å®ç° ğŸ“¡ æœåŠ¡æ³¨å†Œå‘ç° ğŸ‘‘ Leader é€‰ä¸¾ Incoming (Background Agent changes)\n","date":"2025-11-02T00:00:00Z","permalink":"https://zpf-zero.github.io/p/zookeeper-guide/","title":"Zookeeper å®æˆ˜æŒ‡å—ï¼šåˆ†å¸ƒå¼åè°ƒæœåŠ¡"},{"content":"å‰è¨€ Zap æ˜¯ Uber å¼€æºçš„é«˜æ€§èƒ½æ—¥å¿—åº“ï¼Œç›¸æ¯”æ ‡å‡†åº“å’Œå…¶ä»–æ—¥å¿—åº“ï¼ŒZap æä¾›äº†æè‡´çš„æ€§èƒ½å’Œç»“æ„åŒ–æ—¥å¿—æ”¯æŒã€‚å®ƒæ˜¯ Go è¯­è¨€ç”Ÿæ€ä¸­æœ€å¿«çš„æ—¥å¿—åº“ä¹‹ä¸€ï¼Œéå¸¸é€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£… 1 go get -u go.uber.org/zap 1.2 åŸºæœ¬ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package main import ( \u0026#34;go.uber.org/zap\u0026#34; ) func main() { // å¼€å‘ç¯å¢ƒ logger, _ := zap.NewDevelopment() defer logger.Sync() logger.Info(\u0026#34;Hello, Zap!\u0026#34;) logger.Debug(\u0026#34;This is a debug message\u0026#34;) logger.Warn(\u0026#34;This is a warning\u0026#34;) logger.Error(\u0026#34;This is an error\u0026#34;) // ç”Ÿäº§ç¯å¢ƒ prodLogger, _ := zap.NewProduction() defer prodLogger.Sync() prodLogger.Info(\u0026#34;Production log\u0026#34;, zap.String(\u0026#34;url\u0026#34;, \u0026#34;https://example.com\u0026#34;), zap.Int(\u0026#34;status\u0026#34;, 200), ) } 1.3 Sugar Logger 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func main() { logger, _ := zap.NewProduction() defer logger.Sync() sugar := logger.Sugar() // Printf é£æ ¼ sugar.Infof(\u0026#34;User %s logged in\u0026#34;, \u0026#34;alice\u0026#34;) // é”®å€¼å¯¹é£æ ¼ sugar.Infow(\u0026#34;User logged in\u0026#34;, \u0026#34;username\u0026#34;, \u0026#34;alice\u0026#34;, \u0026#34;ip\u0026#34;, \u0026#34;192.168.1.1\u0026#34;, ) // æ¨¡æ¿é£æ ¼ sugar.Debugf(\u0026#34;Request took %dms\u0026#34;, 42) } äºŒã€Logger é…ç½® 2.1 è‡ªå®šä¹‰ Logger 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func NewLogger() *zap.Logger { config := zap.Config{ Level: zap.NewAtomicLevelAt(zap.InfoLevel), Development: false, Encoding: \u0026#34;json\u0026#34;, EncoderConfig: zapcore.EncoderConfig{ TimeKey: \u0026#34;timestamp\u0026#34;, LevelKey: \u0026#34;level\u0026#34;, NameKey: \u0026#34;logger\u0026#34;, CallerKey: \u0026#34;caller\u0026#34;, FunctionKey: zapcore.OmitKey, MessageKey: \u0026#34;message\u0026#34;, StacktraceKey: \u0026#34;stacktrace\u0026#34;, LineEnding: zapcore.DefaultLineEnding, EncodeLevel: zapcore.LowercaseLevelEncoder, EncodeTime: zapcore.ISO8601TimeEncoder, EncodeDuration: zapcore.SecondsDurationEncoder, EncodeCaller: zapcore.ShortCallerEncoder, }, OutputPaths: []string{\u0026#34;stdout\u0026#34;, \u0026#34;/var/log/app.log\u0026#34;}, ErrorOutputPaths: []string{\u0026#34;stderr\u0026#34;}, } logger, err := config.Build() if err != nil { panic(err) } return logger } 2.2 å¤šè¾“å‡ºé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func NewMultiOutputLogger() *zap.Logger { // åˆ›å»º Encoder encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder jsonEncoder := zapcore.NewJSONEncoder(encoderConfig) consoleEncoder := zapcore.NewConsoleEncoder(encoderConfig) // åˆ›å»ºè¾“å‡º consoleOutput := zapcore.Lock(os.Stdout) fileOutput := zapcore.AddSync(\u0026amp;lumberjack.Logger{ Filename: \u0026#34;/var/log/app.log\u0026#34;, MaxSize: 100, // MB MaxBackups: 3, MaxAge: 28, // days Compress: true, }) // åˆ›å»º Core core := zapcore.NewTee( zapcore.NewCore(consoleEncoder, consoleOutput, zap.InfoLevel), zapcore.NewCore(jsonEncoder, fileOutput, zap.InfoLevel), ) return zap.New(core, zap.AddCaller(), zap.AddStacktrace(zap.ErrorLevel)) } 2.3 æ—¥å¿—çº§åˆ« 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // æ—¥å¿—çº§åˆ«ï¼šDebug \u0026lt; Info \u0026lt; Warn \u0026lt; Error \u0026lt; DPanic \u0026lt; Panic \u0026lt; Fatal // åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ« func main() { atomicLevel := zap.NewAtomicLevelAt(zap.InfoLevel) config := zap.Config{ Level: atomicLevel, Encoding: \u0026#34;json\u0026#34;, // ... } logger, _ := config.Build() // è¿è¡Œæ—¶è°ƒæ•´çº§åˆ« atomicLevel.SetLevel(zap.DebugLevel) // é€šè¿‡ HTTP è°ƒæ•´çº§åˆ« http.HandleFunc(\u0026#34;/log/level\u0026#34;, atomicLevel.ServeHTTP) http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil) } // è°ƒç”¨ API ä¿®æ”¹çº§åˆ« // curl -X PUT localhost:8080/log/level -d \u0026#39;{\u0026#34;level\u0026#34;:\u0026#34;debug\u0026#34;}\u0026#39; ä¸‰ã€ç»“æ„åŒ–æ—¥å¿— 3.1 å­—æ®µç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 logger.Info(\u0026#34;User action\u0026#34;, // åŸºæœ¬ç±»å‹ zap.String(\u0026#34;username\u0026#34;, \u0026#34;alice\u0026#34;), zap.Int(\u0026#34;user_id\u0026#34;, 1001), zap.Int64(\u0026#34;timestamp\u0026#34;, time.Now().Unix()), zap.Float64(\u0026#34;duration\u0026#34;, 1.23), zap.Bool(\u0026#34;success\u0026#34;, true), // å¤æ‚ç±»å‹ zap.Strings(\u0026#34;tags\u0026#34;, []string{\u0026#34;vip\u0026#34;, \u0026#34;premium\u0026#34;}), zap.Any(\u0026#34;metadata\u0026#34;, map[string]interface{}{\u0026#34;key\u0026#34;: \u0026#34;value\u0026#34;}), // æ—¶é—´å’ŒæŒç»­æ—¶é—´ zap.Time(\u0026#34;created_at\u0026#34;, time.Now()), zap.Duration(\u0026#34;elapsed\u0026#34;, 100*time.Millisecond), // é”™è¯¯ zap.Error(err), // å‘½åç©ºé—´ zap.Namespace(\u0026#34;request\u0026#34;), zap.String(\u0026#34;method\u0026#34;, \u0026#34;POST\u0026#34;), zap.String(\u0026#34;path\u0026#34;, \u0026#34;/api/users\u0026#34;), ) 3.2 è‡ªå®šä¹‰å­—æ®µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // åˆ›å»ºå¸¦é»˜è®¤å­—æ®µçš„ Logger func NewLoggerWithFields() *zap.Logger { logger, _ := zap.NewProduction() return logger.With( zap.String(\u0026#34;service\u0026#34;, \u0026#34;user-service\u0026#34;), zap.String(\u0026#34;version\u0026#34;, \u0026#34;1.0.0\u0026#34;), zap.String(\u0026#34;env\u0026#34;, os.Getenv(\u0026#34;ENV\u0026#34;)), ) } // ä½¿ç”¨ logger := NewLoggerWithFields() logger.Info(\u0026#34;Server started\u0026#34;, zap.Int(\u0026#34;port\u0026#34;, 8080), ) // è¾“å‡ºï¼š // {\u0026#34;level\u0026#34;:\u0026#34;info\u0026#34;,\u0026#34;timestamp\u0026#34;:\u0026#34;2024-12-15T10:00:00Z\u0026#34;,\u0026#34;service\u0026#34;:\u0026#34;user-service\u0026#34;,\u0026#34;version\u0026#34;:\u0026#34;1.0.0\u0026#34;,\u0026#34;env\u0026#34;:\u0026#34;production\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;Server started\u0026#34;,\u0026#34;port\u0026#34;:8080} 3.3 æ—¥å¿—ä¸Šä¸‹æ–‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // è¯·æ±‚ä¸Šä¸‹æ–‡ Logger func LoggerFromContext(ctx context.Context) *zap.Logger { if logger, ok := ctx.Value(\u0026#34;logger\u0026#34;).(*zap.Logger); ok { return logger } return zap.L() } func WithLogger(ctx context.Context, logger *zap.Logger) context.Context { return context.WithValue(ctx, \u0026#34;logger\u0026#34;, logger) } // åœ¨ä¸­é—´ä»¶ä¸­è®¾ç½® func LoggerMiddleware(logger *zap.Logger) gin.HandlerFunc { return func(c *gin.Context) { requestID := uuid.New().String() // åˆ›å»ºè¯·æ±‚çº§åˆ«çš„ Logger requestLogger := logger.With( zap.String(\u0026#34;request_id\u0026#34;, requestID), zap.String(\u0026#34;method\u0026#34;, c.Request.Method), zap.String(\u0026#34;path\u0026#34;, c.Request.URL.Path), zap.String(\u0026#34;client_ip\u0026#34;, c.ClientIP()), ) // å­˜å…¥ä¸Šä¸‹æ–‡ ctx := WithLogger(c.Request.Context(), requestLogger) c.Request = c.Request.WithContext(ctx) c.Next() } } // åœ¨ Handler ä¸­ä½¿ç”¨ func GetUserHandler(c *gin.Context) { logger := LoggerFromContext(c.Request.Context()) logger.Info(\u0026#34;Getting user\u0026#34;, zap.String(\u0026#34;user_id\u0026#34;, c.Param(\u0026#34;id\u0026#34;)), ) // ä¸šåŠ¡é€»è¾‘... } å››ã€Gin é›†æˆ 4.1 è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func GinLogger(logger *zap.Logger) gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() path := c.Request.URL.Path query := c.Request.URL.RawQuery c.Next() cost := time.Since(start) logger.Info(\u0026#34;HTTP Request\u0026#34;, zap.Int(\u0026#34;status\u0026#34;, c.Writer.Status()), zap.String(\u0026#34;method\u0026#34;, c.Request.Method), zap.String(\u0026#34;path\u0026#34;, path), zap.String(\u0026#34;query\u0026#34;, query), zap.String(\u0026#34;ip\u0026#34;, c.ClientIP()), zap.String(\u0026#34;user-agent\u0026#34;, c.Request.UserAgent()), zap.String(\u0026#34;errors\u0026#34;, c.Errors.ByType(gin.ErrorTypePrivate).String()), zap.Duration(\u0026#34;cost\u0026#34;, cost), ) } } 4.2 Recovery ä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 func GinRecovery(logger *zap.Logger) gin.HandlerFunc { return func(c *gin.Context) { defer func() { if err := recover(); err != nil { // è·å–å †æ ˆä¿¡æ¯ var brokenPipe bool if ne, ok := err.(*net.OpError); ok { if se, ok := ne.Err.(*os.SyscallError); ok { if strings.Contains(strings.ToLower(se.Error()), \u0026#34;broken pipe\u0026#34;) { brokenPipe = true } } } httpRequest, _ := httputil.DumpRequest(c.Request, false) if brokenPipe { logger.Error(\u0026#34;Broken pipe\u0026#34;, zap.Any(\u0026#34;error\u0026#34;, err), zap.String(\u0026#34;request\u0026#34;, string(httpRequest)), ) c.Error(err.(error)) c.Abort() return } logger.Error(\u0026#34;Recovery from panic\u0026#34;, zap.Any(\u0026#34;error\u0026#34;, err), zap.String(\u0026#34;request\u0026#34;, string(httpRequest)), zap.String(\u0026#34;stack\u0026#34;, string(debug.Stack())), ) c.AbortWithStatus(http.StatusInternalServerError) } }() c.Next() } } 4.3 å®Œæ•´é…ç½® 1 2 3 4 5 6 7 8 9 10 11 func SetupRouter(logger *zap.Logger) *gin.Engine { gin.SetMode(gin.ReleaseMode) r := gin.New() // ä½¿ç”¨è‡ªå®šä¹‰ä¸­é—´ä»¶ r.Use(GinLogger(logger)) r.Use(GinRecovery(logger)) return r } äº”ã€æ—¥å¿—è½®è½¬ 5.1 ä½¿ç”¨ Lumberjack 1 go get -u gopkg.in/natefinch/lumberjack.v2 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 import \u0026#34;gopkg.in/natefinch/lumberjack.v2\u0026#34; func NewLoggerWithRotation() *zap.Logger { // æ–‡ä»¶è½®è½¬é…ç½® lumberJackLogger := \u0026amp;lumberjack.Logger{ Filename: \u0026#34;/var/log/app.log\u0026#34;, MaxSize: 100, // MB MaxBackups: 5, // ä¿ç•™æ—§æ–‡ä»¶æ•°é‡ MaxAge: 30, // ä¿ç•™å¤©æ•° Compress: true, // å‹ç¼©æ—§æ–‡ä»¶ LocalTime: true, // ä½¿ç”¨æœ¬åœ°æ—¶é—´ } encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder core := zapcore.NewCore( zapcore.NewJSONEncoder(encoderConfig), zapcore.AddSync(lumberJackLogger), zap.InfoLevel, ) return zap.New(core, zap.AddCaller()) } 5.2 æŒ‰æ—¥æœŸè½®è½¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import \u0026#34;github.com/lestrrat-go/file-rotatelogs\u0026#34; func NewLoggerWithDailyRotation() *zap.Logger { // æŒ‰æ—¥æœŸè½®è½¬ writer, _ := rotatelogs.New( \u0026#34;/var/log/app.%Y%m%d.log\u0026#34;, rotatelogs.WithLinkName(\u0026#34;/var/log/app.log\u0026#34;), rotatelogs.WithMaxAge(7*24*time.Hour), rotatelogs.WithRotationTime(24*time.Hour), ) encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder core := zapcore.NewCore( zapcore.NewJSONEncoder(encoderConfig), zapcore.AddSync(writer), zap.InfoLevel, ) return zap.New(core, zap.AddCaller()) } å…­ã€é”™è¯¯æ—¥å¿— 6.1 é”™è¯¯åŒ…è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import \u0026#34;github.com/pkg/errors\u0026#34; func GetUser(id int64) (*User, error) { user, err := db.QueryUser(id) if err != nil { return nil, errors.Wrapf(err, \u0026#34;failed to get user %d\u0026#34;, id) } return user, nil } func HandleRequest(c *gin.Context) { logger := LoggerFromContext(c.Request.Context()) user, err := GetUser(1001) if err != nil { logger.Error(\u0026#34;Failed to get user\u0026#34;, zap.Error(err), zap.String(\u0026#34;stack\u0026#34;, fmt.Sprintf(\u0026#34;%+v\u0026#34;, err)), ) c.JSON(500, gin.H{\u0026#34;error\u0026#34;: \u0026#34;internal error\u0026#34;}) return } c.JSON(200, user) } 6.2 é”™è¯¯é‡‡æ · 1 2 3 4 5 6 7 8 9 10 11 12 func NewSampledLogger() *zap.Logger { config := zap.NewProductionConfig() // é”™è¯¯æ—¥å¿—é‡‡æ ·ï¼šåˆå§‹ 100 æ¡åï¼Œæ¯ç§’æœ€å¤š 100 æ¡ config.Sampling = \u0026amp;zap.SamplingConfig{ Initial: 100, Thereafter: 100, } logger, _ := config.Build() return logger } ä¸ƒã€æ€§èƒ½ä¼˜åŒ– 7.1 ä½¿ç”¨ Check æ–¹æ³• 1 2 3 4 5 6 // é¿å…ä¸å¿…è¦çš„æ—¥å¿—æ„å»º if ce := logger.Check(zap.DebugLevel, \u0026#34;expensive operation\u0026#34;); ce != nil { ce.Write( zap.String(\u0026#34;detail\u0026#34;, expensiveComputation()), ) } 7.2 å¯¹è±¡æ±  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // Zap å†…éƒ¨å·²ç»ä½¿ç”¨äº†å¯¹è±¡æ± ï¼Œä½†å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ– var loggerPool = sync.Pool{ New: func() interface{} { return \u0026amp;bytes.Buffer{} }, } func LogWithPool(logger *zap.Logger, msg string, fields ...zap.Field) { buf := loggerPool.Get().(*bytes.Buffer) defer func() { buf.Reset() loggerPool.Put(buf) }() // ä½¿ç”¨ buf è¿›è¡Œæ—¥å¿—æ ¼å¼åŒ– logger.Info(msg, fields...) } 7.3 å¼‚æ­¥æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func NewAsyncLogger() *zap.Logger { // åˆ›å»ºå¸¦ç¼“å†²çš„å†™å…¥å™¨ asyncWriter := \u0026amp;zapcore.BufferedWriteSyncer{ WS: zapcore.AddSync(os.Stdout), Size: 256 * 1024, // 256KB ç¼“å†² FlushInterval: time.Second, } encoderConfig := zap.NewProductionEncoderConfig() core := zapcore.NewCore( zapcore.NewJSONEncoder(encoderConfig), asyncWriter, zap.InfoLevel, ) return zap.New(core) } å…«ã€å…¨å±€ Logger 8.1 è®¾ç½®å…¨å±€ Logger 1 2 3 4 5 6 7 8 9 10 func init() { logger, _ := zap.NewProduction() zap.ReplaceGlobals(logger) } func main() { // ä½¿ç”¨å…¨å±€ Logger zap.L().Info(\u0026#34;Using global logger\u0026#34;) zap.S().Infof(\u0026#34;Using global sugar logger: %s\u0026#34;, \u0026#34;hello\u0026#34;) } 8.2 Logger å°è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package log import ( \u0026#34;go.uber.org/zap\u0026#34; \u0026#34;go.uber.org/zap/zapcore\u0026#34; ) var logger *zap.Logger var sugar *zap.SugaredLogger func Init(env string) { var err error if env == \u0026#34;production\u0026#34; { logger, err = zap.NewProduction() } else { logger, err = zap.NewDevelopment() } if err != nil { panic(err) } sugar = logger.Sugar() } func Info(msg string, fields ...zap.Field) { logger.Info(msg, fields...) } func Error(msg string, fields ...zap.Field) { logger.Error(msg, fields...) } func Debug(msg string, fields ...zap.Field) { logger.Debug(msg, fields...) } func Warn(msg string, fields ...zap.Field) { logger.Warn(msg, fields...) } func With(fields ...zap.Field) *zap.Logger { return logger.With(fields...) } func Sync() { logger.Sync() } ä¹ã€ç”Ÿäº§ç¯å¢ƒé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 func NewProductionLogger() *zap.Logger { // Encoder é…ç½® encoderConfig := zapcore.EncoderConfig{ TimeKey: \u0026#34;timestamp\u0026#34;, LevelKey: \u0026#34;level\u0026#34;, NameKey: \u0026#34;logger\u0026#34;, CallerKey: \u0026#34;caller\u0026#34;, FunctionKey: zapcore.OmitKey, MessageKey: \u0026#34;message\u0026#34;, StacktraceKey: \u0026#34;stacktrace\u0026#34;, LineEnding: zapcore.DefaultLineEnding, EncodeLevel: zapcore.LowercaseLevelEncoder, EncodeTime: zapcore.ISO8601TimeEncoder, EncodeDuration: zapcore.MillisDurationEncoder, EncodeCaller: zapcore.ShortCallerEncoder, } // æ–‡ä»¶è½®è½¬ fileWriter := \u0026amp;lumberjack.Logger{ Filename: \u0026#34;/var/log/app/app.log\u0026#34;, MaxSize: 100, MaxBackups: 10, MaxAge: 30, Compress: true, } // å¤šè¾“å‡º core := zapcore.NewTee( // æ§åˆ¶å°ï¼šInfo çº§åˆ«ä»¥ä¸Š zapcore.NewCore( zapcore.NewConsoleEncoder(encoderConfig), zapcore.Lock(os.Stdout), zap.InfoLevel, ), // æ–‡ä»¶ï¼šæ‰€æœ‰æ—¥å¿— zapcore.NewCore( zapcore.NewJSONEncoder(encoderConfig), zapcore.AddSync(fileWriter), zap.DebugLevel, ), // é”™è¯¯æ–‡ä»¶ï¼šError çº§åˆ«ä»¥ä¸Š zapcore.NewCore( zapcore.NewJSONEncoder(encoderConfig), zapcore.AddSync(\u0026amp;lumberjack.Logger{ Filename: \u0026#34;/var/log/app/error.log\u0026#34;, MaxSize: 100, MaxBackups: 10, MaxAge: 30, Compress: true, }), zap.ErrorLevel, ), ) return zap.New(core, zap.AddCaller(), zap.AddStacktrace(zap.ErrorLevel), zap.Fields( zap.String(\u0026#34;service\u0026#34;, \u0026#34;my-service\u0026#34;), zap.String(\u0026#34;version\u0026#34;, \u0026#34;1.0.0\u0026#34;), ), ) } æ€»ç»“ Zap æ˜¯ Go è¯­è¨€ä¸­æ€§èƒ½æœ€å¥½çš„æ—¥å¿—åº“ä¹‹ä¸€ï¼Œé€šè¿‡åˆç†çš„é…ç½®å¯ä»¥æ»¡è¶³å„ç§åœºæ™¯çš„éœ€æ±‚ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nâš¡ æè‡´çš„æ—¥å¿—æ€§èƒ½ ğŸ“Š å¼ºå¤§çš„ç»“æ„åŒ–æ—¥å¿— ğŸ”§ çµæ´»çš„é…ç½®é€‰é¡¹ ğŸ“ å®Œå–„çš„æ—¥å¿—è½®è½¬ ğŸ­ é€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Incoming (Background Agent changes)\n","date":"2025-10-27T00:00:00Z","permalink":"https://zpf-zero.github.io/p/zap-guide/","title":"Zap æ—¥å¿—åº“å®æˆ˜ï¼šGo é«˜æ€§èƒ½æ—¥å¿—è®°å½•æœ€ä½³å®è·µ"},{"content":"å‰è¨€ Axios æ˜¯åŸºäº Promise çš„ HTTP å®¢æˆ·ç«¯ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨å’Œ Node.js ä¸­ä½¿ç”¨ã€‚å®ƒæä¾›äº†ç®€æ´çš„ APIã€è‡ªåŠ¨è½¬æ¢ JSONã€æ‹¦æˆªå™¨ç­‰åŠŸèƒ½ï¼Œæ˜¯å‰ç«¯é¡¹ç›®ä¸­æœ€æµè¡Œçš„ HTTP åº“ã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£… 1 npm install axios 1.2 åŸºæœ¬ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 import axios from \u0026#39;axios\u0026#39; // GET è¯·æ±‚ const response = await axios.get(\u0026#39;/api/users\u0026#39;) // å¸¦å‚æ•°çš„ GET const users = await axios.get(\u0026#39;/api/users\u0026#39;, { params: { page: 1, limit: 10 } }) // POST è¯·æ±‚ const newUser = await axios.post(\u0026#39;/api/users\u0026#39;, { name: \u0026#39;Alice\u0026#39;, email: \u0026#39;alice@example.com\u0026#39; }) // PUT è¯·æ±‚ await axios.put(\u0026#39;/api/users/1\u0026#39;, { name: \u0026#39;Bob\u0026#39; }) // DELETE è¯·æ±‚ await axios.delete(\u0026#39;/api/users/1\u0026#39;) // PATCH è¯·æ±‚ await axios.patch(\u0026#39;/api/users/1\u0026#39;, { name: \u0026#39;Charlie\u0026#39; }) äºŒã€è¯·æ±‚é…ç½® 2.1 é…ç½®é€‰é¡¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 const config = { // URL url: \u0026#39;/api/users\u0026#39;, // è¯·æ±‚æ–¹æ³• method: \u0026#39;post\u0026#39;, // åŸºç¡€ URL baseURL: \u0026#39;https://api.example.com\u0026#39;, // è¯·æ±‚å¤´ headers: { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;, \u0026#39;Authorization\u0026#39;: \u0026#39;Bearer token\u0026#39;, }, // URL å‚æ•° params: { page: 1, limit: 10, }, // è¯·æ±‚ä½“ data: { name: \u0026#39;Alice\u0026#39;, }, // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ timeout: 5000, // å“åº”ç±»å‹ responseType: \u0026#39;json\u0026#39;, // \u0026#39;arraybuffer\u0026#39; | \u0026#39;blob\u0026#39; | \u0026#39;document\u0026#39; | \u0026#39;json\u0026#39; | \u0026#39;text\u0026#39; | \u0026#39;stream\u0026#39; // å‡­è¯ withCredentials: false, // ä¸Šä¼ /ä¸‹è½½è¿›åº¦ onUploadProgress: (progressEvent) =\u0026gt; { const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total!) console.log(`Upload: ${percent}%`) }, onDownloadProgress: (progressEvent) =\u0026gt; { const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total!) console.log(`Download: ${percent}%`) }, // å–æ¶ˆä»¤ç‰Œ signal: controller.signal, } const response = await axios(config) 2.2 åˆ›å»ºå®ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 // utils/request.ts import axios from \u0026#39;axios\u0026#39; import type { AxiosInstance, AxiosRequestConfig, AxiosResponse } from \u0026#39;axios\u0026#39; const instance: AxiosInstance = axios.create({ baseURL: import.meta.env.VITE_API_URL, timeout: 10000, headers: { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;, }, }) export default instance ä¸‰ã€æ‹¦æˆªå™¨ 3.1 è¯·æ±‚æ‹¦æˆªå™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // è¯·æ±‚æ‹¦æˆªå™¨ instance.interceptors.request.use( (config) =\u0026gt; { // æ·»åŠ  token const token = localStorage.getItem(\u0026#39;token\u0026#39;) if (token) { config.headers.Authorization = `Bearer ${token}` } // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜ if (config.method === \u0026#39;get\u0026#39;) { config.params = { ...config.params, _t: Date.now(), } } return config }, (error) =\u0026gt; { return Promise.reject(error) } ) 3.2 å“åº”æ‹¦æˆªå™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 // å“åº”æ‹¦æˆªå™¨ instance.interceptors.response.use( (response: AxiosResponse) =\u0026gt; { const { data } = response // æ ¹æ®ä¸šåŠ¡çŠ¶æ€ç å¤„ç† if (data.code === 0) { return data.data } // ä¸šåŠ¡é”™è¯¯ if (data.code === 401) { // ç™»å½•è¿‡æœŸ localStorage.removeItem(\u0026#39;token\u0026#39;) window.location.href = \u0026#39;/login\u0026#39; return Promise.reject(new Error(\u0026#39;ç™»å½•è¿‡æœŸ\u0026#39;)) } return Promise.reject(new Error(data.message || \u0026#39;è¯·æ±‚å¤±è´¥\u0026#39;)) }, (error) =\u0026gt; { // HTTP é”™è¯¯å¤„ç† if (error.response) { const { status, data } = error.response switch (status) { case 400: console.error(\u0026#39;è¯·æ±‚å‚æ•°é”™è¯¯\u0026#39;) break case 401: console.error(\u0026#39;æœªæˆæƒï¼Œè¯·ç™»å½•\u0026#39;) localStorage.removeItem(\u0026#39;token\u0026#39;) window.location.href = \u0026#39;/login\u0026#39; break case 403: console.error(\u0026#39;æ‹’ç»è®¿é—®\u0026#39;) break case 404: console.error(\u0026#39;è¯·æ±‚åœ°å€ä¸å­˜åœ¨\u0026#39;) break case 500: console.error(\u0026#39;æœåŠ¡å™¨å†…éƒ¨é”™è¯¯\u0026#39;) break default: console.error(`HTTP Error: ${status}`) } } else if (error.request) { // è¯·æ±‚å·²å‘é€ä½†æœªæ”¶åˆ°å“åº” console.error(\u0026#39;ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥\u0026#39;) } else { // è¯·æ±‚é…ç½®é”™è¯¯ console.error(\u0026#39;è¯·æ±‚é…ç½®é”™è¯¯:\u0026#39;, error.message) } return Promise.reject(error) } ) å››ã€é”™è¯¯å¤„ç† 4.1 ç»Ÿä¸€é”™è¯¯å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // utils/errorHandler.ts import { ElMessage } from \u0026#39;element-plus\u0026#39; interface ApiError { code: number message: string data?: any } export class RequestError extends Error { code: number data?: any constructor(error: ApiError) { super(error.message) this.code = error.code this.data = error.data this.name = \u0026#39;RequestError\u0026#39; } } export function handleError(error: any) { if (error instanceof RequestError) { ElMessage.error(error.message) } else if (error.response) { ElMessage.error(`æœåŠ¡å™¨é”™è¯¯: ${error.response.status}`) } else if (error.request) { ElMessage.error(\u0026#39;ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ\u0026#39;) } else { ElMessage.error(\u0026#39;è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•\u0026#39;) } } 4.2 é‡è¯•æœºåˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 import axios from \u0026#39;axios\u0026#39; import type { AxiosInstance, AxiosRequestConfig } from \u0026#39;axios\u0026#39; interface RetryConfig extends AxiosRequestConfig { retries?: number retryDelay?: number retryCondition?: (error: any) =\u0026gt; boolean } const retryRequest = async ( instance: AxiosInstance, config: RetryConfig ): Promise\u0026lt;any\u0026gt; =\u0026gt; { const { retries = 3, retryDelay = 1000, retryCondition = (error) =\u0026gt; error.response?.status \u0026gt;= 500, ...axiosConfig } = config let lastError: any for (let i = 0; i \u0026lt;= retries; i++) { try { return await instance(axiosConfig) } catch (error: any) { lastError = error if (i \u0026lt; retries \u0026amp;\u0026amp; retryCondition(error)) { await new Promise(resolve =\u0026gt; setTimeout(resolve, retryDelay * (i + 1))) console.log(`Retry attempt ${i + 1}/${retries}`) } else { throw error } } } throw lastError } äº”ã€å–æ¶ˆè¯·æ±‚ 5.1 ä½¿ç”¨ AbortController 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // åˆ›å»ºæ§åˆ¶å™¨ const controller = new AbortController() // å‘é€è¯·æ±‚ const fetchData = async () =\u0026gt; { try { const response = await axios.get(\u0026#39;/api/data\u0026#39;, { signal: controller.signal, }) return response.data } catch (error) { if (axios.isCancel(error)) { console.log(\u0026#39;Request canceled:\u0026#39;, error.message) } throw error } } // å–æ¶ˆè¯·æ±‚ controller.abort() 5.2 è¯·æ±‚å»é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // utils/cancelToken.ts const pendingRequests = new Map\u0026lt;string, AbortController\u0026gt;() const generateRequestKey = (config: AxiosRequestConfig): string =\u0026gt; { const { method, url, params, data } = config return [method, url, JSON.stringify(params), JSON.stringify(data)].join(\u0026#39;\u0026amp;\u0026#39;) } export const addPendingRequest = (config: AxiosRequestConfig) =\u0026gt; { const key = generateRequestKey(config) // å–æ¶ˆä¹‹å‰çš„ç›¸åŒè¯·æ±‚ if (pendingRequests.has(key)) { pendingRequests.get(key)!.abort() } // åˆ›å»ºæ–°çš„æ§åˆ¶å™¨ const controller = new AbortController() config.signal = controller.signal pendingRequests.set(key, controller) } export const removePendingRequest = (config: AxiosRequestConfig) =\u0026gt; { const key = generateRequestKey(config) pendingRequests.delete(key) } // åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨ instance.interceptors.request.use((config) =\u0026gt; { addPendingRequest(config) return config }) instance.interceptors.response.use( (response) =\u0026gt; { removePendingRequest(response.config) return response }, (error) =\u0026gt; { if (!axios.isCancel(error)) { removePendingRequest(error.config) } return Promise.reject(error) } ) å…­ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ 6.1 æ–‡ä»¶ä¸Šä¼  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // å•æ–‡ä»¶ä¸Šä¼  const uploadFile = async (file: File) =\u0026gt; { const formData = new FormData() formData.append(\u0026#39;file\u0026#39;, file) const response = await axios.post(\u0026#39;/api/upload\u0026#39;, formData, { headers: { \u0026#39;Content-Type\u0026#39;: \u0026#39;multipart/form-data\u0026#39;, }, onUploadProgress: (progressEvent) =\u0026gt; { const percent = Math.round( (progressEvent.loaded * 100) / progressEvent.total! ) console.log(`Upload progress: ${percent}%`) }, }) return response.data } // å¤šæ–‡ä»¶ä¸Šä¼  const uploadFiles = async (files: File[]) =\u0026gt; { const formData = new FormData() files.forEach((file, index) =\u0026gt; { formData.append(`files`, file) }) return axios.post(\u0026#39;/api/upload-multiple\u0026#39;, formData, { headers: { \u0026#39;Content-Type\u0026#39;: \u0026#39;multipart/form-data\u0026#39; }, }) } 6.2 æ–‡ä»¶ä¸‹è½½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // ä¸‹è½½æ–‡ä»¶ const downloadFile = async (url: string, filename: string) =\u0026gt; { const response = await axios.get(url, { responseType: \u0026#39;blob\u0026#39;, onDownloadProgress: (progressEvent) =\u0026gt; { const percent = Math.round( (progressEvent.loaded * 100) / progressEvent.total! ) console.log(`Download progress: ${percent}%`) }, }) // åˆ›å»ºä¸‹è½½é“¾æ¥ const blob = new Blob([response.data]) const link = document.createElement(\u0026#39;a\u0026#39;) link.href = URL.createObjectURL(blob) link.download = filename link.click() URL.revokeObjectURL(link.href) } // ä»å“åº”å¤´è·å–æ–‡ä»¶å const downloadWithFilename = async (url: string) =\u0026gt; { const response = await axios.get(url, { responseType: \u0026#39;blob\u0026#39; }) const contentDisposition = response.headers[\u0026#39;content-disposition\u0026#39;] const filenameMatch = contentDisposition?.match(/filename=\u0026#34;?(.+)\u0026#34;?/) const filename = filenameMatch ? filenameMatch[1] : \u0026#39;download\u0026#39; // ... ä¸‹è½½é€»è¾‘ } ä¸ƒã€å®Œæ•´å°è£… 7.1 TypeScript å°è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 // utils/request.ts import axios from \u0026#39;axios\u0026#39; import type { AxiosInstance, AxiosRequestConfig, AxiosResponse, InternalAxiosRequestConfig, } from \u0026#39;axios\u0026#39; import { ElMessage, ElLoading } from \u0026#39;element-plus\u0026#39; // å“åº”æ•°æ®ç±»å‹ interface ApiResponse\u0026lt;T = any\u0026gt; { code: number message: string data: T } // è¯·æ±‚é…ç½®æ‰©å±• interface RequestConfig extends AxiosRequestConfig { loading?: boolean showError?: boolean } class Request { private instance: AxiosInstance private loadingInstance: any = null private loadingCount = 0 constructor(config: AxiosRequestConfig) { this.instance = axios.create(config) this.setupInterceptors() } private setupInterceptors() { // è¯·æ±‚æ‹¦æˆªå™¨ this.instance.interceptors.request.use( (config: InternalAxiosRequestConfig) =\u0026gt; { const token = localStorage.getItem(\u0026#39;token\u0026#39;) if (token) { config.headers.Authorization = `Bearer ${token}` } return config }, (error) =\u0026gt; Promise.reject(error) ) // å“åº”æ‹¦æˆªå™¨ this.instance.interceptors.response.use( (response: AxiosResponse\u0026lt;ApiResponse\u0026gt;) =\u0026gt; { const { data } = response if (data.code === 0) { return data.data } return Promise.reject(new Error(data.message)) }, (error) =\u0026gt; { const message = error.response?.data?.message || \u0026#39;ç½‘ç»œé”™è¯¯\u0026#39; return Promise.reject(new Error(message)) } ) } private showLoading() { if (this.loadingCount === 0) { this.loadingInstance = ElLoading.service({ lock: true, text: \u0026#39;åŠ è½½ä¸­...\u0026#39;, background: \u0026#39;rgba(0, 0, 0, 0.7)\u0026#39;, }) } this.loadingCount++ } private hideLoading() { this.loadingCount-- if (this.loadingCount === 0) { this.loadingInstance?.close() } } async request\u0026lt;T\u0026gt;(config: RequestConfig): Promise\u0026lt;T\u0026gt; { const { loading = false, showError = true, ...axiosConfig } = config if (loading) this.showLoading() try { const response = await this.instance.request\u0026lt;any, T\u0026gt;(axiosConfig) return response } catch (error: any) { if (showError) { ElMessage.error(error.message) } throw error } finally { if (loading) this.hideLoading() } } get\u0026lt;T\u0026gt;(url: string, config?: RequestConfig): Promise\u0026lt;T\u0026gt; { return this.request\u0026lt;T\u0026gt;({ ...config, url, method: \u0026#39;GET\u0026#39; }) } post\u0026lt;T\u0026gt;(url: string, data?: any, config?: RequestConfig): Promise\u0026lt;T\u0026gt; { return this.request\u0026lt;T\u0026gt;({ ...config, url, data, method: \u0026#39;POST\u0026#39; }) } put\u0026lt;T\u0026gt;(url: string, data?: any, config?: RequestConfig): Promise\u0026lt;T\u0026gt; { return this.request\u0026lt;T\u0026gt;({ ...config, url, data, method: \u0026#39;PUT\u0026#39; }) } delete\u0026lt;T\u0026gt;(url: string, config?: RequestConfig): Promise\u0026lt;T\u0026gt; { return this.request\u0026lt;T\u0026gt;({ ...config, url, method: \u0026#39;DELETE\u0026#39; }) } patch\u0026lt;T\u0026gt;(url: string, data?: any, config?: RequestConfig): Promise\u0026lt;T\u0026gt; { return this.request\u0026lt;T\u0026gt;({ ...config, url, data, method: \u0026#39;PATCH\u0026#39; }) } } export const request = new Request({ baseURL: import.meta.env.VITE_API_URL, timeout: 10000, }) export default request 7.2 API æ¨¡å—åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // api/user.ts import request from \u0026#39;@/utils/request\u0026#39; export interface User { id: number name: string email: string } export interface LoginParams { username: string password: string } export interface LoginResult { token: string user: User } export const userApi = { // ç™»å½• login(params: LoginParams) { return request.post\u0026lt;LoginResult\u0026gt;(\u0026#39;/auth/login\u0026#39;, params) }, // è·å–ç”¨æˆ·ä¿¡æ¯ getProfile() { return request.get\u0026lt;User\u0026gt;(\u0026#39;/user/profile\u0026#39;) }, // è·å–ç”¨æˆ·åˆ—è¡¨ getList(params: { page: number; limit: number }) { return request.get\u0026lt;{ list: User[]; total: number }\u0026gt;(\u0026#39;/users\u0026#39;, { params }) }, // åˆ›å»ºç”¨æˆ· create(data: Omit\u0026lt;User, \u0026#39;id\u0026#39;\u0026gt;) { return request.post\u0026lt;User\u0026gt;(\u0026#39;/users\u0026#39;, data) }, // æ›´æ–°ç”¨æˆ· update(id: number, data: Partial\u0026lt;User\u0026gt;) { return request.put\u0026lt;User\u0026gt;(`/users/${id}`, data) }, // åˆ é™¤ç”¨æˆ· delete(id: number) { return request.delete\u0026lt;void\u0026gt;(`/users/${id}`) }, } 7.3 ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, onMounted } from \u0026#39;vue\u0026#39; import { userApi, type User } from \u0026#39;@/api/user\u0026#39; const users = ref\u0026lt;User[]\u0026gt;([]) const loading = ref(false) const fetchUsers = async () =\u0026gt; { loading.value = true try { const { list } = await userApi.getList({ page: 1, limit: 10 }) users.value = list } finally { loading.value = false } } const createUser = async () =\u0026gt; { const user = await userApi.create({ name: \u0026#39;New User\u0026#39;, email: \u0026#39;new@example.com\u0026#39;, }) users.value.push(user) } onMounted(fetchUsers) \u0026lt;/script\u0026gt; æ€»ç»“ Axios æ˜¯åŠŸèƒ½å¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„ HTTP å®¢æˆ·ç«¯ï¼Œé€šè¿‡åˆç†å°è£…å¯ä»¥å¤§å¤§æé«˜å¼€å‘æ•ˆç‡ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ”§ çµæ´»çš„è¯·æ±‚é…ç½® ğŸ¯ å¼ºå¤§çš„æ‹¦æˆªå™¨æœºåˆ¶ âŒ å®Œå–„çš„é”™è¯¯å¤„ç† ğŸ“ æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ”¯æŒ ğŸ“¦ TypeScript ç±»å‹æ”¯æŒ Incoming (Background Agent changes)\n","date":"2025-10-15T00:00:00Z","permalink":"https://zpf-zero.github.io/p/axios-guide/","title":"Axios å®æˆ˜æŒ‡å—ï¼šç°ä»£ HTTP å®¢æˆ·ç«¯æœ€ä½³å®è·µ"},{"content":"å‰è¨€ ClickHouse æ˜¯ä¿„ç½—æ–¯ Yandex å¼€æºçš„åˆ—å¼æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œä¸“ä¸º OLAPï¼ˆåœ¨çº¿åˆ†æå¤„ç†ï¼‰åœºæ™¯è®¾è®¡ã€‚å®ƒå…·æœ‰æé«˜çš„æŸ¥è¯¢æ€§èƒ½ï¼Œå¯ä»¥åœ¨å•æœºä¸Šæ¯ç§’å¤„ç†æ•°åäº¿è¡Œæ•°æ®ã€‚\nä¸€ã€æ ¸å¿ƒç‰¹æ€§ 1.1 åˆ—å¼å­˜å‚¨ 1 2 3 4 5 6 7 8 è¡Œå¼å­˜å‚¨ (MySQL): Row 1: [id, name, age, city] Row 2: [id, name, age, city] åˆ—å¼å­˜å‚¨ (ClickHouse): Column id: [1, 2, 3, ...] Column name: [Alice, Bob, ...] Column age: [25, 30, ...] 1.2 ä¼˜åŠ¿ é«˜å‹ç¼©æ¯”ï¼šç›¸åŒç±»å‹æ•°æ®å‹ç¼©æ•ˆæœæ›´å¥½ å‘é‡åŒ–æ‰§è¡Œï¼šæ‰¹é‡å¤„ç†æ•°æ® ç¨€ç–ç´¢å¼•ï¼šå¿«é€Ÿå®šä½æ•°æ®å— åˆ†å¸ƒå¼æ¶æ„ï¼šæ”¯æŒæ°´å¹³æ‰©å±• äºŒã€å¿«é€Ÿéƒ¨ç½² 2.1 Docker éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 version: \u0026#39;3.8\u0026#39; services: clickhouse: image: clickhouse/clickhouse-server:latest ports: - \u0026#34;8123:8123\u0026#34; # HTTP - \u0026#34;9000:9000\u0026#34; # Native volumes: - ./data:/var/lib/clickhouse - ./config:/etc/clickhouse-server/config.d environment: - CLICKHOUSE_DB=default - CLICKHOUSE_USER=default - CLICKHOUSE_PASSWORD=password 2.2 è¿æ¥æ•°æ®åº“ 1 2 3 4 5 # CLI è¿æ¥ clickhouse-client --host localhost --port 9000 # HTTP æ¥å£ curl \u0026#39;http://localhost:8123/?query=SELECT%201\u0026#39; ä¸‰ã€è¡¨å¼•æ“ 3.1 MergeTree å®¶æ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 -- åŸºç¡€ MergeTree CREATE TABLE events ( event_date Date, event_time DateTime, user_id UInt64, event_type String, properties String ) ENGINE = MergeTree() PARTITION BY toYYYYMM(event_date) ORDER BY (event_date, user_id, event_time) SETTINGS index_granularity = 8192; -- ReplacingMergeTreeï¼ˆå»é‡ï¼‰ CREATE TABLE users ( user_id UInt64, name String, email String, updated_at DateTime ) ENGINE = ReplacingMergeTree(updated_at) ORDER BY user_id; -- SummingMergeTreeï¼ˆèšåˆï¼‰ CREATE TABLE daily_stats ( date Date, user_id UInt64, page_views UInt64, clicks UInt64 ) ENGINE = SummingMergeTree((page_views, clicks)) PARTITION BY toYYYYMM(date) ORDER BY (date, user_id); -- AggregatingMergeTreeï¼ˆé«˜çº§èšåˆï¼‰ CREATE TABLE user_stats ( user_id UInt64, visits AggregateFunction(sum, UInt64), unique_pages AggregateFunction(uniq, String) ) ENGINE = AggregatingMergeTree() ORDER BY user_id; 3.2 Log ç³»åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 -- TinyLogï¼ˆå°æ•°æ®é›†ï¼‰ CREATE TABLE temp_log ( id UInt64, message String ) ENGINE = TinyLog; -- Logï¼ˆä¸­ç­‰æ•°æ®é›†ï¼‰ CREATE TABLE access_log ( timestamp DateTime, ip String, path String ) ENGINE = Log; 3.3 ç‰¹æ®Šå¼•æ“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 -- Bufferï¼ˆç¼“å†²å†™å…¥ï¼‰ CREATE TABLE buffer_events AS events ENGINE = Buffer(default, events, 16, 10, 100, 10000, 1000000, 10000000, 100000000); -- Kafka å¼•æ“ CREATE TABLE kafka_events ( event_time DateTime, user_id UInt64, event_type String ) ENGINE = Kafka SETTINGS kafka_broker_list = \u0026#39;kafka:9092\u0026#39;, kafka_topic_list = \u0026#39;events\u0026#39;, kafka_group_name = \u0026#39;clickhouse\u0026#39;, kafka_format = \u0026#39;JSONEachRow\u0026#39;; -- ç‰©åŒ–è§†å›¾ CREATE MATERIALIZED VIEW events_mv TO events AS SELECT * FROM kafka_events; å››ã€SQL è¯­æ³• 4.1 æ•°æ®æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 -- æ’å…¥æ•°æ® INSERT INTO events VALUES (\u0026#39;2024-01-01\u0026#39;, \u0026#39;2024-01-01 10:00:00\u0026#39;, 1001, \u0026#39;click\u0026#39;, \u0026#39;{}\u0026#39;), (\u0026#39;2024-01-01\u0026#39;, \u0026#39;2024-01-01 10:01:00\u0026#39;, 1002, \u0026#39;view\u0026#39;, \u0026#39;{}\u0026#39;); -- æ‰¹é‡æ’å…¥ INSERT INTO events FORMAT JSONEachRow {\u0026#34;event_date\u0026#34;: \u0026#34;2024-01-01\u0026#34;, \u0026#34;user_id\u0026#34;: 1001, \u0026#34;event_type\u0026#34;: \u0026#34;click\u0026#34;} {\u0026#34;event_date\u0026#34;: \u0026#34;2024-01-01\u0026#34;, \u0026#34;user_id\u0026#34;: 1002, \u0026#34;event_type\u0026#34;: \u0026#34;view\u0026#34;} -- ä»æ–‡ä»¶å¯¼å…¥ clickhouse-client --query \u0026#34;INSERT INTO events FORMAT CSV\u0026#34; \u0026lt; data.csv -- æ›´æ–°ï¼ˆALTERï¼‰ ALTER TABLE events UPDATE event_type = \u0026#39;purchase\u0026#39; WHERE event_type = \u0026#39;buy\u0026#39;; -- åˆ é™¤ ALTER TABLE events DELETE WHERE event_date \u0026lt; \u0026#39;2023-01-01\u0026#39;; 4.2 æŸ¥è¯¢è¯­æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 -- åŸºç¡€æŸ¥è¯¢ SELECT toDate(event_time) AS date, count() AS events, uniq(user_id) AS users FROM events WHERE event_date \u0026gt;= \u0026#39;2024-01-01\u0026#39; GROUP BY date ORDER BY date; -- çª—å£å‡½æ•° SELECT user_id, event_time, row_number() OVER (PARTITION BY user_id ORDER BY event_time) AS rn, lag(event_time) OVER (PARTITION BY user_id ORDER BY event_time) AS prev_time FROM events; -- æ•°ç»„å‡½æ•° SELECT user_id, groupArray(event_type) AS event_types, arrayDistinct(groupArray(event_type)) AS unique_types FROM events GROUP BY user_id; -- JSON å¤„ç† SELECT JSONExtractString(properties, \u0026#39;source\u0026#39;) AS source, JSONExtractInt(properties, \u0026#39;value\u0026#39;) AS value FROM events WHERE JSONHas(properties, \u0026#39;source\u0026#39;); -- WITH å­å¥ WITH daily_users AS ( SELECT toDate(event_time) AS date, uniq(user_id) AS users FROM events GROUP BY date ) SELECT date, users, users - lagInFrame(users, 1) OVER (ORDER BY date) AS growth FROM daily_users; 4.3 èšåˆå‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 -- å¸¸ç”¨èšåˆ SELECT count(), sum(amount), avg(amount), min(amount), max(amount), uniq(user_id), -- åŸºæ•°ä¼°ç®— uniqExact(user_id), -- ç²¾ç¡®å»é‡ quantile(0.95)(latency), -- åˆ†ä½æ•° median(latency) -- ä¸­ä½æ•° FROM orders; -- æ¡ä»¶èšåˆ SELECT countIf(status = \u0026#39;success\u0026#39;) AS success_count, sumIf(amount, status = \u0026#39;success\u0026#39;) AS success_amount, avgIf(latency, status = \u0026#39;success\u0026#39;) AS avg_latency FROM requests; -- æ•°ç»„èšåˆ SELECT user_id, groupArray(product_id) AS products, groupUniqArray(category) AS categories FROM orders GROUP BY user_id; äº”ã€Go åº”ç”¨é›†æˆ 5.1 å®‰è£…ä¾èµ– 1 go get github.com/ClickHouse/clickhouse-go/v2 5.2 è¿æ¥ä¸æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 package clickhouse import ( \u0026#34;context\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;time\u0026#34; \u0026#34;github.com/ClickHouse/clickhouse-go/v2\u0026#34; \u0026#34;github.com/ClickHouse/clickhouse-go/v2/lib/driver\u0026#34; ) type Client struct { conn driver.Conn } func NewClient(host string, port int, database, username, password string) (*Client, error) { conn, err := clickhouse.Open(\u0026amp;clickhouse.Options{ Addr: []string{fmt.Sprintf(\u0026#34;%s:%d\u0026#34;, host, port)}, Auth: clickhouse.Auth{ Database: database, Username: username, Password: password, }, Settings: clickhouse.Settings{ \u0026#34;max_execution_time\u0026#34;: 60, }, Compression: \u0026amp;clickhouse.Compression{ Method: clickhouse.CompressionLZ4, }, DialTimeout: 10 * time.Second, MaxOpenConns: 10, MaxIdleConns: 5, ConnMaxLifetime: time.Hour, }) if err != nil { return nil, err } return \u0026amp;Client{conn: conn}, nil } // æŸ¥è¯¢ func (c *Client) Query(ctx context.Context, query string) ([]map[string]interface{}, error) { rows, err := c.conn.Query(ctx, query) if err != nil { return nil, err } defer rows.Close() columns := rows.Columns() var results []map[string]interface{} for rows.Next() { values := make([]interface{}, len(columns)) valuePtrs := make([]interface{}, len(columns)) for i := range values { valuePtrs[i] = \u0026amp;values[i] } if err := rows.Scan(valuePtrs...); err != nil { return nil, err } row := make(map[string]interface{}) for i, col := range columns { row[col] = values[i] } results = append(results, row) } return results, nil } 5.3 æ‰¹é‡å†™å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 // æ‰¹é‡æ’å…¥ func (c *Client) BatchInsert(ctx context.Context, table string, events []Event) error { batch, err := c.conn.PrepareBatch(ctx, fmt.Sprintf(\u0026#34;INSERT INTO %s\u0026#34;, table)) if err != nil { return err } for _, event := range events { err := batch.Append( event.Date, event.Time, event.UserID, event.EventType, event.Properties, ) if err != nil { return err } } return batch.Send() } // å¼‚æ­¥æ‰¹é‡å†™å…¥ type BatchWriter struct { client *Client table string batchSize int buffer []Event mu sync.Mutex ticker *time.Ticker } func NewBatchWriter(client *Client, table string, batchSize int, flushInterval time.Duration) *BatchWriter { bw := \u0026amp;BatchWriter{ client: client, table: table, batchSize: batchSize, buffer: make([]Event, 0, batchSize), ticker: time.NewTicker(flushInterval), } go bw.flushLoop() return bw } func (bw *BatchWriter) Write(event Event) { bw.mu.Lock() bw.buffer = append(bw.buffer, event) shouldFlush := len(bw.buffer) \u0026gt;= bw.batchSize bw.mu.Unlock() if shouldFlush { bw.flush() } } func (bw *BatchWriter) flush() { bw.mu.Lock() if len(bw.buffer) == 0 { bw.mu.Unlock() return } events := bw.buffer bw.buffer = make([]Event, 0, bw.batchSize) bw.mu.Unlock() ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second) defer cancel() if err := bw.client.BatchInsert(ctx, bw.table, events); err != nil { log.Printf(\u0026#34;Batch insert failed: %v\u0026#34;, err) } } func (bw *BatchWriter) flushLoop() { for range bw.ticker.C { bw.flush() } } å…­ã€æŸ¥è¯¢ä¼˜åŒ– 6.1 ç´¢å¼•ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 -- ä¸»é”®ç´¢å¼• CREATE TABLE events ( event_date Date, user_id UInt64, event_type LowCardinality(String), -- ä½åŸºæ•°ä¼˜åŒ– ... ) ENGINE = MergeTree() ORDER BY (event_date, user_id); -- ä¸»é”®é¡ºåºå¾ˆé‡è¦ -- è·³æ•°ç´¢å¼• CREATE TABLE events ( event_date Date, user_id UInt64, event_type String, INDEX idx_event_type event_type TYPE set(100) GRANULARITY 4, INDEX idx_user_id user_id TYPE minmax GRANULARITY 3 ) ENGINE = MergeTree() ORDER BY event_date; 6.2 æŸ¥è¯¢ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 -- ä½¿ç”¨ PREWHERE SELECT * FROM events PREWHERE event_date = \u0026#39;2024-01-01\u0026#39; -- å…ˆè¿‡æ»¤ï¼Œå‡å°‘è¯»å– WHERE user_id = 1001; -- ä½¿ç”¨é‡‡æ · SELECT avg(amount) FROM orders SAMPLE 0.1; -- 10% é‡‡æ · -- åˆ†ææŸ¥è¯¢ EXPLAIN SELECT ... FROM events WHERE ...; EXPLAIN ESTIMATE SELECT ... FROM events WHERE ...; ä¸ƒã€æœ€ä½³å®è·µ 7.1 è¡¨è®¾è®¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 -- ä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹ CREATE TABLE optimized_events ( event_date Date, event_time DateTime, user_id UInt64, -- æ•´æ•°ä¼˜äºå­—ç¬¦ä¸² event_type LowCardinality(String), -- ä½åŸºæ•°å­—ç¬¦ä¸² country FixedString(2), -- å›ºå®šé•¿åº¦ amount Decimal(10, 2), -- ç²¾ç¡®å°æ•° properties String CODEC(ZSTD(3)) -- æŒ‡å®šå‹ç¼© ) ENGINE = MergeTree() PARTITION BY toYYYYMM(event_date) ORDER BY (event_date, user_id) TTL event_date + INTERVAL 90 DAY; -- è‡ªåŠ¨è¿‡æœŸ 7.2 åˆ†åŒºç­–ç•¥ 1 2 3 4 5 6 7 8 -- æŒ‰æœˆåˆ†åŒº PARTITION BY toYYYYMM(event_date) -- æŒ‰å¤©åˆ†åŒºï¼ˆé«˜é¢‘å†™å…¥ï¼‰ PARTITION BY event_date -- å¤åˆåˆ†åŒº PARTITION BY (toYYYYMM(event_date), region) æ€»ç»“ ClickHouse æ˜¯æè‡´æ€§èƒ½çš„ OLAP æ•°æ®åº“ï¼Œç‰¹åˆ«é€‚åˆæ—¥å¿—åˆ†æã€æ—¶åºæ•°æ®ã€å®æ—¶æŠ¥è¡¨ç­‰åœºæ™¯ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“Š åˆ—å¼å­˜å‚¨ï¼Œé«˜å‹ç¼©æ¯” âš¡ å‘é‡åŒ–æ‰§è¡Œï¼Œæé€ŸæŸ¥è¯¢ ğŸ”§ ä¸°å¯Œçš„è¡¨å¼•æ“é€‰æ‹© ğŸ“ˆ å¼ºå¤§çš„èšåˆå‡½æ•° ğŸ¯ SQL å…¼å®¹ï¼Œæ˜“äºä¸Šæ‰‹ ","date":"2025-10-10T00:00:00Z","permalink":"https://zpf-zero.github.io/p/clickhouse-guide/","title":"ClickHouse å®æˆ˜æŒ‡å—ï¼šOLAP æ•°æ®ä»“åº“"},{"content":"å‰è¨€ OpenTelemetry (OTel) æ˜¯ CNCF çš„å¼€æºé¡¹ç›®ï¼Œæä¾›ç»Ÿä¸€çš„å¯è§‚æµ‹æ€§æ ‡å‡†ï¼ŒåŒ…æ‹¬è¿½è¸ª (Traces)ã€æŒ‡æ ‡ (Metrics) å’Œæ—¥å¿— (Logs)ã€‚å®ƒåˆå¹¶äº† OpenTracing å’Œ OpenCensusï¼Œæˆä¸ºäº‘åŸç”Ÿå¯è§‚æµ‹æ€§çš„äº‹å®æ ‡å‡†ã€‚\nä¸€ã€æ ¸å¿ƒæ¦‚å¿µ 1.1 ä¸‰å¤§ä¿¡å· Tracesï¼ˆè¿½è¸ªï¼‰ï¼šè®°å½•è¯·æ±‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å®Œæ•´è·¯å¾„ Metricsï¼ˆæŒ‡æ ‡ï¼‰ï¼šæ•°å€¼å‹æµ‹é‡æ•°æ®ï¼Œå¦‚è¯·æ±‚è®¡æ•°ã€å»¶è¿Ÿ Logsï¼ˆæ—¥å¿—ï¼‰ï¼šå¸¦æ—¶é—´æˆ³çš„ç¦»æ•£äº‹ä»¶è®°å½• 1.2 å…³é”®ç»„ä»¶ 1 2 3 Application -\u0026gt; SDK -\u0026gt; Exporter -\u0026gt; Collector -\u0026gt; Backend | | +--- Instrumentation Libraries +--- Jaeger/Prometheus/etc. äºŒã€Go åº”ç”¨é›†æˆ 2.1 å®‰è£…ä¾èµ– 1 2 3 4 5 go get go.opentelemetry.io/otel go get go.opentelemetry.io/otel/sdk go get go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc go get go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetricgrpc go get go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin 2.2 åˆå§‹åŒ– Tracer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 package otel import ( \u0026#34;context\u0026#34; \u0026#34;time\u0026#34; \u0026#34;go.opentelemetry.io/otel\u0026#34; \u0026#34;go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc\u0026#34; \u0026#34;go.opentelemetry.io/otel/propagation\u0026#34; \u0026#34;go.opentelemetry.io/otel/sdk/resource\u0026#34; sdktrace \u0026#34;go.opentelemetry.io/otel/sdk/trace\u0026#34; semconv \u0026#34;go.opentelemetry.io/otel/semconv/v1.17.0\u0026#34; ) func InitTracer(serviceName, endpoint string) (*sdktrace.TracerProvider, error) { ctx := context.Background() // åˆ›å»º Exporter exporter, err := otlptracegrpc.New(ctx, otlptracegrpc.WithEndpoint(endpoint), otlptracegrpc.WithInsecure(), ) if err != nil { return nil, err } // åˆ›å»º Resource res, err := resource.Merge( resource.Default(), resource.NewWithAttributes( semconv.SchemaURL, semconv.ServiceName(serviceName), semconv.ServiceVersion(\u0026#34;1.0.0\u0026#34;), ), ) if err != nil { return nil, err } // åˆ›å»º TracerProvider tp := sdktrace.NewTracerProvider( sdktrace.WithBatcher(exporter), sdktrace.WithResource(res), sdktrace.WithSampler(sdktrace.AlwaysSample()), ) // è®¾ç½®å…¨å±€ TracerProvider otel.SetTracerProvider(tp) // è®¾ç½® Propagator otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator( propagation.TraceContext{}, propagation.Baggage{}, )) return tp, nil } 2.3 åˆå§‹åŒ– Meter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import ( \u0026#34;go.opentelemetry.io/otel\u0026#34; \u0026#34;go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetricgrpc\u0026#34; sdkmetric \u0026#34;go.opentelemetry.io/otel/sdk/metric\u0026#34; ) func InitMeter(serviceName, endpoint string) (*sdkmetric.MeterProvider, error) { ctx := context.Background() exporter, err := otlpmetricgrpc.New(ctx, otlpmetricgrpc.WithEndpoint(endpoint), otlpmetricgrpc.WithInsecure(), ) if err != nil { return nil, err } mp := sdkmetric.NewMeterProvider( sdkmetric.WithReader(sdkmetric.NewPeriodicReader(exporter, sdkmetric.WithInterval(10*time.Second), )), sdkmetric.WithResource(res), ) otel.SetMeterProvider(mp) return mp, nil } ä¸‰ã€åˆ†å¸ƒå¼è¿½è¸ª 3.1 åˆ›å»º Span 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 import ( \u0026#34;go.opentelemetry.io/otel\u0026#34; \u0026#34;go.opentelemetry.io/otel/attribute\u0026#34; \u0026#34;go.opentelemetry.io/otel/codes\u0026#34; \u0026#34;go.opentelemetry.io/otel/trace\u0026#34; ) var tracer = otel.Tracer(\u0026#34;my-service\u0026#34;) func ProcessOrder(ctx context.Context, orderID string) error { // åˆ›å»º Span ctx, span := tracer.Start(ctx, \u0026#34;ProcessOrder\u0026#34;, trace.WithAttributes( attribute.String(\u0026#34;order.id\u0026#34;, orderID), ), ) defer span.End() // æ·»åŠ äº‹ä»¶ span.AddEvent(\u0026#34;å¼€å§‹å¤„ç†è®¢å•\u0026#34;) // è°ƒç”¨å­æœåŠ¡ if err := validateOrder(ctx, orderID); err != nil { span.RecordError(err) span.SetStatus(codes.Error, err.Error()) return err } span.AddEvent(\u0026#34;è®¢å•éªŒè¯å®Œæˆ\u0026#34;) // æ›´æ–°å±æ€§ span.SetAttributes(attribute.Bool(\u0026#34;order.validated\u0026#34;, true)) return nil } func validateOrder(ctx context.Context, orderID string) error { ctx, span := tracer.Start(ctx, \u0026#34;ValidateOrder\u0026#34;) defer span.End() // éªŒè¯é€»è¾‘ return nil } 3.2 è·¨æœåŠ¡ä¼ æ’­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import ( \u0026#34;net/http\u0026#34; \u0026#34;go.opentelemetry.io/otel\u0026#34; \u0026#34;go.opentelemetry.io/otel/propagation\u0026#34; ) // HTTP å®¢æˆ·ç«¯ func CallService(ctx context.Context, url string) error { req, _ := http.NewRequestWithContext(ctx, \u0026#34;GET\u0026#34;, url, nil) // æ³¨å…¥ trace context otel.GetTextMapPropagator().Inject(ctx, propagation.HeaderCarrier(req.Header)) resp, err := http.DefaultClient.Do(req) // ... } // HTTP æœåŠ¡ç«¯ func Handler(w http.ResponseWriter, r *http.Request) { // æå– trace context ctx := otel.GetTextMapPropagator().Extract(r.Context(), propagation.HeaderCarrier(r.Header)) ctx, span := tracer.Start(ctx, \u0026#34;HandleRequest\u0026#34;) defer span.End() // å¤„ç†è¯·æ±‚ } 3.3 Gin é›†æˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 import ( \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin\u0026#34; ) func SetupRouter() *gin.Engine { r := gin.New() // æ·»åŠ  OpenTelemetry ä¸­é—´ä»¶ r.Use(otelgin.Middleware(\u0026#34;my-service\u0026#34;)) r.Use(gin.Recovery()) r.GET(\u0026#34;/users/:id\u0026#34;, GetUser) return r } func GetUser(c *gin.Context) { ctx := c.Request.Context() // åˆ›å»ºå­ Span ctx, span := tracer.Start(ctx, \u0026#34;GetUserFromDB\u0026#34;) defer span.End() userID := c.Param(\u0026#34;id\u0026#34;) span.SetAttributes(attribute.String(\u0026#34;user.id\u0026#34;, userID)) // æ•°æ®åº“æŸ¥è¯¢ user, err := db.GetUser(ctx, userID) if err != nil { span.RecordError(err) c.JSON(500, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } c.JSON(200, user) } å››ã€æŒ‡æ ‡é‡‡é›† 4.1 å®šä¹‰æŒ‡æ ‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 import ( \u0026#34;go.opentelemetry.io/otel\u0026#34; \u0026#34;go.opentelemetry.io/otel/metric\u0026#34; ) var meter = otel.Meter(\u0026#34;my-service\u0026#34;) var ( requestCounter metric.Int64Counter requestDuration metric.Float64Histogram activeRequests metric.Int64UpDownCounter ) func InitMetrics() error { var err error // Counter requestCounter, err = meter.Int64Counter(\u0026#34;http_requests_total\u0026#34;, metric.WithDescription(\u0026#34;Total HTTP requests\u0026#34;), metric.WithUnit(\u0026#34;1\u0026#34;), ) if err != nil { return err } // Histogram requestDuration, err = meter.Float64Histogram(\u0026#34;http_request_duration_seconds\u0026#34;, metric.WithDescription(\u0026#34;HTTP request duration\u0026#34;), metric.WithUnit(\u0026#34;s\u0026#34;), ) if err != nil { return err } // UpDownCounter activeRequests, err = meter.Int64UpDownCounter(\u0026#34;http_requests_active\u0026#34;, metric.WithDescription(\u0026#34;Active HTTP requests\u0026#34;), ) if err != nil { return err } return nil } 4.2 è®°å½•æŒ‡æ ‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func MetricsMiddleware() gin.HandlerFunc { return func(c *gin.Context) { ctx := c.Request.Context() start := time.Now() activeRequests.Add(ctx, 1) c.Next() activeRequests.Add(ctx, -1) duration := time.Since(start).Seconds() attrs := metric.WithAttributes( attribute.String(\u0026#34;method\u0026#34;, c.Request.Method), attribute.String(\u0026#34;path\u0026#34;, c.FullPath()), attribute.Int(\u0026#34;status\u0026#34;, c.Writer.Status()), ) requestCounter.Add(ctx, 1, attrs) requestDuration.Record(ctx, duration, attrs) } } äº”ã€OTel Collector 5.1 éƒ¨ç½²é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 # otel-collector-config.yaml receivers: otlp: protocols: grpc: endpoint: 0.0.0.0:4317 http: endpoint: 0.0.0.0:4318 processors: batch: timeout: 10s send_batch_size: 1000 memory_limiter: check_interval: 1s limit_mib: 1000 exporters: jaeger: endpoint: jaeger:14250 tls: insecure: true prometheus: endpoint: \u0026#34;0.0.0.0:8889\u0026#34; logging: loglevel: debug service: pipelines: traces: receivers: [otlp] processors: [memory_limiter, batch] exporters: [jaeger, logging] metrics: receivers: [otlp] processors: [memory_limiter, batch] exporters: [prometheus] 5.2 Docker Compose 1 2 3 4 5 6 7 8 9 10 11 version: \u0026#39;3.8\u0026#39; services: otel-collector: image: otel/opentelemetry-collector-contrib:latest command: [\u0026#34;--config=/etc/otel-collector-config.yaml\u0026#34;] volumes: - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml ports: - \u0026#34;4317:4317\u0026#34; # OTLP gRPC - \u0026#34;4318:4318\u0026#34; # OTLP HTTP - \u0026#34;8889:8889\u0026#34; # Prometheus metrics å…­ã€é‡‡æ ·ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 import ( sdktrace \u0026#34;go.opentelemetry.io/otel/sdk/trace\u0026#34; ) // å§‹ç»ˆé‡‡æ · sampler := sdktrace.AlwaysSample() // ä»ä¸é‡‡æ · sampler := sdktrace.NeverSample() // åŸºäºæ¦‚ç‡é‡‡æ · sampler := sdktrace.TraceIDRatioBased(0.5) // 50% // çˆ¶çº§é‡‡æ · sampler := sdktrace.ParentBased(sdktrace.TraceIDRatioBased(0.1)) // è‡ªå®šä¹‰é‡‡æ ·å™¨ type CustomSampler struct{} func (s CustomSampler) ShouldSample(p sdktrace.SamplingParameters) sdktrace.SamplingResult { // å¯¹é«˜ä¼˜å…ˆçº§è¯·æ±‚å§‹ç»ˆé‡‡æ · if p.Name == \u0026#34;important-operation\u0026#34; { return sdktrace.SamplingResult{Decision: sdktrace.RecordAndSample} } return sdktrace.SamplingResult{Decision: sdktrace.Drop} } func (s CustomSampler) Description() string { return \u0026#34;CustomSampler\u0026#34; } æ€»ç»“ OpenTelemetry æä¾›äº†ç»Ÿä¸€çš„å¯è§‚æµ‹æ€§è§£å†³æ–¹æ¡ˆï¼Œæ˜¯æ„å»ºç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§çš„åŸºç¡€ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“Š ç»Ÿä¸€çš„è¿½è¸ªã€æŒ‡æ ‡ã€æ—¥å¿— API ğŸ”Œ ä¸°å¯Œçš„è¯­è¨€ SDK æ”¯æŒ ğŸ¯ çµæ´»çš„é‡‡æ ·ç­–ç•¥ ğŸ“¦ ä¸å¤šç§åç«¯é›†æˆ ğŸŒ äº‘åŸç”Ÿæ ‡å‡†æ”¯æŒ ","date":"2025-09-16T00:00:00Z","permalink":"https://zpf-zero.github.io/p/opentelemetry-guide/","title":"OpenTelemetry å®æˆ˜æŒ‡å—ï¼šç»Ÿä¸€å¯è§‚æµ‹æ€§æ ‡å‡†"},{"content":"å‰è¨€ ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashingï¼‰æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ ¸å¿ƒç®—æ³•ï¼Œæœ€åˆç”± Karger ç­‰äººåœ¨ 1997 å¹´æå‡ºã€‚å®ƒè§£å†³äº†ä¼ ç»Ÿå“ˆå¸Œå–æ¨¡åœ¨èŠ‚ç‚¹å˜åŒ–æ—¶æ•°æ®è¿ç§»é‡è¿‡å¤§çš„é—®é¢˜ï¼Œå¹¿æ³›åº”ç”¨äºç¼“å­˜ã€æ•°æ®åº“åˆ†ç‰‡ã€è´Ÿè½½å‡è¡¡ç­‰åœºæ™¯ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£ä¸€è‡´æ€§å“ˆå¸Œçš„åŸç†å’Œ Go è¯­è¨€å®ç°ã€‚\nä¸€ã€é—®é¢˜èƒŒæ™¯ 1.1 ä¼ ç»Ÿå“ˆå¸Œçš„é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 ä¼ ç»Ÿå“ˆå¸Œå–æ¨¡ï¼šhash(key) % N å‡è®¾æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼š - key1 -\u0026gt; hash(key1) % 3 = 0 -\u0026gt; Node0 - key2 -\u0026gt; hash(key2) % 3 = 1 -\u0026gt; Node1 - key3 -\u0026gt; hash(key3) % 3 = 2 -\u0026gt; Node2 å½“å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆN=4ï¼‰ï¼š - key1 -\u0026gt; hash(key1) % 4 = 2 -\u0026gt; Node2 âŒ éœ€è¦è¿ç§» - key2 -\u0026gt; hash(key2) % 4 = 1 -\u0026gt; Node1 âœ“ ä¸å˜ - key3 -\u0026gt; hash(key3) % 4 = 0 -\u0026gt; Node0 âŒ éœ€è¦è¿ç§» é—®é¢˜ï¼šèŠ‚ç‚¹å˜åŒ–æ—¶ï¼Œå¤§é‡æ•°æ®éœ€è¦é‡æ–°æ˜ å°„ å½±å“ï¼šç¼“å­˜å¤§é¢ç§¯å¤±æ•ˆï¼Œæ•°æ®åº“å‹åŠ›æ¿€å¢ 1.2 ä¸€è‡´æ€§å“ˆå¸Œçš„è§£å†³æ–¹æ¡ˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ä¸€è‡´æ€§å“ˆå¸Œï¼šå°†èŠ‚ç‚¹å’Œæ•°æ®éƒ½æ˜ å°„åˆ°ä¸€ä¸ªç¯ä¸Š 0Â° â”Œâ”€â”€â”€â” 270Â° â”‚ â”‚ 90Â° â”‚ â—‹ â”‚â”€â”€\u0026gt; Node A (hash=50Â°) â”‚ â”‚ â”‚ â—‹ â”‚â”€â”€\u0026gt; Node B (hash=150Â°) â”‚ â”‚ â”‚ â—‹ â”‚â”€â”€\u0026gt; Node C (hash=250Â°) â””â”€â”€â”€â”˜ 180Â° æ•°æ®æ˜ å°„è§„åˆ™ï¼š - é¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ - key1 (hash=30Â°) -\u0026gt; Node A (50Â°) - key2 (hash=100Â°) -\u0026gt; Node B (150Â°) - key3 (hash=200Â°) -\u0026gt; Node C (250Â°) èŠ‚ç‚¹å˜åŒ–å½±å“ï¼š - åªå½±å“ç›¸é‚»èŠ‚ç‚¹é—´çš„æ•°æ® - å¹³å‡åªéœ€è¿ç§» 1/N çš„æ•°æ® äºŒã€åŸºç¡€å®ç° 2.1 æ•°æ®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package consistenthash import ( \u0026#34;hash/crc32\u0026#34; \u0026#34;sort\u0026#34; \u0026#34;sync\u0026#34; ) // å“ˆå¸Œå‡½æ•°ç±»å‹ type HashFunc func(data []byte) uint32 // ä¸€è‡´æ€§å“ˆå¸Œ type ConsistentHash struct { hashFunc HashFunc // å“ˆå¸Œå‡½æ•° replicas int // è™šæ‹ŸèŠ‚ç‚¹æ•° ring []uint32 // å“ˆå¸Œç¯ï¼ˆæœ‰åºï¼‰ nodes map[uint32]string // å“ˆå¸Œå€¼ -\u0026gt; èŠ‚ç‚¹ mu sync.RWMutex } // åˆ›å»ºä¸€è‡´æ€§å“ˆå¸Œ func New(replicas int, fn HashFunc) *ConsistentHash { ch := \u0026amp;ConsistentHash{ replicas: replicas, hashFunc: fn, nodes: make(map[uint32]string), } if ch.hashFunc == nil { ch.hashFunc = crc32.ChecksumIEEE } return ch } 2.2 æ ¸å¿ƒæ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 // æ·»åŠ èŠ‚ç‚¹ func (ch *ConsistentHash) AddNode(nodes ...string) { ch.mu.Lock() defer ch.mu.Unlock() for _, node := range nodes { // åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ for i := 0; i \u0026lt; ch.replicas; i++ { hash := ch.hashFunc([]byte(fmt.Sprintf(\u0026#34;%s#%d\u0026#34;, node, i))) ch.ring = append(ch.ring, hash) ch.nodes[hash] = node } } // æ’åºå“ˆå¸Œç¯ sort.Slice(ch.ring, func(i, j int) bool { return ch.ring[i] \u0026lt; ch.ring[j] }) } // ç§»é™¤èŠ‚ç‚¹ func (ch *ConsistentHash) RemoveNode(node string) { ch.mu.Lock() defer ch.mu.Unlock() for i := 0; i \u0026lt; ch.replicas; i++ { hash := ch.hashFunc([]byte(fmt.Sprintf(\u0026#34;%s#%d\u0026#34;, node, i))) delete(ch.nodes, hash) // ä»ç¯ä¸­ç§»é™¤ for j := 0; j \u0026lt; len(ch.ring); j++ { if ch.ring[j] == hash { ch.ring = append(ch.ring[:j], ch.ring[j+1:]...) break } } } } // è·å–èŠ‚ç‚¹ func (ch *ConsistentHash) GetNode(key string) string { ch.mu.RLock() defer ch.mu.RUnlock() if len(ch.ring) == 0 { return \u0026#34;\u0026#34; } hash := ch.hashFunc([]byte(key)) // äºŒåˆ†æŸ¥æ‰¾ï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äº hash çš„ä½ç½® idx := sort.Search(len(ch.ring), func(i int) bool { return ch.ring[i] \u0026gt;= hash }) // ç¯å½¢ï¼šå¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ if idx == len(ch.ring) { idx = 0 } return ch.nodes[ch.ring[idx]] } // è·å–å¤šä¸ªèŠ‚ç‚¹ï¼ˆç”¨äºå‰¯æœ¬ï¼‰ func (ch *ConsistentHash) GetNodes(key string, count int) []string { ch.mu.RLock() defer ch.mu.RUnlock() if len(ch.ring) == 0 { return nil } hash := ch.hashFunc([]byte(key)) idx := sort.Search(len(ch.ring), func(i int) bool { return ch.ring[i] \u0026gt;= hash }) if idx == len(ch.ring) { idx = 0 } // æ”¶é›†ä¸é‡å¤çš„èŠ‚ç‚¹ result := make([]string, 0, count) seen := make(map[string]bool) for i := 0; i \u0026lt; len(ch.ring) \u0026amp;\u0026amp; len(result) \u0026lt; count; i++ { pos := (idx + i) % len(ch.ring) node := ch.nodes[ch.ring[pos]] if !seen[node] { seen[node] = true result = append(result, node) } } return result } 2.3 ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func main() { // åˆ›å»ºä¸€è‡´æ€§å“ˆå¸Œï¼Œæ¯ä¸ªèŠ‚ç‚¹ 150 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ ch := New(150, nil) // æ·»åŠ èŠ‚ç‚¹ ch.AddNode(\u0026#34;192.168.1.1:6379\u0026#34;, \u0026#34;192.168.1.2:6379\u0026#34;, \u0026#34;192.168.1.3:6379\u0026#34;) // æ¨¡æ‹Ÿæ•°æ®åˆ†å¸ƒ distribution := make(map[string]int) for i := 0; i \u0026lt; 10000; i++ { key := fmt.Sprintf(\u0026#34;key-%d\u0026#34;, i) node := ch.GetNode(key) distribution[node]++ } // è¾“å‡ºåˆ†å¸ƒæƒ…å†µ for node, count := range distribution { fmt.Printf(\u0026#34;%s: %d (%.2f%%)\\n\u0026#34;, node, count, float64(count)/100) } // ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ fmt.Println(\u0026#34;\\nç§»é™¤èŠ‚ç‚¹ 192.168.1.2:6379 åï¼š\u0026#34;) ch.RemoveNode(\u0026#34;192.168.1.2:6379\u0026#34;) distribution = make(map[string]int) for i := 0; i \u0026lt; 10000; i++ { key := fmt.Sprintf(\u0026#34;key-%d\u0026#34;, i) node := ch.GetNode(key) distribution[node]++ } for node, count := range distribution { fmt.Printf(\u0026#34;%s: %d (%.2f%%)\\n\u0026#34;, node, count, float64(count)/100) } } ä¸‰ã€è™šæ‹ŸèŠ‚ç‚¹ä¼˜åŒ– 3.1 ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹ŸèŠ‚ç‚¹ï¼Ÿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 é—®é¢˜ï¼šèŠ‚ç‚¹æ•°é‡å°‘æ—¶ï¼Œæ•°æ®åˆ†å¸ƒä¸å‡åŒ€ åªæœ‰ 3 ä¸ªç‰©ç†èŠ‚ç‚¹ï¼š 0Â° â”Œâ”€â”€â”€â” â”‚ â”‚ â”‚ A â”‚ (30Â°) â”‚ â”‚ â”‚ B â”‚ (100Â°) â”‚ â”‚ â”‚ C â”‚ (110Â°) â””â”€â”€â”€â”˜ èŠ‚ç‚¹ C åªè´Ÿè´£ 10Â° èŒƒå›´ï¼Œè€Œ A è´Ÿè´£ 280Â° èŒƒå›´ æ•°æ®åˆ†å¸ƒæä¸å‡è¡¡ï¼ è§£å†³æ–¹æ¡ˆï¼šè™šæ‹ŸèŠ‚ç‚¹ - æ¯ä¸ªç‰©ç†èŠ‚ç‚¹æ˜ å°„å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ - è™šæ‹ŸèŠ‚ç‚¹å‡åŒ€åˆ†å¸ƒåœ¨ç¯ä¸Š - è™šæ‹ŸèŠ‚ç‚¹æŒ‡å‘å®é™…ç‰©ç†èŠ‚ç‚¹ 3.2 è™šæ‹ŸèŠ‚ç‚¹æ•°é‡é€‰æ‹© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // æµ‹è¯•ä¸åŒè™šæ‹ŸèŠ‚ç‚¹æ•°é‡çš„åˆ†å¸ƒå‡åŒ€åº¦ func TestVirtualNodes() { replicaCounts := []int{1, 10, 50, 100, 150, 200, 500} nodes := []string{\u0026#34;node1\u0026#34;, \u0026#34;node2\u0026#34;, \u0026#34;node3\u0026#34;, \u0026#34;node4\u0026#34;, \u0026#34;node5\u0026#34;} for _, replicas := range replicaCounts { ch := New(replicas, nil) ch.AddNode(nodes...) distribution := make(map[string]int) for i := 0; i \u0026lt; 100000; i++ { key := fmt.Sprintf(\u0026#34;key-%d\u0026#34;, i) node := ch.GetNode(key) distribution[node]++ } // è®¡ç®—æ ‡å‡†å·® mean := 100000 / len(nodes) variance := 0.0 for _, count := range distribution { variance += math.Pow(float64(count-mean), 2) } stdDev := math.Sqrt(variance / float64(len(nodes))) fmt.Printf(\u0026#34;Replicas: %3d, StdDev: %.2f\\n\u0026#34;, replicas, stdDev) } } // è¾“å‡ºç¤ºä¾‹ï¼š // Replicas: 1, StdDev: 8234.56 // Replicas: 10, StdDev: 2456.78 // Replicas: 50, StdDev: 892.34 // Replicas: 100, StdDev: 623.45 // Replicas: 150, StdDev: 512.34 \u0026lt;- æ¨è // Replicas: 200, StdDev: 478.90 // Replicas: 500, StdDev: 301.23 å››ã€å¸¦æƒé‡çš„ä¸€è‡´æ€§å“ˆå¸Œ 4.1 å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 // å¸¦æƒé‡çš„ä¸€è‡´æ€§å“ˆå¸Œ type WeightedConsistentHash struct { hashFunc HashFunc baseWeight int // åŸºç¡€è™šæ‹ŸèŠ‚ç‚¹æ•° ring []uint32 nodes map[uint32]string weights map[string]int // èŠ‚ç‚¹æƒé‡ mu sync.RWMutex } func NewWeighted(baseWeight int, fn HashFunc) *WeightedConsistentHash { wch := \u0026amp;WeightedConsistentHash{ baseWeight: baseWeight, hashFunc: fn, nodes: make(map[uint32]string), weights: make(map[string]int), } if wch.hashFunc == nil { wch.hashFunc = crc32.ChecksumIEEE } return wch } // æ·»åŠ å¸¦æƒé‡çš„èŠ‚ç‚¹ func (wch *WeightedConsistentHash) AddNode(node string, weight int) { wch.mu.Lock() defer wch.mu.Unlock() wch.weights[node] = weight // è™šæ‹ŸèŠ‚ç‚¹æ•° = åŸºç¡€æ•° * æƒé‡ replicas := wch.baseWeight * weight for i := 0; i \u0026lt; replicas; i++ { hash := wch.hashFunc([]byte(fmt.Sprintf(\u0026#34;%s#%d\u0026#34;, node, i))) wch.ring = append(wch.ring, hash) wch.nodes[hash] = node } sort.Slice(wch.ring, func(i, j int) bool { return wch.ring[i] \u0026lt; wch.ring[j] }) } // ä½¿ç”¨ç¤ºä¾‹ func main() { wch := NewWeighted(50, nil) // é«˜é…æœåŠ¡å™¨æƒé‡æ›´é«˜ wch.AddNode(\u0026#34;high-spec-1\u0026#34;, 3) // 150 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ wch.AddNode(\u0026#34;high-spec-2\u0026#34;, 3) wch.AddNode(\u0026#34;low-spec-1\u0026#34;, 1) // 50 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ wch.AddNode(\u0026#34;low-spec-2\u0026#34;, 1) // é«˜é…æœåŠ¡å™¨ä¼šæ‰¿æ‹…æ›´å¤šè¯·æ±‚ } äº”ã€Jump Consistent Hash 5.1 åŸç† Jump Consistent Hash æ˜¯ Google åœ¨ 2014 å¹´æå‡ºçš„ç®—æ³•ï¼š\nç©ºé—´å¤æ‚åº¦ O(1)ï¼šä¸éœ€è¦å­˜å‚¨ç¯ æ—¶é—´å¤æ‚åº¦ O(log n) åˆ†å¸ƒæ›´å‡åŒ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // Jump Consistent Hash å®ç° func JumpConsistentHash(key uint64, numBuckets int) int { var b int64 = -1 var j int64 = 0 for j \u0026lt; int64(numBuckets) { b = j key = key*2862933555777941757 + 1 j = int64(float64(b+1) * (float64(int64(1)\u0026lt;\u0026lt;31) / float64((key\u0026gt;\u0026gt;33)+1))) } return int(b) } // ä½¿ç”¨ func main() { numNodes := 5 for i := 0; i \u0026lt; 10; i++ { key := uint64(i) node := JumpConsistentHash(key, numNodes) fmt.Printf(\u0026#34;Key %d -\u0026gt; Node %d\\n\u0026#34;, key, node) } } 5.2 å¯¹æ¯” ç‰¹æ€§ Ring Hash Jump Hash ç©ºé—´å¤æ‚åº¦ O(n * replicas) O(1) æ—¶é—´å¤æ‚åº¦ O(log n) O(log n) èŠ‚ç‚¹ç§»é™¤ æ”¯æŒ åªæ”¯æŒç§»é™¤å°¾éƒ¨ åˆ†å¸ƒå‡åŒ€åº¦ ä¾èµ–è™šæ‹ŸèŠ‚ç‚¹æ•° éå¸¸å‡åŒ€ é€‚ç”¨åœºæ™¯ åŠ¨æ€èŠ‚ç‚¹å˜åŒ– èŠ‚ç‚¹æ•°é‡ç›¸å¯¹å›ºå®š å…­ã€å®é™…åº”ç”¨ 6.1 ç¼“å­˜è·¯ç”± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 // ç¼“å­˜å®¢æˆ·ç«¯ type CacheClient struct { hash *ConsistentHash pool map[string]*redis.Client mu sync.RWMutex } func NewCacheClient(nodes []string) *CacheClient { cc := \u0026amp;CacheClient{ hash: New(150, nil), pool: make(map[string]*redis.Client), } for _, node := range nodes { cc.hash.AddNode(node) cc.pool[node] = redis.NewClient(\u0026amp;redis.Options{ Addr: node, }) } return cc } func (cc *CacheClient) Get(ctx context.Context, key string) (string, error) { node := cc.hash.GetNode(key) cc.mu.RLock() client := cc.pool[node] cc.mu.RUnlock() return client.Get(ctx, key).Result() } func (cc *CacheClient) Set(ctx context.Context, key, value string, exp time.Duration) error { node := cc.hash.GetNode(key) cc.mu.RLock() client := cc.pool[node] cc.mu.RUnlock() return client.Set(ctx, key, value, exp).Err() } // æ·»åŠ èŠ‚ç‚¹ï¼ˆéœ€è¦æ•°æ®è¿ç§»ï¼‰ func (cc *CacheClient) AddNode(node string) { cc.mu.Lock() defer cc.mu.Unlock() cc.hash.AddNode(node) cc.pool[node] = redis.NewClient(\u0026amp;redis.Options{ Addr: node, }) } 6.2 è´Ÿè½½å‡è¡¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // è´Ÿè½½å‡è¡¡å™¨ type LoadBalancer struct { hash *WeightedConsistentHash clients map[string]*http.Client health map[string]bool mu sync.RWMutex } func (lb *LoadBalancer) Route(key string) (string, error) { lb.mu.RLock() defer lb.mu.RUnlock() // è·å–å¤šä¸ªå€™é€‰èŠ‚ç‚¹ nodes := lb.hash.GetNodes(key, 3) // è¿”å›ç¬¬ä¸€ä¸ªå¥åº·çš„èŠ‚ç‚¹ for _, node := range nodes { if lb.health[node] { return node, nil } } return \u0026#34;\u0026#34;, errors.New(\u0026#34;no healthy nodes\u0026#34;) } // å¥åº·æ£€æŸ¥ func (lb *LoadBalancer) healthCheck() { ticker := time.NewTicker(10 * time.Second) defer ticker.Stop() for range ticker.C { lb.mu.Lock() for node, client := range lb.clients { resp, err := client.Get(node + \u0026#34;/health\u0026#34;) lb.health[node] = err == nil \u0026amp;\u0026amp; resp.StatusCode == 200 } lb.mu.Unlock() } } 6.3 æ•°æ®åˆ†ç‰‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // æ•°æ®åº“åˆ†ç‰‡ type ShardManager struct { hash *ConsistentHash shards map[string]*sql.DB } func (sm *ShardManager) GetShard(userID string) *sql.DB { shardKey := sm.hash.GetNode(userID) return sm.shards[shardKey] } func (sm *ShardManager) Query(ctx context.Context, userID string, query string) (*sql.Rows, error) { db := sm.GetShard(userID) return db.QueryContext(ctx, query) } æ€»ç»“ ä¸€è‡´æ€§å“ˆå¸Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒç®—æ³•ï¼Œè§£å†³äº†èŠ‚ç‚¹å˜åŒ–æ—¶æ•°æ®è¿ç§»é‡è¿‡å¤§çš„é—®é¢˜ã€‚\nå…³é”®è¦ç‚¹ï¼š\nåŸºæœ¬åŸç†ï¼šå°†èŠ‚ç‚¹å’Œæ•°æ®æ˜ å°„åˆ°å“ˆå¸Œç¯ è™šæ‹ŸèŠ‚ç‚¹ï¼šè§£å†³æ•°æ®åˆ†å¸ƒä¸å‡é—®é¢˜ èŠ‚ç‚¹å˜åŒ–ï¼šåªå½±å“ç›¸é‚»åŒºé—´çš„æ•°æ® åº”ç”¨åœºæ™¯ï¼šç¼“å­˜ã€è´Ÿè½½å‡è¡¡ã€æ•°æ®åˆ†ç‰‡ ç»§ç»­å­¦ä¹ ï¼š\nè®ºæ–‡ï¼šã€ŠConsistent Hashing and Random Treesã€‹ è®ºæ–‡ï¼šã€ŠA Fast, Minimal Memory, Consistent Hash Algorithmã€‹ Ketama ä¸€è‡´æ€§å“ˆå¸Œå®ç° Incoming (Background Agent changes)\n","date":"2025-09-13T00:00:00Z","permalink":"https://zpf-zero.github.io/p/consistent-hash-algorithm/","title":"ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è¯¦è§£ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿè´Ÿè½½å‡è¡¡"},{"content":"å‰è¨€ Redis æ˜¯ä¸€ä¸ªå¼€æºçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚Redis 7.0 å¸¦æ¥äº† Redis Functionsã€ACL æ”¹è¿›ã€Sharded Pub/Sub ç­‰æ–°ç‰¹æ€§ï¼Œè¿›ä¸€æ­¥æå‡äº†æ€§èƒ½å’ŒåŠŸèƒ½ã€‚\nä¸€ã€Redis åŸºç¡€ 1.1 å®‰è£…ä¸å¯åŠ¨ 1 2 3 4 5 6 7 8 # Docker æ–¹å¼å®‰è£… docker run -d --name redis -p 6379:6379 redis:7.0 # å¸¦å¯†ç å¯åŠ¨ docker run -d --name redis -p 6379:6379 redis:7.0 --requirepass yourpassword # è¿æ¥ Redis redis-cli -h localhost -p 6379 -a yourpassword 1.2 åŸºæœ¬å‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # å­—ç¬¦ä¸²æ“ä½œ SET key value GET key SET key value EX 60 # è®¾ç½®è¿‡æœŸæ—¶é—´ 60 ç§’ SETNX key value # ä¸å­˜åœ¨æ—¶æ‰è®¾ç½® MSET k1 v1 k2 v2 # æ‰¹é‡è®¾ç½® MGET k1 k2 # æ‰¹é‡è·å– INCR counter # è‡ªå¢ INCRBY counter 10 # å¢åŠ æŒ‡å®šå€¼ DECR counter # è‡ªå‡ # é”®æ“ä½œ EXISTS key DEL key EXPIRE key 60 TTL key # æŸ¥çœ‹å‰©ä½™æ—¶é—´ KEYS pattern # æŸ¥æ‰¾é”®ï¼ˆç”Ÿäº§æ…ç”¨ï¼‰ SCAN cursor # è¿­ä»£é”®ï¼ˆæ¨èï¼‰ TYPE key # æŸ¥çœ‹ç±»å‹ äºŒã€æ•°æ®ç»“æ„ 2.1 Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # åŸºæœ¬æ“ä½œ SET user:1:name \u0026#34;Alice\u0026#34; GET user:1:name # è®¡æ•°å™¨ INCR article:1:views INCRBY article:1:views 10 # åˆ†å¸ƒå¼ ID INCR order_id # ä½æ“ä½œ SETBIT user:login:20241215 1001 1 # ç”¨æˆ· 1001 ä»Šæ—¥ç™»å½• GETBIT user:login:20241215 1001 BITCOUNT user:login:20241215 # ç»Ÿè®¡ä»Šæ—¥ç™»å½•äººæ•° Go ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import \u0026#34;github.com/redis/go-redis/v9\u0026#34; func main() { rdb := redis.NewClient(\u0026amp;redis.Options{ Addr: \u0026#34;localhost:6379\u0026#34;, Password: \u0026#34;\u0026#34;, DB: 0, }) ctx := context.Background() // è®¾ç½®å€¼ err := rdb.Set(ctx, \u0026#34;key\u0026#34;, \u0026#34;value\u0026#34;, time.Hour).Err() // è·å–å€¼ val, err := rdb.Get(ctx, \u0026#34;key\u0026#34;).Result() // è‡ªå¢ rdb.Incr(ctx, \u0026#34;counter\u0026#34;) rdb.IncrBy(ctx, \u0026#34;counter\u0026#34;, 10) } 2.2 Hashï¼ˆå“ˆå¸Œï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 # å­˜å‚¨å¯¹è±¡ HSET user:1 name \u0026#34;Alice\u0026#34; age 25 email \u0026#34;alice@example.com\u0026#34; HGET user:1 name HGETALL user:1 HMGET user:1 name age # å­—æ®µæ“ä½œ HINCRBY user:1 age 1 HDEL user:1 email HEXISTS user:1 name HKEYS user:1 HVALS user:1 HLEN user:1 Go ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ user := map[string]interface{}{ \u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 25, \u0026#34;email\u0026#34;: \u0026#34;alice@example.com\u0026#34;, } rdb.HSet(ctx, \u0026#34;user:1\u0026#34;, user) // è·å–å•ä¸ªå­—æ®µ name, _ := rdb.HGet(ctx, \u0026#34;user:1\u0026#34;, \u0026#34;name\u0026#34;).Result() // è·å–æ‰€æœ‰å­—æ®µ data, _ := rdb.HGetAll(ctx, \u0026#34;user:1\u0026#34;).Result() 2.3 Listï¼ˆåˆ—è¡¨ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # é˜Ÿåˆ—æ“ä½œ LPUSH queue task1 task2 task3 # å·¦ä¾§æ’å…¥ RPUSH queue task4 # å³ä¾§æ’å…¥ LPOP queue # å·¦ä¾§å¼¹å‡º RPOP queue # å³ä¾§å¼¹å‡º LRANGE queue 0 -1 # è·å–æ‰€æœ‰å…ƒç´  LLEN queue # è·å–é•¿åº¦ # é˜»å¡æ“ä½œ BLPOP queue 10 # é˜»å¡å¼¹å‡ºï¼Œè¶…æ—¶ 10 ç§’ BRPOP queue 10 # æ¶ˆæ¯é˜Ÿåˆ— LPUSH notifications:user:1 \u0026#39;{\u0026#34;type\u0026#34;: \u0026#34;order\u0026#34;, \u0026#34;msg\u0026#34;: \u0026#34;è®¢å•å·²å‘è´§\u0026#34;}\u0026#39; BRPOP notifications:user:1 0 # ç”¨æˆ·ç›‘å¬æ¶ˆæ¯ 2.4 Setï¼ˆé›†åˆï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # é›†åˆæ“ä½œ SADD tags:article:1 go redis mysql SMEMBERS tags:article:1 SISMEMBER tags:article:1 go SCARD tags:article:1 # å…ƒç´ æ•°é‡ SREM tags:article:1 mysql # åˆ é™¤å…ƒç´  # é›†åˆè¿ç®— SINTER tags:article:1 tags:article:2 # äº¤é›† SUNION tags:article:1 tags:article:2 # å¹¶é›† SDIFF tags:article:1 tags:article:2 # å·®é›† # éšæœºå…ƒç´  SRANDMEMBER users 5 # éšæœºè·å– 5 ä¸ªç”¨æˆ· SPOP users # éšæœºå¼¹å‡ºä¸€ä¸ªå…ƒç´  2.5 Sorted Setï¼ˆæœ‰åºé›†åˆï¼‰ 1 2 3 4 5 6 7 8 9 10 11 # æ’è¡Œæ¦œ ZADD leaderboard 100 \u0026#34;player1\u0026#34; 200 \u0026#34;player2\u0026#34; 150 \u0026#34;player3\u0026#34; ZRANGE leaderboard 0 -1 WITHSCORES # æŒ‰åˆ†æ•°å‡åº ZREVRANGE leaderboard 0 2 WITHSCORES # æŒ‰åˆ†æ•°é™åºï¼Œå‰ 3 å ZRANK leaderboard \u0026#34;player1\u0026#34; # è·å–æ’å ZSCORE leaderboard \u0026#34;player1\u0026#34; # è·å–åˆ†æ•° ZINCRBY leaderboard 50 \u0026#34;player1\u0026#34; # å¢åŠ åˆ†æ•° # èŒƒå›´æŸ¥è¯¢ ZRANGEBYSCORE leaderboard 100 200 ZCOUNT leaderboard 100 200 Go ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 // æ’è¡Œæ¦œ members := []redis.Z{ {Score: 100, Member: \u0026#34;player1\u0026#34;}, {Score: 200, Member: \u0026#34;player2\u0026#34;}, {Score: 150, Member: \u0026#34;player3\u0026#34;}, } rdb.ZAdd(ctx, \u0026#34;leaderboard\u0026#34;, members...) // è·å–æ’å rank, _ := rdb.ZRevRank(ctx, \u0026#34;leaderboard\u0026#34;, \u0026#34;player1\u0026#34;).Result() // è·å–å‰ 10 å top10, _ := rdb.ZRevRangeWithScores(ctx, \u0026#34;leaderboard\u0026#34;, 0, 9).Result() ä¸‰ã€ç¼“å­˜ç­–ç•¥ 3.1 ç¼“å­˜æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // Cache-Aside æ¨¡å¼ func GetUser(ctx context.Context, userID int64) (*User, error) { key := fmt.Sprintf(\u0026#34;user:%d\u0026#34;, userID) // 1. å…ˆæŸ¥ç¼“å­˜ val, err := rdb.Get(ctx, key).Result() if err == nil { var user User json.Unmarshal([]byte(val), \u0026amp;user) return \u0026amp;user, nil } // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ user, err := db.GetUser(userID) if err != nil { return nil, err } // 3. å†™å…¥ç¼“å­˜ data, _ := json.Marshal(user) rdb.Set(ctx, key, data, time.Hour) return user, nil } // æ›´æ–°æ—¶åˆ é™¤ç¼“å­˜ func UpdateUser(ctx context.Context, user *User) error { // 1. æ›´æ–°æ•°æ®åº“ err := db.UpdateUser(user) if err != nil { return err } // 2. åˆ é™¤ç¼“å­˜ key := fmt.Sprintf(\u0026#34;user:%d\u0026#34;, user.ID) rdb.Del(ctx, key) return nil } 3.2 ç¼“å­˜ç©¿é€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // ç¼“å­˜ç©ºå€¼ func GetUserWithNullCache(ctx context.Context, userID int64) (*User, error) { key := fmt.Sprintf(\u0026#34;user:%d\u0026#34;, userID) val, err := rdb.Get(ctx, key).Result() if err == nil { if val == \u0026#34;NULL\u0026#34; { return nil, ErrUserNotFound } var user User json.Unmarshal([]byte(val), \u0026amp;user) return \u0026amp;user, nil } user, err := db.GetUser(userID) if err == ErrUserNotFound { // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€ rdb.Set(ctx, key, \u0026#34;NULL\u0026#34;, 5*time.Minute) return nil, err } data, _ := json.Marshal(user) rdb.Set(ctx, key, data, time.Hour) return user, nil } // å¸ƒéš†è¿‡æ»¤å™¨ func InitBloomFilter(ctx context.Context) { // å°†æ‰€æœ‰ç”¨æˆ· ID åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ userIDs, _ := db.GetAllUserIDs() for _, id := range userIDs { rdb.BFAdd(ctx, \u0026#34;user_bloom\u0026#34;, id) } } func GetUserWithBloom(ctx context.Context, userID int64) (*User, error) { // å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ exists, _ := rdb.BFExists(ctx, \u0026#34;user_bloom\u0026#34;, userID).Result() if !exists { return nil, ErrUserNotFound } // ç»§ç»­æ­£å¸¸çš„ç¼“å­˜é€»è¾‘ return GetUser(ctx, userID) } 3.3 ç¼“å­˜é›ªå´© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // éšæœºè¿‡æœŸæ—¶é—´ func SetWithRandomExpire(ctx context.Context, key string, value interface{}) error { data, _ := json.Marshal(value) // åŸºç¡€è¿‡æœŸæ—¶é—´ + éšæœºæ—¶é—´ï¼ˆ0-5åˆ†é’Ÿï¼‰ expire := time.Hour + time.Duration(rand.Intn(300))*time.Second return rdb.Set(ctx, key, data, expire).Err() } // çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ func SetHotData(ctx context.Context, key string, value interface{}) error { data, _ := json.Marshal(value) return rdb.Set(ctx, key, data, 0).Err() // 0 è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ } 3.4 ç¼“å­˜å‡»ç©¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 import \u0026#34;golang.org/x/sync/singleflight\u0026#34; var sf singleflight.Group // ä½¿ç”¨ singleflight é˜²æ­¢ç¼“å­˜å‡»ç©¿ func GetUserWithSingleFlight(ctx context.Context, userID int64) (*User, error) { key := fmt.Sprintf(\u0026#34;user:%d\u0026#34;, userID) // å…ˆæŸ¥ç¼“å­˜ val, err := rdb.Get(ctx, key).Result() if err == nil { var user User json.Unmarshal([]byte(val), \u0026amp;user) return \u0026amp;user, nil } // ä½¿ç”¨ singleflightï¼Œç›¸åŒ key åªæ‰§è¡Œä¸€æ¬¡ result, err, _ := sf.Do(key, func() (interface{}, error) { user, err := db.GetUser(userID) if err != nil { return nil, err } data, _ := json.Marshal(user) rdb.Set(ctx, key, data, time.Hour) return user, nil }) if err != nil { return nil, err } return result.(*User), nil } å››ã€åˆ†å¸ƒå¼é” 4.1 åŸºæœ¬å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // è·å–é” func AcquireLock(ctx context.Context, key string, value string, expire time.Duration) (bool, error) { return rdb.SetNX(ctx, key, value, expire).Result() } // é‡Šæ”¾é”ï¼ˆä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ï¼‰ var releaseLockScript = redis.NewScript(` if redis.call(\u0026#34;get\u0026#34;, KEYS[1]) == ARGV[1] then return redis.call(\u0026#34;del\u0026#34;, KEYS[1]) else return 0 end `) func ReleaseLock(ctx context.Context, key string, value string) (bool, error) { result, err := releaseLockScript.Run(ctx, rdb, []string{key}, value).Int64() return result == 1, err } // ä½¿ç”¨ç¤ºä¾‹ func DoWithLock(ctx context.Context) error { lockKey := \u0026#34;lock:order:create\u0026#34; lockValue := uuid.New().String() // è·å–é” acquired, err := AcquireLock(ctx, lockKey, lockValue, 30*time.Second) if err != nil || !acquired { return errors.New(\u0026#34;failed to acquire lock\u0026#34;) } // ç¡®ä¿é‡Šæ”¾é” defer ReleaseLock(ctx, lockKey, lockValue) // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ return doBusinessLogic() } 4.2 Redlock ç®—æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import \u0026#34;github.com/go-redsync/redsync/v4\u0026#34; func NewRedSync() *redsync.Redsync { pool := goredis.NewPool(rdb) return redsync.New(pool) } func DoWithRedlock(ctx context.Context) error { rs := NewRedSync() mutex := rs.NewMutex(\u0026#34;lock:order:create\u0026#34;, redsync.WithExpiry(30*time.Second), redsync.WithTries(3), redsync.WithRetryDelay(100*time.Millisecond), ) // è·å–é” if err := mutex.Lock(); err != nil { return err } // ç¡®ä¿é‡Šæ”¾é” defer mutex.Unlock() // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ return doBusinessLogic() } 4.3 çœ‹é—¨ç‹—æœºåˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // è‡ªåŠ¨ç»­æœŸçš„åˆ†å¸ƒå¼é” type WatchDogLock struct { key string value string expire time.Duration stopCh chan struct{} rdb *redis.Client } func NewWatchDogLock(rdb *redis.Client, key string, expire time.Duration) *WatchDogLock { return \u0026amp;WatchDogLock{ key: key, value: uuid.New().String(), expire: expire, stopCh: make(chan struct{}), rdb: rdb, } } func (l *WatchDogLock) Lock(ctx context.Context) error { // è·å–é” acquired, err := l.rdb.SetNX(ctx, l.key, l.value, l.expire).Result() if err != nil || !acquired { return errors.New(\u0026#34;failed to acquire lock\u0026#34;) } // å¯åŠ¨çœ‹é—¨ç‹— go l.watchDog(ctx) return nil } func (l *WatchDogLock) watchDog(ctx context.Context) { ticker := time.NewTicker(l.expire / 3) defer ticker.Stop() for { select { case \u0026lt;-ticker.C: // ç»­æœŸ l.rdb.Expire(ctx, l.key, l.expire) case \u0026lt;-l.stopCh: return case \u0026lt;-ctx.Done(): return } } } func (l *WatchDogLock) Unlock(ctx context.Context) error { close(l.stopCh) _, err := releaseLockScript.Run(ctx, l.rdb, []string{l.key}, l.value).Result() return err } äº”ã€æŒä¹…åŒ– 5.1 RDB å¿«ç…§ 1 2 3 4 5 6 7 8 9 10 11 # redis.conf é…ç½® save 900 1 # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ– save 300 10 # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ– save 60 10000 # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ– # æ‰‹åŠ¨è§¦å‘ BGSAVE # åå°ä¿å­˜ SAVE # åŒæ­¥ä¿å­˜ï¼ˆé˜»å¡ï¼‰ # æŸ¥çœ‹æœ€åä¿å­˜æ—¶é—´ LASTSAVE 5.2 AOF æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # redis.conf é…ç½® appendonly yes appendfilename \u0026#34;appendonly.aof\u0026#34; # åŒæ­¥ç­–ç•¥ appendfsync always # æ¯æ¬¡å†™å…¥éƒ½åŒæ­¥ appendfsync everysec # æ¯ç§’åŒæ­¥ï¼ˆæ¨èï¼‰ appendfsync no # ç”±æ“ä½œç³»ç»Ÿå†³å®š # AOF é‡å†™ auto-aof-rewrite-percentage 100 auto-aof-rewrite-min-size 64mb # æ‰‹åŠ¨é‡å†™ BGREWRITEAOF 5.3 æ··åˆæŒä¹…åŒ– 1 2 # Redis 4.0+ æ”¯æŒ aof-use-rdb-preamble yes å…­ã€é›†ç¾¤æ¶æ„ 6.1 ä¸»ä»å¤åˆ¶ 1 2 3 4 5 # ä»èŠ‚ç‚¹é…ç½® replicaof 192.168.1.100 6379 # æŸ¥çœ‹å¤åˆ¶çŠ¶æ€ INFO replication 6.2 å“¨å…µæ¨¡å¼ 1 2 3 4 5 6 7 8 # sentinel.conf sentinel monitor mymaster 192.168.1.100 6379 2 sentinel down-after-milliseconds mymaster 30000 sentinel failover-timeout mymaster 180000 sentinel parallel-syncs mymaster 1 # å¯åŠ¨å“¨å…µ redis-sentinel /path/to/sentinel.conf Go è¿æ¥å“¨å…µï¼š\n1 2 3 4 5 6 rdb := redis.NewFailoverClient(\u0026amp;redis.FailoverOptions{ MasterName: \u0026#34;mymaster\u0026#34;, SentinelAddrs: []string{\u0026#34;localhost:26379\u0026#34;, \u0026#34;localhost:26380\u0026#34;, \u0026#34;localhost:26381\u0026#34;}, Password: \u0026#34;\u0026#34;, DB: 0, }) 6.3 é›†ç¾¤æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åˆ›å»ºé›†ç¾¤ï¼ˆ6ä¸ªèŠ‚ç‚¹ï¼Œ3ä¸»3ä»ï¼‰ redis-cli --cluster create \\ 192.168.1.101:6379 \\ 192.168.1.102:6379 \\ 192.168.1.103:6379 \\ 192.168.1.104:6379 \\ 192.168.1.105:6379 \\ 192.168.1.106:6379 \\ --cluster-replicas 1 # é›†ç¾¤å‘½ä»¤ CLUSTER INFO CLUSTER NODES CLUSTER SLOTS Go è¿æ¥é›†ç¾¤ï¼š\n1 2 3 4 5 6 7 8 rdb := redis.NewClusterClient(\u0026amp;redis.ClusterOptions{ Addrs: []string{ \u0026#34;192.168.1.101:6379\u0026#34;, \u0026#34;192.168.1.102:6379\u0026#34;, \u0026#34;192.168.1.103:6379\u0026#34;, }, Password: \u0026#34;\u0026#34;, }) ä¸ƒã€Lua è„šæœ¬ 7.1 åŸºæœ¬ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // åŸå­æ“ä½œï¼šæ£€æŸ¥å¹¶è®¾ç½® var checkAndSetScript = redis.NewScript(` local current = redis.call(\u0026#39;GET\u0026#39;, KEYS[1]) if current == ARGV[1] then redis.call(\u0026#39;SET\u0026#39;, KEYS[1], ARGV[2]) return 1 end return 0 `) result, err := checkAndSetScript.Run(ctx, rdb, []string{\u0026#34;key\u0026#34;}, \u0026#34;oldValue\u0026#34;, \u0026#34;newValue\u0026#34;).Int64() // é™æµè„šæœ¬ var rateLimitScript = redis.NewScript(` local key = KEYS[1] local limit = tonumber(ARGV[1]) local window = tonumber(ARGV[2]) local current = tonumber(redis.call(\u0026#39;GET\u0026#39;, key) or 0) if current \u0026lt; limit then redis.call(\u0026#39;INCR\u0026#39;, key) if current == 0 then redis.call(\u0026#39;EXPIRE\u0026#39;, key, window) end return 1 end return 0 `) func RateLimit(ctx context.Context, key string, limit int, window int) (bool, error) { result, err := rateLimitScript.Run(ctx, rdb, []string{key}, limit, window).Int64() return result == 1, err } å…«ã€å‘å¸ƒè®¢é˜… 8.1 åŸºæœ¬ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // å‘å¸ƒæ¶ˆæ¯ func Publish(ctx context.Context, channel string, message interface{}) error { return rdb.Publish(ctx, channel, message).Err() } // è®¢é˜…æ¶ˆæ¯ func Subscribe(ctx context.Context, channel string) { pubsub := rdb.Subscribe(ctx, channel) defer pubsub.Close() ch := pubsub.Channel() for msg := range ch { fmt.Printf(\u0026#34;Received message: %s from channel: %s\\n\u0026#34;, msg.Payload, msg.Channel) } } 8.2 Streamï¼ˆRedis 5.0+ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // æ·»åŠ æ¶ˆæ¯ func AddMessage(ctx context.Context, stream string, values map[string]interface{}) (string, error) { return rdb.XAdd(ctx, \u0026amp;redis.XAddArgs{ Stream: stream, ID: \u0026#34;*\u0026#34;, Values: values, }).Result() } // æ¶ˆè´¹æ¶ˆæ¯ func ConsumeMessages(ctx context.Context, stream, group, consumer string) { for { messages, err := rdb.XReadGroup(ctx, \u0026amp;redis.XReadGroupArgs{ Group: group, Consumer: consumer, Streams: []string{stream, \u0026#34;\u0026gt;\u0026#34;}, Count: 10, Block: 0, }).Result() if err != nil { continue } for _, msg := range messages[0].Messages { // å¤„ç†æ¶ˆæ¯ processMessage(msg) // ç¡®è®¤æ¶ˆæ¯ rdb.XAck(ctx, stream, group, msg.ID) } } } // åˆ›å»ºæ¶ˆè´¹è€…ç»„ rdb.XGroupCreateMkStream(ctx, \u0026#34;mystream\u0026#34;, \u0026#34;mygroup\u0026#34;, \u0026#34;0\u0026#34;) æ€»ç»“ Redis æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å†…å­˜æ•°æ®åº“ï¼Œå¹¿æ³›åº”ç”¨äºç¼“å­˜ã€åˆ†å¸ƒå¼é”ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰åœºæ™¯ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“Š ä¸°å¯Œçš„æ•°æ®ç»“æ„æ”¯æŒ ğŸš€ æé«˜çš„è¯»å†™æ€§èƒ½ ğŸ”’ åˆ†å¸ƒå¼é”å®ç° ğŸ’¾ å¤šç§æŒä¹…åŒ–æ–¹å¼ ğŸ—ï¸ çµæ´»çš„é›†ç¾¤æ¶æ„ ","date":"2025-08-08T00:00:00Z","permalink":"https://zpf-zero.github.io/p/redis-guide/","title":"Redis 7.0 å®æˆ˜æŒ‡å—ï¼šé«˜æ€§èƒ½ç¼“å­˜ä¸åˆ†å¸ƒå¼é”"},{"content":"å‰è¨€ Docker æ˜¯ç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†æ–¹å¼ï¼Œå®ƒé€šè¿‡å®¹å™¨åŒ–æŠ€æœ¯å®ç°äº†\u0026quot;ä¸€æ¬¡æ„å»ºï¼Œåˆ°å¤„è¿è¡Œ\u0026quot;çš„ç†å¿µã€‚æŒæ¡ Docker æ˜¯æ¯ä¸ªå¼€å‘è€…å’Œè¿ç»´äººå‘˜çš„å¿…å¤‡æŠ€èƒ½ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£ Docker çš„æ ¸å¿ƒæ¦‚å¿µå’Œå®æˆ˜æŠ€å·§ã€‚\nä¸€ã€æ ¸å¿ƒæ¦‚å¿µ 1.1 æ¶æ„æ¦‚è§ˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Docker æ¶æ„ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Docker â”‚ â”‚ Docker â”‚ â”‚ Docker â”‚ â”‚ â”‚ â”‚ Client â”‚â”€â”€â”€â”€â”€\u0026gt;â”‚ Daemon â”‚\u0026lt;â”€â”€â”€â”€â”€â”‚ Registry â”‚ â”‚ â”‚ â”‚ (docker CLI)â”‚ â”‚ (dockerd) â”‚ â”‚ (Docker Hub) â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â–¼ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Container Runtime â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚Containerâ”‚ â”‚Containerâ”‚ â”‚Containerâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ App1 â”‚ â”‚ App2 â”‚ â”‚ App3 â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Host OS â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 1.2 æ ¸å¿ƒæ¦‚å¿µ æ¦‚å¿µ è¯´æ˜ é•œåƒ (Image) åªè¯»æ¨¡æ¿ï¼ŒåŒ…å«è¿è¡Œåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ å®¹å™¨ (Container) é•œåƒçš„è¿è¡Œå®ä¾‹ï¼Œå¯å†™å±‚ ä»“åº“ (Registry) å­˜å‚¨å’Œåˆ†å‘é•œåƒçš„æœåŠ¡ Dockerfile æ„å»ºé•œåƒçš„è„šæœ¬æ–‡ä»¶ å· (Volume) æŒä¹…åŒ–æ•°æ®å­˜å‚¨ ç½‘ç»œ (Network) å®¹å™¨é—´é€šä¿¡æœºåˆ¶ äºŒã€å¸¸ç”¨å‘½ä»¤ 2.1 é•œåƒæ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # æ‹‰å–é•œåƒ docker pull nginx:latest docker pull mysql:8.0 # æŸ¥çœ‹é•œåƒ docker images docker image ls # æ„å»ºé•œåƒ docker build -t myapp:v1.0 . docker build -t myapp:v1.0 -f Dockerfile.prod . # æ ‡è®°é•œåƒ docker tag myapp:v1.0 registry.example.com/myapp:v1.0 # æ¨é€é•œåƒ docker push registry.example.com/myapp:v1.0 # åˆ é™¤é•œåƒ docker rmi myapp:v1.0 docker image prune # åˆ é™¤æ‚¬ç©ºé•œåƒ docker image prune -a # åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨é•œåƒ # æŸ¥çœ‹é•œåƒå†å² docker history myapp:v1.0 # å¯¼å‡º/å¯¼å…¥é•œåƒ docker save -o myapp.tar myapp:v1.0 docker load -i myapp.tar 2.2 å®¹å™¨æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 # è¿è¡Œå®¹å™¨ docker run nginx docker run -d nginx # åå°è¿è¡Œ docker run -d -p 8080:80 nginx # ç«¯å£æ˜ å°„ docker run -d --name my-nginx nginx # æŒ‡å®šåç§° docker run -d -v /data:/app/data nginx # æŒ‚è½½å· docker run -d -e MYSQL_ROOT_PASSWORD=password mysql # ç¯å¢ƒå˜é‡ docker run -d --restart=always nginx # è‡ªåŠ¨é‡å¯ # æŸ¥çœ‹å®¹å™¨ docker ps # è¿è¡Œä¸­çš„å®¹å™¨ docker ps -a # æ‰€æœ‰å®¹å™¨ # å®¹å™¨ç”Ÿå‘½å‘¨æœŸ docker start my-nginx docker stop my-nginx docker restart my-nginx docker pause my-nginx docker unpause my-nginx docker rm my-nginx docker rm -f my-nginx # å¼ºåˆ¶åˆ é™¤ # è¿›å…¥å®¹å™¨ docker exec -it my-nginx bash docker exec -it my-nginx sh # æŸ¥çœ‹æ—¥å¿— docker logs my-nginx docker logs -f my-nginx # å®æ—¶æ—¥å¿— docker logs --tail 100 my-nginx # æœ€å100è¡Œ # æŸ¥çœ‹å®¹å™¨è¯¦æƒ… docker inspect my-nginx docker stats # èµ„æºä½¿ç”¨ # å¤åˆ¶æ–‡ä»¶ docker cp myfile.txt my-nginx:/app/ docker cp my-nginx:/app/config.yml ./ 2.3 ç½‘ç»œæ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # åˆ›å»ºç½‘ç»œ docker network create my-network docker network create --driver bridge my-bridge # æŸ¥çœ‹ç½‘ç»œ docker network ls docker network inspect my-network # è¿æ¥/æ–­å¼€ç½‘ç»œ docker network connect my-network my-container docker network disconnect my-network my-container # åˆ é™¤ç½‘ç»œ docker network rm my-network docker network prune 2.4 å·æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 # åˆ›å»ºå· docker volume create my-volume # æŸ¥çœ‹å· docker volume ls docker volume inspect my-volume # ä½¿ç”¨å· docker run -v my-volume:/app/data nginx # åˆ é™¤å· docker volume rm my-volume docker volume prune ä¸‰ã€Dockerfile ç¼–å†™ 3.1 åŸºç¡€æŒ‡ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # åŸºç¡€é•œåƒ FROM golang:1.21-alpine AS builder # ç»´æŠ¤è€…ä¿¡æ¯ LABEL maintainer=\u0026#34;dev@example.com\u0026#34; LABEL version=\u0026#34;1.0\u0026#34; # è®¾ç½®å·¥ä½œç›®å½• WORKDIR /app # å¤åˆ¶æ–‡ä»¶ COPY go.mod go.sum ./ COPY . . # è¿è¡Œå‘½ä»¤ RUN go mod download RUN go build -o main . # ç¯å¢ƒå˜é‡ ENV APP_ENV=production ENV PORT=8080 # æš´éœ²ç«¯å£ EXPOSE 8080 # å¯åŠ¨å‘½ä»¤ CMD [\u0026#34;./main\u0026#34;] # æˆ– ENTRYPOINT [\u0026#34;./main\u0026#34;] 3.2 å¤šé˜¶æ®µæ„å»º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Go åº”ç”¨å¤šé˜¶æ®µæ„å»º FROM golang:1.21-alpine AS builder WORKDIR /app # ä¾èµ–ç¼“å­˜ COPY go.mod go.sum ./ RUN go mod download # ç¼–è¯‘ COPY . . RUN CGO_ENABLED=0 GOOS=linux go build -ldflags=\u0026#34;-s -w\u0026#34; -o main . # æœ€ç»ˆé•œåƒ FROM alpine:latest RUN apk --no-cache add ca-certificates tzdata ENV TZ=Asia/Shanghai WORKDIR /app # åªå¤åˆ¶ç¼–è¯‘äº§ç‰© COPY --from=builder /app/main . COPY --from=builder /app/config ./config EXPOSE 8080 CMD [\u0026#34;./main\u0026#34;] 3.3 Node.js åº”ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # Node.js å¤šé˜¶æ®µæ„å»º FROM node:18-alpine AS builder WORKDIR /app COPY package*.json ./ RUN npm ci --only=production COPY . . RUN npm run build # ç”Ÿäº§é•œåƒ FROM node:18-alpine WORKDIR /app COPY --from=builder /app/dist ./dist COPY --from=builder /app/node_modules ./node_modules COPY package*.json ./ EXPOSE 3000 CMD [\u0026#34;node\u0026#34;, \u0026#34;dist/main.js\u0026#34;] 3.4 æœ€ä½³å®è·µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # âœ… å¥½çš„å®è·µ # 1. ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬æ ‡ç­¾ FROM node:18.17.0-alpine # 2. åˆå¹¶ RUN æŒ‡ä»¤å‡å°‘å±‚æ•° RUN apk add --no-cache \\ git \\ curl \\ \u0026amp;\u0026amp; rm -rf /var/cache/apk/* # 3. åˆ©ç”¨æ„å»ºç¼“å­˜ï¼ˆå…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼‰ COPY package*.json ./ RUN npm ci COPY . . # 4. ä½¿ç”¨ .dockerignore # node_modules # .git # *.log # 5. é root ç”¨æˆ·è¿è¡Œ RUN addgroup -S appgroup \u0026amp;\u0026amp; adduser -S appuser -G appgroup USER appuser # 6. å¥åº·æ£€æŸ¥ HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\ CMD curl -f http://localhost:8080/health || exit 1 # 7. ä½¿ç”¨ ARG ä¼ é€’æ„å»ºå‚æ•° ARG VERSION=latest LABEL version=$VERSION å››ã€Docker Compose 4.1 åŸºç¡€é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 # docker-compose.yml version: \u0026#39;3.8\u0026#39; services: app: build: context: . dockerfile: Dockerfile image: myapp:latest container_name: myapp ports: - \u0026#34;8080:8080\u0026#34; environment: - DB_HOST=mysql - REDIS_HOST=redis depends_on: - mysql - redis volumes: - ./config:/app/config - app_logs:/app/logs networks: - app-network restart: unless-stopped mysql: image: mysql:8.0 container_name: mysql environment: MYSQL_ROOT_PASSWORD: rootpassword MYSQL_DATABASE: myapp MYSQL_USER: user MYSQL_PASSWORD: password volumes: - mysql_data:/var/lib/mysql - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql ports: - \u0026#34;3306:3306\u0026#34; networks: - app-network redis: image: redis:7-alpine container_name: redis command: redis-server --appendonly yes volumes: - redis_data:/data ports: - \u0026#34;6379:6379\u0026#34; networks: - app-network volumes: mysql_data: redis_data: app_logs: networks: app-network: driver: bridge 4.2 å¸¸ç”¨å‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # å¯åŠ¨æœåŠ¡ docker-compose up docker-compose up -d # åå°è¿è¡Œ docker-compose up --build # é‡æ–°æ„å»º # åœæ­¢æœåŠ¡ docker-compose down docker-compose down -v # åŒæ—¶åˆ é™¤å· # æŸ¥çœ‹çŠ¶æ€ docker-compose ps docker-compose logs docker-compose logs -f app # æ‰©ç¼©å®¹ docker-compose up -d --scale app=3 # æ‰§è¡Œå‘½ä»¤ docker-compose exec app sh docker-compose run app npm test 4.3 ç¯å¢ƒå˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # docker-compose.yml services: app: image: myapp environment: - NODE_ENV=${NODE_ENV:-production} - DB_HOST=${DB_HOST} env_file: - .env - .env.local # .env NODE_ENV=development DB_HOST=localhost DB_PORT=3306 4.4 å¤šç¯å¢ƒé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # docker-compose.ymlï¼ˆåŸºç¡€é…ç½®ï¼‰ version: \u0026#39;3.8\u0026#39; services: app: image: myapp ports: - \u0026#34;8080:8080\u0026#34; # docker-compose.override.ymlï¼ˆå¼€å‘ç¯å¢ƒï¼Œè‡ªåŠ¨åŠ è½½ï¼‰ services: app: build: . volumes: - .:/app environment: - DEBUG=true # docker-compose.prod.ymlï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ services: app: restart: always deploy: replicas: 3 resources: limits: cpus: \u0026#39;0.5\u0026#39; memory: 512M # ä½¿ç”¨ docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d äº”ã€ç½‘ç»œæ¨¡å¼ 5.1 ç½‘ç»œç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # Bridgeï¼ˆé»˜è®¤ï¼‰ docker run --network bridge nginx # Hostï¼ˆå…±äº«ä¸»æœºç½‘ç»œï¼‰ docker run --network host nginx # Noneï¼ˆæ— ç½‘ç»œï¼‰ docker run --network none nginx # Containerï¼ˆå…±äº«å®¹å™¨ç½‘ç»œï¼‰ docker run --network container:other-container nginx # è‡ªå®šä¹‰ç½‘ç»œ docker network create --driver bridge my-network docker run --network my-network nginx 5.2 å®¹å™¨é€šä¿¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # docker-compose.yml services: app: networks: - frontend - backend nginx: networks: - frontend mysql: networks: - backend networks: frontend: backend: å…­ã€æ•°æ®ç®¡ç† 6.1 æ•°æ®å· 1 2 3 4 5 6 7 8 9 10 11 # å‘½åå· docker run -v mydata:/app/data nginx # ç»‘å®šæŒ‚è½½ docker run -v /host/path:/container/path nginx # åªè¯»æŒ‚è½½ docker run -v /host/path:/container/path:ro nginx # ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ docker run --tmpfs /app/tmp nginx 6.2 æ•°æ®å¤‡ä»½ 1 2 3 4 5 6 7 8 9 10 11 # å¤‡ä»½å·æ•°æ® docker run --rm \\ -v mydata:/data \\ -v $(pwd):/backup \\ alpine tar cvf /backup/backup.tar /data # æ¢å¤å·æ•°æ® docker run --rm \\ -v mydata:/data \\ -v $(pwd):/backup \\ alpine tar xvf /backup/backup.tar -C / ä¸ƒã€å®‰å…¨æœ€ä½³å®è·µ 7.1 é•œåƒå®‰å…¨ 1 2 3 4 5 6 7 8 9 10 # 1. ä½¿ç”¨å®˜æ–¹é•œåƒ FROM node:18-alpine # 2. å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ # 3. æ‰«æé•œåƒæ¼æ´ # docker scan myapp:latest # 4. æœ€å°åŒ–é•œåƒå†…å®¹ FROM alpine RUN apk add --no-cache nodejs 7.2 è¿è¡Œæ—¶å®‰å…¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # é root ç”¨æˆ·è¿è¡Œ docker run --user 1000:1000 nginx # åªè¯»æ–‡ä»¶ç³»ç»Ÿ docker run --read-only nginx # é™åˆ¶èµ„æº docker run --memory=512m --cpus=0.5 nginx # ç§»é™¤ç‰¹æƒ docker run --cap-drop=ALL --cap-add=NET_BIND_SERVICE nginx # å®‰å…¨é…ç½® docker run --security-opt=no-new-privileges nginx å…«ã€é•œåƒä¼˜åŒ– 8.1 å‡å°é•œåƒå¤§å° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # 1. ä½¿ç”¨ Alpine åŸºç¡€é•œåƒ FROM node:18-alpine # ~180MB # vs FROM node:18 # ~1GB # 2. å¤šé˜¶æ®µæ„å»º FROM golang:1.21 AS builder # ... æ„å»º FROM scratch COPY --from=builder /app/main /main # 3. æ¸…ç†ç¼“å­˜ RUN apt-get update \u0026amp;\u0026amp; apt-get install -y \\ package \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* # 4. åˆå¹¶å±‚ RUN npm ci \u0026amp;\u0026amp; npm run build \u0026amp;\u0026amp; npm prune --production 8.2 æ„å»ºç¼“å­˜ 1 2 3 4 5 6 7 # åˆ©ç”¨ç¼“å­˜ï¼šå…ˆå¤åˆ¶å˜åŒ–å°‘çš„æ–‡ä»¶ COPY package*.json ./ RUN npm ci # åå¤åˆ¶æºä»£ç  COPY . . RUN npm run build æ€»ç»“ Docker é€šè¿‡å®¹å™¨åŒ–æŠ€æœ¯ç®€åŒ–äº†åº”ç”¨éƒ¨ç½²ï¼Œæ˜¯ç°ä»£ DevOps çš„åŸºç¡€æŠ€èƒ½ã€‚\nå…³é”®è¦ç‚¹ï¼š\né•œåƒæ„å»ºï¼šå¤šé˜¶æ®µæ„å»ºã€æœ€å°åŒ–é•œåƒ Dockerfileï¼šåˆ©ç”¨ç¼“å­˜ã€é root ç”¨æˆ· Docker Composeï¼šæœåŠ¡ç¼–æ’ã€å¤šç¯å¢ƒé…ç½® æ•°æ®ç®¡ç†ï¼šå·ã€ç»‘å®šæŒ‚è½½ å®‰å…¨å®è·µï¼šèµ„æºé™åˆ¶ã€æƒé™æ§åˆ¶ ç»§ç»­å­¦ä¹ ï¼š\nDocker å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.docker.com/ Docker Hubï¼šhttps://hub.docker.com/ Incoming (Background Agent changes)\n","date":"2025-08-06T00:00:00Z","permalink":"https://zpf-zero.github.io/p/docker-two/","title":"Docker å®æˆ˜æŒ‡å—ï¼šå®¹å™¨åŒ–éƒ¨ç½²ä»å…¥é—¨åˆ°ç²¾é€š"},{"content":"å‰è¨€ Prometheus æ˜¯ CNCF æ¯•ä¸šçš„å¼€æºç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿï¼Œå·²æˆä¸ºäº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­çš„æ ‡å‡†ç›‘æ§è§£å†³æ–¹æ¡ˆã€‚å®ƒå…·æœ‰å¤šç»´æ•°æ®æ¨¡å‹ã€å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ PromQLã€è‡ªåŠ¨æœåŠ¡å‘ç°ç­‰ç‰¹æ€§ã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£…éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # docker-compose.yml version: \u0026#39;3.8\u0026#39; services: prometheus: image: prom/prometheus:latest ports: - \u0026#34;9090:9090\u0026#34; volumes: - ./prometheus.yml:/etc/prometheus/prometheus.yml - prometheus_data:/prometheus command: - \u0026#39;--config.file=/etc/prometheus/prometheus.yml\u0026#39; - \u0026#39;--storage.tsdb.path=/prometheus\u0026#39; - \u0026#39;--web.enable-lifecycle\u0026#39; volumes: prometheus_data: 1.2 åŸºç¡€é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # prometheus.yml global: scrape_interval: 15s evaluation_interval: 15s alerting: alertmanagers: - static_configs: - targets: - alertmanager:9093 rule_files: - \u0026#34;alerts/*.yml\u0026#34; scrape_configs: - job_name: \u0026#39;prometheus\u0026#39; static_configs: - targets: [\u0026#39;localhost:9090\u0026#39;] - job_name: \u0026#39;node\u0026#39; static_configs: - targets: [\u0026#39;node-exporter:9100\u0026#39;] - job_name: \u0026#39;app\u0026#39; static_configs: - targets: [\u0026#39;app:8080\u0026#39;] metrics_path: /metrics äºŒã€æŒ‡æ ‡ç±»å‹ 2.1 Counterï¼ˆè®¡æ•°å™¨ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import ( \u0026#34;github.com/prometheus/client_golang/prometheus\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus/promauto\u0026#34; ) // å®šä¹‰ Counter var httpRequestsTotal = promauto.NewCounterVec( prometheus.CounterOpts{ Name: \u0026#34;http_requests_total\u0026#34;, Help: \u0026#34;Total number of HTTP requests\u0026#34;, }, []string{\u0026#34;method\u0026#34;, \u0026#34;path\u0026#34;, \u0026#34;status\u0026#34;}, ) // ä½¿ç”¨ httpRequestsTotal.WithLabelValues(\u0026#34;GET\u0026#34;, \u0026#34;/api/users\u0026#34;, \u0026#34;200\u0026#34;).Inc() httpRequestsTotal.WithLabelValues(\u0026#34;POST\u0026#34;, \u0026#34;/api/users\u0026#34;, \u0026#34;201\u0026#34;).Add(1) 2.2 Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // å®šä¹‰ Gauge var activeConnections = promauto.NewGauge( prometheus.GaugeOpts{ Name: \u0026#34;active_connections\u0026#34;, Help: \u0026#34;Number of active connections\u0026#34;, }, ) var memoryUsage = promauto.NewGaugeVec( prometheus.GaugeOpts{ Name: \u0026#34;memory_usage_bytes\u0026#34;, Help: \u0026#34;Memory usage in bytes\u0026#34;, }, []string{\u0026#34;type\u0026#34;}, ) // ä½¿ç”¨ activeConnections.Set(100) activeConnections.Inc() activeConnections.Dec() activeConnections.Add(10) activeConnections.Sub(5) memoryUsage.WithLabelValues(\u0026#34;heap\u0026#34;).Set(1024 * 1024 * 100) 2.3 Histogramï¼ˆç›´æ–¹å›¾ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // å®šä¹‰ Histogram var httpRequestDuration = promauto.NewHistogramVec( prometheus.HistogramOpts{ Name: \u0026#34;http_request_duration_seconds\u0026#34;, Help: \u0026#34;HTTP request duration in seconds\u0026#34;, Buckets: []float64{0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1, 5}, }, []string{\u0026#34;method\u0026#34;, \u0026#34;path\u0026#34;}, ) // ä½¿ç”¨ start := time.Now() // å¤„ç†è¯·æ±‚ duration := time.Since(start).Seconds() httpRequestDuration.WithLabelValues(\u0026#34;GET\u0026#34;, \u0026#34;/api/users\u0026#34;).Observe(duration) // ä½¿ç”¨ Timer timer := prometheus.NewTimer(httpRequestDuration.WithLabelValues(\u0026#34;POST\u0026#34;, \u0026#34;/api/users\u0026#34;)) defer timer.ObserveDuration() 2.4 Summaryï¼ˆæ‘˜è¦ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // å®šä¹‰ Summary var requestLatency = promauto.NewSummaryVec( prometheus.SummaryOpts{ Name: \u0026#34;request_latency_seconds\u0026#34;, Help: \u0026#34;Request latency in seconds\u0026#34;, Objectives: map[float64]float64{ 0.5: 0.05, // 50th percentile, 5% error 0.9: 0.01, // 90th percentile, 1% error 0.99: 0.001, // 99th percentile, 0.1% error }, }, []string{\u0026#34;handler\u0026#34;}, ) // ä½¿ç”¨ requestLatency.WithLabelValues(\u0026#34;GetUser\u0026#34;).Observe(0.042) ä¸‰ã€Go åº”ç”¨é›†æˆ 3.1 Gin ä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 package middleware import ( \u0026#34;strconv\u0026#34; \u0026#34;time\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus/promauto\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus/promhttp\u0026#34; ) var ( httpRequestsTotal = promauto.NewCounterVec( prometheus.CounterOpts{ Name: \u0026#34;http_requests_total\u0026#34;, Help: \u0026#34;Total number of HTTP requests\u0026#34;, }, []string{\u0026#34;method\u0026#34;, \u0026#34;path\u0026#34;, \u0026#34;status\u0026#34;}, ) httpRequestDuration = promauto.NewHistogramVec( prometheus.HistogramOpts{ Name: \u0026#34;http_request_duration_seconds\u0026#34;, Help: \u0026#34;HTTP request duration in seconds\u0026#34;, Buckets: prometheus.DefBuckets, }, []string{\u0026#34;method\u0026#34;, \u0026#34;path\u0026#34;}, ) httpRequestsInFlight = promauto.NewGauge( prometheus.GaugeOpts{ Name: \u0026#34;http_requests_in_flight\u0026#34;, Help: \u0026#34;Number of HTTP requests currently being processed\u0026#34;, }, ) ) func PrometheusMiddleware() gin.HandlerFunc { return func(c *gin.Context) { path := c.FullPath() if path == \u0026#34;\u0026#34; { path = \u0026#34;unknown\u0026#34; } httpRequestsInFlight.Inc() start := time.Now() c.Next() httpRequestsInFlight.Dec() duration := time.Since(start).Seconds() status := strconv.Itoa(c.Writer.Status()) httpRequestsTotal.WithLabelValues(c.Request.Method, path, status).Inc() httpRequestDuration.WithLabelValues(c.Request.Method, path).Observe(duration) } } func MetricsHandler() gin.HandlerFunc { h := promhttp.Handler() return func(c *gin.Context) { h.ServeHTTP(c.Writer, c.Request) } } 3.2 è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 package metrics import ( \u0026#34;github.com/prometheus/client_golang/prometheus\u0026#34; \u0026#34;github.com/prometheus/client_golang/prometheus/promauto\u0026#34; ) var ( // è®¢å•æŒ‡æ ‡ OrdersCreated = promauto.NewCounterVec( prometheus.CounterOpts{ Name: \u0026#34;orders_created_total\u0026#34;, Help: \u0026#34;Total number of orders created\u0026#34;, }, []string{\u0026#34;product_type\u0026#34;}, ) OrderAmount = promauto.NewHistogramVec( prometheus.HistogramOpts{ Name: \u0026#34;order_amount\u0026#34;, Help: \u0026#34;Order amount distribution\u0026#34;, Buckets: []float64{10, 50, 100, 500, 1000, 5000, 10000}, }, []string{\u0026#34;product_type\u0026#34;}, ) // ç”¨æˆ·æŒ‡æ ‡ ActiveUsers = promauto.NewGauge( prometheus.GaugeOpts{ Name: \u0026#34;active_users\u0026#34;, Help: \u0026#34;Number of active users\u0026#34;, }, ) // ç¼“å­˜æŒ‡æ ‡ CacheHits = promauto.NewCounterVec( prometheus.CounterOpts{ Name: \u0026#34;cache_hits_total\u0026#34;, Help: \u0026#34;Total number of cache hits\u0026#34;, }, []string{\u0026#34;cache_name\u0026#34;}, ) CacheMisses = promauto.NewCounterVec( prometheus.CounterOpts{ Name: \u0026#34;cache_misses_total\u0026#34;, Help: \u0026#34;Total number of cache misses\u0026#34;, }, []string{\u0026#34;cache_name\u0026#34;}, ) ) // ä¸šåŠ¡ä½¿ç”¨ func CreateOrder(productType string, amount float64) { // ä¸šåŠ¡é€»è¾‘... OrdersCreated.WithLabelValues(productType).Inc() OrderAmount.WithLabelValues(productType).Observe(amount) } å››ã€PromQL æŸ¥è¯¢ 4.1 åŸºç¡€æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 # å³æ—¶æŸ¥è¯¢ http_requests_total # å¸¦æ ‡ç­¾è¿‡æ»¤ http_requests_total{method=\u0026#34;GET\u0026#34;} http_requests_total{method=~\u0026#34;GET|POST\u0026#34;} http_requests_total{path!=\u0026#34;/health\u0026#34;} # èŒƒå›´æŸ¥è¯¢ï¼ˆè¿‡å»5åˆ†é’Ÿï¼‰ http_requests_total[5m] # åç§»é‡ http_requests_total offset 1h 4.2 èšåˆæ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # æ±‚å’Œ sum(http_requests_total) sum by (method) (http_requests_total) sum without (instance) (http_requests_total) # è®¡æ•° count(http_requests_total) # å¹³å‡å€¼ avg(http_request_duration_seconds) # æœ€å¤§/æœ€å°å€¼ max(http_request_duration_seconds) min(http_request_duration_seconds) # æ ‡å‡†å·® stddev(http_request_duration_seconds) # Top N topk(5, http_requests_total) bottomk(5, http_requests_total) 4.3 å¸¸ç”¨å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # é€Ÿç‡ï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰ rate(http_requests_total[5m]) irate(http_requests_total[5m]) # å¢é•¿é‡ increase(http_requests_total[1h]) delta(temperature[1h]) # ç›´æ–¹å›¾åˆ†ä½æ•° histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket[5m]))) # æ—¶é—´å‡½æ•° time() timestamp(http_requests_total) # é¢„æµ‹ predict_linear(node_filesystem_free_bytes[1h], 4*3600) # æ’åº sort(http_requests_total) sort_desc(http_requests_total) 4.4 å®ç”¨æŸ¥è¯¢ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰ sum(rate(http_requests_total[5m])) # é”™è¯¯ç‡ sum(rate(http_requests_total{status=~\u0026#34;5..\u0026#34;}[5m])) / sum(rate(http_requests_total[5m])) * 100 # å¹³å‡å“åº”æ—¶é—´ sum(rate(http_request_duration_seconds_sum[5m])) / sum(rate(http_request_duration_seconds_count[5m])) # P99 å“åº”æ—¶é—´ histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket[5m]))) # CPU ä½¿ç”¨ç‡ 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\u0026#34;idle\u0026#34;}[5m])) * 100) # å†…å­˜ä½¿ç”¨ç‡ (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 # ç£ç›˜ä½¿ç”¨ç‡ (1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 äº”ã€å‘Šè­¦è§„åˆ™ 5.1 å‘Šè­¦é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # alerts/app.yml groups: - name: app rules: - alert: HighErrorRate expr: | sum(rate(http_requests_total{status=~\u0026#34;5..\u0026#34;}[5m])) / sum(rate(http_requests_total[5m])) \u0026gt; 0.01 for: 5m labels: severity: critical annotations: summary: \u0026#34;High error rate detected\u0026#34; description: \u0026#34;Error rate is {{ $value | humanizePercentage }}\u0026#34; - alert: HighLatency expr: | histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket[5m]))) \u0026gt; 1 for: 5m labels: severity: warning annotations: summary: \u0026#34;High latency detected\u0026#34; description: \u0026#34;P99 latency is {{ $value }}s\u0026#34; - alert: ServiceDown expr: up == 0 for: 1m labels: severity: critical annotations: summary: \u0026#34;Service {{ $labels.instance }} is down\u0026#34; 5.2 Alertmanager é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # alertmanager.yml global: smtp_smarthost: \u0026#39;smtp.example.com:587\u0026#39; smtp_from: \u0026#39;alertmanager@example.com\u0026#39; route: group_by: [\u0026#39;alertname\u0026#39;, \u0026#39;severity\u0026#39;] group_wait: 30s group_interval: 5m repeat_interval: 4h receiver: \u0026#39;default\u0026#39; routes: - match: severity: critical receiver: \u0026#39;critical\u0026#39; - match: severity: warning receiver: \u0026#39;warning\u0026#39; receivers: - name: \u0026#39;default\u0026#39; email_configs: - to: \u0026#39;team@example.com\u0026#39; - name: \u0026#39;critical\u0026#39; email_configs: - to: \u0026#39;oncall@example.com\u0026#39; webhook_configs: - url: \u0026#39;http://pagerduty.example.com/alert\u0026#39; - name: \u0026#39;warning\u0026#39; slack_configs: - api_url: \u0026#39;https://hooks.slack.com/services/xxx\u0026#39; channel: \u0026#39;#alerts\u0026#39; å…­ã€æœåŠ¡å‘ç° 6.1 Kubernetes æœåŠ¡å‘ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # prometheus.yml scrape_configs: - job_name: \u0026#39;kubernetes-pods\u0026#39; kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape] action: keep regex: true - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path] action: replace target_label: __metrics_path__ regex: (.+) - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port] action: replace regex: ([^:]+)(?::\\d+)?;(\\d+) replacement: $1:$2 target_label: __address__ 6.2 Consul æœåŠ¡å‘ç° 1 2 3 4 5 6 7 8 9 scrape_configs: - job_name: \u0026#39;consul\u0026#39; consul_sd_configs: - server: \u0026#39;consul:8500\u0026#39; services: [] relabel_configs: - source_labels: [__meta_consul_tags] regex: .*,prometheus,.* action: keep ä¸ƒã€æœ€ä½³å®è·µ 7.1 æŒ‡æ ‡å‘½åè§„èŒƒ 1 2 3 4 5 6 7 8 9 // å¥½çš„å‘½å http_requests_total http_request_duration_seconds node_memory_usage_bytes // é¿å…çš„å‘½å requests duration memory 7.2 æ ‡ç­¾ä½¿ç”¨ 1 2 3 4 5 // å¥½çš„æ ‡ç­¾ä½¿ç”¨ httpRequestsTotal.WithLabelValues(\u0026#34;GET\u0026#34;, \u0026#34;/api/users\u0026#34;, \u0026#34;200\u0026#34;) // é¿å…é«˜åŸºæ•°æ ‡ç­¾ httpRequestsTotal.WithLabelValues(\u0026#34;GET\u0026#34;, \u0026#34;/api/users/123\u0026#34;, \u0026#34;200\u0026#34;) // ç”¨æˆ·IDä¸åº”ä½œä¸ºæ ‡ç­¾ æ€»ç»“ Prometheus æ˜¯äº‘åŸç”Ÿæ—¶ä»£æœ€æµè¡Œçš„ç›‘æ§ç³»ç»Ÿï¼Œå…·æœ‰å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€å’Œçµæ´»çš„å‘Šè­¦æœºåˆ¶ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“Š å¤šç»´åº¦æ•°æ®æ¨¡å‹ ğŸ” å¼ºå¤§çš„ PromQL æŸ¥è¯¢ ğŸš¨ çµæ´»çš„å‘Šè­¦è§„åˆ™ ğŸ”Œ ä¸°å¯Œçš„é›†æˆç”Ÿæ€ ğŸ“ˆ é«˜æ•ˆçš„æ—¶åºå­˜å‚¨ ","date":"2025-08-03T00:00:00Z","permalink":"https://zpf-zero.github.io/p/prometheus-guide/","title":"Prometheus å®æˆ˜æŒ‡å—ï¼šäº‘åŸç”Ÿç›‘æ§ç³»ç»Ÿ"},{"content":"å‰è¨€ ECharts æ˜¯ç™¾åº¦å¼€æºçš„å¼ºå¤§æ•°æ®å¯è§†åŒ–å›¾è¡¨åº“ï¼Œæä¾›äº†ä¸°å¯Œçš„å›¾è¡¨ç±»å‹å’Œçµæ´»çš„é…ç½®é€‰é¡¹ã€‚å®ƒæ”¯æŒ Canvas å’Œ SVG æ¸²æŸ“ï¼Œå¯ä»¥æµç•…è¿è¡Œåœ¨ PC å’Œç§»åŠ¨è®¾å¤‡ä¸Šã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£… 1 npm install echarts 1.2 åŸºæœ¬ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 \u0026lt;template\u0026gt; \u0026lt;div ref=\u0026#34;chartRef\u0026#34; style=\u0026#34;width: 600px; height: 400px\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, onMounted, onUnmounted } from \u0026#39;vue\u0026#39; import * as echarts from \u0026#39;echarts\u0026#39; const chartRef = ref\u0026lt;HTMLElement\u0026gt;() let chart: echarts.ECharts | null = null onMounted(() =\u0026gt; { if (chartRef.value) { chart = echarts.init(chartRef.value) const option = { title: { text: \u0026#39;ç¤ºä¾‹å›¾è¡¨\u0026#39;, }, xAxis: { type: \u0026#39;category\u0026#39;, data: [\u0026#39;Mon\u0026#39;, \u0026#39;Tue\u0026#39;, \u0026#39;Wed\u0026#39;, \u0026#39;Thu\u0026#39;, \u0026#39;Fri\u0026#39;, \u0026#39;Sat\u0026#39;, \u0026#39;Sun\u0026#39;], }, yAxis: { type: \u0026#39;value\u0026#39;, }, series: [ { data: [120, 200, 150, 80, 70, 110, 130], type: \u0026#39;bar\u0026#39;, }, ], } chart.setOption(option) } }) onUnmounted(() =\u0026gt; { chart?.dispose() }) \u0026lt;/script\u0026gt; 1.3 æŒ‰éœ€å¼•å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // å¼•å…¥æ ¸å¿ƒæ¨¡å— import * as echarts from \u0026#39;echarts/core\u0026#39; // å¼•å…¥å›¾è¡¨ import { BarChart, LineChart, PieChart } from \u0026#39;echarts/charts\u0026#39; // å¼•å…¥ç»„ä»¶ import { TitleComponent, TooltipComponent, GridComponent, LegendComponent, } from \u0026#39;echarts/components\u0026#39; // å¼•å…¥æ¸²æŸ“å™¨ import { CanvasRenderer } from \u0026#39;echarts/renderers\u0026#39; // æ³¨å†Œ echarts.use([ BarChart, LineChart, PieChart, TitleComponent, TooltipComponent, GridComponent, LegendComponent, CanvasRenderer, ]) export default echarts äºŒã€å¸¸ç”¨å›¾è¡¨ 2.1 æŠ˜çº¿å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 const option = { title: { text: \u0026#39;é”€å”®è¶‹åŠ¿\u0026#39; }, tooltip: { trigger: \u0026#39;axis\u0026#39;, }, legend: { data: [\u0026#39;é”€å”®é¢\u0026#39;, \u0026#39;è®¢å•æ•°\u0026#39;], }, xAxis: { type: \u0026#39;category\u0026#39;, data: [\u0026#39;1æœˆ\u0026#39;, \u0026#39;2æœˆ\u0026#39;, \u0026#39;3æœˆ\u0026#39;, \u0026#39;4æœˆ\u0026#39;, \u0026#39;5æœˆ\u0026#39;, \u0026#39;6æœˆ\u0026#39;], }, yAxis: [ { type: \u0026#39;value\u0026#39;, name: \u0026#39;é”€å”®é¢(ä¸‡)\u0026#39; }, { type: \u0026#39;value\u0026#39;, name: \u0026#39;è®¢å•æ•°\u0026#39; }, ], series: [ { name: \u0026#39;é”€å”®é¢\u0026#39;, type: \u0026#39;line\u0026#39;, data: [150, 230, 224, 218, 135, 147], smooth: true, areaStyle: { opacity: 0.3, }, }, { name: \u0026#39;è®¢å•æ•°\u0026#39;, type: \u0026#39;line\u0026#39;, yAxisIndex: 1, data: [320, 332, 301, 334, 390, 330], }, ], } 2.2 æŸ±çŠ¶å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 const option = { title: { text: \u0026#39;æœˆåº¦é”€å”®\u0026#39; }, tooltip: { trigger: \u0026#39;axis\u0026#39;, axisPointer: { type: \u0026#39;shadow\u0026#39; }, }, legend: {}, xAxis: { type: \u0026#39;category\u0026#39;, data: [\u0026#39;1æœˆ\u0026#39;, \u0026#39;2æœˆ\u0026#39;, \u0026#39;3æœˆ\u0026#39;, \u0026#39;4æœˆ\u0026#39;, \u0026#39;5æœˆ\u0026#39;, \u0026#39;6æœˆ\u0026#39;], }, yAxis: { type: \u0026#39;value\u0026#39; }, series: [ { name: \u0026#39;çº¿ä¸Š\u0026#39;, type: \u0026#39;bar\u0026#39;, data: [320, 332, 301, 334, 390, 330], itemStyle: { borderRadius: [4, 4, 0, 0], }, }, { name: \u0026#39;çº¿ä¸‹\u0026#39;, type: \u0026#39;bar\u0026#39;, data: [120, 132, 101, 134, 90, 230], itemStyle: { borderRadius: [4, 4, 0, 0], }, }, ], } 2.3 é¥¼å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 const option = { title: { text: \u0026#39;è®¿é—®æ¥æº\u0026#39;, left: \u0026#39;center\u0026#39;, }, tooltip: { trigger: \u0026#39;item\u0026#39;, formatter: \u0026#39;{a} \u0026lt;br/\u0026gt;{b}: {c} ({d}%)\u0026#39;, }, legend: { orient: \u0026#39;vertical\u0026#39;, left: \u0026#39;left\u0026#39;, }, series: [ { name: \u0026#39;è®¿é—®æ¥æº\u0026#39;, type: \u0026#39;pie\u0026#39;, radius: [\u0026#39;40%\u0026#39;, \u0026#39;70%\u0026#39;], avoidLabelOverlap: false, itemStyle: { borderRadius: 10, borderColor: \u0026#39;#fff\u0026#39;, borderWidth: 2, }, label: { show: false, position: \u0026#39;center\u0026#39;, }, emphasis: { label: { show: true, fontSize: 20, fontWeight: \u0026#39;bold\u0026#39;, }, }, labelLine: { show: false }, data: [ { value: 1048, name: \u0026#39;æœç´¢å¼•æ“\u0026#39; }, { value: 735, name: \u0026#39;ç›´æ¥è®¿é—®\u0026#39; }, { value: 580, name: \u0026#39;é‚®ä»¶è¥é”€\u0026#39; }, { value: 484, name: \u0026#39;è”ç›Ÿå¹¿å‘Š\u0026#39; }, { value: 300, name: \u0026#39;è§†é¢‘å¹¿å‘Š\u0026#39; }, ], }, ], } 2.4 æ•£ç‚¹å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 const option = { title: { text: \u0026#39;èº«é«˜ä½“é‡åˆ†å¸ƒ\u0026#39; }, xAxis: { name: \u0026#39;èº«é«˜(cm)\u0026#39; }, yAxis: { name: \u0026#39;ä½“é‡(kg)\u0026#39; }, tooltip: { formatter: (params: any) =\u0026gt; { return `èº«é«˜: ${params.value[0]}cm\u0026lt;br/\u0026gt;ä½“é‡: ${params.value[1]}kg` }, }, series: [ { type: \u0026#39;scatter\u0026#39;, symbolSize: 10, data: [ [161, 51], [167, 59], [159, 49], [157, 63], [155, 53], [170, 59], [159, 47], [166, 69], ], }, ], } ä¸‰ã€é«˜çº§é…ç½® 3.1 æ•°æ®ç¼©æ”¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 const option = { dataZoom: [ { type: \u0026#39;slider\u0026#39;, show: true, xAxisIndex: [0], start: 0, end: 50, }, { type: \u0026#39;inside\u0026#39;, xAxisIndex: [0], start: 0, end: 50, }, ], // ... å…¶ä»–é…ç½® } 3.2 å·¥å…·ç®± 1 2 3 4 5 6 7 8 9 10 11 const option = { toolbox: { feature: { dataZoom: { yAxisIndex: \u0026#39;none\u0026#39; }, dataView: { readOnly: false }, magicType: { type: [\u0026#39;line\u0026#39;, \u0026#39;bar\u0026#39;] }, restore: {}, saveAsImage: {}, }, }, } 3.3 å›¾è¡¨è”åŠ¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // å¤šå›¾è”åŠ¨ const option = { axisPointer: { link: [{ xAxisIndex: \u0026#39;all\u0026#39; }], }, grid: [ { left: \u0026#39;3%\u0026#39;, right: \u0026#39;3%\u0026#39;, top: \u0026#39;10%\u0026#39;, height: \u0026#39;35%\u0026#39; }, { left: \u0026#39;3%\u0026#39;, right: \u0026#39;3%\u0026#39;, top: \u0026#39;55%\u0026#39;, height: \u0026#39;35%\u0026#39; }, ], xAxis: [ { gridIndex: 0, type: \u0026#39;category\u0026#39;, data: xData }, { gridIndex: 1, type: \u0026#39;category\u0026#39;, data: xData }, ], yAxis: [ { gridIndex: 0 }, { gridIndex: 1 }, ], series: [ { xAxisIndex: 0, yAxisIndex: 0, type: \u0026#39;bar\u0026#39;, data: data1 }, { xAxisIndex: 1, yAxisIndex: 1, type: \u0026#39;line\u0026#39;, data: data2 }, ], } å››ã€Vue 3 ç»„ä»¶å°è£… 4.1 é€šç”¨å›¾è¡¨ç»„ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 \u0026lt;!-- components/Chart.vue --\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div ref=\u0026#34;chartRef\u0026#34; :style=\u0026#34;{ width, height }\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, watch, onMounted, onUnmounted } from \u0026#39;vue\u0026#39; import * as echarts from \u0026#39;echarts\u0026#39; import type { EChartsOption } from \u0026#39;echarts\u0026#39; interface Props { option: EChartsOption width?: string height?: string theme?: string } const props = withDefaults(defineProps\u0026lt;Props\u0026gt;(), { width: \u0026#39;100%\u0026#39;, height: \u0026#39;400px\u0026#39;, theme: undefined, }) const emit = defineEmits\u0026lt;{ (e: \u0026#39;click\u0026#39;, params: any): void (e: \u0026#39;legendselectchanged\u0026#39;, params: any): void }\u0026gt;() const chartRef = ref\u0026lt;HTMLElement\u0026gt;() let chart: echarts.ECharts | null = null // åˆå§‹åŒ–å›¾è¡¨ const initChart = () =\u0026gt; { if (chartRef.value) { chart = echarts.init(chartRef.value, props.theme) chart.setOption(props.option) bindEvents() } } // ç»‘å®šäº‹ä»¶ const bindEvents = () =\u0026gt; { chart?.on(\u0026#39;click\u0026#39;, (params) =\u0026gt; emit(\u0026#39;click\u0026#39;, params)) chart?.on(\u0026#39;legendselectchanged\u0026#39;, (params) =\u0026gt; emit(\u0026#39;legendselectchanged\u0026#39;, params)) } // ç›‘å¬ option å˜åŒ– watch( () =\u0026gt; props.option, (newOption) =\u0026gt; { chart?.setOption(newOption, true) }, { deep: true } ) // å“åº”å¼è°ƒæ•´ const handleResize = () =\u0026gt; { chart?.resize() } onMounted(() =\u0026gt; { initChart() window.addEventListener(\u0026#39;resize\u0026#39;, handleResize) }) onUnmounted(() =\u0026gt; { chart?.dispose() window.removeEventListener(\u0026#39;resize\u0026#39;, handleResize) }) // æš´éœ²æ–¹æ³• defineExpose({ getInstance: () =\u0026gt; chart, resize: handleResize, }) \u0026lt;/script\u0026gt; 4.2 ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 \u0026lt;template\u0026gt; \u0026lt;Chart :option=\u0026#34;chartOption\u0026#34; height=\u0026#34;500px\u0026#34; @click=\u0026#34;handleChartClick\u0026#34; /\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { computed } from \u0026#39;vue\u0026#39; import Chart from \u0026#39;@/components/Chart.vue\u0026#39; const data = ref([ { name: \u0026#39;A\u0026#39;, value: 100 }, { name: \u0026#39;B\u0026#39;, value: 200 }, { name: \u0026#39;C\u0026#39;, value: 150 }, ]) const chartOption = computed(() =\u0026gt; ({ xAxis: { type: \u0026#39;category\u0026#39;, data: data.value.map(d =\u0026gt; d.name), }, yAxis: { type: \u0026#39;value\u0026#39; }, series: [{ type: \u0026#39;bar\u0026#39;, data: data.value.map(d =\u0026gt; d.value), }], })) const handleChartClick = (params: any) =\u0026gt; { console.log(\u0026#39;Clicked:\u0026#39;, params.name, params.value) } \u0026lt;/script\u0026gt; äº”ã€åŠ¨æ€æ•°æ® 5.1 å®æ—¶æ•°æ®æ›´æ–° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, onMounted, onUnmounted } from \u0026#39;vue\u0026#39; const chartOption = ref({ xAxis: { type: \u0026#39;category\u0026#39;, data: [] as string[] }, yAxis: { type: \u0026#39;value\u0026#39; }, series: [{ type: \u0026#39;line\u0026#39;, data: [] as number[] }], }) let timer: number | null = null const updateData = () =\u0026gt; { const now = new Date() const time = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}` const value = Math.random() * 100 chartOption.value.xAxis.data.push(time) chartOption.value.series[0].data.push(value) // ä¿æŒæœ€å¤šæ˜¾ç¤º 20 ä¸ªæ•°æ®ç‚¹ if (chartOption.value.xAxis.data.length \u0026gt; 20) { chartOption.value.xAxis.data.shift() chartOption.value.series[0].data.shift() } } onMounted(() =\u0026gt; { timer = window.setInterval(updateData, 1000) }) onUnmounted(() =\u0026gt; { if (timer) clearInterval(timer) }) \u0026lt;/script\u0026gt; 5.2 æ•°æ®åŠ è½½åŠ¨ç”» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // æ˜¾ç¤ºåŠ è½½åŠ¨ç”» chart.showLoading({ text: \u0026#39;æ•°æ®åŠ è½½ä¸­...\u0026#39;, color: \u0026#39;#1890ff\u0026#39;, maskColor: \u0026#39;rgba(255, 255, 255, 0.8)\u0026#39;, }) // åŠ è½½æ•°æ® const data = await fetchData() // éšè—åŠ è½½åŠ¨ç”» chart.hideLoading() // è®¾ç½®æ•°æ® chart.setOption({ series: [{ data }] }) å…­ã€ä¸»é¢˜å®šåˆ¶ 6.1 æ³¨å†Œè‡ªå®šä¹‰ä¸»é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // theme/custom.ts export const customTheme = { color: [ \u0026#39;#5470c6\u0026#39;, \u0026#39;#91cc75\u0026#39;, \u0026#39;#fac858\u0026#39;, \u0026#39;#ee6666\u0026#39;, \u0026#39;#73c0de\u0026#39;, \u0026#39;#3ba272\u0026#39;, \u0026#39;#fc8452\u0026#39;, \u0026#39;#9a60b4\u0026#39;, ], backgroundColor: \u0026#39;transparent\u0026#39;, textStyle: {}, title: { textStyle: { color: \u0026#39;#333\u0026#39; }, }, line: { itemStyle: { borderWidth: 2 }, lineStyle: { width: 2 }, symbolSize: 6, symbol: \u0026#39;circle\u0026#39;, smooth: true, }, bar: { itemStyle: { barBorderRadius: [4, 4, 0, 0] }, }, } // æ³¨å†Œä¸»é¢˜ echarts.registerTheme(\u0026#39;custom\u0026#39;, customTheme) // ä½¿ç”¨ä¸»é¢˜ const chart = echarts.init(dom, \u0026#39;custom\u0026#39;) 6.2 å“åº”å¼é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 const getResponsiveOption = () =\u0026gt; { const width = window.innerWidth return { grid: { left: width \u0026lt; 768 ? \u0026#39;5%\u0026#39; : \u0026#39;3%\u0026#39;, right: width \u0026lt; 768 ? \u0026#39;5%\u0026#39; : \u0026#39;3%\u0026#39;, }, legend: { orient: width \u0026lt; 768 ? \u0026#39;horizontal\u0026#39; : \u0026#39;vertical\u0026#39;, left: width \u0026lt; 768 ? \u0026#39;center\u0026#39; : \u0026#39;right\u0026#39;, top: width \u0026lt; 768 ? \u0026#39;bottom\u0026#39; : \u0026#39;middle\u0026#39;, }, } } ä¸ƒã€å¸¸è§å›¾è¡¨é…ç½® 7.1 ä»ªè¡¨ç›˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 const option = { series: [ { type: \u0026#39;gauge\u0026#39;, startAngle: 180, endAngle: 0, min: 0, max: 100, splitNumber: 10, axisLine: { lineStyle: { width: 6, color: [ [0.3, \u0026#39;#67e0e3\u0026#39;], [0.7, \u0026#39;#37a2da\u0026#39;], [1, \u0026#39;#fd666d\u0026#39;], ], }, }, pointer: { itemStyle: { color: \u0026#39;auto\u0026#39; }, }, axisTick: { distance: -30, length: 8 }, splitLine: { distance: -30, length: 30 }, axisLabel: { distance: 40, fontSize: 12 }, detail: { valueAnimation: true, formatter: \u0026#39;{value}%\u0026#39;, fontSize: 24, }, data: [{ value: 70 }], }, ], } 7.2 é›·è¾¾å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 const option = { radar: { indicator: [ { name: \u0026#39;é”€å”®\u0026#39;, max: 6500 }, { name: \u0026#39;ç®¡ç†\u0026#39;, max: 16000 }, { name: \u0026#39;ä¿¡æ¯æŠ€æœ¯\u0026#39;, max: 30000 }, { name: \u0026#39;å®¢æœ\u0026#39;, max: 38000 }, { name: \u0026#39;ç ”å‘\u0026#39;, max: 52000 }, { name: \u0026#39;å¸‚åœº\u0026#39;, max: 25000 }, ], }, series: [ { type: \u0026#39;radar\u0026#39;, data: [ { value: [4200, 3000, 20000, 35000, 50000, 18000], name: \u0026#39;é¢„ç®—\u0026#39; }, { value: [5000, 14000, 28000, 26000, 42000, 21000], name: \u0026#39;å®é™…\u0026#39; }, ], }, ], } æ€»ç»“ ECharts æ˜¯åŠŸèƒ½å¼ºå¤§çš„æ•°æ®å¯è§†åŒ–åº“ï¼Œå¯ä»¥æ»¡è¶³å„ç§å¤æ‚çš„å›¾è¡¨éœ€æ±‚ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“Š ä¸°å¯Œçš„å›¾è¡¨ç±»å‹ ğŸ¨ çµæ´»çš„ä¸»é¢˜å®šåˆ¶ âš¡ é«˜æ€§èƒ½æ¸²æŸ“ ğŸ”§ å¼ºå¤§çš„äº¤äº’åŠŸèƒ½ ğŸ“± å“åº”å¼è®¾è®¡æ”¯æŒ Incoming (Background Agent changes)\n","date":"2025-07-21T00:00:00Z","permalink":"https://zpf-zero.github.io/p/echarts-guide/","title":"ECharts å®æˆ˜æŒ‡å—ï¼šæ•°æ®å¯è§†åŒ–å›¾è¡¨åº“"},{"content":"å‰è¨€ Vite æ˜¯ä¸€ä¸ªç”± Vue.js ä½œè€…å°¤é›¨æºªå¼€å‘çš„ä¸‹ä¸€ä»£å‰ç«¯æ„å»ºå·¥å…·ã€‚å®ƒåˆ©ç”¨æµè§ˆå™¨åŸç”Ÿ ES æ¨¡å—æ”¯æŒå’Œ esbuild çš„æé€Ÿç¼–è¯‘èƒ½åŠ›ï¼Œæä¾›äº†é—ªç”µèˆ¬çš„å†·å¯åŠ¨é€Ÿåº¦å’Œçƒ­æ›´æ–°ä½“éªŒã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 åˆ›å»ºé¡¹ç›® 1 2 3 4 5 6 7 8 9 10 11 12 # ä½¿ç”¨ npm npm create vite@latest my-project # ä½¿ç”¨ yarn yarn create vite my-project # ä½¿ç”¨ pnpm pnpm create vite my-project # æŒ‡å®šæ¨¡æ¿ npm create vite@latest my-vue-app -- --template vue-ts npm create vite@latest my-react-app -- --template react-ts 1.2 æ”¯æŒçš„æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 # å®˜æ–¹æ¨¡æ¿ vanilla # åŸç”Ÿ JavaScript vanilla-ts # åŸç”Ÿ TypeScript vue # Vue 3 vue-ts # Vue 3 + TypeScript react # React react-ts # React + TypeScript preact # Preact preact-ts # Preact + TypeScript lit # Lit lit-ts # Lit + TypeScript svelte # Svelte svelte-ts # Svelte + TypeScript 1.3 é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 my-project/ â”œâ”€â”€ public/ # é™æ€èµ„æº â”‚ â””â”€â”€ favicon.ico â”œâ”€â”€ src/ â”‚ â”œâ”€â”€ assets/ # éœ€è¦å¤„ç†çš„èµ„æº â”‚ â”œâ”€â”€ components/ â”‚ â”œâ”€â”€ App.vue â”‚ â””â”€â”€ main.ts â”œâ”€â”€ index.html # å…¥å£ HTML â”œâ”€â”€ vite.config.ts # Vite é…ç½® â”œâ”€â”€ tsconfig.json # TypeScript é…ç½® â””â”€â”€ package.json äºŒã€æ ¸å¿ƒç‰¹æ€§ 2.1 åŸç”Ÿ ESM å¼€å‘æœåŠ¡å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;!-- index.html --\u0026gt; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;Vite App\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;app\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;!-- type=\u0026#34;module\u0026#34; å¯ç”¨åŸç”Ÿ ESM --\u0026gt; \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;/src/main.ts\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; 2.2 çƒ­æ¨¡å—æ›¿æ¢ (HMR) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // main.ts import { createApp } from \u0026#39;vue\u0026#39; import App from \u0026#39;./App.vue\u0026#39; createApp(App).mount(\u0026#39;#app\u0026#39;) // æ‰‹åŠ¨ HMR API if (import.meta.hot) { import.meta.hot.accept(\u0026#39;./module.ts\u0026#39;, (newModule) =\u0026gt; { // å¤„ç†æ›´æ–° }) import.meta.hot.dispose(() =\u0026gt; { // æ¸…ç†å‰¯ä½œç”¨ }) } 2.3 ç¯å¢ƒå˜é‡ 1 2 3 4 5 6 7 8 # .env VITE_APP_TITLE=My App # .env.development VITE_API_URL=http://localhost:3000 # .env.production VITE_API_URL=https://api.example.com 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // ä½¿ç”¨ç¯å¢ƒå˜é‡ console.log(import.meta.env.VITE_APP_TITLE) console.log(import.meta.env.VITE_API_URL) console.log(import.meta.env.MODE) // development / production console.log(import.meta.env.DEV) // true / false console.log(import.meta.env.PROD) // true / false // TypeScript ç±»å‹å®šä¹‰ // env.d.ts /// \u0026lt;reference types=\u0026#34;vite/client\u0026#34; /\u0026gt; interface ImportMetaEnv { readonly VITE_APP_TITLE: string readonly VITE_API_URL: string } interface ImportMeta { readonly env: ImportMetaEnv } ä¸‰ã€é…ç½®è¯¦è§£ 3.1 åŸºç¡€é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 // vite.config.ts import { defineConfig } from \u0026#39;vite\u0026#39; import vue from \u0026#39;@vitejs/plugin-vue\u0026#39; import path from \u0026#39;path\u0026#39; export default defineConfig({ // åº”ç”¨åŸºç¡€è·¯å¾„ base: \u0026#39;/\u0026#39;, // æ’ä»¶ plugins: [vue()], // è·¯å¾„åˆ«å resolve: { alias: { \u0026#39;@\u0026#39;: path.resolve(__dirname, \u0026#39;src\u0026#39;), \u0026#39;@components\u0026#39;: path.resolve(__dirname, \u0026#39;src/components\u0026#39;), \u0026#39;@utils\u0026#39;: path.resolve(__dirname, \u0026#39;src/utils\u0026#39;), }, }, // å¼€å‘æœåŠ¡å™¨ server: { host: \u0026#39;0.0.0.0\u0026#39;, port: 3000, open: true, cors: true, // ä»£ç†é…ç½® proxy: { \u0026#39;/api\u0026#39;: { target: \u0026#39;http://localhost:8080\u0026#39;, changeOrigin: true, rewrite: (path) =\u0026gt; path.replace(/^\\/api/, \u0026#39;\u0026#39;), }, }, }, // æ„å»ºé…ç½® build: { outDir: \u0026#39;dist\u0026#39;, assetsDir: \u0026#39;assets\u0026#39;, sourcemap: true, minify: \u0026#39;terser\u0026#39;, terserOptions: { compress: { drop_console: true, drop_debugger: true, }, }, }, }) 3.2 CSS é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 export default defineConfig({ css: { // CSS é¢„å¤„ç†å™¨ preprocessorOptions: { scss: { additionalData: `@import \u0026#34;@/styles/variables.scss\u0026#34;;`, }, less: { javascriptEnabled: true, additionalData: `@import \u0026#34;@/styles/variables.less\u0026#34;;`, }, }, // CSS Modules modules: { localsConvention: \u0026#39;camelCase\u0026#39;, scopeBehaviour: \u0026#39;local\u0026#39;, generateScopedName: \u0026#39;[name]__[local]___[hash:base64:5]\u0026#39;, }, // PostCSS postcss: { plugins: [ require(\u0026#39;autoprefixer\u0026#39;), require(\u0026#39;tailwindcss\u0026#39;), ], }, }, }) 3.3 æ„å»ºä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 export default defineConfig({ build: { // åˆ†åŒ…ç­–ç•¥ rollupOptions: { output: { manualChunks: { \u0026#39;vue-vendor\u0026#39;: [\u0026#39;vue\u0026#39;, \u0026#39;vue-router\u0026#39;, \u0026#39;pinia\u0026#39;], \u0026#39;ui-vendor\u0026#39;: [\u0026#39;element-plus\u0026#39;], \u0026#39;utils\u0026#39;: [\u0026#39;lodash-es\u0026#39;, \u0026#39;dayjs\u0026#39;], }, // æˆ–ä½¿ç”¨å‡½æ•° manualChunks(id) { if (id.includes(\u0026#39;node_modules\u0026#39;)) { return id.toString().split(\u0026#39;node_modules/\u0026#39;)[1].split(\u0026#39;/\u0026#39;)[0].toString() } }, }, }, // å‹ç¼©é…ç½® minify: \u0026#39;terser\u0026#39;, terserOptions: { compress: { drop_console: true, drop_debugger: true, }, }, // å—å¤§å°è­¦å‘Šé™åˆ¶ chunkSizeWarningLimit: 1000, // èµ„æºå†…è”é™åˆ¶ï¼ˆå°äºæ­¤å¤§å°çš„èµ„æºä¼šè¢«å†…è”ä¸º base64ï¼‰ assetsInlineLimit: 4096, }, }) å››ã€é™æ€èµ„æºå¤„ç† 4.1 å¯¼å…¥èµ„æº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // å¯¼å…¥å›¾ç‰‡ import imgUrl from \u0026#39;./img.png\u0026#39; // æ˜¾å¼ URL å¯¼å…¥ import imgUrl from \u0026#39;./img.png?url\u0026#39; // å¯¼å…¥ä¸ºå­—ç¬¦ä¸² import imgString from \u0026#39;./shader.glsl?raw\u0026#39; // å¯¼å…¥ Web Worker import Worker from \u0026#39;./worker.js?worker\u0026#39; // å¯¼å…¥ JSON import data from \u0026#39;./data.json\u0026#39; // åŠ¨æ€å¯¼å…¥ const module = await import(`./dir/${file}.js`) 4.2 public ç›®å½• 1 2 3 4 // public ç›®å½•ä¸‹çš„èµ„æºå¯ä»¥é€šè¿‡ / ç›´æ¥è®¿é—® const imgUrl = \u0026#39;/images/logo.png\u0026#39; // ä¸ä¼šè¢« Vite å¤„ç† 4.3 èµ„æºå¼•ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;template\u0026gt; \u0026lt;!-- é™æ€èµ„æº --\u0026gt; \u0026lt;img src=\u0026#34;@/assets/logo.png\u0026#34; alt=\u0026#34;Logo\u0026#34; /\u0026gt; \u0026lt;!-- åŠ¨æ€èµ„æº --\u0026gt; \u0026lt;img :src=\u0026#34;getImageUrl(name)\u0026#34; alt=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; // åŠ¨æ€å¯¼å…¥èµ„æº const getImageUrl = (name: string) =\u0026gt; { return new URL(`../assets/${name}.png`, import.meta.url).href } \u0026lt;/script\u0026gt; äº”ã€å¸¸ç”¨æ’ä»¶ 5.1 Vue ç›¸å…³æ’ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import { defineConfig } from \u0026#39;vite\u0026#39; import vue from \u0026#39;@vitejs/plugin-vue\u0026#39; import vueJsx from \u0026#39;@vitejs/plugin-vue-jsx\u0026#39; import Components from \u0026#39;unplugin-vue-components/vite\u0026#39; import AutoImport from \u0026#39;unplugin-auto-import/vite\u0026#39; import { ElementPlusResolver } from \u0026#39;unplugin-vue-components/resolvers\u0026#39; export default defineConfig({ plugins: [ vue(), // JSX æ”¯æŒ vueJsx(), // è‡ªåŠ¨å¯¼å…¥ API AutoImport({ imports: [\u0026#39;vue\u0026#39;, \u0026#39;vue-router\u0026#39;, \u0026#39;pinia\u0026#39;], resolvers: [ElementPlusResolver()], dts: \u0026#39;src/auto-imports.d.ts\u0026#39;, }), // è‡ªåŠ¨å¯¼å…¥ç»„ä»¶ Components({ resolvers: [ElementPlusResolver()], dts: \u0026#39;src/components.d.ts\u0026#39;, }), ], }) 5.2 å¸¸ç”¨å·¥å…·æ’ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 import { defineConfig } from \u0026#39;vite\u0026#39; import { visualizer } from \u0026#39;rollup-plugin-visualizer\u0026#39; import { compression } from \u0026#39;vite-plugin-compression2\u0026#39; import legacy from \u0026#39;@vitejs/plugin-legacy\u0026#39; import { VitePWA } from \u0026#39;vite-plugin-pwa\u0026#39; export default defineConfig({ plugins: [ // æ‰“åŒ…åˆ†æ visualizer({ open: true, gzipSize: true, brotliSize: true, }), // Gzip/Brotli å‹ç¼© compression({ algorithm: \u0026#39;gzip\u0026#39;, threshold: 10240, }), compression({ algorithm: \u0026#39;brotliCompress\u0026#39;, threshold: 10240, }), // æ—§æµè§ˆå™¨å…¼å®¹ legacy({ targets: [\u0026#39;defaults\u0026#39;, \u0026#39;not IE 11\u0026#39;], }), // PWA æ”¯æŒ VitePWA({ registerType: \u0026#39;autoUpdate\u0026#39;, manifest: { name: \u0026#39;My App\u0026#39;, short_name: \u0026#39;App\u0026#39;, theme_color: \u0026#39;#ffffff\u0026#39;, }, }), ], }) 5.3 å¼€å‘å·¥å…·æ’ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 import { defineConfig } from \u0026#39;vite\u0026#39; import Inspect from \u0026#39;vite-plugin-inspect\u0026#39; import VueDevTools from \u0026#39;vite-plugin-vue-devtools\u0026#39; export default defineConfig({ plugins: [ // æ£€æŸ¥ Vite æ’ä»¶è½¬æ¢ Inspect(), // Vue DevTools VueDevTools(), ], }) å…­ã€è‡ªå®šä¹‰æ’ä»¶ 6.1 æ’ä»¶åŸºç¡€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 // my-plugin.ts import type { Plugin } from \u0026#39;vite\u0026#39; export function myPlugin(): Plugin { return { name: \u0026#39;my-plugin\u0026#39;, // é…ç½®è§£æ config(config, { command }) { if (command === \u0026#39;build\u0026#39;) { config.build = config.build || {} config.build.sourcemap = true } }, // é…ç½®è§£æå®Œæˆ configResolved(config) { console.log(\u0026#39;Resolved config:\u0026#39;, config) }, // é…ç½®å¼€å‘æœåŠ¡å™¨ configureServer(server) { server.middlewares.use((req, res, next) =\u0026gt; { // è‡ªå®šä¹‰ä¸­é—´ä»¶ next() }) }, // è½¬æ¢ HTML transformIndexHtml(html) { return html.replace( \u0026#39;\u0026lt;title\u0026gt;\u0026#39;, \u0026#39;\u0026lt;title\u0026gt;Prefix - \u0026#39; ) }, // åŠ è½½æ¨¡å— load(id) { if (id === \u0026#39;virtual:my-module\u0026#39;) { return `export const msg = \u0026#34;Hello\u0026#34;` } }, // è½¬æ¢æ¨¡å— transform(code, id) { if (id.endsWith(\u0026#39;.vue\u0026#39;)) { // è½¬æ¢ Vue æ–‡ä»¶ } }, } } 6.2 è™šæ‹Ÿæ¨¡å— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // virtual-module-plugin.ts import type { Plugin } from \u0026#39;vite\u0026#39; const virtualModuleId = \u0026#39;virtual:my-module\u0026#39; const resolvedVirtualModuleId = \u0026#39;\\0\u0026#39; + virtualModuleId export function virtualModulePlugin(): Plugin { return { name: \u0026#39;virtual-module-plugin\u0026#39;, resolveId(id) { if (id === virtualModuleId) { return resolvedVirtualModuleId } }, load(id) { if (id === resolvedVirtualModuleId) { return ` export const version = \u0026#39;1.0.0\u0026#39; export const buildTime = \u0026#39;${new Date().toISOString()}\u0026#39; ` } }, } } // ä½¿ç”¨ // import { version, buildTime } from \u0026#39;virtual:my-module\u0026#39; 6.3 è‡ªå®šä¹‰ HMR 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 export function hmrPlugin(): Plugin { return { name: \u0026#39;hmr-plugin\u0026#39;, handleHotUpdate({ file, server }) { if (file.endsWith(\u0026#39;.custom\u0026#39;)) { // è‡ªå®šä¹‰ HMR å¤„ç† server.ws.send({ type: \u0026#39;custom\u0026#39;, event: \u0026#39;custom-update\u0026#39;, data: { file }, }) return [] } }, } } // å®¢æˆ·ç«¯ä»£ç  if (import.meta.hot) { import.meta.hot.on(\u0026#39;custom-update\u0026#39;, (data) =\u0026gt; { console.log(\u0026#39;Custom update:\u0026#39;, data) }) } ä¸ƒã€æ€§èƒ½ä¼˜åŒ– 7.1 é¢„æ„å»ºä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 export default defineConfig({ optimizeDeps: { // å¼ºåˆ¶é¢„æ„å»º include: [\u0026#39;lodash-es\u0026#39;, \u0026#39;axios\u0026#39;], // æ’é™¤é¢„æ„å»º exclude: [\u0026#39;your-local-package\u0026#39;], // esbuild é€‰é¡¹ esbuildOptions: { target: \u0026#39;es2020\u0026#39;, }, }, }) 7.2 æ„å»ºä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 export default defineConfig({ build: { // ç›®æ ‡æµè§ˆå™¨ target: \u0026#39;es2020\u0026#39;, // CSS ä»£ç åˆ†å‰² cssCodeSplit: true, // åˆ†åŒ… rollupOptions: { output: { manualChunks: { vendor: [\u0026#39;vue\u0026#39;, \u0026#39;vue-router\u0026#39;, \u0026#39;pinia\u0026#39;], }, }, }, // æŠ¥å‘Šå‹ç¼©åçš„å¤§å° reportCompressedSize: false, }, // esbuild ä¼˜åŒ– esbuild: { drop: [\u0026#39;console\u0026#39;, \u0026#39;debugger\u0026#39;], }, }) 7.3 å¼€å‘æœåŠ¡å™¨ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 export default defineConfig({ server: { // é¢„çƒ­å¸¸ç”¨æ–‡ä»¶ warmup: { clientFiles: [\u0026#39;./src/components/*.vue\u0026#39;], }, // æ–‡ä»¶ç³»ç»Ÿç›‘å¬é€‰é¡¹ watch: { usePolling: false, interval: 100, }, }, }) å…«ã€éƒ¨ç½²é…ç½® 8.1 ä¸åŒç¯å¢ƒé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // vite.config.ts import { defineConfig, loadEnv } from \u0026#39;vite\u0026#39; export default defineConfig(({ command, mode }) =\u0026gt; { // åŠ è½½ç¯å¢ƒå˜é‡ const env = loadEnv(mode, process.cwd(), \u0026#39;\u0026#39;) const isProduction = mode === \u0026#39;production\u0026#39; return { base: isProduction ? \u0026#39;/app/\u0026#39; : \u0026#39;/\u0026#39;, build: { sourcemap: !isProduction, minify: isProduction ? \u0026#39;terser\u0026#39; : false, }, define: { __APP_VERSION__: JSON.stringify(env.npm_package_version), }, } }) 8.2 é™æ€éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # æ„å»º npm run build # é¢„è§ˆ npm run preview # éƒ¨ç½²åˆ° nginx server { listen 80; server_name example.com; location / { root /var/www/dist; try_files $uri $uri/ /index.html; } location /assets { root /var/www/dist; expires 1y; add_header Cache-Control \u0026#34;public, immutable\u0026#34;; } } 8.3 Docker éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 # Dockerfile FROM node:18-alpine as builder WORKDIR /app COPY package*.json ./ RUN npm ci COPY . . RUN npm run build FROM nginx:alpine COPY --from=builder /app/dist /usr/share/nginx/html COPY nginx.conf /etc/nginx/conf.d/default.conf EXPOSE 80 CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] ä¹ã€å®Œæ•´é…ç½®ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 // vite.config.ts import { defineConfig, loadEnv } from \u0026#39;vite\u0026#39; import vue from \u0026#39;@vitejs/plugin-vue\u0026#39; import vueJsx from \u0026#39;@vitejs/plugin-vue-jsx\u0026#39; import Components from \u0026#39;unplugin-vue-components/vite\u0026#39; import AutoImport from \u0026#39;unplugin-auto-import/vite\u0026#39; import { ElementPlusResolver } from \u0026#39;unplugin-vue-components/resolvers\u0026#39; import { compression } from \u0026#39;vite-plugin-compression2\u0026#39; import path from \u0026#39;path\u0026#39; export default defineConfig(({ command, mode }) =\u0026gt; { const env = loadEnv(mode, process.cwd(), \u0026#39;\u0026#39;) const isProduction = mode === \u0026#39;production\u0026#39; return { base: env.VITE_BASE_URL || \u0026#39;/\u0026#39;, plugins: [ vue(), vueJsx(), AutoImport({ imports: [\u0026#39;vue\u0026#39;, \u0026#39;vue-router\u0026#39;, \u0026#39;pinia\u0026#39;], resolvers: [ElementPlusResolver()], dts: \u0026#39;src/auto-imports.d.ts\u0026#39;, }), Components({ resolvers: [ElementPlusResolver()], dts: \u0026#39;src/components.d.ts\u0026#39;, }), isProduction \u0026amp;\u0026amp; compression(), ], resolve: { alias: { \u0026#39;@\u0026#39;: path.resolve(__dirname, \u0026#39;src\u0026#39;), }, }, css: { preprocessorOptions: { scss: { additionalData: `@import \u0026#34;@/styles/variables.scss\u0026#34;;`, }, }, }, server: { host: \u0026#39;0.0.0.0\u0026#39;, port: 3000, proxy: { \u0026#39;/api\u0026#39;: { target: env.VITE_API_URL, changeOrigin: true, }, }, }, build: { target: \u0026#39;es2020\u0026#39;, outDir: \u0026#39;dist\u0026#39;, sourcemap: !isProduction, minify: isProduction ? \u0026#39;terser\u0026#39; : false, terserOptions: { compress: { drop_console: isProduction, drop_debugger: isProduction, }, }, rollupOptions: { output: { manualChunks: { \u0026#39;vue-vendor\u0026#39;: [\u0026#39;vue\u0026#39;, \u0026#39;vue-router\u0026#39;, \u0026#39;pinia\u0026#39;], \u0026#39;element-plus\u0026#39;: [\u0026#39;element-plus\u0026#39;], }, }, }, }, } }) æ€»ç»“ Vite ä»¥å…¶æå¿«çš„å¯åŠ¨é€Ÿåº¦å’Œçƒ­æ›´æ–°èƒ½åŠ›ï¼Œæˆä¸ºç°ä»£å‰ç«¯å¼€å‘çš„é¦–é€‰æ„å»ºå·¥å…·ã€‚\næ ¸å¿ƒä¼˜åŠ¿ï¼š\nâš¡ é—ªç”µèˆ¬çš„å†·å¯åŠ¨é€Ÿåº¦ ğŸ”¥ å³æ—¶çš„çƒ­æ¨¡å—æ›¿æ¢ ğŸ“¦ ä¼˜åŒ–çš„ç”Ÿäº§æ„å»º ğŸ”Œ ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ ğŸ› ï¸ çµæ´»çš„é…ç½®é€‰é¡¹ ","date":"2025-07-11T00:00:00Z","permalink":"https://zpf-zero.github.io/p/vite-guide/","title":"Vite å®æˆ˜æŒ‡å—ï¼šä¸‹ä¸€ä»£å‰ç«¯æ„å»ºå·¥å…·"},{"content":"å‰è¨€ Vue 3 æ˜¯ Vue.js çš„æœ€æ–°ä¸»è¦ç‰ˆæœ¬ï¼Œå¸¦æ¥äº†ç»„åˆå¼ APIã€æ›´å¥½çš„ TypeScript æ”¯æŒã€æ›´å°çš„åŒ…ä½“ç§¯å’Œæ›´å¥½çš„æ€§èƒ½ã€‚å®ƒæ˜¯æ„å»ºç°ä»£ Web åº”ç”¨çš„ç»ä½³é€‰æ‹©ã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 åˆ›å»ºé¡¹ç›® 1 2 3 4 5 6 7 # ä½¿ç”¨ Vite åˆ›å»º npm create vite@latest my-vue-app -- --template vue-ts # è¿›å…¥é¡¹ç›® cd my-vue-app npm install npm run dev 1.2 é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 my-vue-app/ â”œâ”€â”€ public/ â”œâ”€â”€ src/ â”‚ â”œâ”€â”€ assets/ â”‚ â”œâ”€â”€ components/ â”‚ â”œâ”€â”€ composables/ # ç»„åˆå¼å‡½æ•° â”‚ â”œâ”€â”€ views/ # é¡µé¢ç»„ä»¶ â”‚ â”œâ”€â”€ router/ # è·¯ç”±é…ç½® â”‚ â”œâ”€â”€ stores/ # Pinia çŠ¶æ€ç®¡ç† â”‚ â”œâ”€â”€ types/ # TypeScript ç±»å‹ â”‚ â”œâ”€â”€ utils/ # å·¥å…·å‡½æ•° â”‚ â”œâ”€â”€ App.vue â”‚ â””â”€â”€ main.ts â”œâ”€â”€ index.html â”œâ”€â”€ vite.config.ts â”œâ”€â”€ tsconfig.json â””â”€â”€ package.json äºŒã€ç»„åˆå¼ API 2.1 setup å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, reactive, computed, watch, onMounted } from \u0026#39;vue\u0026#39; // å“åº”å¼æ•°æ® const count = ref(0) const user = reactive({ name: \u0026#39;Alice\u0026#39;, age: 25 }) // è®¡ç®—å±æ€§ const doubleCount = computed(() =\u0026gt; count.value * 2) // æ–¹æ³• const increment = () =\u0026gt; { count.value++ } // ä¾¦å¬å™¨ watch(count, (newVal, oldVal) =\u0026gt; { console.log(`count changed from ${oldVal} to ${newVal}`) }) // ç”Ÿå‘½å‘¨æœŸ onMounted(() =\u0026gt; { console.log(\u0026#39;Component mounted\u0026#39;) }) \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;Count: {{ count }}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Double: {{ doubleCount }}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;User: {{ user.name }}, {{ user.age }}\u0026lt;/p\u0026gt; \u0026lt;button @click=\u0026#34;increment\u0026#34;\u0026gt;Increment\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; 2.2 ref vs reactive 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, reactive, toRefs, toRef } from \u0026#39;vue\u0026#39; // refï¼šé€‚ç”¨äºåŸºæœ¬ç±»å‹ const count = ref(0) const name = ref(\u0026#39;Alice\u0026#39;) // è®¿é—®å’Œä¿®æ”¹éœ€è¦ .value count.value++ // reactiveï¼šé€‚ç”¨äºå¯¹è±¡ const state = reactive({ count: 0, user: { name: \u0026#39;Alice\u0026#39;, age: 25 } }) // ç›´æ¥è®¿é—®å’Œä¿®æ”¹ state.count++ state.user.name = \u0026#39;Bob\u0026#39; // è§£æ„ä¼šä¸¢å¤±å“åº”æ€§ï¼Œä½¿ç”¨ toRefs const { count: refCount, user } = toRefs(state) // å•ä¸ªå±æ€§è½¬ ref const nameRef = toRef(state.user, \u0026#39;name\u0026#39;) \u0026lt;/script\u0026gt; 2.3 computed è®¡ç®—å±æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, computed } from \u0026#39;vue\u0026#39; const firstName = ref(\u0026#39;John\u0026#39;) const lastName = ref(\u0026#39;Doe\u0026#39;) // åªè¯»è®¡ç®—å±æ€§ const fullName = computed(() =\u0026gt; `${firstName.value} ${lastName.value}`) // å¯å†™è®¡ç®—å±æ€§ const fullNameWritable = computed({ get: () =\u0026gt; `${firstName.value} ${lastName.value}`, set: (val: string) =\u0026gt; { const [first, last] = val.split(\u0026#39; \u0026#39;) firstName.value = first lastName.value = last } }) // ä½¿ç”¨ fullNameWritable.value = \u0026#39;Jane Smith\u0026#39; \u0026lt;/script\u0026gt; 2.4 watch ä¾¦å¬å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, reactive, watch, watchEffect } from \u0026#39;vue\u0026#39; const count = ref(0) const user = reactive({ name: \u0026#39;Alice\u0026#39;, age: 25 }) // ä¾¦å¬ ref watch(count, (newVal, oldVal) =\u0026gt; { console.log(`count: ${oldVal} -\u0026gt; ${newVal}`) }) // ä¾¦å¬ reactive å¯¹è±¡çš„å±æ€§ watch( () =\u0026gt; user.name, (newVal, oldVal) =\u0026gt; { console.log(`name: ${oldVal} -\u0026gt; ${newVal}`) } ) // ä¾¦å¬å¤šä¸ªæº watch([count, () =\u0026gt; user.name], ([newCount, newName], [oldCount, oldName]) =\u0026gt; { console.log(`count: ${oldCount} -\u0026gt; ${newCount}`) console.log(`name: ${oldName} -\u0026gt; ${newName}`) }) // æ·±åº¦ä¾¦å¬ watch( () =\u0026gt; user, (newVal) =\u0026gt; { console.log(\u0026#39;user changed\u0026#39;, newVal) }, { deep: true } ) // ç«‹å³æ‰§è¡Œ watch(count, (newVal) =\u0026gt; { console.log(newVal) }, { immediate: true }) // watchEffectï¼šè‡ªåŠ¨æ”¶é›†ä¾èµ– watchEffect(() =\u0026gt; { console.log(`Count is ${count.value}`) console.log(`User is ${user.name}`) }) \u0026lt;/script\u0026gt; ä¸‰ã€ç”Ÿå‘½å‘¨æœŸ 3.1 ç”Ÿå‘½å‘¨æœŸé’©å­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { onBeforeMount, onMounted, onBeforeUpdate, onUpdated, onBeforeUnmount, onUnmounted, onErrorCaptured } from \u0026#39;vue\u0026#39; // æŒ‚è½½å‰ onBeforeMount(() =\u0026gt; { console.log(\u0026#39;Before mount\u0026#39;) }) // æŒ‚è½½å onMounted(() =\u0026gt; { console.log(\u0026#39;Mounted\u0026#39;) // å¯ä»¥è®¿é—® DOM }) // æ›´æ–°å‰ onBeforeUpdate(() =\u0026gt; { console.log(\u0026#39;Before update\u0026#39;) }) // æ›´æ–°å onUpdated(() =\u0026gt; { console.log(\u0026#39;Updated\u0026#39;) }) // å¸è½½å‰ onBeforeUnmount(() =\u0026gt; { console.log(\u0026#39;Before unmount\u0026#39;) // æ¸…ç†å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬ç­‰ }) // å¸è½½å onUnmounted(() =\u0026gt; { console.log(\u0026#39;Unmounted\u0026#39;) }) // é”™è¯¯æ•è· onErrorCaptured((err, instance, info) =\u0026gt; { console.error(\u0026#39;Error captured:\u0026#39;, err) return false // é˜»æ­¢é”™è¯¯ç»§ç»­ä¼ æ’­ }) \u0026lt;/script\u0026gt; å››ã€ç»„ä»¶é€šä¿¡ 4.1 Props 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 \u0026lt;!-- çˆ¶ç»„ä»¶ --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import ChildComponent from \u0026#39;./ChildComponent.vue\u0026#39; const user = { name: \u0026#39;Alice\u0026#39;, age: 25 } \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;ChildComponent :user=\u0026#34;user\u0026#34; title=\u0026#34;User Info\u0026#34; :count=\u0026#34;10\u0026#34; /\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!-- å­ç»„ä»¶ ChildComponent.vue --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; interface Props { user: { name: string age: number } title: string count?: number } // å®šä¹‰ props const props = defineProps\u0026lt;Props\u0026gt;() // å¸¦é»˜è®¤å€¼ const propsWithDefaults = withDefaults(defineProps\u0026lt;Props\u0026gt;(), { count: 0 }) \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;h2\u0026gt;{{ title }}\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;{{ user.name }}, {{ user.age }}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Count: {{ count }}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; 4.2 Emits 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 \u0026lt;!-- å­ç»„ä»¶ --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; // å®šä¹‰äº‹ä»¶ const emit = defineEmits\u0026lt;{ (e: \u0026#39;update\u0026#39;, value: number): void (e: \u0026#39;submit\u0026#39;, data: { name: string; age: number }): void }\u0026gt;() const handleClick = () =\u0026gt; { emit(\u0026#39;update\u0026#39;, 42) } const handleSubmit = () =\u0026gt; { emit(\u0026#39;submit\u0026#39;, { name: \u0026#39;Alice\u0026#39;, age: 25 }) } \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;button @click=\u0026#34;handleClick\u0026#34;\u0026gt;Update\u0026lt;/button\u0026gt; \u0026lt;button @click=\u0026#34;handleSubmit\u0026#34;\u0026gt;Submit\u0026lt;/button\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!-- çˆ¶ç»„ä»¶ --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; const handleUpdate = (value: number) =\u0026gt; { console.log(\u0026#39;Updated:\u0026#39;, value) } const handleSubmit = (data: { name: string; age: number }) =\u0026gt; { console.log(\u0026#39;Submitted:\u0026#39;, data) } \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;ChildComponent @update=\u0026#34;handleUpdate\u0026#34; @submit=\u0026#34;handleSubmit\u0026#34; /\u0026gt; \u0026lt;/template\u0026gt; 4.3 v-model 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 \u0026lt;!-- å­ç»„ä»¶ CustomInput.vue --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; const props = defineProps\u0026lt;{ modelValue: string }\u0026gt;() const emit = defineEmits\u0026lt;{ (e: \u0026#39;update:modelValue\u0026#39;, value: string): void }\u0026gt;() const updateValue = (event: Event) =\u0026gt; { emit(\u0026#39;update:modelValue\u0026#39;, (event.target as HTMLInputElement).value) } \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;input :value=\u0026#34;modelValue\u0026#34; @input=\u0026#34;updateValue\u0026#34; /\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!-- çˆ¶ç»„ä»¶ --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref } from \u0026#39;vue\u0026#39; import CustomInput from \u0026#39;./CustomInput.vue\u0026#39; const text = ref(\u0026#39;\u0026#39;) \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;CustomInput v-model=\u0026#34;text\u0026#34; /\u0026gt; \u0026lt;p\u0026gt;Input: {{ text }}\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!-- å¤šä¸ª v-model --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; defineProps\u0026lt;{ firstName: string lastName: string }\u0026gt;() defineEmits\u0026lt;{ (e: \u0026#39;update:firstName\u0026#39;, value: string): void (e: \u0026#39;update:lastName\u0026#39;, value: string): void }\u0026gt;() \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;UserForm v-model:firstName=\u0026#34;first\u0026#34; v-model:lastName=\u0026#34;last\u0026#34; /\u0026gt; \u0026lt;/template\u0026gt; 4.4 provide / inject 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 \u0026lt;!-- ç¥–å…ˆç»„ä»¶ --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { provide, ref } from \u0026#39;vue\u0026#39; const theme = ref(\u0026#39;dark\u0026#39;) const updateTheme = (newTheme: string) =\u0026gt; { theme.value = newTheme } // æä¾›æ•°æ®å’Œæ–¹æ³• provide(\u0026#39;theme\u0026#39;, theme) provide(\u0026#39;updateTheme\u0026#39;, updateTheme) // ä½¿ç”¨ Symbol ä½œä¸º keyï¼ˆæ¨èï¼‰ export const ThemeKey = Symbol(\u0026#39;theme\u0026#39;) provide(ThemeKey, { theme, updateTheme }) \u0026lt;/script\u0026gt; \u0026lt;!-- åä»£ç»„ä»¶ --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { inject } from \u0026#39;vue\u0026#39; import type { Ref } from \u0026#39;vue\u0026#39; // æ³¨å…¥ const theme = inject\u0026lt;Ref\u0026lt;string\u0026gt;\u0026gt;(\u0026#39;theme\u0026#39;) const updateTheme = inject\u0026lt;(theme: string) =\u0026gt; void\u0026gt;(\u0026#39;updateTheme\u0026#39;) // å¸¦é»˜è®¤å€¼ const themeWithDefault = inject(\u0026#39;theme\u0026#39;, ref(\u0026#39;light\u0026#39;)) \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div :class=\u0026#34;theme\u0026#34;\u0026gt; \u0026lt;button @click=\u0026#34;updateTheme?.(\u0026#39;light\u0026#39;)\u0026#34;\u0026gt;Light\u0026lt;/button\u0026gt; \u0026lt;button @click=\u0026#34;updateTheme?.(\u0026#39;dark\u0026#39;)\u0026#34;\u0026gt;Dark\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; äº”ã€ç»„åˆå¼å‡½æ•° 5.1 åŸºæœ¬ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // composables/useMouse.ts import { ref, onMounted, onUnmounted } from \u0026#39;vue\u0026#39; export function useMouse() { const x = ref(0) const y = ref(0) const update = (event: MouseEvent) =\u0026gt; { x.value = event.pageX y.value = event.pageY } onMounted(() =\u0026gt; { window.addEventListener(\u0026#39;mousemove\u0026#39;, update) }) onUnmounted(() =\u0026gt; { window.removeEventListener(\u0026#39;mousemove\u0026#39;, update) }) return { x, y } } 1 2 3 4 5 6 7 8 9 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { useMouse } from \u0026#39;@/composables/useMouse\u0026#39; const { x, y } = useMouse() \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;p\u0026gt;Mouse position: {{ x }}, {{ y }}\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; 5.2 å¼‚æ­¥æ•°æ®è·å– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // composables/useFetch.ts import { ref, watchEffect, toValue } from \u0026#39;vue\u0026#39; import type { Ref } from \u0026#39;vue\u0026#39; export function useFetch\u0026lt;T\u0026gt;(url: string | Ref\u0026lt;string\u0026gt;) { const data = ref\u0026lt;T | null\u0026gt;(null) const error = ref\u0026lt;Error | null\u0026gt;(null) const loading = ref(false) const fetchData = async () =\u0026gt; { loading.value = true error.value = null try { const response = await fetch(toValue(url)) if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`) } data.value = await response.json() } catch (e) { error.value = e as Error } finally { loading.value = false } } watchEffect(() =\u0026gt; { fetchData() }) return { data, error, loading, refetch: fetchData } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { useFetch } from \u0026#39;@/composables/useFetch\u0026#39; interface User { id: number name: string email: string } const { data: users, loading, error, refetch } = useFetch\u0026lt;User[]\u0026gt;(\u0026#39;/api/users\u0026#39;) \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div v-if=\u0026#34;loading\u0026#34;\u0026gt;Loading...\u0026lt;/div\u0026gt; \u0026lt;div v-else-if=\u0026#34;error\u0026#34;\u0026gt;Error: {{ error.message }}\u0026lt;/div\u0026gt; \u0026lt;ul v-else\u0026gt; \u0026lt;li v-for=\u0026#34;user in users\u0026#34; :key=\u0026#34;user.id\u0026#34;\u0026gt;{{ user.name }}\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;button @click=\u0026#34;refetch\u0026#34;\u0026gt;Refresh\u0026lt;/button\u0026gt; \u0026lt;/template\u0026gt; 5.3 é˜²æŠ–å’ŒèŠ‚æµ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // composables/useDebounce.ts import { ref, watch } from \u0026#39;vue\u0026#39; import type { Ref } from \u0026#39;vue\u0026#39; export function useDebounce\u0026lt;T\u0026gt;(value: Ref\u0026lt;T\u0026gt;, delay = 300) { const debouncedValue = ref(value.value) as Ref\u0026lt;T\u0026gt; let timeout: ReturnType\u0026lt;typeof setTimeout\u0026gt; watch(value, (newValue) =\u0026gt; { clearTimeout(timeout) timeout = setTimeout(() =\u0026gt; { debouncedValue.value = newValue }, delay) }) return debouncedValue } // composables/useThrottle.ts export function useThrottle\u0026lt;T extends (...args: any[]) =\u0026gt; any\u0026gt;(fn: T, delay = 300) { let lastTime = 0 return (...args: Parameters\u0026lt;T\u0026gt;) =\u0026gt; { const now = Date.now() if (now - lastTime \u0026gt;= delay) { lastTime = now return fn(...args) } } } å…­ã€æ¨¡æ¿è¯­æ³• 6.1 æ¡ä»¶æ¸²æŸ“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;template\u0026gt; \u0026lt;!-- v-if / v-else-if / v-else --\u0026gt; \u0026lt;div v-if=\u0026#34;type === \u0026#39;A\u0026#39;\u0026#34;\u0026gt;Type A\u0026lt;/div\u0026gt; \u0026lt;div v-else-if=\u0026#34;type === \u0026#39;B\u0026#39;\u0026#34;\u0026gt;Type B\u0026lt;/div\u0026gt; \u0026lt;div v-else\u0026gt;Other\u0026lt;/div\u0026gt; \u0026lt;!-- v-showï¼ˆåˆ‡æ¢ displayï¼‰ --\u0026gt; \u0026lt;div v-show=\u0026#34;isVisible\u0026#34;\u0026gt;Visible content\u0026lt;/div\u0026gt; \u0026lt;!-- template ä¸Šä½¿ç”¨ v-if --\u0026gt; \u0026lt;template v-if=\u0026#34;showSection\u0026#34;\u0026gt; \u0026lt;h1\u0026gt;Title\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Content\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/template\u0026gt; 6.2 åˆ—è¡¨æ¸²æŸ“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; const items = [ { id: 1, name: \u0026#39;Item 1\u0026#39; }, { id: 2, name: \u0026#39;Item 2\u0026#39; }, { id: 3, name: \u0026#39;Item 3\u0026#39; } ] \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;!-- æ•°ç»„ --\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li v-for=\u0026#34;item in items\u0026#34; :key=\u0026#34;item.id\u0026#34;\u0026gt; {{ item.name }} \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;!-- å¸¦ç´¢å¼• --\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li v-for=\u0026#34;(item, index) in items\u0026#34; :key=\u0026#34;item.id\u0026#34;\u0026gt; {{ index }}: {{ item.name }} \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;!-- å¯¹è±¡ --\u0026gt; \u0026lt;div v-for=\u0026#34;(value, key, index) in object\u0026#34; :key=\u0026#34;key\u0026#34;\u0026gt; {{ index }}. {{ key }}: {{ value }} \u0026lt;/div\u0026gt; \u0026lt;!-- èŒƒå›´ --\u0026gt; \u0026lt;span v-for=\u0026#34;n in 10\u0026#34; :key=\u0026#34;n\u0026#34;\u0026gt;{{ n }}\u0026lt;/span\u0026gt; \u0026lt;/template\u0026gt; 6.3 äº‹ä»¶å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; const handleClick = (event: MouseEvent) =\u0026gt; { console.log(event) } const submit = (data: string) =\u0026gt; { console.log(data) } \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;!-- åŸºæœ¬äº‹ä»¶ --\u0026gt; \u0026lt;button @click=\u0026#34;handleClick\u0026#34;\u0026gt;Click\u0026lt;/button\u0026gt; \u0026lt;!-- å†…è”å¤„ç† --\u0026gt; \u0026lt;button @click=\u0026#34;count++\u0026#34;\u0026gt;Add\u0026lt;/button\u0026gt; \u0026lt;!-- ä¼ å‚ --\u0026gt; \u0026lt;button @click=\u0026#34;submit(\u0026#39;hello\u0026#39;)\u0026#34;\u0026gt;Submit\u0026lt;/button\u0026gt; \u0026lt;!-- è®¿é—®äº‹ä»¶å¯¹è±¡ --\u0026gt; \u0026lt;button @click=\u0026#34;submit(\u0026#39;hello\u0026#39;, $event)\u0026#34;\u0026gt;Submit\u0026lt;/button\u0026gt; \u0026lt;!-- äº‹ä»¶ä¿®é¥°ç¬¦ --\u0026gt; \u0026lt;form @submit.prevent=\u0026#34;onSubmit\u0026#34;\u0026gt;...\u0026lt;/form\u0026gt; \u0026lt;div @click.stop=\u0026#34;onClick\u0026#34;\u0026gt;Stop propagation\u0026lt;/div\u0026gt; \u0026lt;input @keyup.enter=\u0026#34;onEnter\u0026#34; /\u0026gt; \u0026lt;button @click.once=\u0026#34;doOnce\u0026#34;\u0026gt;Once\u0026lt;/button\u0026gt; \u0026lt;/template\u0026gt; ä¸ƒã€æ’æ§½ 7.1 åŸºæœ¬æ’æ§½ 1 2 3 4 5 6 7 8 9 10 11 \u0026lt;!-- å­ç»„ä»¶ Card.vue --\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;card\u0026#34;\u0026gt; \u0026lt;slot\u0026gt;Default content\u0026lt;/slot\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!-- ä½¿ç”¨ --\u0026gt; \u0026lt;Card\u0026gt; \u0026lt;p\u0026gt;Custom content\u0026lt;/p\u0026gt; \u0026lt;/Card\u0026gt; 7.2 å…·åæ’æ§½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 \u0026lt;!-- å­ç»„ä»¶ Layout.vue --\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;layout\u0026#34;\u0026gt; \u0026lt;header\u0026gt; \u0026lt;slot name=\u0026#34;header\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;/header\u0026gt; \u0026lt;main\u0026gt; \u0026lt;slot\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;/main\u0026gt; \u0026lt;footer\u0026gt; \u0026lt;slot name=\u0026#34;footer\u0026#34;\u0026gt;\u0026lt;/slot\u0026gt; \u0026lt;/footer\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!-- ä½¿ç”¨ --\u0026gt; \u0026lt;Layout\u0026gt; \u0026lt;template #header\u0026gt; \u0026lt;h1\u0026gt;Page Title\u0026lt;/h1\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;p\u0026gt;Main content\u0026lt;/p\u0026gt; \u0026lt;template #footer\u0026gt; \u0026lt;p\u0026gt;Footer content\u0026lt;/p\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/Layout\u0026gt; 7.3 ä½œç”¨åŸŸæ’æ§½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 \u0026lt;!-- å­ç»„ä»¶ List.vue --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; interface Item { id: number name: string } defineProps\u0026lt;{ items: Item[] }\u0026gt;() \u0026lt;/script\u0026gt; \u0026lt;template\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li v-for=\u0026#34;item in items\u0026#34; :key=\u0026#34;item.id\u0026#34;\u0026gt; \u0026lt;slot :item=\u0026#34;item\u0026#34; :index=\u0026#34;index\u0026#34;\u0026gt; {{ item.name }} \u0026lt;/slot\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;!-- ä½¿ç”¨ --\u0026gt; \u0026lt;List :items=\u0026#34;items\u0026#34;\u0026gt; \u0026lt;template #default=\u0026#34;{ item, index }\u0026#34;\u0026gt; \u0026lt;span\u0026gt;{{ index + 1 }}. {{ item.name }}\u0026lt;/span\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/List\u0026gt; å…«ã€TypeScript æ”¯æŒ 8.1 ç±»å‹å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // types/user.ts export interface User { id: number name: string email: string role: \u0026#39;admin\u0026#39; | \u0026#39;user\u0026#39; createdAt: Date } export interface CreateUserDTO { name: string email: string password: string } export type UserList = User[] 8.2 ç»„ä»¶ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import type { User } from \u0026#39;@/types/user\u0026#39; // Props ç±»å‹ interface Props { user: User loading?: boolean } const props = defineProps\u0026lt;Props\u0026gt;() // Emits ç±»å‹ const emit = defineEmits\u0026lt;{ (e: \u0026#39;update\u0026#39;, user: User): void (e: \u0026#39;delete\u0026#39;, id: number): void }\u0026gt;() // Ref ç±»å‹ const inputRef = ref\u0026lt;HTMLInputElement | null\u0026gt;(null) // æ³›å‹ç»„ä»¶ const data = ref\u0026lt;User[]\u0026gt;([]) \u0026lt;/script\u0026gt; æ€»ç»“ Vue 3 çš„ç»„åˆå¼ API æä¾›äº†æ›´çµæ´»ã€æ›´æ˜“äºå¤ç”¨çš„ä»£ç ç»„ç»‡æ–¹å¼ï¼Œé…åˆ TypeScript å¯ä»¥æ„å»ºç±»å‹å®‰å…¨çš„å¤§å‹åº”ç”¨ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ¯ ç»„åˆå¼ API æ›¿ä»£é€‰é¡¹å¼ API ğŸ“¦ ç»„åˆå¼å‡½æ•°å®ç°é€»è¾‘å¤ç”¨ ğŸ”§ æ›´å¥½çš„ TypeScript æ”¯æŒ âš¡ æ›´å°çš„åŒ…ä½“ç§¯å’Œæ›´å¥½çš„æ€§èƒ½ ğŸ¨ çµæ´»çš„ç»„ä»¶é€šä¿¡æ–¹å¼ ","date":"2025-07-06T00:00:00Z","permalink":"https://zpf-zero.github.io/p/vue3-guide/","title":"Vue 3 å®æˆ˜æŒ‡å—ï¼šç»„åˆå¼ API ä¸ç°ä»£å‰ç«¯å¼€å‘"},{"content":"å‰è¨€ Vue Router æ˜¯ Vue.js çš„å®˜æ–¹è·¯ç”±ç®¡ç†å™¨ï¼Œå®ƒä¸ Vue.js æ ¸å¿ƒæ·±åº¦é›†æˆï¼Œè®©æ„å»ºå•é¡µé¢åº”ç”¨å˜å¾—ç®€å•ã€‚Vue Router 4 æ˜¯ä¸“ä¸º Vue 3 è®¾è®¡çš„ç‰ˆæœ¬ï¼Œæä¾›äº†ç»„åˆå¼ API æ”¯æŒå’Œæ›´å¥½çš„ TypeScript é›†æˆã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£… 1 npm install vue-router@4 1.2 åŸºç¡€é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // router/index.ts import { createRouter, createWebHistory } from \u0026#39;vue-router\u0026#39; import type { RouteRecordRaw } from \u0026#39;vue-router\u0026#39; const routes: RouteRecordRaw[] = [ { path: \u0026#39;/\u0026#39;, name: \u0026#39;Home\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/Home.vue\u0026#39;), }, { path: \u0026#39;/about\u0026#39;, name: \u0026#39;About\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/About.vue\u0026#39;), }, ] const router = createRouter({ history: createWebHistory(import.meta.env.BASE_URL), routes, }) export default router 1 2 3 4 5 6 7 8 // main.ts import { createApp } from \u0026#39;vue\u0026#39; import router from \u0026#39;./router\u0026#39; import App from \u0026#39;./App.vue\u0026#39; const app = createApp(App) app.use(router) app.mount(\u0026#39;#app\u0026#39;) 1.3 è·¯ç”±è§†å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;!-- App.vue --\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div id=\u0026#34;app\u0026#34;\u0026gt; \u0026lt;nav\u0026gt; \u0026lt;router-link to=\u0026#34;/\u0026#34;\u0026gt;Home\u0026lt;/router-link\u0026gt; \u0026lt;router-link to=\u0026#34;/about\u0026#34;\u0026gt;About\u0026lt;/router-link\u0026gt; \u0026lt;/nav\u0026gt; \u0026lt;!-- è·¯ç”±å‡ºå£ --\u0026gt; \u0026lt;router-view /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; äºŒã€è·¯ç”±é…ç½® 2.1 åŠ¨æ€è·¯ç”± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 const routes: RouteRecordRaw[] = [ // åŠ¨æ€æ®µ { path: \u0026#39;/users/:id\u0026#39;, name: \u0026#39;User\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/User.vue\u0026#39;), }, // å¤šä¸ªåŠ¨æ€æ®µ { path: \u0026#39;/users/:userId/posts/:postId\u0026#39;, name: \u0026#39;UserPost\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/UserPost.vue\u0026#39;), }, // å¯é€‰å‚æ•° { path: \u0026#39;/users/:id?\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/Users.vue\u0026#39;), }, // æ­£åˆ™çº¦æŸ { path: \u0026#39;/users/:id(\\\\d+)\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/User.vue\u0026#39;), }, // å¯é‡å¤å‚æ•° { path: \u0026#39;/files/:path+\u0026#39;, // è‡³å°‘ä¸€ä¸ª component: () =\u0026gt; import(\u0026#39;@/views/Files.vue\u0026#39;), }, { path: \u0026#39;/files/:path*\u0026#39;, // é›¶ä¸ªæˆ–å¤šä¸ª component: () =\u0026gt; import(\u0026#39;@/views/Files.vue\u0026#39;), }, ] 1 2 3 4 5 6 7 8 9 10 11 \u0026lt;!-- è·å–è·¯ç”±å‚æ•° --\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { useRoute } from \u0026#39;vue-router\u0026#39; const route = useRoute() // è®¿é—®å‚æ•° console.log(route.params.id) console.log(route.params.userId) console.log(route.params.postId) \u0026lt;/script\u0026gt; 2.2 åµŒå¥—è·¯ç”± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 const routes: RouteRecordRaw[] = [ { path: \u0026#39;/user/:id\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/User.vue\u0026#39;), children: [ { // é»˜è®¤å­è·¯ç”± path: \u0026#39;\u0026#39;, name: \u0026#39;UserProfile\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/UserProfile.vue\u0026#39;), }, { path: \u0026#39;posts\u0026#39;, name: \u0026#39;UserPosts\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/UserPosts.vue\u0026#39;), }, { path: \u0026#39;settings\u0026#39;, name: \u0026#39;UserSettings\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/UserSettings.vue\u0026#39;), }, ], }, ] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;!-- views/User.vue --\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;user\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;User {{ $route.params.id }}\u0026lt;/h2\u0026gt; \u0026lt;nav\u0026gt; \u0026lt;router-link :to=\u0026#34;{ name: \u0026#39;UserProfile\u0026#39; }\u0026#34;\u0026gt;Profile\u0026lt;/router-link\u0026gt; \u0026lt;router-link :to=\u0026#34;{ name: \u0026#39;UserPosts\u0026#39; }\u0026#34;\u0026gt;Posts\u0026lt;/router-link\u0026gt; \u0026lt;router-link :to=\u0026#34;{ name: \u0026#39;UserSettings\u0026#39; }\u0026#34;\u0026gt;Settings\u0026lt;/router-link\u0026gt; \u0026lt;/nav\u0026gt; \u0026lt;!-- åµŒå¥—è·¯ç”±å‡ºå£ --\u0026gt; \u0026lt;router-view /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; 2.3 å‘½åè§†å›¾ 1 2 3 4 5 6 7 8 9 10 const routes: RouteRecordRaw[] = [ { path: \u0026#39;/\u0026#39;, components: { default: () =\u0026gt; import(\u0026#39;@/views/Main.vue\u0026#39;), sidebar: () =\u0026gt; import(\u0026#39;@/views/Sidebar.vue\u0026#39;), header: () =\u0026gt; import(\u0026#39;@/views/Header.vue\u0026#39;), }, }, ] 1 2 3 4 5 6 7 8 9 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;layout\u0026#34;\u0026gt; \u0026lt;router-view name=\u0026#34;header\u0026#34; /\u0026gt; \u0026lt;div class=\u0026#34;content\u0026#34;\u0026gt; \u0026lt;router-view name=\u0026#34;sidebar\u0026#34; /\u0026gt; \u0026lt;router-view /\u0026gt; \u0026lt;!-- default --\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; 2.4 é‡å®šå‘å’Œåˆ«å 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 const routes: RouteRecordRaw[] = [ // é‡å®šå‘ { path: \u0026#39;/home\u0026#39;, redirect: \u0026#39;/\u0026#39;, }, { path: \u0026#39;/search/:query\u0026#39;, redirect: to =\u0026gt; ({ path: \u0026#39;/results\u0026#39;, query: { q: to.params.query }, }), }, // åˆ«å { path: \u0026#39;/users\u0026#39;, alias: [\u0026#39;/people\u0026#39;, \u0026#39;/members\u0026#39;], component: () =\u0026gt; import(\u0026#39;@/views/Users.vue\u0026#39;), }, ] ä¸‰ã€ç¼–ç¨‹å¼å¯¼èˆª 3.1 ä½¿ç”¨ useRouter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { useRouter, useRoute } from \u0026#39;vue-router\u0026#39; const router = useRouter() const route = useRoute() // å¯¼èˆªåˆ°æŒ‡å®šè·¯å¾„ const goToHome = () =\u0026gt; { router.push(\u0026#39;/\u0026#39;) } // å‘½åè·¯ç”± const goToUser = (id: number) =\u0026gt; { router.push({ name: \u0026#39;User\u0026#39;, params: { id } }) } // å¸¦æŸ¥è¯¢å‚æ•° const goToSearch = (query: string) =\u0026gt; { router.push({ path: \u0026#39;/search\u0026#39;, query: { q: query } }) } // æ›¿æ¢å½“å‰è·¯ç”±ï¼ˆä¸æ·»åŠ å†å²è®°å½•ï¼‰ const replaceToHome = () =\u0026gt; { router.replace(\u0026#39;/\u0026#39;) } // å‰è¿›/åé€€ const goBack = () =\u0026gt; router.back() const goForward = () =\u0026gt; router.forward() const goTo = (n: number) =\u0026gt; router.go(n) \u0026lt;/script\u0026gt; 3.2 å¯¼èˆªç»“æœ 1 2 3 4 5 6 7 8 9 10 11 12 13 // push è¿”å› Promise const navigate = async () =\u0026gt; { try { await router.push(\u0026#39;/dashboard\u0026#39;) console.log(\u0026#39;Navigation successful\u0026#39;) } catch (error) { if (isNavigationFailure(error, NavigationFailureType.aborted)) { console.log(\u0026#39;Navigation aborted\u0026#39;) } else if (isNavigationFailure(error, NavigationFailureType.duplicated)) { console.log(\u0026#39;Already at this location\u0026#39;) } } } å››ã€å¯¼èˆªå®ˆå« 4.1 å…¨å±€å®ˆå« 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 // router/index.ts import { createRouter } from \u0026#39;vue-router\u0026#39; import { useAuthStore } from \u0026#39;@/stores/auth\u0026#39; const router = createRouter({ ... }) // å…¨å±€å‰ç½®å®ˆå« router.beforeEach((to, from) =\u0026gt; { const authStore = useAuthStore() // æ£€æŸ¥è·¯ç”±æ˜¯å¦éœ€è¦è®¤è¯ if (to.meta.requiresAuth \u0026amp;\u0026amp; !authStore.isLoggedIn) { // é‡å®šå‘åˆ°ç™»å½•é¡µ return { path: \u0026#39;/login\u0026#39;, query: { redirect: to.fullPath }, } } // æ£€æŸ¥æƒé™ if (to.meta.roles \u0026amp;\u0026amp; !to.meta.roles.includes(authStore.user?.role)) { return { path: \u0026#39;/403\u0026#39; } } return true // æˆ–è€… undefined ç»§ç»­å¯¼èˆª }) // å…¨å±€åç½®é’©å­ router.afterEach((to, from) =\u0026gt; { // æ›´æ–°é¡µé¢æ ‡é¢˜ document.title = to.meta.title || \u0026#39;My App\u0026#39; // è®°å½•é¡µé¢è®¿é—® analytics.logPageView(to.path) }) // å…¨å±€é”™è¯¯å¤„ç† router.onError((error) =\u0026gt; { console.error(\u0026#39;Navigation error:\u0026#39;, error) }) 4.2 è·¯ç”±ç‹¬äº«å®ˆå« 1 2 3 4 5 6 7 8 9 10 11 12 const routes: RouteRecordRaw[] = [ { path: \u0026#39;/admin\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/Admin.vue\u0026#39;), beforeEnter: (to, from) =\u0026gt; { const authStore = useAuthStore() if (authStore.user?.role !== \u0026#39;admin\u0026#39;) { return { path: \u0026#39;/403\u0026#39; } } }, }, ] 4.3 ç»„ä»¶å†…å®ˆå« 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { onBeforeRouteLeave, onBeforeRouteUpdate } from \u0026#39;vue-router\u0026#39; // ç¦»å¼€å®ˆå« onBeforeRouteLeave((to, from) =\u0026gt; { if (hasUnsavedChanges.value) { const answer = window.confirm(\u0026#39;æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šç¦»å¼€å—ï¼Ÿ\u0026#39;) if (!answer) return false } }) // æ›´æ–°å®ˆå«ï¼ˆå‚æ•°å˜åŒ–æ—¶ï¼‰ onBeforeRouteUpdate(async (to, from) =\u0026gt; { // è·¯ç”±å‚æ•°å˜åŒ–æ—¶é‡æ–°è·å–æ•°æ® if (to.params.id !== from.params.id) { await fetchData(to.params.id as string) } }) \u0026lt;/script\u0026gt; äº”ã€è·¯ç”±å…ƒä¿¡æ¯ 5.1 å®šä¹‰å…ƒä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // ç±»å‹å£°æ˜ declare module \u0026#39;vue-router\u0026#39; { interface RouteMeta { title?: string requiresAuth?: boolean roles?: string[] keepAlive?: boolean transition?: string } } const routes: RouteRecordRaw[] = [ { path: \u0026#39;/dashboard\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/Dashboard.vue\u0026#39;), meta: { title: \u0026#39;ä»ªè¡¨ç›˜\u0026#39;, requiresAuth: true, roles: [\u0026#39;admin\u0026#39;, \u0026#39;user\u0026#39;], keepAlive: true, }, }, ] 5.2 ä½¿ç”¨å…ƒä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 \u0026lt;template\u0026gt; \u0026lt;router-view v-slot=\u0026#34;{ Component, route }\u0026#34;\u0026gt; \u0026lt;transition :name=\u0026#34;route.meta.transition || \u0026#39;fade\u0026#39;\u0026#34;\u0026gt; \u0026lt;keep-alive v-if=\u0026#34;route.meta.keepAlive\u0026#34;\u0026gt; \u0026lt;component :is=\u0026#34;Component\u0026#34; :key=\u0026#34;route.path\u0026#34; /\u0026gt; \u0026lt;/keep-alive\u0026gt; \u0026lt;component v-else :is=\u0026#34;Component\u0026#34; :key=\u0026#34;route.path\u0026#34; /\u0026gt; \u0026lt;/transition\u0026gt; \u0026lt;/router-view\u0026gt; \u0026lt;/template\u0026gt; å…­ã€è·¯ç”±æ‡’åŠ è½½ 6.1 åŸºç¡€æ‡’åŠ è½½ 1 2 3 4 5 6 const routes: RouteRecordRaw[] = [ { path: \u0026#39;/dashboard\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/Dashboard.vue\u0026#39;), }, ] 6.2 å‘½å chunk 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 const routes: RouteRecordRaw[] = [ { path: \u0026#39;/admin\u0026#39;, component: () =\u0026gt; import(/* webpackChunkName: \u0026#34;admin\u0026#34; */ \u0026#39;@/views/Admin.vue\u0026#39;), children: [ { path: \u0026#39;users\u0026#39;, component: () =\u0026gt; import(/* webpackChunkName: \u0026#34;admin\u0026#34; */ \u0026#39;@/views/AdminUsers.vue\u0026#39;), }, { path: \u0026#39;settings\u0026#39;, component: () =\u0026gt; import(/* webpackChunkName: \u0026#34;admin\u0026#34; */ \u0026#39;@/views/AdminSettings.vue\u0026#39;), }, ], }, ] 6.3 åŠ è½½çŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;template\u0026gt; \u0026lt;router-view v-slot=\u0026#34;{ Component }\u0026#34;\u0026gt; \u0026lt;Suspense\u0026gt; \u0026lt;template #default\u0026gt; \u0026lt;component :is=\u0026#34;Component\u0026#34; /\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;template #fallback\u0026gt; \u0026lt;div class=\u0026#34;loading\u0026#34;\u0026gt;Loading...\u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/Suspense\u0026gt; \u0026lt;/router-view\u0026gt; \u0026lt;/template\u0026gt; ä¸ƒã€æ»šåŠ¨è¡Œä¸º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 const router = createRouter({ history: createWebHistory(), routes, scrollBehavior(to, from, savedPosition) { // å¦‚æœæœ‰ä¿å­˜çš„ä½ç½®ï¼ˆæµè§ˆå™¨å‰è¿›/åé€€ï¼‰ if (savedPosition) { return savedPosition } // å¦‚æœæœ‰é”šç‚¹ if (to.hash) { return { el: to.hash, behavior: \u0026#39;smooth\u0026#39;, } } // æ»šåŠ¨åˆ°é¡¶éƒ¨ return { top: 0, behavior: \u0026#39;smooth\u0026#39; } }, }) // å»¶è¿Ÿæ»šåŠ¨ scrollBehavior(to, from, savedPosition) { return new Promise((resolve) =\u0026gt; { setTimeout(() =\u0026gt; { resolve({ top: 0 }) }, 300) }) } å…«ã€åŠ¨æ€è·¯ç”± 8.1 æ·»åŠ è·¯ç”± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // åŠ¨æ€æ·»åŠ è·¯ç”± router.addRoute({ path: \u0026#39;/new-page\u0026#39;, name: \u0026#39;NewPage\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/NewPage.vue\u0026#39;), }) // æ·»åŠ åµŒå¥—è·¯ç”± router.addRoute(\u0026#39;User\u0026#39;, { path: \u0026#39;activity\u0026#39;, name: \u0026#39;UserActivity\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/UserActivity.vue\u0026#39;), }) // åˆ é™¤è·¯ç”± router.removeRoute(\u0026#39;NewPage\u0026#39;) // æ£€æŸ¥è·¯ç”±æ˜¯å¦å­˜åœ¨ router.hasRoute(\u0026#39;NewPage\u0026#39;) // è·å–æ‰€æœ‰è·¯ç”± router.getRoutes() 8.2 æƒé™è·¯ç”± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // stores/permission.ts export const usePermissionStore = defineStore(\u0026#39;permission\u0026#39;, () =\u0026gt; { const routes = ref\u0026lt;RouteRecordRaw[]\u0026gt;([]) const addedRoutes = ref\u0026lt;RouteRecordRaw[]\u0026gt;([]) // æ ¹æ®ç”¨æˆ·è§’è‰²ç”Ÿæˆè·¯ç”± function generateRoutes(roles: string[]) { const asyncRoutes = filterAsyncRoutes(allAsyncRoutes, roles) addedRoutes.value = asyncRoutes routes.value = constantRoutes.concat(asyncRoutes) return asyncRoutes } return { routes, addedRoutes, generateRoutes } }) // è¿‡æ»¤è·¯ç”± function filterAsyncRoutes(routes: RouteRecordRaw[], roles: string[]): RouteRecordRaw[] { const res: RouteRecordRaw[] = [] routes.forEach(route =\u0026gt; { const tmp = { ...route } if (hasPermission(roles, tmp)) { if (tmp.children) { tmp.children = filterAsyncRoutes(tmp.children, roles) } res.push(tmp) } }) return res } function hasPermission(roles: string[], route: RouteRecordRaw): boolean { if (route.meta \u0026amp;\u0026amp; route.meta.roles) { return roles.some(role =\u0026gt; route.meta!.roles!.includes(role)) } return true } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // åœ¨å®ˆå«ä¸­åŠ¨æ€æ·»åŠ è·¯ç”± router.beforeEach(async (to, from) =\u0026gt; { const authStore = useAuthStore() const permissionStore = usePermissionStore() if (authStore.token) { if (!permissionStore.addedRoutes.length) { // è·å–ç”¨æˆ·ä¿¡æ¯ const user = await authStore.getUserInfo() // ç”Ÿæˆè·¯ç”± const asyncRoutes = permissionStore.generateRoutes(user.roles) // åŠ¨æ€æ·»åŠ è·¯ç”± asyncRoutes.forEach(route =\u0026gt; { router.addRoute(route) }) // é‡æ–°å¯¼èˆª return { ...to, replace: true } } } }) ä¹ã€è·¯ç”±è¿‡æ¸¡åŠ¨ç”» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 \u0026lt;template\u0026gt; \u0026lt;router-view v-slot=\u0026#34;{ Component, route }\u0026#34;\u0026gt; \u0026lt;transition :name=\u0026#34;getTransitionName(route)\u0026#34; mode=\u0026#34;out-in\u0026#34;\u0026gt; \u0026lt;component :is=\u0026#34;Component\u0026#34; /\u0026gt; \u0026lt;/transition\u0026gt; \u0026lt;/router-view\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import type { RouteLocationNormalized } from \u0026#39;vue-router\u0026#39; const getTransitionName = (route: RouteLocationNormalized) =\u0026gt; { return route.meta.transition || \u0026#39;fade\u0026#39; } \u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; } .fade-enter-from, .fade-leave-to { opacity: 0; } .slide-left-enter-active, .slide-left-leave-active { transition: transform 0.3s ease; } .slide-left-enter-from { transform: translateX(100%); } .slide-left-leave-to { transform: translateX(-100%); } \u0026lt;/style\u0026gt; åã€å®Œæ•´é…ç½®ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 // router/index.ts import { createRouter, createWebHistory, RouteRecordRaw } from \u0026#39;vue-router\u0026#39; import { useAuthStore } from \u0026#39;@/stores/auth\u0026#39; import NProgress from \u0026#39;nprogress\u0026#39; import \u0026#39;nprogress/nprogress.css\u0026#39; // å…¬å…±è·¯ç”± const constantRoutes: RouteRecordRaw[] = [ { path: \u0026#39;/login\u0026#39;, name: \u0026#39;Login\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/Login.vue\u0026#39;), meta: { title: \u0026#39;ç™»å½•\u0026#39; }, }, { path: \u0026#39;/404\u0026#39;, name: \u0026#39;NotFound\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/404.vue\u0026#39;), meta: { title: \u0026#39;é¡µé¢ä¸å­˜åœ¨\u0026#39; }, }, ] // éœ€è¦æƒé™çš„è·¯ç”± const asyncRoutes: RouteRecordRaw[] = [ { path: \u0026#39;/\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/layouts/Default.vue\u0026#39;), redirect: \u0026#39;/dashboard\u0026#39;, children: [ { path: \u0026#39;dashboard\u0026#39;, name: \u0026#39;Dashboard\u0026#39;, component: () =\u0026gt; import(\u0026#39;@/views/Dashboard.vue\u0026#39;), meta: { title: \u0026#39;ä»ªè¡¨ç›˜\u0026#39;, requiresAuth: true }, }, ], }, { path: \u0026#39;/:pathMatch(.*)*\u0026#39;, redirect: \u0026#39;/404\u0026#39;, }, ] const router = createRouter({ history: createWebHistory(), routes: [...constantRoutes, ...asyncRoutes], scrollBehavior(to, from, savedPosition) { return savedPosition || { top: 0 } }, }) // ç™½åå• const whiteList = [\u0026#39;/login\u0026#39;, \u0026#39;/404\u0026#39;] router.beforeEach(async (to, from) =\u0026gt; { NProgress.start() const authStore = useAuthStore() if (authStore.token) { if (to.path === \u0026#39;/login\u0026#39;) { return \u0026#39;/\u0026#39; } return true } else { if (whiteList.includes(to.path)) { return true } return { path: \u0026#39;/login\u0026#39;, query: { redirect: to.fullPath } } } }) router.afterEach((to) =\u0026gt; { NProgress.done() document.title = `${to.meta.title || \u0026#39;\u0026#39;} - My App` }) export default router æ€»ç»“ Vue Router æ˜¯ Vue 3 åº”ç”¨ä¸­ä¸å¯æˆ–ç¼ºçš„è·¯ç”±ç®¡ç†æ–¹æ¡ˆï¼Œæä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½æ¥æ„å»ºå¤æ‚çš„å•é¡µé¢åº”ç”¨ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ›£ï¸ çµæ´»çš„è·¯ç”±é…ç½® ğŸ”’ å¼ºå¤§çš„å¯¼èˆªå®ˆå« âš¡ è·¯ç”±æ‡’åŠ è½½ä¼˜åŒ– ğŸ­ ä¸°å¯Œçš„è¿‡æ¸¡æ•ˆæœ ğŸ” å®Œå–„çš„æƒé™æ§åˆ¶ Incoming (Background Agent changes)\n","date":"2025-06-19T00:00:00Z","permalink":"https://zpf-zero.github.io/p/vue-router-guide/","title":"Vue Router å®æˆ˜æŒ‡å—ï¼šVue 3 è·¯ç”±ç®¡ç†å®Œå…¨æ‰‹å†Œ"},{"content":"å‰è¨€ Element Plus æ˜¯åŸºäº Vue 3 çš„ä¼ä¸šçº§ UI ç»„ä»¶åº“ï¼Œæ˜¯ Element UI çš„ Vue 3 ç‰ˆæœ¬ã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„ç»„ä»¶å’Œå®Œå–„çš„æ–‡æ¡£ï¼Œæ˜¯æ„å»ºä¸­åå°ç®¡ç†ç³»ç»Ÿçš„ç»ä½³é€‰æ‹©ã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£… 1 2 3 npm install element-plus # å›¾æ ‡åº“ npm install @element-plus/icons-vue 1.2 å®Œæ•´å¼•å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // main.ts import { createApp } from \u0026#39;vue\u0026#39; import ElementPlus from \u0026#39;element-plus\u0026#39; import \u0026#39;element-plus/dist/index.css\u0026#39; import * as ElementPlusIconsVue from \u0026#39;@element-plus/icons-vue\u0026#39; import App from \u0026#39;./App.vue\u0026#39; const app = createApp(App) // æ³¨å†Œæ‰€æœ‰å›¾æ ‡ for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component) } app.use(ElementPlus) app.mount(\u0026#39;#app\u0026#39;) 1.3 æŒ‰éœ€å¼•å…¥ï¼ˆæ¨èï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // vite.config.ts import { defineConfig } from \u0026#39;vite\u0026#39; import vue from \u0026#39;@vitejs/plugin-vue\u0026#39; import AutoImport from \u0026#39;unplugin-auto-import/vite\u0026#39; import Components from \u0026#39;unplugin-vue-components/vite\u0026#39; import { ElementPlusResolver } from \u0026#39;unplugin-vue-components/resolvers\u0026#39; export default defineConfig({ plugins: [ vue(), AutoImport({ resolvers: [ElementPlusResolver()], }), Components({ resolvers: [ElementPlusResolver()], }), ], }) äºŒã€åŸºç¡€ç»„ä»¶ 2.1 æŒ‰é’® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;button-demo\u0026#34;\u0026gt; \u0026lt;!-- åŸºç¡€æŒ‰é’® --\u0026gt; \u0026lt;el-button\u0026gt;é»˜è®¤æŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;el-button type=\u0026#34;primary\u0026#34;\u0026gt;ä¸»è¦æŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;el-button type=\u0026#34;success\u0026#34;\u0026gt;æˆåŠŸæŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;el-button type=\u0026#34;warning\u0026#34;\u0026gt;è­¦å‘ŠæŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;el-button type=\u0026#34;danger\u0026#34;\u0026gt;å±é™©æŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;el-button type=\u0026#34;info\u0026#34;\u0026gt;ä¿¡æ¯æŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;!-- æœ´ç´ æŒ‰é’® --\u0026gt; \u0026lt;el-button plain\u0026gt;æœ´ç´ æŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;el-button type=\u0026#34;primary\u0026#34; plain\u0026gt;ä¸»è¦æŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;!-- åœ†è§’æŒ‰é’® --\u0026gt; \u0026lt;el-button round\u0026gt;åœ†è§’æŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;!-- åœ†å½¢æŒ‰é’® --\u0026gt; \u0026lt;el-button :icon=\u0026#34;Search\u0026#34; circle /\u0026gt; \u0026lt;!-- åŠ è½½çŠ¶æ€ --\u0026gt; \u0026lt;el-button type=\u0026#34;primary\u0026#34; :loading=\u0026#34;loading\u0026#34; @click=\u0026#34;handleClick\u0026#34;\u0026gt; åŠ è½½ä¸­ \u0026lt;/el-button\u0026gt; \u0026lt;!-- ç¦ç”¨çŠ¶æ€ --\u0026gt; \u0026lt;el-button disabled\u0026gt;ç¦ç”¨æŒ‰é’®\u0026lt;/el-button\u0026gt; \u0026lt;!-- æŒ‰é’®ç»„ --\u0026gt; \u0026lt;el-button-group\u0026gt; \u0026lt;el-button type=\u0026#34;primary\u0026#34; :icon=\u0026#34;ArrowLeft\u0026#34;\u0026gt;ä¸Šä¸€é¡µ\u0026lt;/el-button\u0026gt; \u0026lt;el-button type=\u0026#34;primary\u0026#34;\u0026gt; ä¸‹ä¸€é¡µ\u0026lt;el-icon class=\u0026#34;el-icon--right\u0026#34;\u0026gt;\u0026lt;ArrowRight /\u0026gt;\u0026lt;/el-icon\u0026gt; \u0026lt;/el-button\u0026gt; \u0026lt;/el-button-group\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref } from \u0026#39;vue\u0026#39; import { Search, ArrowLeft, ArrowRight } from \u0026#39;@element-plus/icons-vue\u0026#39; const loading = ref(false) const handleClick = () =\u0026gt; { loading.value = true setTimeout(() =\u0026gt; { loading.value = false }, 2000) } \u0026lt;/script\u0026gt; 2.2 è¾“å…¥æ¡† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;input-demo\u0026#34;\u0026gt; \u0026lt;!-- åŸºç¡€è¾“å…¥æ¡† --\u0026gt; \u0026lt;el-input v-model=\u0026#34;input\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥å†…å®¹\u0026#34; /\u0026gt; \u0026lt;!-- å¯æ¸…ç©º --\u0026gt; \u0026lt;el-input v-model=\u0026#34;input\u0026#34; clearable /\u0026gt; \u0026lt;!-- å¯†ç æ¡† --\u0026gt; \u0026lt;el-input v-model=\u0026#34;password\u0026#34; type=\u0026#34;password\u0026#34; show-password /\u0026gt; \u0026lt;!-- å¸¦å›¾æ ‡ --\u0026gt; \u0026lt;el-input v-model=\u0026#34;input\u0026#34; :prefix-icon=\u0026#34;Search\u0026#34; /\u0026gt; \u0026lt;el-input v-model=\u0026#34;input\u0026#34; :suffix-icon=\u0026#34;Calendar\u0026#34; /\u0026gt; \u0026lt;!-- å¤åˆè¾“å…¥æ¡† --\u0026gt; \u0026lt;el-input v-model=\u0026#34;input\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥å†…å®¹\u0026#34;\u0026gt; \u0026lt;template #prepend\u0026gt;http://\u0026lt;/template\u0026gt; \u0026lt;/el-input\u0026gt; \u0026lt;el-input v-model=\u0026#34;input\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥å†…å®¹\u0026#34;\u0026gt; \u0026lt;template #append\u0026gt;.com\u0026lt;/template\u0026gt; \u0026lt;/el-input\u0026gt; \u0026lt;!-- æ–‡æœ¬åŸŸ --\u0026gt; \u0026lt;el-input v-model=\u0026#34;textarea\u0026#34; type=\u0026#34;textarea\u0026#34; :rows=\u0026#34;4\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥å†…å®¹\u0026#34; maxlength=\u0026#34;200\u0026#34; show-word-limit /\u0026gt; \u0026lt;!-- è‡ªé€‚åº”é«˜åº¦ --\u0026gt; \u0026lt;el-input v-model=\u0026#34;textarea\u0026#34; type=\u0026#34;textarea\u0026#34; :autosize=\u0026#34;{ minRows: 2, maxRows: 6 }\u0026#34; /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref } from \u0026#39;vue\u0026#39; import { Search, Calendar } from \u0026#39;@element-plus/icons-vue\u0026#39; const input = ref(\u0026#39;\u0026#39;) const password = ref(\u0026#39;\u0026#39;) const textarea = ref(\u0026#39;\u0026#39;) \u0026lt;/script\u0026gt; 2.3 é€‰æ‹©å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;select-demo\u0026#34;\u0026gt; \u0026lt;!-- åŸºç¡€é€‰æ‹© --\u0026gt; \u0026lt;el-select v-model=\u0026#34;value\u0026#34; placeholder=\u0026#34;è¯·é€‰æ‹©\u0026#34;\u0026gt; \u0026lt;el-option v-for=\u0026#34;item in options\u0026#34; :key=\u0026#34;item.value\u0026#34; :label=\u0026#34;item.label\u0026#34; :value=\u0026#34;item.value\u0026#34; /\u0026gt; \u0026lt;/el-select\u0026gt; \u0026lt;!-- å¯æ¸…ç©º --\u0026gt; \u0026lt;el-select v-model=\u0026#34;value\u0026#34; clearable placeholder=\u0026#34;è¯·é€‰æ‹©\u0026#34;\u0026gt; \u0026lt;el-option v-for=\u0026#34;item in options\u0026#34; :key=\u0026#34;item.value\u0026#34; :label=\u0026#34;item.label\u0026#34; :value=\u0026#34;item.value\u0026#34; /\u0026gt; \u0026lt;/el-select\u0026gt; \u0026lt;!-- å¤šé€‰ --\u0026gt; \u0026lt;el-select v-model=\u0026#34;multiValue\u0026#34; multiple placeholder=\u0026#34;è¯·é€‰æ‹©\u0026#34;\u0026gt; \u0026lt;el-option v-for=\u0026#34;item in options\u0026#34; :key=\u0026#34;item.value\u0026#34; :label=\u0026#34;item.label\u0026#34; :value=\u0026#34;item.value\u0026#34; /\u0026gt; \u0026lt;/el-select\u0026gt; \u0026lt;!-- å¯æœç´¢ --\u0026gt; \u0026lt;el-select v-model=\u0026#34;value\u0026#34; filterable placeholder=\u0026#34;è¯·é€‰æ‹©\u0026#34;\u0026gt; \u0026lt;el-option v-for=\u0026#34;item in options\u0026#34; :key=\u0026#34;item.value\u0026#34; :label=\u0026#34;item.label\u0026#34; :value=\u0026#34;item.value\u0026#34; /\u0026gt; \u0026lt;/el-select\u0026gt; \u0026lt;!-- è¿œç¨‹æœç´¢ --\u0026gt; \u0026lt;el-select v-model=\u0026#34;remoteValue\u0026#34; filterable remote :remote-method=\u0026#34;remoteMethod\u0026#34; :loading=\u0026#34;loading\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥å…³é”®è¯\u0026#34; \u0026gt; \u0026lt;el-option v-for=\u0026#34;item in remoteOptions\u0026#34; :key=\u0026#34;item.value\u0026#34; :label=\u0026#34;item.label\u0026#34; :value=\u0026#34;item.value\u0026#34; /\u0026gt; \u0026lt;/el-select\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref } from \u0026#39;vue\u0026#39; const value = ref(\u0026#39;\u0026#39;) const multiValue = ref([]) const remoteValue = ref(\u0026#39;\u0026#39;) const loading = ref(false) const remoteOptions = ref([]) const options = [ { value: \u0026#39;1\u0026#39;, label: \u0026#39;é€‰é¡¹ä¸€\u0026#39; }, { value: \u0026#39;2\u0026#39;, label: \u0026#39;é€‰é¡¹äºŒ\u0026#39; }, { value: \u0026#39;3\u0026#39;, label: \u0026#39;é€‰é¡¹ä¸‰\u0026#39; }, ] const remoteMethod = async (query: string) =\u0026gt; { if (query) { loading.value = true // æ¨¡æ‹Ÿè¿œç¨‹è¯·æ±‚ setTimeout(() =\u0026gt; { remoteOptions.value = options.filter(item =\u0026gt; item.label.includes(query) ) loading.value = false }, 200) } } \u0026lt;/script\u0026gt; ä¸‰ã€è¡¨å• 3.1 åŸºç¡€è¡¨å• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 \u0026lt;template\u0026gt; \u0026lt;el-form ref=\u0026#34;formRef\u0026#34; :model=\u0026#34;form\u0026#34; :rules=\u0026#34;rules\u0026#34; label-width=\u0026#34;100px\u0026#34; label-position=\u0026#34;right\u0026#34; \u0026gt; \u0026lt;el-form-item label=\u0026#34;ç”¨æˆ·å\u0026#34; prop=\u0026#34;username\u0026#34;\u0026gt; \u0026lt;el-input v-model=\u0026#34;form.username\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥ç”¨æˆ·å\u0026#34; /\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item label=\u0026#34;é‚®ç®±\u0026#34; prop=\u0026#34;email\u0026#34;\u0026gt; \u0026lt;el-input v-model=\u0026#34;form.email\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥é‚®ç®±\u0026#34; /\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item label=\u0026#34;å¯†ç \u0026#34; prop=\u0026#34;password\u0026#34;\u0026gt; \u0026lt;el-input v-model=\u0026#34;form.password\u0026#34; type=\u0026#34;password\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥å¯†ç \u0026#34; show-password /\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item label=\u0026#34;æ€§åˆ«\u0026#34; prop=\u0026#34;gender\u0026#34;\u0026gt; \u0026lt;el-radio-group v-model=\u0026#34;form.gender\u0026#34;\u0026gt; \u0026lt;el-radio label=\u0026#34;male\u0026#34;\u0026gt;ç”·\u0026lt;/el-radio\u0026gt; \u0026lt;el-radio label=\u0026#34;female\u0026#34;\u0026gt;å¥³\u0026lt;/el-radio\u0026gt; \u0026lt;/el-radio-group\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item label=\u0026#34;çˆ±å¥½\u0026#34; prop=\u0026#34;hobbies\u0026#34;\u0026gt; \u0026lt;el-checkbox-group v-model=\u0026#34;form.hobbies\u0026#34;\u0026gt; \u0026lt;el-checkbox label=\u0026#34;reading\u0026#34;\u0026gt;é˜…è¯»\u0026lt;/el-checkbox\u0026gt; \u0026lt;el-checkbox label=\u0026#34;music\u0026#34;\u0026gt;éŸ³ä¹\u0026lt;/el-checkbox\u0026gt; \u0026lt;el-checkbox label=\u0026#34;sports\u0026#34;\u0026gt;è¿åŠ¨\u0026lt;/el-checkbox\u0026gt; \u0026lt;/el-checkbox-group\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item label=\u0026#34;åŸå¸‚\u0026#34; prop=\u0026#34;city\u0026#34;\u0026gt; \u0026lt;el-select v-model=\u0026#34;form.city\u0026#34; placeholder=\u0026#34;è¯·é€‰æ‹©åŸå¸‚\u0026#34;\u0026gt; \u0026lt;el-option label=\u0026#34;åŒ—äº¬\u0026#34; value=\u0026#34;beijing\u0026#34; /\u0026gt; \u0026lt;el-option label=\u0026#34;ä¸Šæµ·\u0026#34; value=\u0026#34;shanghai\u0026#34; /\u0026gt; \u0026lt;el-option label=\u0026#34;å¹¿å·\u0026#34; value=\u0026#34;guangzhou\u0026#34; /\u0026gt; \u0026lt;/el-select\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item label=\u0026#34;æ—¥æœŸ\u0026#34; prop=\u0026#34;date\u0026#34;\u0026gt; \u0026lt;el-date-picker v-model=\u0026#34;form.date\u0026#34; type=\u0026#34;date\u0026#34; placeholder=\u0026#34;é€‰æ‹©æ—¥æœŸ\u0026#34; /\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item label=\u0026#34;å¤‡æ³¨\u0026#34; prop=\u0026#34;remark\u0026#34;\u0026gt; \u0026lt;el-input v-model=\u0026#34;form.remark\u0026#34; type=\u0026#34;textarea\u0026#34; :rows=\u0026#34;3\u0026#34; placeholder=\u0026#34;è¯·è¾“å…¥å¤‡æ³¨\u0026#34; /\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item\u0026gt; \u0026lt;el-button type=\u0026#34;primary\u0026#34; @click=\u0026#34;submitForm\u0026#34;\u0026gt;æäº¤\u0026lt;/el-button\u0026gt; \u0026lt;el-button @click=\u0026#34;resetForm\u0026#34;\u0026gt;é‡ç½®\u0026lt;/el-button\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;/el-form\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, reactive } from \u0026#39;vue\u0026#39; import type { FormInstance, FormRules } from \u0026#39;element-plus\u0026#39; const formRef = ref\u0026lt;FormInstance\u0026gt;() const form = reactive({ username: \u0026#39;\u0026#39;, email: \u0026#39;\u0026#39;, password: \u0026#39;\u0026#39;, gender: \u0026#39;\u0026#39;, hobbies: [], city: \u0026#39;\u0026#39;, date: \u0026#39;\u0026#39;, remark: \u0026#39;\u0026#39;, }) const rules: FormRules = { username: [ { required: true, message: \u0026#39;è¯·è¾“å…¥ç”¨æˆ·å\u0026#39;, trigger: \u0026#39;blur\u0026#39; }, { min: 3, max: 20, message: \u0026#39;é•¿åº¦åœ¨ 3 åˆ° 20 ä¸ªå­—ç¬¦\u0026#39;, trigger: \u0026#39;blur\u0026#39; }, ], email: [ { required: true, message: \u0026#39;è¯·è¾“å…¥é‚®ç®±\u0026#39;, trigger: \u0026#39;blur\u0026#39; }, { type: \u0026#39;email\u0026#39;, message: \u0026#39;è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€\u0026#39;, trigger: \u0026#39;blur\u0026#39; }, ], password: [ { required: true, message: \u0026#39;è¯·è¾“å…¥å¯†ç \u0026#39;, trigger: \u0026#39;blur\u0026#39; }, { min: 6, message: \u0026#39;å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½\u0026#39;, trigger: \u0026#39;blur\u0026#39; }, ], gender: [ { required: true, message: \u0026#39;è¯·é€‰æ‹©æ€§åˆ«\u0026#39;, trigger: \u0026#39;change\u0026#39; }, ], hobbies: [ { type: \u0026#39;array\u0026#39;, required: true, message: \u0026#39;è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªçˆ±å¥½\u0026#39;, trigger: \u0026#39;change\u0026#39; }, ], city: [ { required: true, message: \u0026#39;è¯·é€‰æ‹©åŸå¸‚\u0026#39;, trigger: \u0026#39;change\u0026#39; }, ], } const submitForm = async () =\u0026gt; { if (!formRef.value) return await formRef.value.validate((valid) =\u0026gt; { if (valid) { console.log(\u0026#39;è¡¨å•æ•°æ®:\u0026#39;, form) // æäº¤è¡¨å• } }) } const resetForm = () =\u0026gt; { formRef.value?.resetFields() } \u0026lt;/script\u0026gt; 3.2 è‡ªå®šä¹‰éªŒè¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import type { FormRules } from \u0026#39;element-plus\u0026#39; // è‡ªå®šä¹‰éªŒè¯å™¨ const validateUsername = (rule: any, value: string, callback: any) =\u0026gt; { if (!value) { callback(new Error(\u0026#39;è¯·è¾“å…¥ç”¨æˆ·å\u0026#39;)) } else if (!/^[a-zA-Z][a-zA-Z0-9_]{2,19}$/.test(value)) { callback(new Error(\u0026#39;ç”¨æˆ·åå¿…é¡»ä»¥å­—æ¯å¼€å¤´ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿\u0026#39;)) } else { callback() } } const validatePassword = (rule: any, value: string, callback: any) =\u0026gt; { if (!value) { callback(new Error(\u0026#39;è¯·è¾“å…¥å¯†ç \u0026#39;)) } else if (value.length \u0026lt; 6) { callback(new Error(\u0026#39;å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½\u0026#39;)) } else if (!/[A-Z]/.test(value)) { callback(new Error(\u0026#39;å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯\u0026#39;)) } else if (!/[a-z]/.test(value)) { callback(new Error(\u0026#39;å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯\u0026#39;)) } else if (!/[0-9]/.test(value)) { callback(new Error(\u0026#39;å¯†ç å¿…é¡»åŒ…å«æ•°å­—\u0026#39;)) } else { callback() } } const rules: FormRules = { username: [ { validator: validateUsername, trigger: \u0026#39;blur\u0026#39; }, ], password: [ { validator: validatePassword, trigger: \u0026#39;blur\u0026#39; }, ], } \u0026lt;/script\u0026gt; å››ã€è¡¨æ ¼ 4.1 åŸºç¡€è¡¨æ ¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 \u0026lt;template\u0026gt; \u0026lt;el-table :data=\u0026#34;tableData\u0026#34; stripe border style=\u0026#34;width: 100%\u0026#34;\u0026gt; \u0026lt;el-table-column prop=\u0026#34;date\u0026#34; label=\u0026#34;æ—¥æœŸ\u0026#34; width=\u0026#34;180\u0026#34; /\u0026gt; \u0026lt;el-table-column prop=\u0026#34;name\u0026#34; label=\u0026#34;å§“å\u0026#34; width=\u0026#34;180\u0026#34; /\u0026gt; \u0026lt;el-table-column prop=\u0026#34;address\u0026#34; label=\u0026#34;åœ°å€\u0026#34; /\u0026gt; \u0026lt;el-table-column label=\u0026#34;æ“ä½œ\u0026#34; width=\u0026#34;200\u0026#34;\u0026gt; \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; \u0026lt;el-button size=\u0026#34;small\u0026#34; @click=\u0026#34;handleEdit(row)\u0026#34;\u0026gt;ç¼–è¾‘\u0026lt;/el-button\u0026gt; \u0026lt;el-button size=\u0026#34;small\u0026#34; type=\u0026#34;danger\u0026#34; @click=\u0026#34;handleDelete(row)\u0026#34;\u0026gt; åˆ é™¤ \u0026lt;/el-button\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/el-table-column\u0026gt; \u0026lt;/el-table\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; const tableData = [ { date: \u0026#39;2024-01-01\u0026#39;, name: \u0026#39;å¼ ä¸‰\u0026#39;, address: \u0026#39;åŒ—äº¬å¸‚æœé˜³åŒº\u0026#39; }, { date: \u0026#39;2024-01-02\u0026#39;, name: \u0026#39;æå››\u0026#39;, address: \u0026#39;ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº\u0026#39; }, { date: \u0026#39;2024-01-03\u0026#39;, name: \u0026#39;ç‹äº”\u0026#39;, address: \u0026#39;å¹¿å·å¸‚å¤©æ²³åŒº\u0026#39; }, ] const handleEdit = (row: any) =\u0026gt; { console.log(\u0026#39;ç¼–è¾‘\u0026#39;, row) } const handleDelete = (row: any) =\u0026gt; { console.log(\u0026#39;åˆ é™¤\u0026#39;, row) } \u0026lt;/script\u0026gt; 4.2 é«˜çº§è¡¨æ ¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;table-container\u0026#34;\u0026gt; \u0026lt;!-- å·¥å…·æ  --\u0026gt; \u0026lt;div class=\u0026#34;toolbar\u0026#34;\u0026gt; \u0026lt;el-input v-model=\u0026#34;searchKeyword\u0026#34; placeholder=\u0026#34;æœç´¢\u0026#34; :prefix-icon=\u0026#34;Search\u0026#34; clearable style=\u0026#34;width: 200px\u0026#34; /\u0026gt; \u0026lt;el-button type=\u0026#34;primary\u0026#34; :icon=\u0026#34;Plus\u0026#34; @click=\u0026#34;handleAdd\u0026#34;\u0026gt; æ–°å¢ \u0026lt;/el-button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;!-- è¡¨æ ¼ --\u0026gt; \u0026lt;el-table v-loading=\u0026#34;loading\u0026#34; :data=\u0026#34;filteredData\u0026#34; stripe border @selection-change=\u0026#34;handleSelectionChange\u0026#34; @sort-change=\u0026#34;handleSortChange\u0026#34; \u0026gt; \u0026lt;el-table-column type=\u0026#34;selection\u0026#34; width=\u0026#34;50\u0026#34; /\u0026gt; \u0026lt;el-table-column type=\u0026#34;index\u0026#34; label=\u0026#34;#\u0026#34; width=\u0026#34;50\u0026#34; /\u0026gt; \u0026lt;el-table-column prop=\u0026#34;name\u0026#34; label=\u0026#34;å§“å\u0026#34; sortable /\u0026gt; \u0026lt;el-table-column prop=\u0026#34;age\u0026#34; label=\u0026#34;å¹´é¾„\u0026#34; sortable width=\u0026#34;100\u0026#34; /\u0026gt; \u0026lt;el-table-column prop=\u0026#34;email\u0026#34; label=\u0026#34;é‚®ç®±\u0026#34; show-overflow-tooltip /\u0026gt; \u0026lt;el-table-column prop=\u0026#34;status\u0026#34; label=\u0026#34;çŠ¶æ€\u0026#34; width=\u0026#34;100\u0026#34;\u0026gt; \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; \u0026lt;el-tag :type=\u0026#34;row.status === 1 ? \u0026#39;success\u0026#39; : \u0026#39;danger\u0026#39;\u0026#34;\u0026gt; {{ row.status === 1 ? \u0026#39;å¯ç”¨\u0026#39; : \u0026#39;ç¦ç”¨\u0026#39; }} \u0026lt;/el-tag\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/el-table-column\u0026gt; \u0026lt;el-table-column label=\u0026#34;æ“ä½œ\u0026#34; width=\u0026#34;200\u0026#34; fixed=\u0026#34;right\u0026#34;\u0026gt; \u0026lt;template #default=\u0026#34;{ row }\u0026#34;\u0026gt; \u0026lt;el-button link type=\u0026#34;primary\u0026#34; @click=\u0026#34;handleEdit(row)\u0026#34;\u0026gt; ç¼–è¾‘ \u0026lt;/el-button\u0026gt; \u0026lt;el-popconfirm title=\u0026#34;ç¡®å®šåˆ é™¤å—ï¼Ÿ\u0026#34; @confirm=\u0026#34;handleDelete(row)\u0026#34; \u0026gt; \u0026lt;template #reference\u0026gt; \u0026lt;el-button link type=\u0026#34;danger\u0026#34;\u0026gt;åˆ é™¤\u0026lt;/el-button\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/el-popconfirm\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/el-table-column\u0026gt; \u0026lt;/el-table\u0026gt; \u0026lt;!-- åˆ†é¡µ --\u0026gt; \u0026lt;el-pagination v-model:current-page=\u0026#34;pagination.page\u0026#34; v-model:page-size=\u0026#34;pagination.pageSize\u0026#34; :page-sizes=\u0026#34;[10, 20, 50, 100]\u0026#34; :total=\u0026#34;pagination.total\u0026#34; layout=\u0026#34;total, sizes, prev, pager, next, jumper\u0026#34; @size-change=\u0026#34;handleSizeChange\u0026#34; @current-change=\u0026#34;handlePageChange\u0026#34; /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, reactive, computed } from \u0026#39;vue\u0026#39; import { Search, Plus } from \u0026#39;@element-plus/icons-vue\u0026#39; interface User { id: number name: string age: number email: string status: number } const loading = ref(false) const searchKeyword = ref(\u0026#39;\u0026#39;) const selectedRows = ref\u0026lt;User[]\u0026gt;([]) const tableData = ref\u0026lt;User[]\u0026gt;([ { id: 1, name: \u0026#39;å¼ ä¸‰\u0026#39;, age: 25, email: \u0026#39;zhangsan@example.com\u0026#39;, status: 1 }, { id: 2, name: \u0026#39;æå››\u0026#39;, age: 30, email: \u0026#39;lisi@example.com\u0026#39;, status: 1 }, { id: 3, name: \u0026#39;ç‹äº”\u0026#39;, age: 28, email: \u0026#39;wangwu@example.com\u0026#39;, status: 0 }, ]) const pagination = reactive({ page: 1, pageSize: 10, total: 100, }) const filteredData = computed(() =\u0026gt; { if (!searchKeyword.value) return tableData.value return tableData.value.filter(item =\u0026gt; item.name.includes(searchKeyword.value) || item.email.includes(searchKeyword.value) ) }) const handleSelectionChange = (rows: User[]) =\u0026gt; { selectedRows.value = rows } const handleSortChange = ({ prop, order }: any) =\u0026gt; { console.log(\u0026#39;æ’åº:\u0026#39;, prop, order) } const handleAdd = () =\u0026gt; { console.log(\u0026#39;æ–°å¢\u0026#39;) } const handleEdit = (row: User) =\u0026gt; { console.log(\u0026#39;ç¼–è¾‘\u0026#39;, row) } const handleDelete = (row: User) =\u0026gt; { console.log(\u0026#39;åˆ é™¤\u0026#39;, row) } const handleSizeChange = (size: number) =\u0026gt; { pagination.pageSize = size // é‡æ–°åŠ è½½æ•°æ® } const handlePageChange = (page: number) =\u0026gt; { pagination.page = page // é‡æ–°åŠ è½½æ•°æ® } \u0026lt;/script\u0026gt; äº”ã€å¼¹çª—ä¸é€šçŸ¥ 5.1 å¯¹è¯æ¡† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 \u0026lt;template\u0026gt; \u0026lt;el-button @click=\u0026#34;dialogVisible = true\u0026#34;\u0026gt;æ‰“å¼€å¯¹è¯æ¡†\u0026lt;/el-button\u0026gt; \u0026lt;el-dialog v-model=\u0026#34;dialogVisible\u0026#34; title=\u0026#34;ç”¨æˆ·ç¼–è¾‘\u0026#34; width=\u0026#34;500px\u0026#34; :close-on-click-modal=\u0026#34;false\u0026#34; @close=\u0026#34;handleClose\u0026#34; \u0026gt; \u0026lt;el-form ref=\u0026#34;formRef\u0026#34; :model=\u0026#34;form\u0026#34; :rules=\u0026#34;rules\u0026#34; label-width=\u0026#34;80px\u0026#34;\u0026gt; \u0026lt;el-form-item label=\u0026#34;ç”¨æˆ·å\u0026#34; prop=\u0026#34;username\u0026#34;\u0026gt; \u0026lt;el-input v-model=\u0026#34;form.username\u0026#34; /\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;el-form-item label=\u0026#34;é‚®ç®±\u0026#34; prop=\u0026#34;email\u0026#34;\u0026gt; \u0026lt;el-input v-model=\u0026#34;form.email\u0026#34; /\u0026gt; \u0026lt;/el-form-item\u0026gt; \u0026lt;/el-form\u0026gt; \u0026lt;template #footer\u0026gt; \u0026lt;el-button @click=\u0026#34;dialogVisible = false\u0026#34;\u0026gt;å–æ¶ˆ\u0026lt;/el-button\u0026gt; \u0026lt;el-button type=\u0026#34;primary\u0026#34; :loading=\u0026#34;submitLoading\u0026#34; @click=\u0026#34;handleSubmit\u0026#34;\u0026gt; ç¡®å®š \u0026lt;/el-button\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;/el-dialog\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, reactive } from \u0026#39;vue\u0026#39; import type { FormInstance, FormRules } from \u0026#39;element-plus\u0026#39; const dialogVisible = ref(false) const submitLoading = ref(false) const formRef = ref\u0026lt;FormInstance\u0026gt;() const form = reactive({ username: \u0026#39;\u0026#39;, email: \u0026#39;\u0026#39;, }) const rules: FormRules = { username: [{ required: true, message: \u0026#39;è¯·è¾“å…¥ç”¨æˆ·å\u0026#39;, trigger: \u0026#39;blur\u0026#39; }], email: [{ required: true, message: \u0026#39;è¯·è¾“å…¥é‚®ç®±\u0026#39;, trigger: \u0026#39;blur\u0026#39; }], } const handleSubmit = async () =\u0026gt; { if (!formRef.value) return await formRef.value.validate(async (valid) =\u0026gt; { if (valid) { submitLoading.value = true try { // æäº¤æ•°æ® await new Promise(resolve =\u0026gt; setTimeout(resolve, 1000)) dialogVisible.value = false } finally { submitLoading.value = false } } }) } const handleClose = () =\u0026gt; { formRef.value?.resetFields() } \u0026lt;/script\u0026gt; 5.2 æ¶ˆæ¯ä¸é€šçŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ElMessage, ElMessageBox, ElNotification } from \u0026#39;element-plus\u0026#39; // æ¶ˆæ¯æç¤º const showMessage = () =\u0026gt; { ElMessage.success(\u0026#39;æ“ä½œæˆåŠŸ\u0026#39;) ElMessage.warning(\u0026#39;è­¦å‘Šä¿¡æ¯\u0026#39;) ElMessage.error(\u0026#39;é”™è¯¯ä¿¡æ¯\u0026#39;) ElMessage.info(\u0026#39;æç¤ºä¿¡æ¯\u0026#39;) } // ç¡®è®¤æ¡† const showConfirm = async () =\u0026gt; { try { await ElMessageBox.confirm(\u0026#39;ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ\u0026#39;, \u0026#39;æç¤º\u0026#39;, { confirmButtonText: \u0026#39;ç¡®å®š\u0026#39;, cancelButtonText: \u0026#39;å–æ¶ˆ\u0026#39;, type: \u0026#39;warning\u0026#39;, }) ElMessage.success(\u0026#39;åˆ é™¤æˆåŠŸ\u0026#39;) } catch { ElMessage.info(\u0026#39;å·²å–æ¶ˆ\u0026#39;) } } // è¾“å…¥æ¡† const showPrompt = async () =\u0026gt; { try { const { value } = await ElMessageBox.prompt(\u0026#39;è¯·è¾“å…¥åç§°\u0026#39;, \u0026#39;æç¤º\u0026#39;, { confirmButtonText: \u0026#39;ç¡®å®š\u0026#39;, cancelButtonText: \u0026#39;å–æ¶ˆ\u0026#39;, inputPattern: /^.{1,20}$/, inputErrorMessage: \u0026#39;åç§°é•¿åº¦åœ¨ 1 åˆ° 20 ä¸ªå­—ç¬¦\u0026#39;, }) ElMessage.success(`è¾“å…¥çš„å†…å®¹æ˜¯: ${value}`) } catch { ElMessage.info(\u0026#39;å·²å–æ¶ˆ\u0026#39;) } } // é€šçŸ¥ const showNotification = () =\u0026gt; { ElNotification({ title: \u0026#39;æ ‡é¢˜\u0026#39;, message: \u0026#39;è¿™æ˜¯ä¸€æ¡é€šçŸ¥æ¶ˆæ¯\u0026#39;, type: \u0026#39;success\u0026#39;, duration: 3000, }) } \u0026lt;/script\u0026gt; å…­ã€ä¸»é¢˜å®šåˆ¶ 6.1 CSS å˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // styles/element.scss :root { // ä¸»é¢˜è‰² --el-color-primary: #409eff; --el-color-success: #67c23a; --el-color-warning: #e6a23c; --el-color-danger: #f56c6c; --el-color-info: #909399; // æ–‡å­—é¢œè‰² --el-text-color-primary: #303133; --el-text-color-regular: #606266; --el-text-color-secondary: #909399; // è¾¹æ¡†é¢œè‰² --el-border-color: #dcdfe6; --el-border-color-light: #e4e7ed; // èƒŒæ™¯è‰² --el-bg-color: #ffffff; --el-bg-color-page: #f2f3f5; // åœ†è§’ --el-border-radius-base: 4px; --el-border-radius-small: 2px; --el-border-radius-round: 20px; } // æš—é»‘æ¨¡å¼ html.dark { --el-color-primary: #409eff; --el-bg-color: #141414; --el-bg-color-page: #0a0a0a; --el-text-color-primary: rgba(255, 255, 255, 0.85); } 6.2 SCSS å˜é‡è¦†ç›– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // styles/element-variables.scss @forward \u0026#39;element-plus/theme-chalk/src/common/var.scss\u0026#39; with ( $colors: ( \u0026#39;primary\u0026#39;: ( \u0026#39;base\u0026#39;: #1890ff, ), \u0026#39;success\u0026#39;: ( \u0026#39;base\u0026#39;: #52c41a, ), \u0026#39;warning\u0026#39;: ( \u0026#39;base\u0026#39;: #faad14, ), \u0026#39;danger\u0026#39;: ( \u0026#39;base\u0026#39;: #ff4d4f, ), ), $font-size: ( \u0026#39;extra-large\u0026#39;: 20px, \u0026#39;large\u0026#39;: 18px, \u0026#39;medium\u0026#39;: 16px, \u0026#39;base\u0026#39;: 14px, \u0026#39;small\u0026#39;: 13px, \u0026#39;extra-small\u0026#39;: 12px, ), ); @use \u0026#39;element-plus/theme-chalk/src/index.scss\u0026#39; as *; 1 2 3 4 5 6 7 8 9 10 // vite.config.ts export default defineConfig({ css: { preprocessorOptions: { scss: { additionalData: `@use \u0026#34;@/styles/element-variables.scss\u0026#34; as *;`, }, }, }, }) ä¸ƒã€å›½é™…åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // main.ts import { createApp } from \u0026#39;vue\u0026#39; import ElementPlus from \u0026#39;element-plus\u0026#39; import zhCn from \u0026#39;element-plus/dist/locale/zh-cn.mjs\u0026#39; import en from \u0026#39;element-plus/dist/locale/en.mjs\u0026#39; const app = createApp(App) // ä½¿ç”¨ä¸­æ–‡ app.use(ElementPlus, { locale: zhCn, }) // åŠ¨æ€åˆ‡æ¢è¯­è¨€ import { ref } from \u0026#39;vue\u0026#39; import { ElConfigProvider } from \u0026#39;element-plus\u0026#39; const locale = ref(zhCn) const changeLocale = (lang: string) =\u0026gt; { locale.value = lang === \u0026#39;zh\u0026#39; ? zhCn : en } 1 2 3 4 5 \u0026lt;template\u0026gt; \u0026lt;el-config-provider :locale=\u0026#34;locale\u0026#34;\u0026gt; \u0026lt;App /\u0026gt; \u0026lt;/el-config-provider\u0026gt; \u0026lt;/template\u0026gt; å…«ã€æœ€ä½³å®è·µ 8.1 è¡¨æ ¼å°è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 \u0026lt;!-- components/ProTable.vue --\u0026gt; \u0026lt;template\u0026gt; \u0026lt;div class=\u0026#34;pro-table\u0026#34;\u0026gt; \u0026lt;el-table v-loading=\u0026#34;loading\u0026#34; :data=\u0026#34;data\u0026#34; v-bind=\u0026#34;$attrs\u0026#34; \u0026gt; \u0026lt;slot /\u0026gt; \u0026lt;/el-table\u0026gt; \u0026lt;el-pagination v-if=\u0026#34;pagination\u0026#34; v-model:current-page=\u0026#34;currentPage\u0026#34; v-model:page-size=\u0026#34;pageSize\u0026#34; :total=\u0026#34;total\u0026#34; :page-sizes=\u0026#34;[10, 20, 50, 100]\u0026#34; layout=\u0026#34;total, sizes, prev, pager, next\u0026#34; @size-change=\u0026#34;handleSizeChange\u0026#34; @current-change=\u0026#34;handlePageChange\u0026#34; /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { ref, watch } from \u0026#39;vue\u0026#39; interface Props { data: any[] loading?: boolean pagination?: boolean total?: number page?: number size?: number } const props = withDefaults(defineProps\u0026lt;Props\u0026gt;(), { loading: false, pagination: true, total: 0, page: 1, size: 10, }) const emit = defineEmits\u0026lt;{ (e: \u0026#39;update:page\u0026#39;, value: number): void (e: \u0026#39;update:size\u0026#39;, value: number): void (e: \u0026#39;page-change\u0026#39;, page: number, size: number): void }\u0026gt;() const currentPage = ref(props.page) const pageSize = ref(props.size) watch(() =\u0026gt; props.page, (val) =\u0026gt; { currentPage.value = val }) const handleSizeChange = (size: number) =\u0026gt; { emit(\u0026#39;update:size\u0026#39;, size) emit(\u0026#39;page-change\u0026#39;, currentPage.value, size) } const handlePageChange = (page: number) =\u0026gt; { emit(\u0026#39;update:page\u0026#39;, page) emit(\u0026#39;page-change\u0026#39;, page, pageSize.value) } \u0026lt;/script\u0026gt; æ€»ç»“ Element Plus æä¾›äº†ä¸°å¯Œçš„ä¼ä¸šçº§ UI ç»„ä»¶ï¼Œæ˜¯æ„å»º Vue 3 ä¸­åå°åº”ç”¨çš„é¦–é€‰ç»„ä»¶åº“ã€‚\næ ¸å¿ƒä¼˜åŠ¿ï¼š\nğŸ“¦ ä¸°å¯Œçš„ç»„ä»¶åº“ ğŸ¨ çµæ´»çš„ä¸»é¢˜å®šåˆ¶ ğŸŒ å®Œå–„çš„å›½é™…åŒ–æ”¯æŒ ğŸ“ è¯¦å°½çš„æ–‡æ¡£å’Œç¤ºä¾‹ âš¡ è‰¯å¥½çš„ TypeScript æ”¯æŒ Incoming (Background Agent changes)\n","date":"2025-05-28T00:00:00Z","permalink":"https://zpf-zero.github.io/p/element-plus-guide/","title":"Element Plus å®æˆ˜æŒ‡å—ï¼šVue 3 ä¼ä¸šçº§ UI ç»„ä»¶åº“"},{"content":"å‰è¨€ Jaeger æ˜¯ Uber å¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œåæèµ ç»™ CNCFã€‚å®ƒç”¨äºç›‘æ§å’Œæ’æŸ¥åŸºäºå¾®æœåŠ¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£æœåŠ¡é—´çš„ä¾èµ–å…³ç³»ã€å®šä½æ€§èƒ½ç“¶é¢ˆã€‚\nä¸€ã€æ¶æ„æ¦‚è¿° 1.1 æ ¸å¿ƒç»„ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 Client (Instrumentation) | v Jaeger Agent (UDP/HTTP) | v Jaeger Collector | v Storage (Cassandra/Elasticsearch/Kafka) | v Jaeger Query / UI 1.2 éƒ¨ç½²æ¨¡å¼ All-in-Oneï¼šå•èŠ‚ç‚¹éƒ¨ç½²ï¼Œé€‚åˆå¼€å‘æµ‹è¯• Productionï¼šåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå„ç»„ä»¶ç‹¬ç«‹æ‰©å±• äºŒã€å¿«é€Ÿéƒ¨ç½² 2.1 All-in-One 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # docker-compose.yml version: \u0026#39;3.8\u0026#39; services: jaeger: image: jaegertracing/all-in-one:latest ports: - \u0026#34;6831:6831/udp\u0026#34; # Thrift compact - \u0026#34;6832:6832/udp\u0026#34; # Thrift binary - \u0026#34;5778:5778\u0026#34; # Config - \u0026#34;16686:16686\u0026#34; # UI - \u0026#34;4317:4317\u0026#34; # OTLP gRPC - \u0026#34;4318:4318\u0026#34; # OTLP HTTP - \u0026#34;14250:14250\u0026#34; # gRPC - \u0026#34;14268:14268\u0026#34; # HTTP environment: - COLLECTOR_OTLP_ENABLED=true 2.2 ç”Ÿäº§éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 version: \u0026#39;3.8\u0026#39; services: elasticsearch: image: elasticsearch:7.17.9 environment: - discovery.type=single-node - ES_JAVA_OPTS=-Xms512m -Xmx512m volumes: - es_data:/usr/share/elasticsearch/data jaeger-collector: image: jaegertracing/jaeger-collector:latest environment: - SPAN_STORAGE_TYPE=elasticsearch - ES_SERVER_URLS=http://elasticsearch:9200 ports: - \u0026#34;14250:14250\u0026#34; - \u0026#34;14268:14268\u0026#34; - \u0026#34;4317:4317\u0026#34; jaeger-query: image: jaegertracing/jaeger-query:latest environment: - SPAN_STORAGE_TYPE=elasticsearch - ES_SERVER_URLS=http://elasticsearch:9200 ports: - \u0026#34;16686:16686\u0026#34; volumes: es_data: ä¸‰ã€Go åº”ç”¨é›†æˆ 3.1 ä½¿ç”¨ OpenTelemetry 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package tracing import ( \u0026#34;context\u0026#34; \u0026#34;go.opentelemetry.io/otel\u0026#34; \u0026#34;go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc\u0026#34; \u0026#34;go.opentelemetry.io/otel/propagation\u0026#34; \u0026#34;go.opentelemetry.io/otel/sdk/resource\u0026#34; sdktrace \u0026#34;go.opentelemetry.io/otel/sdk/trace\u0026#34; semconv \u0026#34;go.opentelemetry.io/otel/semconv/v1.17.0\u0026#34; ) func InitJaeger(serviceName, endpoint string) (*sdktrace.TracerProvider, error) { ctx := context.Background() exporter, err := otlptracegrpc.New(ctx, otlptracegrpc.WithEndpoint(endpoint), otlptracegrpc.WithInsecure(), ) if err != nil { return nil, err } res := resource.NewWithAttributes( semconv.SchemaURL, semconv.ServiceName(serviceName), semconv.ServiceVersion(\u0026#34;1.0.0\u0026#34;), semconv.DeploymentEnvironment(\u0026#34;production\u0026#34;), ) tp := sdktrace.NewTracerProvider( sdktrace.WithBatcher(exporter), sdktrace.WithResource(res), sdktrace.WithSampler(sdktrace.ParentBased( sdktrace.TraceIDRatioBased(0.1), // 10% é‡‡æ · )), ) otel.SetTracerProvider(tp) otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator( propagation.TraceContext{}, propagation.Baggage{}, )) return tp, nil } 3.2 HTTP æœåŠ¡è¿½è¸ª 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 package main import ( \u0026#34;github.com/gin-gonic/gin\u0026#34; \u0026#34;go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin\u0026#34; \u0026#34;go.opentelemetry.io/otel\u0026#34; \u0026#34;go.opentelemetry.io/otel/attribute\u0026#34; ) var tracer = otel.Tracer(\u0026#34;order-service\u0026#34;) func main() { tp, _ := tracing.InitJaeger(\u0026#34;order-service\u0026#34;, \u0026#34;jaeger:4317\u0026#34;) defer tp.Shutdown(context.Background()) r := gin.New() r.Use(otelgin.Middleware(\u0026#34;order-service\u0026#34;)) r.POST(\u0026#34;/orders\u0026#34;, CreateOrder) r.Run(\u0026#34;:8080\u0026#34;) } func CreateOrder(c *gin.Context) { ctx := c.Request.Context() // åˆ›å»ºè®¢å• Span ctx, span := tracer.Start(ctx, \u0026#34;create-order\u0026#34;) defer span.End() var order Order c.ShouldBindJSON(\u0026amp;order) span.SetAttributes( attribute.String(\u0026#34;order.customer_id\u0026#34;, order.CustomerID), attribute.Float64(\u0026#34;order.amount\u0026#34;, order.Amount), ) // éªŒè¯åº“å­˜ if err := checkInventory(ctx, order.Items); err != nil { span.RecordError(err) c.JSON(400, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } // åˆ›å»ºæ”¯ä»˜ if err := processPayment(ctx, order); err != nil { span.RecordError(err) c.JSON(500, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } c.JSON(201, order) } func checkInventory(ctx context.Context, items []Item) error { ctx, span := tracer.Start(ctx, \u0026#34;check-inventory\u0026#34;) defer span.End() span.SetAttributes(attribute.Int(\u0026#34;items.count\u0026#34;, len(items))) // è°ƒç”¨åº“å­˜æœåŠ¡ return inventoryClient.Check(ctx, items) } func processPayment(ctx context.Context, order Order) error { ctx, span := tracer.Start(ctx, \u0026#34;process-payment\u0026#34;) defer span.End() span.AddEvent(\u0026#34;payment-started\u0026#34;) // è°ƒç”¨æ”¯ä»˜æœåŠ¡ result, err := paymentClient.Process(ctx, order) if err == nil { span.AddEvent(\u0026#34;payment-completed\u0026#34;, trace.WithAttributes( attribute.String(\u0026#34;transaction_id\u0026#34;, result.TransactionID), ), ) } return err } 3.3 gRPC è¿½è¸ª 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import ( \u0026#34;go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc\u0026#34; \u0026#34;google.golang.org/grpc\u0026#34; ) // å®¢æˆ·ç«¯ conn, err := grpc.Dial(address, grpc.WithUnaryInterceptor(otelgrpc.UnaryClientInterceptor()), grpc.WithStreamInterceptor(otelgrpc.StreamClientInterceptor()), ) // æœåŠ¡ç«¯ server := grpc.NewServer( grpc.UnaryInterceptor(otelgrpc.UnaryServerInterceptor()), grpc.StreamInterceptor(otelgrpc.StreamServerInterceptor()), ) å››ã€æ•°æ®åº“è¿½è¸ª 4.1 GORM è¿½è¸ª 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import ( \u0026#34;gorm.io/driver/mysql\u0026#34; \u0026#34;gorm.io/gorm\u0026#34; \u0026#34;gorm.io/plugin/opentelemetry/tracing\u0026#34; ) func InitDB() (*gorm.DB, error) { db, err := gorm.Open(mysql.Open(dsn), \u0026amp;gorm.Config{}) if err != nil { return nil, err } // æ·»åŠ è¿½è¸ªæ’ä»¶ if err := db.Use(tracing.NewPlugin()); err != nil { return nil, err } return db, nil } 4.2 Redis è¿½è¸ª 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import ( \u0026#34;github.com/redis/go-redis/extra/redisotel/v9\u0026#34; \u0026#34;github.com/redis/go-redis/v9\u0026#34; ) func InitRedis() *redis.Client { rdb := redis.NewClient(\u0026amp;redis.Options{ Addr: \u0026#34;localhost:6379\u0026#34;, }) // æ·»åŠ è¿½è¸ª if err := redisotel.InstrumentTracing(rdb); err != nil { panic(err) } return rdb } äº”ã€è¿½è¸ªåˆ†æ 5.1 UI åŠŸèƒ½ æœç´¢è¿½è¸ªï¼šæŒ‰æœåŠ¡ã€æ“ä½œã€æ—¶é—´èŒƒå›´ç­›é€‰ è¿½è¸ªè¯¦æƒ…ï¼šæŸ¥çœ‹ Span å±‚çº§å…³ç³»å’Œæ—¶é—´çº¿ æ¯”è¾ƒè¿½è¸ªï¼šå¯¹æ¯”ä¸åŒè¿½è¸ªçš„å·®å¼‚ ä¾èµ–å›¾ï¼šå¯è§†åŒ–æœåŠ¡é—´è°ƒç”¨å…³ç³» 5.2 API æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 # æœç´¢è¿½è¸ª curl \u0026#34;http://jaeger:16686/api/traces?service=order-service\u0026amp;limit=20\u0026#34; # è·å–è¿½è¸ªè¯¦æƒ… curl \u0026#34;http://jaeger:16686/api/traces/{traceID}\u0026#34; # è·å–æœåŠ¡åˆ—è¡¨ curl \u0026#34;http://jaeger:16686/api/services\u0026#34; # è·å–æ“ä½œåˆ—è¡¨ curl \u0026#34;http://jaeger:16686/api/services/{service}/operations\u0026#34; å…­ã€æ€§èƒ½ä¼˜åŒ– 6.1 é‡‡æ ·é…ç½® 1 2 3 4 5 6 // è‡ªé€‚åº”é‡‡æ · sampler := sdktrace.ParentBased( sdktrace.TraceIDRatioBased(0.01), // 1% é‡‡æ · sdktrace.WithLocalParentSampled(sdktrace.AlwaysSample()), sdktrace.WithRemoteParentSampled(sdktrace.AlwaysSample()), ) 6.2 æ‰¹é‡å¯¼å‡º 1 2 3 4 5 6 7 8 9 10 11 exporter, _ := otlptracegrpc.New(ctx, otlptracegrpc.WithEndpoint(endpoint), ) tp := sdktrace.NewTracerProvider( sdktrace.WithBatcher(exporter, sdktrace.WithMaxExportBatchSize(512), sdktrace.WithBatchTimeout(5*time.Second), sdktrace.WithMaxQueueSize(2048), ), ) æ€»ç»“ Jaeger æ˜¯æˆç†Ÿçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œå¸®åŠ©ç†è§£å¾®æœåŠ¡æ¶æ„ä¸­çš„è¯·æ±‚æµç¨‹å’Œæ€§èƒ½ç“¶é¢ˆã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ” å®Œæ•´çš„è¯·æ±‚é“¾è·¯è¿½è¸ª ğŸ“Š ç›´è§‚çš„ UI å¯è§†åŒ– ğŸ”Œ OpenTelemetry é›†æˆ ğŸ“ˆ çµæ´»çš„é‡‡æ ·ç­–ç•¥ ğŸ—„ï¸ å¤šç§å­˜å‚¨åç«¯æ”¯æŒ ","date":"2025-04-11T00:00:00Z","permalink":"https://zpf-zero.github.io/p/jaeger-guide/","title":"Jaeger å®æˆ˜æŒ‡å—ï¼šåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ"},{"content":"å‰è¨€ JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ä½œä¸º JSON å¯¹è±¡ã€‚JWT å¸¸ç”¨äºèº«ä»½è®¤è¯å’Œä¿¡æ¯äº¤æ¢ï¼Œæ˜¯ç°ä»£ Web åº”ç”¨ä¸­æœ€æµè¡Œçš„è®¤è¯æ–¹æ¡ˆä¹‹ä¸€ã€‚\nä¸€ã€JWT åŸºç¡€ 1.1 JWT ç»“æ„ JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä½¿ç”¨ . åˆ†éš”ï¼š\n1 Header.Payload.Signature 1 2 3 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9. eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkFsaWNlIiwiaWF0IjoxNTE2MjM5MDIyfQ. SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c Headerï¼ˆå¤´éƒ¨ï¼‰ï¼š\n1 2 3 4 { \u0026#34;alg\u0026#34;: \u0026#34;HS256\u0026#34;, \u0026#34;typ\u0026#34;: \u0026#34;JWT\u0026#34; } Payloadï¼ˆè½½è·ï¼‰ï¼š\n1 2 3 4 5 6 { \u0026#34;sub\u0026#34;: \u0026#34;1234567890\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;iat\u0026#34;: 1516239022, \u0026#34;exp\u0026#34;: 1516242622 } Signatureï¼ˆç­¾åï¼‰ï¼š\n1 2 3 4 HMACSHA256( base64UrlEncode(header) + \u0026#34;.\u0026#34; + base64UrlEncode(payload), secret ) 1.2 æ ‡å‡†å£°æ˜ å£°æ˜ è¯´æ˜ iss ç­¾å‘è€… sub ä¸»é¢˜ï¼ˆé€šå¸¸æ˜¯ç”¨æˆ·IDï¼‰ aud æ¥æ”¶æ–¹ exp è¿‡æœŸæ—¶é—´ nbf ç”Ÿæ•ˆæ—¶é—´ iat ç­¾å‘æ—¶é—´ jti JWT IDï¼Œå”¯ä¸€æ ‡è¯† äºŒã€Go å®ç° JWT 2.1 å®‰è£…ä¾èµ– 1 go get -u github.com/golang-jwt/jwt/v5 2.2 å®šä¹‰ Claims 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package auth import ( \u0026#34;github.com/golang-jwt/jwt/v5\u0026#34; \u0026#34;time\u0026#34; ) // è‡ªå®šä¹‰ Claims type CustomClaims struct { UserID int64 `json:\u0026#34;user_id\u0026#34;` Username string `json:\u0026#34;username\u0026#34;` Role string `json:\u0026#34;role\u0026#34;` jwt.RegisteredClaims } // JWT é…ç½® type JWTConfig struct { SecretKey string AccessExpire time.Duration RefreshExpire time.Duration Issuer string } var config = JWTConfig{ SecretKey: \u0026#34;your-secret-key-at-least-32-characters\u0026#34;, AccessExpire: 2 * time.Hour, RefreshExpire: 7 * 24 * time.Hour, Issuer: \u0026#34;my-app\u0026#34;, } 2.3 ç”Ÿæˆ Token 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 // ç”Ÿæˆ Access Token func GenerateAccessToken(userID int64, username, role string) (string, error) { claims := CustomClaims{ UserID: userID, Username: username, Role: role, RegisteredClaims: jwt.RegisteredClaims{ ExpiresAt: jwt.NewNumericDate(time.Now().Add(config.AccessExpire)), IssuedAt: jwt.NewNumericDate(time.Now()), NotBefore: jwt.NewNumericDate(time.Now()), Issuer: config.Issuer, Subject: fmt.Sprintf(\u0026#34;%d\u0026#34;, userID), }, } token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims) return token.SignedString([]byte(config.SecretKey)) } // ç”Ÿæˆ Refresh Token func GenerateRefreshToken(userID int64) (string, error) { claims := jwt.RegisteredClaims{ ExpiresAt: jwt.NewNumericDate(time.Now().Add(config.RefreshExpire)), IssuedAt: jwt.NewNumericDate(time.Now()), Issuer: config.Issuer, Subject: fmt.Sprintf(\u0026#34;%d\u0026#34;, userID), } token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims) return token.SignedString([]byte(config.SecretKey)) } // ç”Ÿæˆ Token å¯¹ func GenerateTokenPair(userID int64, username, role string) (accessToken, refreshToken string, err error) { accessToken, err = GenerateAccessToken(userID, username, role) if err != nil { return \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, err } refreshToken, err = GenerateRefreshToken(userID) if err != nil { return \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, err } return accessToken, refreshToken, nil } 2.4 éªŒè¯ Token 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 // è§£æå¹¶éªŒè¯ Token func ParseToken(tokenString string) (*CustomClaims, error) { token, err := jwt.ParseWithClaims(tokenString, \u0026amp;CustomClaims{}, func(token *jwt.Token) (interface{}, error) { // éªŒè¯ç­¾åç®—æ³• if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, fmt.Errorf(\u0026#34;unexpected signing method: %v\u0026#34;, token.Header[\u0026#34;alg\u0026#34;]) } return []byte(config.SecretKey), nil }) if err != nil { return nil, err } if claims, ok := token.Claims.(*CustomClaims); ok \u0026amp;\u0026amp; token.Valid { return claims, nil } return nil, errors.New(\u0026#34;invalid token\u0026#34;) } // éªŒè¯ Refresh Token func ParseRefreshToken(tokenString string) (*jwt.RegisteredClaims, error) { token, err := jwt.ParseWithClaims(tokenString, \u0026amp;jwt.RegisteredClaims{}, func(token *jwt.Token) (interface{}, error) { if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, fmt.Errorf(\u0026#34;unexpected signing method: %v\u0026#34;, token.Header[\u0026#34;alg\u0026#34;]) } return []byte(config.SecretKey), nil }) if err != nil { return nil, err } if claims, ok := token.Claims.(*jwt.RegisteredClaims); ok \u0026amp;\u0026amp; token.Valid { return claims, nil } return nil, errors.New(\u0026#34;invalid refresh token\u0026#34;) } ä¸‰ã€Gin ä¸­é—´ä»¶ 3.1 JWT è®¤è¯ä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 package middleware import ( \u0026#34;strings\u0026#34; \u0026#34;github.com/gin-gonic/gin\u0026#34; ) func JWTAuth() gin.HandlerFunc { return func(c *gin.Context) { // è·å– Authorization Header authHeader := c.GetHeader(\u0026#34;Authorization\u0026#34;) if authHeader == \u0026#34;\u0026#34; { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;authorization header required\u0026#34;}) c.Abort() return } // æ£€æŸ¥ Bearer å‰ç¼€ parts := strings.SplitN(authHeader, \u0026#34; \u0026#34;, 2) if len(parts) != 2 || parts[0] != \u0026#34;Bearer\u0026#34; { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;invalid authorization header format\u0026#34;}) c.Abort() return } // è§£æ Token claims, err := auth.ParseToken(parts[1]) if err != nil { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;invalid or expired token\u0026#34;}) c.Abort() return } // å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ä¸Šä¸‹æ–‡ c.Set(\u0026#34;userID\u0026#34;, claims.UserID) c.Set(\u0026#34;username\u0026#34;, claims.Username) c.Set(\u0026#34;role\u0026#34;, claims.Role) c.Set(\u0026#34;claims\u0026#34;, claims) c.Next() } } // è§’è‰²éªŒè¯ä¸­é—´ä»¶ func RequireRole(roles ...string) gin.HandlerFunc { return func(c *gin.Context) { role, exists := c.Get(\u0026#34;role\u0026#34;) if !exists { c.JSON(403, gin.H{\u0026#34;error\u0026#34;: \u0026#34;role not found\u0026#34;}) c.Abort() return } userRole := role.(string) for _, r := range roles { if userRole == r { c.Next() return } } c.JSON(403, gin.H{\u0026#34;error\u0026#34;: \u0026#34;insufficient permissions\u0026#34;}) c.Abort() } } 3.2 è·¯ç”±é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func SetupRouter() *gin.Engine { r := gin.Default() // å…¬å¼€è·¯ç”± public := r.Group(\u0026#34;/api/v1\u0026#34;) { public.POST(\u0026#34;/login\u0026#34;, LoginHandler) public.POST(\u0026#34;/register\u0026#34;, RegisterHandler) public.POST(\u0026#34;/refresh\u0026#34;, RefreshTokenHandler) } // éœ€è¦è®¤è¯çš„è·¯ç”± protected := r.Group(\u0026#34;/api/v1\u0026#34;) protected.Use(middleware.JWTAuth()) { protected.GET(\u0026#34;/profile\u0026#34;, GetProfileHandler) protected.PUT(\u0026#34;/profile\u0026#34;, UpdateProfileHandler) } // ç®¡ç†å‘˜è·¯ç”± admin := r.Group(\u0026#34;/api/v1/admin\u0026#34;) admin.Use(middleware.JWTAuth(), middleware.RequireRole(\u0026#34;admin\u0026#34;)) { admin.GET(\u0026#34;/users\u0026#34;, ListUsersHandler) admin.DELETE(\u0026#34;/users/:id\u0026#34;, DeleteUserHandler) } return r } å››ã€ç™»å½•ä¸åˆ·æ–° 4.1 ç™»å½•å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 type LoginRequest struct { Username string `json:\u0026#34;username\u0026#34; binding:\u0026#34;required\u0026#34;` Password string `json:\u0026#34;password\u0026#34; binding:\u0026#34;required\u0026#34;` } type LoginResponse struct { AccessToken string `json:\u0026#34;access_token\u0026#34;` RefreshToken string `json:\u0026#34;refresh_token\u0026#34;` ExpiresIn int64 `json:\u0026#34;expires_in\u0026#34;` TokenType string `json:\u0026#34;token_type\u0026#34;` } func LoginHandler(c *gin.Context) { var req LoginRequest if err := c.ShouldBindJSON(\u0026amp;req); err != nil { c.JSON(400, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } // éªŒè¯ç”¨æˆ· user, err := userService.ValidateUser(req.Username, req.Password) if err != nil { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;invalid credentials\u0026#34;}) return } // ç”Ÿæˆ Token accessToken, refreshToken, err := auth.GenerateTokenPair(user.ID, user.Username, user.Role) if err != nil { c.JSON(500, gin.H{\u0026#34;error\u0026#34;: \u0026#34;failed to generate token\u0026#34;}) return } // å°† Refresh Token å­˜å…¥ Redisï¼ˆå¯é€‰ï¼Œç”¨äºæ³¨é”€ï¼‰ rdb.Set(c, fmt.Sprintf(\u0026#34;refresh_token:%d\u0026#34;, user.ID), refreshToken, 7*24*time.Hour) c.JSON(200, LoginResponse{ AccessToken: accessToken, RefreshToken: refreshToken, ExpiresIn: int64(config.AccessExpire.Seconds()), TokenType: \u0026#34;Bearer\u0026#34;, }) } 4.2 Token åˆ·æ–° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 type RefreshRequest struct { RefreshToken string `json:\u0026#34;refresh_token\u0026#34; binding:\u0026#34;required\u0026#34;` } func RefreshTokenHandler(c *gin.Context) { var req RefreshRequest if err := c.ShouldBindJSON(\u0026amp;req); err != nil { c.JSON(400, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } // è§£æ Refresh Token claims, err := auth.ParseRefreshToken(req.RefreshToken) if err != nil { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;invalid refresh token\u0026#34;}) return } userID, _ := strconv.ParseInt(claims.Subject, 10, 64) // éªŒè¯ Refresh Token æ˜¯å¦åœ¨ Redis ä¸­ï¼ˆå¯é€‰ï¼‰ storedToken, err := rdb.Get(c, fmt.Sprintf(\u0026#34;refresh_token:%d\u0026#34;, userID)).Result() if err != nil || storedToken != req.RefreshToken { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;refresh token revoked\u0026#34;}) return } // è·å–ç”¨æˆ·ä¿¡æ¯ user, err := userService.GetByID(userID) if err != nil { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;user not found\u0026#34;}) return } // ç”Ÿæˆæ–°çš„ Token å¯¹ accessToken, refreshToken, err := auth.GenerateTokenPair(user.ID, user.Username, user.Role) if err != nil { c.JSON(500, gin.H{\u0026#34;error\u0026#34;: \u0026#34;failed to generate token\u0026#34;}) return } // æ›´æ–° Redis ä¸­çš„ Refresh Token rdb.Set(c, fmt.Sprintf(\u0026#34;refresh_token:%d\u0026#34;, user.ID), refreshToken, 7*24*time.Hour) c.JSON(200, LoginResponse{ AccessToken: accessToken, RefreshToken: refreshToken, ExpiresIn: int64(config.AccessExpire.Seconds()), TokenType: \u0026#34;Bearer\u0026#34;, }) } 4.3 ç™»å‡ºå¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 func LogoutHandler(c *gin.Context) { userID, _ := c.Get(\u0026#34;userID\u0026#34;) // åˆ é™¤ Redis ä¸­çš„ Refresh Token rdb.Del(c, fmt.Sprintf(\u0026#34;refresh_token:%d\u0026#34;, userID)) // å¯é€‰ï¼šå°†å½“å‰ Access Token åŠ å…¥é»‘åå• token := c.GetHeader(\u0026#34;Authorization\u0026#34;) if parts := strings.SplitN(token, \u0026#34; \u0026#34;, 2); len(parts) == 2 { claims, _ := auth.ParseToken(parts[1]) if claims != nil { // è®¡ç®— Token å‰©ä½™æœ‰æ•ˆæœŸ remaining := time.Until(claims.ExpiresAt.Time) if remaining \u0026gt; 0 { rdb.Set(c, fmt.Sprintf(\u0026#34;token_blacklist:%s\u0026#34;, parts[1]), \u0026#34;1\u0026#34;, remaining) } } } c.JSON(200, gin.H{\u0026#34;message\u0026#34;: \u0026#34;logged out successfully\u0026#34;}) } // åœ¨ JWTAuth ä¸­é—´ä»¶ä¸­æ·»åŠ é»‘åå•æ£€æŸ¥ func JWTAuth() gin.HandlerFunc { return func(c *gin.Context) { // ... è·å– token ... // æ£€æŸ¥é»‘åå• if _, err := rdb.Get(c, fmt.Sprintf(\u0026#34;token_blacklist:%s\u0026#34;, parts[1])).Result(); err == nil { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;token has been revoked\u0026#34;}) c.Abort() return } // ... ç»§ç»­éªŒè¯ ... } } äº”ã€å®‰å…¨æœ€ä½³å®è·µ 5.1 å¯†é’¥ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 // ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å¯†é’¥ func LoadConfig() *JWTConfig { secretKey := os.Getenv(\u0026#34;JWT_SECRET_KEY\u0026#34;) if secretKey == \u0026#34;\u0026#34; { log.Fatal(\u0026#34;JWT_SECRET_KEY environment variable is required\u0026#34;) } return \u0026amp;JWTConfig{ SecretKey: secretKey, AccessExpire: parseDuration(os.Getenv(\u0026#34;JWT_ACCESS_EXPIRE\u0026#34;), 2*time.Hour), RefreshExpire: parseDuration(os.Getenv(\u0026#34;JWT_REFRESH_EXPIRE\u0026#34;), 7*24*time.Hour), Issuer: os.Getenv(\u0026#34;JWT_ISSUER\u0026#34;), } } // ä½¿ç”¨ RS256 éå¯¹ç§°åŠ å¯†ï¼ˆæ›´å®‰å…¨ï¼‰ func GenerateTokenWithRS256(claims jwt.Claims) (string, error) { privateKey, err := jwt.ParseRSAPrivateKeyFromPEM(privateKeyPEM) if err != nil { return \u0026#34;\u0026#34;, err } token := jwt.NewWithClaims(jwt.SigningMethodRS256, claims) return token.SignedString(privateKey) } func ParseTokenWithRS256(tokenString string) (*CustomClaims, error) { publicKey, err := jwt.ParseRSAPublicKeyFromPEM(publicKeyPEM) if err != nil { return nil, err } token, err := jwt.ParseWithClaims(tokenString, \u0026amp;CustomClaims{}, func(token *jwt.Token) (interface{}, error) { if _, ok := token.Method.(*jwt.SigningMethodRSA); !ok { return nil, fmt.Errorf(\u0026#34;unexpected signing method: %v\u0026#34;, token.Header[\u0026#34;alg\u0026#34;]) } return publicKey, nil }) if err != nil { return nil, err } if claims, ok := token.Claims.(*CustomClaims); ok \u0026amp;\u0026amp; token.Valid { return claims, nil } return nil, errors.New(\u0026#34;invalid token\u0026#34;) } 5.2 Token å®‰å…¨å­˜å‚¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // å‰ç«¯å®‰å…¨å­˜å‚¨å»ºè®® // 1. Access Token å­˜å‚¨åœ¨å†…å­˜ä¸­ let accessToken = null; // 2. Refresh Token å­˜å‚¨åœ¨ HttpOnly Cookie ä¸­ // åç«¯è®¾ç½®ï¼š // c.SetCookie(\u0026#34;refresh_token\u0026#34;, refreshToken, 7*24*3600, \u0026#34;/\u0026#34;, \u0026#34;\u0026#34;, true, true) // 3. ä½¿ç”¨ axios æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ  Token axios.interceptors.request.use(config =\u0026gt; { if (accessToken) { config.headers.Authorization = `Bearer ${accessToken}`; } return config; }); // 4. è‡ªåŠ¨åˆ·æ–° Token axios.interceptors.response.use( response =\u0026gt; response, async error =\u0026gt; { if (error.response.status === 401) { try { const { data } = await axios.post(\u0026#39;/api/v1/refresh\u0026#39;); accessToken = data.access_token; error.config.headers.Authorization = `Bearer ${accessToken}`; return axios(error.config); } catch (e) { // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ window.location.href = \u0026#39;/login\u0026#39;; } } return Promise.reject(error); } ); 5.3 é˜²æ­¢å¸¸è§æ”»å‡» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // 1. è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ AccessExpire: 15 * time.Minute // Access Token çŸ­æœŸæœ‰æ•ˆ RefreshExpire: 7 * 24 * time.Hour // Refresh Token é•¿æœŸæœ‰æ•ˆ // 2. æ·»åŠ  jtiï¼ˆJWT IDï¼‰é˜²æ­¢é‡æ”¾æ”»å‡» claims := CustomClaims{ RegisteredClaims: jwt.RegisteredClaims{ ID: uuid.New().String(), // å”¯ä¸€ ID // ... }, } // 3. éªŒè¯ audienceï¼ˆæ¥æ”¶æ–¹ï¼‰ claims := CustomClaims{ RegisteredClaims: jwt.RegisteredClaims{ Audience: jwt.ClaimStrings{\u0026#34;web\u0026#34;, \u0026#34;mobile\u0026#34;}, // å…è®¸çš„å®¢æˆ·ç«¯ // ... }, } // 4. IP ç»‘å®šï¼ˆå¯é€‰ï¼Œå½±å“ä½“éªŒï¼‰ type CustomClaims struct { IP string `json:\u0026#34;ip\u0026#34;` // ... } // éªŒè¯æ—¶æ£€æŸ¥ IP if claims.IP != c.ClientIP() { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;token ip mismatch\u0026#34;}) c.Abort() return } å…­ã€å®Œæ•´ç¤ºä¾‹ 6.1 é¡¹ç›®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 jwt-demo/ â”œâ”€â”€ cmd/ â”‚ â””â”€â”€ main.go â”œâ”€â”€ internal/ â”‚ â”œâ”€â”€ auth/ â”‚ â”‚ â””â”€â”€ jwt.go â”‚ â”œâ”€â”€ handler/ â”‚ â”‚ â””â”€â”€ auth.go â”‚ â”œâ”€â”€ middleware/ â”‚ â”‚ â””â”€â”€ jwt.go â”‚ â”œâ”€â”€ model/ â”‚ â”‚ â””â”€â”€ user.go â”‚ â””â”€â”€ service/ â”‚ â””â”€â”€ user.go â”œâ”€â”€ pkg/ â”‚ â””â”€â”€ response/ â”‚ â””â”€â”€ response.go â”œâ”€â”€ configs/ â”‚ â””â”€â”€ config.yaml â”œâ”€â”€ go.mod â””â”€â”€ go.sum 6.2 å®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 // internal/auth/jwt.go package auth import ( \u0026#34;errors\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;time\u0026#34; \u0026#34;github.com/golang-jwt/jwt/v5\u0026#34; ) type CustomClaims struct { UserID int64 `json:\u0026#34;user_id\u0026#34;` Username string `json:\u0026#34;username\u0026#34;` Role string `json:\u0026#34;role\u0026#34;` jwt.RegisteredClaims } var ( secretKey = os.Getenv(\u0026#34;JWT_SECRET_KEY\u0026#34;) accessExpire = 2 * time.Hour refreshExpire = 7 * 24 * time.Hour ) func GenerateTokenPair(userID int64, username, role string) (string, string, error) { // Access Token accessClaims := CustomClaims{ UserID: userID, Username: username, Role: role, RegisteredClaims: jwt.RegisteredClaims{ ExpiresAt: jwt.NewNumericDate(time.Now().Add(accessExpire)), IssuedAt: jwt.NewNumericDate(time.Now()), Issuer: \u0026#34;my-app\u0026#34;, Subject: fmt.Sprintf(\u0026#34;%d\u0026#34;, userID), }, } accessToken := jwt.NewWithClaims(jwt.SigningMethodHS256, accessClaims) accessTokenString, err := accessToken.SignedString([]byte(secretKey)) if err != nil { return \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, err } // Refresh Token refreshClaims := jwt.RegisteredClaims{ ExpiresAt: jwt.NewNumericDate(time.Now().Add(refreshExpire)), IssuedAt: jwt.NewNumericDate(time.Now()), Issuer: \u0026#34;my-app\u0026#34;, Subject: fmt.Sprintf(\u0026#34;%d\u0026#34;, userID), } refreshToken := jwt.NewWithClaims(jwt.SigningMethodHS256, refreshClaims) refreshTokenString, err := refreshToken.SignedString([]byte(secretKey)) if err != nil { return \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, err } return accessTokenString, refreshTokenString, nil } func ParseToken(tokenString string) (*CustomClaims, error) { token, err := jwt.ParseWithClaims(tokenString, \u0026amp;CustomClaims{}, func(token *jwt.Token) (interface{}, error) { return []byte(secretKey), nil }) if err != nil { return nil, err } if claims, ok := token.Claims.(*CustomClaims); ok \u0026amp;\u0026amp; token.Valid { return claims, nil } return nil, errors.New(\u0026#34;invalid token\u0026#34;) } æ€»ç»“ JWT æ˜¯ç°ä»£ Web åº”ç”¨ä¸­æœ€æµè¡Œçš„èº«ä»½è®¤è¯æ–¹æ¡ˆï¼Œå…·æœ‰æ— çŠ¶æ€ã€å¯æ‰©å±•çš„ä¼˜ç‚¹ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ” ç†è§£ JWT ç»“æ„å’ŒåŸç† â° åˆç†è®¾ç½® Token æœ‰æ•ˆæœŸ ğŸ”„ å®ç° Token åˆ·æ–°æœºåˆ¶ ğŸ›¡ï¸ æ³¨é‡å®‰å…¨æœ€ä½³å®è·µ ğŸš€ ç»“åˆ Redis å®ç° Token ç®¡ç† ","date":"2025-03-03T00:00:00Z","permalink":"https://zpf-zero.github.io/p/jwt-guide/","title":"JWT å®æˆ˜æŒ‡å—ï¼šGo è¯­è¨€èº«ä»½è®¤è¯æœ€ä½³å®è·µ"},{"content":"å‰è¨€ Fluent Bit æ˜¯ CNCF æ¯•ä¸šé¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½çš„æ—¥å¿—å¤„ç†å™¨å’Œè½¬å‘å™¨ã€‚å®ƒä¸“ä¸ºäº‘åŸç”Ÿç¯å¢ƒè®¾è®¡ï¼Œèµ„æºå ç”¨æä½ï¼Œéå¸¸é€‚åˆåœ¨å®¹å™¨å’Œ Kubernetes ç¯å¢ƒä¸­ä½¿ç”¨ã€‚\nä¸€ã€æ¶æ„æ¦‚è¿° 1.1 å¤„ç†æµç¨‹ 1 2 3 Input -\u0026gt; Parser -\u0026gt; Filter -\u0026gt; Buffer -\u0026gt; Output | | +-- æ—¥å¿—æº +-- ç›®æ ‡å­˜å‚¨ 1.2 æ ¸å¿ƒç‰¹æ€§ è½»é‡çº§ï¼šå†…å­˜å ç”¨çº¦ 450KB é«˜æ€§èƒ½ï¼šæ¯ç§’å¤„ç†æ•°åä¸‡æ¡æ—¥å¿— å¤šè¾“å…¥è¾“å‡ºï¼šæ”¯æŒ 70+ æ’ä»¶ æµå¼å¤„ç†ï¼šå®æ—¶å¤„ç†æ—¥å¿— äºŒã€å¿«é€Ÿéƒ¨ç½² 2.1 Docker éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 # docker-compose.yml version: \u0026#39;3.8\u0026#39; services: fluent-bit: image: fluent/fluent-bit:latest volumes: - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf - ./parsers.conf:/fluent-bit/etc/parsers.conf - /var/log:/var/log:ro ports: - \u0026#34;24224:24224\u0026#34; 2.2 åŸºç¡€é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # fluent-bit.conf [SERVICE] Flush 1 Log_Level info Parsers_File parsers.conf HTTP_Server On HTTP_Listen 0.0.0.0 HTTP_Port 2020 [INPUT] Name tail Path /var/log/app/*.log Parser json Tag app.* Refresh_Interval 5 [OUTPUT] Name stdout Match * ä¸‰ã€è¾“å…¥é…ç½® 3.1 æ–‡ä»¶è¾“å…¥ 1 2 3 4 5 6 7 8 9 10 [INPUT] Name tail Path /var/log/app/*.log Path_Key filename Tag app.logs Parser json DB /var/log/flb_app.db Mem_Buf_Limit 5MB Skip_Long_Lines On Refresh_Interval 10 3.2 Docker æ—¥å¿— 1 2 3 4 5 6 7 [INPUT] Name forward Listen 0.0.0.0 Port 24224 # Docker é…ç½® # docker run --log-driver=fluentd --log-opt fluentd-address=localhost:24224 myapp 3.3 Kubernetes æ—¥å¿— 1 2 3 4 5 6 7 8 9 [INPUT] Name tail Tag kube.* Path /var/log/containers/*.log Parser docker DB /var/log/flb_kube.db Mem_Buf_Limit 5MB Skip_Long_Lines On Refresh_Interval 10 3.4 ç³»ç»Ÿæ—¥å¿— 1 2 3 4 5 6 [INPUT] Name systemd Tag host.* Systemd_Filter _SYSTEMD_UNIT=docker.service Systemd_Filter _SYSTEMD_UNIT=kubelet.service Read_From_Tail On å››ã€è§£æå™¨é…ç½® 4.1 JSON è§£æ 1 2 3 4 5 6 7 # parsers.conf [PARSER] Name json Format json Time_Key time Time_Format %Y-%m-%dT%H:%M:%S.%L Time_Keep On 4.2 æ­£åˆ™è§£æ 1 2 3 4 5 6 7 8 9 10 11 12 13 [PARSER] Name nginx Format regex Regex ^(?\u0026lt;remote\u0026gt;[^ ]*) (?\u0026lt;host\u0026gt;[^ ]*) (?\u0026lt;user\u0026gt;[^ ]*) \\[(?\u0026lt;time\u0026gt;[^\\]]*)\\] \u0026#34;(?\u0026lt;method\u0026gt;\\S+)(?: +(?\u0026lt;path\u0026gt;[^\\\u0026#34;]*?)(?: +\\S*)?)?\u0026#34; (?\u0026lt;code\u0026gt;[^ ]*) (?\u0026lt;size\u0026gt;[^ ]*)(?: \u0026#34;(?\u0026lt;referer\u0026gt;[^\\\u0026#34;]*)\u0026#34; \u0026#34;(?\u0026lt;agent\u0026gt;[^\\\u0026#34;]*)\u0026#34;)?$ Time_Key time Time_Format %d/%b/%Y:%H:%M:%S %z [PARSER] Name syslog Format regex Regex ^\\\u0026lt;(?\u0026lt;pri\u0026gt;[0-9]+)\\\u0026gt;(?\u0026lt;time\u0026gt;[^ ]* {1,2}[^ ]* [^ ]*) (?\u0026lt;host\u0026gt;[^ ]*) (?\u0026lt;ident\u0026gt;[a-zA-Z0-9_\\/\\.\\-]*)(?:\\[(?\u0026lt;pid\u0026gt;[0-9]+)\\])?(?:[^\\:]*\\:)? *(?\u0026lt;message\u0026gt;.*)$ Time_Key time Time_Format %b %d %H:%M:%S 4.3 Go åº”ç”¨æ—¥å¿— 1 2 3 4 5 6 [PARSER] Name go_app Format regex Regex ^(?\u0026lt;level\u0026gt;[A-Z]+)\\s+\\[(?\u0026lt;time\u0026gt;[^\\]]+)\\]\\s+(?\u0026lt;message\u0026gt;.*)$ Time_Key time Time_Format %Y-%m-%d %H:%M:%S.%L äº”ã€è¿‡æ»¤å™¨é…ç½® 5.1 Kubernetes å…ƒæ•°æ® 1 2 3 4 5 6 7 8 9 10 11 [FILTER] Name kubernetes Match kube.* Kube_URL https://kubernetes.default.svc:443 Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token Kube_Tag_Prefix kube.var.log.containers. Merge_Log On Keep_Log Off K8S-Logging.Parser On K8S-Logging.Exclude On 5.2 å­—æ®µä¿®æ”¹ 1 2 3 4 5 6 7 [FILTER] Name modify Match * Add env production Add cluster main Rename message log Remove kubernetes.labels.app.kubernetes.io/managed-by 5.3 è®°å½•ä¿®æ”¹ 1 2 3 4 5 [FILTER] Name record_modifier Match * Record hostname ${HOSTNAME} Record service_name my-app 5.4 Lua è„šæœ¬ 1 2 3 4 5 [FILTER] Name lua Match * Script filter.lua Call add_timestamp 1 2 3 4 5 6 -- filter.lua function add_timestamp(tag, timestamp, record) new_record = record new_record[\u0026#34;processed_at\u0026#34;] = os.date(\u0026#34;!%Y-%m-%dT%H:%M:%SZ\u0026#34;) return 1, timestamp, new_record end 5.5 æ—¥å¿—è¿‡æ»¤ 1 2 3 4 5 6 7 8 9 10 11 # æ’é™¤å¥åº·æ£€æŸ¥æ—¥å¿— [FILTER] Name grep Match app.* Exclude path /health # åªä¿ç•™é”™è¯¯æ—¥å¿— [FILTER] Name grep Match app.* Regex level (ERROR|FATAL) å…­ã€è¾“å‡ºé…ç½® 6.1 Elasticsearch 1 2 3 4 5 6 7 8 9 10 11 12 13 14 [OUTPUT] Name es Match * Host elasticsearch Port 9200 Index logs Type _doc Logstash_Format On Logstash_Prefix app-logs Time_Key @timestamp Include_Tag_Key On Tag_Key tag Buffer_Size 5MB Retry_Limit False 6.2 Kafka 1 2 3 4 5 6 7 8 [OUTPUT] Name kafka Match * Brokers kafka:9092 Topics logs Timestamp_Key @timestamp Retry_Limit False rdkafka.batch.num.messages 1000 6.3 Prometheus 1 2 3 4 5 [OUTPUT] Name prometheus_exporter Match * Host 0.0.0.0 Port 2021 6.4 HTTP è¾“å‡º 1 2 3 4 5 6 7 8 9 [OUTPUT] Name http Match * Host logserver.example.com Port 8080 URI /logs Format json Header Content-Type application/json Header Authorization Bearer ${LOG_TOKEN} 6.5 å¤šè¾“å‡º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªç›®æ ‡ [OUTPUT] Name es Match * Host elasticsearch Port 9200 [OUTPUT] Name kafka Match error.* Brokers kafka:9092 Topics error-logs [OUTPUT] Name stdout Match * ä¸ƒã€Kubernetes éƒ¨ç½² 7.1 DaemonSet 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 apiVersion: apps/v1 kind: DaemonSet metadata: name: fluent-bit namespace: logging spec: selector: matchLabels: app: fluent-bit template: metadata: labels: app: fluent-bit spec: serviceAccountName: fluent-bit containers: - name: fluent-bit image: fluent/fluent-bit:latest volumeMounts: - name: varlog mountPath: /var/log - name: config mountPath: /fluent-bit/etc/ resources: limits: memory: 100Mi requests: cpu: 100m memory: 50Mi volumes: - name: varlog hostPath: path: /var/log - name: config configMap: name: fluent-bit-config 7.2 ConfigMap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 apiVersion: v1 kind: ConfigMap metadata: name: fluent-bit-config namespace: logging data: fluent-bit.conf: | [SERVICE] Flush 1 Log_Level info Parsers_File parsers.conf [INPUT] Name tail Tag kube.* Path /var/log/containers/*.log Parser docker DB /var/log/flb_kube.db Mem_Buf_Limit 5MB [FILTER] Name kubernetes Match kube.* Merge_Log On Keep_Log Off [OUTPUT] Name es Match * Host ${FLUENT_ELASTICSEARCH_HOST} Port ${FLUENT_ELASTICSEARCH_PORT} Logstash_Format On å…«ã€ç›‘æ§ä¸è°ƒè¯• 8.1 å†…ç½®ç›‘æ§ 1 2 3 4 [SERVICE] HTTP_Server On HTTP_Listen 0.0.0.0 HTTP_Port 2020 1 2 3 4 5 6 7 8 # å¥åº·æ£€æŸ¥ curl http://localhost:2020/api/v1/health # æŒ‡æ ‡ curl http://localhost:2020/api/v1/metrics # ä¸Šæ¸¸çŠ¶æ€ curl http://localhost:2020/api/v1/uptime 8.2 è°ƒè¯•è¾“å‡º 1 2 3 4 [OUTPUT] Name stdout Match * Format json_lines æ€»ç»“ Fluent Bit æ˜¯äº‘åŸç”Ÿæ—¥å¿—æ”¶é›†çš„ç†æƒ³é€‰æ‹©ï¼Œå…·æœ‰æä½çš„èµ„æºå ç”¨å’Œå¼ºå¤§çš„å¤„ç†èƒ½åŠ›ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸª¶ è¶…è½»é‡çº§è®¾è®¡ âš¡ é«˜æ€§èƒ½å¤„ç† ğŸ”Œ ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ â˜¸ï¸ äº‘åŸç”Ÿå‹å¥½ ğŸ”§ çµæ´»çš„é…ç½®é€‰é¡¹ Incoming (Background Agent changes)\n","date":"2025-01-25T00:00:00Z","permalink":"https://zpf-zero.github.io/p/fluentbit-guide/","title":"Fluent Bit å®æˆ˜æŒ‡å—ï¼šè½»é‡çº§æ—¥å¿—æ”¶é›†å™¨"},{"content":"å‰è¨€ Apache Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼Œå…·æœ‰é«˜ååé‡ã€ä½å»¶è¿Ÿã€é«˜å¯é æ€§ç­‰ç‰¹ç‚¹ã€‚å®ƒå¹¿æ³›åº”ç”¨äºæ—¥å¿—æ”¶é›†ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æµå¤„ç†ç­‰åœºæ™¯ã€‚\nä¸€ã€æ ¸å¿ƒæ¦‚å¿µ 1.1 æ¶æ„ç»„ä»¶ 1 2 3 Producer -\u0026gt; Broker Cluster -\u0026gt; Consumer Group | Zookeeper (å…ƒæ•°æ®ç®¡ç†) Producerï¼šæ¶ˆæ¯ç”Ÿäº§è€… Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€… Brokerï¼šKafka æœåŠ¡èŠ‚ç‚¹ Topicï¼šæ¶ˆæ¯ä¸»é¢˜ Partitionï¼šåˆ†åŒºï¼Œå®ç°å¹¶è¡Œå¤„ç† Consumer Groupï¼šæ¶ˆè´¹è€…ç»„ï¼Œå®ç°è´Ÿè½½å‡è¡¡ 1.2 æ¶ˆæ¯å­˜å‚¨ 1 2 3 4 5 6 7 Topic: orders â”œâ”€â”€ Partition 0 â”‚ â”œâ”€â”€ Segment 0 (offset 0-999) â”‚ â”œâ”€â”€ Segment 1 (offset 1000-1999) â”‚ â””â”€â”€ ... â”œâ”€â”€ Partition 1 â””â”€â”€ Partition 2 äºŒã€å¿«é€Ÿéƒ¨ç½² 2.1 Docker Compose 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 version: \u0026#39;3.8\u0026#39; services: zookeeper: image: confluentinc/cp-zookeeper:latest environment: ZOOKEEPER_CLIENT_PORT: 2181 ZOOKEEPER_TICK_TIME: 2000 kafka: image: confluentinc/cp-kafka:latest depends_on: - zookeeper ports: - \u0026#34;9092:9092\u0026#34; environment: KAFKA_BROKER_ID: 1 KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092 KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 KAFKA_AUTO_CREATE_TOPICS_ENABLE: \u0026#34;true\u0026#34; kafka-ui: image: provectuslabs/kafka-ui:latest ports: - \u0026#34;8080:8080\u0026#34; environment: KAFKA_CLUSTERS_0_NAME: local KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092 2.2 ä¸»é¢˜ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # åˆ›å»ºä¸»é¢˜ kafka-topics.sh --create --topic orders \\ --bootstrap-server localhost:9092 \\ --partitions 3 \\ --replication-factor 1 # æŸ¥çœ‹ä¸»é¢˜ kafka-topics.sh --list --bootstrap-server localhost:9092 # æŸ¥çœ‹ä¸»é¢˜è¯¦æƒ… kafka-topics.sh --describe --topic orders \\ --bootstrap-server localhost:9092 # åˆ é™¤ä¸»é¢˜ kafka-topics.sh --delete --topic orders \\ --bootstrap-server localhost:9092 ä¸‰ã€Go åº”ç”¨é›†æˆ 3.1 å®‰è£…ä¾èµ– 1 go get github.com/segmentio/kafka-go 3.2 ç”Ÿäº§è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 package kafka import ( \u0026#34;context\u0026#34; \u0026#34;encoding/json\u0026#34; \u0026#34;time\u0026#34; \u0026#34;github.com/segmentio/kafka-go\u0026#34; ) type Producer struct { writer *kafka.Writer } func NewProducer(brokers []string, topic string) *Producer { return \u0026amp;Producer{ writer: \u0026amp;kafka.Writer{ Addr: kafka.TCP(brokers...), Topic: topic, Balancer: \u0026amp;kafka.LeastBytes{}, BatchSize: 100, BatchTimeout: 10 * time.Millisecond, RequiredAcks: kafka.RequireAll, Async: false, }, } } func (p *Producer) Send(ctx context.Context, key string, value interface{}) error { data, err := json.Marshal(value) if err != nil { return err } return p.writer.WriteMessages(ctx, kafka.Message{ Key: []byte(key), Value: data, Time: time.Now(), }, ) } func (p *Producer) SendBatch(ctx context.Context, messages []kafka.Message) error { return p.writer.WriteMessages(ctx, messages...) } func (p *Producer) Close() error { return p.writer.Close() } // ä½¿ç”¨ç¤ºä¾‹ func main() { producer := NewProducer([]string{\u0026#34;localhost:9092\u0026#34;}, \u0026#34;orders\u0026#34;) defer producer.Close() order := Order{ ID: \u0026#34;12345\u0026#34;, UserID: \u0026#34;user-1\u0026#34;, Amount: 99.99, CreatedAt: time.Now(), } err := producer.Send(context.Background(), order.ID, order) if err != nil { log.Fatal(err) } } 3.3 æ¶ˆè´¹è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 package kafka import ( \u0026#34;context\u0026#34; \u0026#34;encoding/json\u0026#34; \u0026#34;log\u0026#34; \u0026#34;github.com/segmentio/kafka-go\u0026#34; ) type Consumer struct { reader *kafka.Reader } func NewConsumer(brokers []string, topic, groupID string) *Consumer { return \u0026amp;Consumer{ reader: kafka.NewReader(kafka.ReaderConfig{ Brokers: brokers, Topic: topic, GroupID: groupID, MinBytes: 10e3, // 10KB MaxBytes: 10e6, // 10MB CommitInterval: time.Second, StartOffset: kafka.LastOffset, }), } } func (c *Consumer) Consume(ctx context.Context, handler func(message kafka.Message) error) error { for { select { case \u0026lt;-ctx.Done(): return ctx.Err() default: msg, err := c.reader.FetchMessage(ctx) if err != nil { return err } if err := handler(msg); err != nil { log.Printf(\u0026#34;Error processing message: %v\u0026#34;, err) continue } if err := c.reader.CommitMessages(ctx, msg); err != nil { return err } } } } func (c *Consumer) Close() error { return c.reader.Close() } // ä½¿ç”¨ç¤ºä¾‹ func main() { consumer := NewConsumer( []string{\u0026#34;localhost:9092\u0026#34;}, \u0026#34;orders\u0026#34;, \u0026#34;order-processor\u0026#34;, ) defer consumer.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() err := consumer.Consume(ctx, func(msg kafka.Message) error { var order Order if err := json.Unmarshal(msg.Value, \u0026amp;order); err != nil { return err } log.Printf(\u0026#34;Received order: %s, amount: %.2f\u0026#34;, order.ID, order.Amount) return processOrder(order) }) if err != nil { log.Fatal(err) } } 3.4 åˆ†åŒºé”®ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // è‡ªå®šä¹‰åˆ†åŒºå™¨ type OrderPartitioner struct{} func (p *OrderPartitioner) Balance(msg kafka.Message, partitions ...int) int { // æŒ‰ç”¨æˆ· ID åˆ†åŒºï¼Œä¿è¯åŒä¸€ç”¨æˆ·çš„è®¢å•é¡ºåº key := string(msg.Key) hash := fnv.New32a() hash.Write([]byte(key)) return int(hash.Sum32()) % len(partitions) } // ä½¿ç”¨è‡ªå®šä¹‰åˆ†åŒºå™¨ writer := \u0026amp;kafka.Writer{ Addr: kafka.TCP(brokers...), Topic: topic, Balancer: \u0026amp;OrderPartitioner{}, } å››ã€é«˜çº§ç‰¹æ€§ 4.1 äº‹åŠ¡æ”¯æŒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func (p *Producer) SendWithTransaction(ctx context.Context, messages []kafka.Message) error { // åˆ›å»ºäº‹åŠ¡æ€§ Writer w := \u0026amp;kafka.Writer{ Addr: kafka.TCP(p.brokers...), Topic: p.topic, RequiredAcks: kafka.RequireAll, Balancer: \u0026amp;kafka.Hash{}, } defer w.Close() // å¼€å¯äº‹åŠ¡ tx, err := w.BeginTx(ctx, \u0026amp;kafka.TxnConfig{}) if err != nil { return err } // å‘é€æ¶ˆæ¯ if err := tx.WriteMessages(ctx, messages...); err != nil { tx.Abort(ctx) return err } // æäº¤äº‹åŠ¡ return tx.Commit(ctx) } 4.2 æ¶ˆè´¹è€…ç»„å†å¹³è¡¡ 1 2 3 4 5 6 7 8 9 reader := kafka.NewReader(kafka.ReaderConfig{ Brokers: brokers, Topic: topic, GroupID: groupID, GroupBalancers: []kafka.GroupBalancer{ kafka.RangeGroupBalancer{}, kafka.RoundRobinGroupBalancer{}, }, }) 4.3 å»¶è¿Ÿé˜Ÿåˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // å»¶è¿Ÿé˜Ÿåˆ—å®ç° type DelayedMessage struct { OriginalTopic string `json:\u0026#34;original_topic\u0026#34;` Message []byte `json:\u0026#34;message\u0026#34;` ExecuteAt time.Time `json:\u0026#34;execute_at\u0026#34;` } func (p *Producer) SendDelayed(ctx context.Context, topic string, msg interface{}, delay time.Duration) error { data, _ := json.Marshal(msg) delayed := DelayedMessage{ OriginalTopic: topic, Message: data, ExecuteAt: time.Now().Add(delay), } return p.Send(ctx, uuid.New().String(), delayed) } // å»¶è¿Ÿé˜Ÿåˆ—æ¶ˆè´¹è€… func (c *Consumer) ConsumeDelayed(ctx context.Context) error { return c.Consume(ctx, func(msg kafka.Message) error { var delayed DelayedMessage json.Unmarshal(msg.Value, \u0026amp;delayed) // ç­‰å¾…æ‰§è¡Œæ—¶é—´ waitTime := time.Until(delayed.ExecuteAt) if waitTime \u0026gt; 0 { time.Sleep(waitTime) } // å‘é€åˆ°åŸå§‹ä¸»é¢˜ return producer.SendRaw(ctx, delayed.OriginalTopic, delayed.Message) }) } äº”ã€æ€§èƒ½ä¼˜åŒ– 5.1 ç”Ÿäº§è€…ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 writer := \u0026amp;kafka.Writer{ Addr: kafka.TCP(brokers...), Topic: topic, Balancer: \u0026amp;kafka.LeastBytes{}, BatchSize: 1000, // æ‰¹é‡å¤§å° BatchBytes: 1048576, // 1MB BatchTimeout: 100 * time.Millisecond, RequiredAcks: kafka.RequireOne, // åªéœ€ Leader ç¡®è®¤ Async: true, // å¼‚æ­¥å‘é€ Compression: kafka.Snappy, // å‹ç¼© } 5.2 æ¶ˆè´¹è€…ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 reader := kafka.NewReader(kafka.ReaderConfig{ Brokers: brokers, Topic: topic, GroupID: groupID, MinBytes: 1e3, // 1KB MaxBytes: 10e6, // 10MB MaxWait: 100 * time.Millisecond, CommitInterval: 5 * time.Second, QueueCapacity: 1000, }) å…­ã€ç›‘æ§æŒ‡æ ‡ 6.1 ç”Ÿäº§è€…æŒ‡æ ‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type ProducerMetrics struct { MessagesSent prometheus.Counter BytesSent prometheus.Counter SendLatency prometheus.Histogram SendErrors prometheus.Counter } func (p *Producer) SendWithMetrics(ctx context.Context, msg kafka.Message) error { start := time.Now() err := p.writer.WriteMessages(ctx, msg) p.metrics.SendLatency.Observe(time.Since(start).Seconds()) if err != nil { p.metrics.SendErrors.Inc() return err } p.metrics.MessagesSent.Inc() p.metrics.BytesSent.Add(float64(len(msg.Value))) return nil } 6.2 æ¶ˆè´¹è€…æŒ‡æ ‡ 1 2 3 4 5 6 7 8 9 10 11 type ConsumerMetrics struct { MessagesConsumed prometheus.Counter ConsumeLag prometheus.Gauge ProcessLatency prometheus.Histogram ProcessErrors prometheus.Counter } func (c *Consumer) updateLag() { stats := c.reader.Stats() c.metrics.ConsumeLag.Set(float64(stats.Lag)) } ä¸ƒã€æœ€ä½³å®è·µ 7.1 æ¶ˆæ¯æ ¼å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // ä½¿ç”¨ Avro/Protobuf åºåˆ—åŒ– type OrderEvent struct { EventID string `json:\u0026#34;event_id\u0026#34;` EventType string `json:\u0026#34;event_type\u0026#34;` Timestamp time.Time `json:\u0026#34;timestamp\u0026#34;` Data Order `json:\u0026#34;data\u0026#34;` } // æ¶ˆæ¯å¹‚ç­‰æ€§ type IdempotentMessage struct { ID string `json:\u0026#34;id\u0026#34;` // å”¯ä¸€æ ‡è¯† Timestamp int64 `json:\u0026#34;timestamp\u0026#34;` Payload []byte `json:\u0026#34;payload\u0026#34;` } 7.2 é”™è¯¯å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // æ­»ä¿¡é˜Ÿåˆ— func (c *Consumer) ConsumeWithDLQ(ctx context.Context, handler func(kafka.Message) error) error { return c.Consume(ctx, func(msg kafka.Message) error { retries := 0 maxRetries := 3 for retries \u0026lt; maxRetries { if err := handler(msg); err != nil { retries++ time.Sleep(time.Second * time.Duration(retries)) continue } return nil } // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ— return c.dlqProducer.Send(ctx, string(msg.Key), msg.Value) }) } æ€»ç»“ Kafka æ˜¯é«˜æ€§èƒ½åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿçš„é¦–é€‰ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®æµå¤„ç†åœºæ™¯ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸš€ é«˜ååé‡è®¾è®¡ ğŸ“Š åˆ†åŒºå¹¶è¡Œå¤„ç† ğŸ”„ æ¶ˆè´¹è€…ç»„è´Ÿè½½å‡è¡¡ ğŸ’¾ æŒä¹…åŒ–å­˜å‚¨ ğŸ”Œ ä¸°å¯Œçš„å®¢æˆ·ç«¯ç”Ÿæ€ ","date":"2024-12-12T00:00:00Z","permalink":"https://zpf-zero.github.io/p/kafka-guide/","title":"Kafka å®æˆ˜æŒ‡å—ï¼šé«˜ååé‡åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿ"},{"content":"å‰è¨€ Go è¯­è¨€ï¼ˆåˆç§° Golangï¼‰ç”± Google äº 2009 å¹´å‘å¸ƒï¼Œæ˜¯ä¸€é—¨ç®€æ´ã€é«˜æ•ˆã€å¹¶å‘å‹å¥½çš„ç¼–ç¨‹è¯­è¨€ã€‚å®ƒç»“åˆäº†é™æ€è¯­è¨€çš„å®‰å…¨æ€§å’ŒåŠ¨æ€è¯­è¨€çš„å¼€å‘æ•ˆç‡ï¼Œå·²æˆä¸ºäº‘åŸç”Ÿæ—¶ä»£æœ€å—æ¬¢è¿çš„åç«¯å¼€å‘è¯­è¨€ä¹‹ä¸€ã€‚\nä¸€ã€Go è¯­è¨€æ ¸å¿ƒç‰¹æ€§ 1.1 ç®€æ´çš„è¯­æ³• Go è¯­è¨€è¯­æ³•ç®€æ´æ˜äº†ï¼Œå»é™¤äº†ç±»ç»§æ‰¿ã€æ³›å‹ï¼ˆGo 1.18 ä¹‹å‰ï¼‰ç­‰å¤æ‚ç‰¹æ€§ï¼š\n1 2 3 4 5 6 7 package main import \u0026#34;fmt\u0026#34; func main() { fmt.Println(\u0026#34;Hello, Go!\u0026#34;) } 1.2 å¼ºå¤§çš„å¹¶å‘æ”¯æŒ Go è¯­è¨€å†…ç½® Goroutine å’Œ Channelï¼Œä½¿å¹¶å‘ç¼–ç¨‹å˜å¾—ç®€å•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;time\u0026#34; ) func worker(id int, ch chan int) { for job := range ch { fmt.Printf(\u0026#34;Worker %d processing job %d\\n\u0026#34;, id, job) time.Sleep(time.Second) } } func main() { jobs := make(chan int, 100) // å¯åŠ¨ 3 ä¸ª worker for i := 1; i \u0026lt;= 3; i++ { go worker(i, jobs) } // å‘é€ä»»åŠ¡ for j := 1; j \u0026lt;= 9; j++ { jobs \u0026lt;- j } close(jobs) time.Sleep(4 * time.Second) } 1.3 å†…ç½®åƒåœ¾å›æ”¶ Go æ‹¥æœ‰é«˜æ•ˆçš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼ˆGCï¼‰ï¼Œå¼€å‘è€…æ— éœ€æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼š\nä¸‰è‰²æ ‡è®°æ³•ï¼šå¹¶å‘æ ‡è®°ï¼Œå‡å°‘ STWï¼ˆStop The Worldï¼‰æ—¶é—´ å†™å±éšœï¼šä¿è¯å¹¶å‘æ ‡è®°çš„æ­£ç¡®æ€§ åˆ†ä»£å›æ”¶ï¼šGo 1.14+ å¼•å…¥çš„ä¼˜åŒ– äºŒã€Go åŸºç¡€è¯­æ³• 2.1 å˜é‡ä¸å¸¸é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // å˜é‡å£°æ˜ var name string = \u0026#34;Go\u0026#34; var age int = 15 var isAwesome bool = true // çŸ­å˜é‡å£°æ˜ count := 10 message := \u0026#34;Hello\u0026#34; // å¸¸é‡ const Pi = 3.14159 const ( StatusOK = 200 StatusNotFound = 404 ) 2.2 æ•°æ®ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // åŸºæœ¬ç±»å‹ var i int = 42 var f float64 = 3.14 var s string = \u0026#34;hello\u0026#34; var b bool = true // å¤åˆç±»å‹ var arr [5]int // æ•°ç»„ var slice []int = []int{1, 2, 3} // åˆ‡ç‰‡ var m map[string]int // æ˜ å°„ var ch chan int // é€šé“ // ç»“æ„ä½“ type User struct { ID int Name string Age int } 2.3 æ§åˆ¶æµ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // if è¯­å¥ if score \u0026gt;= 90 { fmt.Println(\u0026#34;ä¼˜ç§€\u0026#34;) } else if score \u0026gt;= 60 { fmt.Println(\u0026#34;åŠæ ¼\u0026#34;) } else { fmt.Println(\u0026#34;ä¸åŠæ ¼\u0026#34;) } // for å¾ªç¯ï¼ˆGo ä¸­å”¯ä¸€çš„å¾ªç¯è¯­å¥ï¼‰ for i := 0; i \u0026lt; 10; i++ { fmt.Println(i) } // range éå† nums := []int{1, 2, 3, 4, 5} for index, value := range nums { fmt.Printf(\u0026#34;Index: %d, Value: %d\\n\u0026#34;, index, value) } // switch è¯­å¥ switch day { case \u0026#34;Monday\u0026#34;: fmt.Println(\u0026#34;æ˜ŸæœŸä¸€\u0026#34;) case \u0026#34;Tuesday\u0026#34;: fmt.Println(\u0026#34;æ˜ŸæœŸäºŒ\u0026#34;) default: fmt.Println(\u0026#34;å…¶ä»–\u0026#34;) } ä¸‰ã€å‡½æ•°ä¸æ–¹æ³• 3.1 å‡½æ•°å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // æ™®é€šå‡½æ•° func add(a, b int) int { return a + b } // å¤šè¿”å›å€¼ func divide(a, b int) (int, error) { if b == 0 { return 0, errors.New(\u0026#34;division by zero\u0026#34;) } return a / b, nil } // å‘½åè¿”å›å€¼ func split(sum int) (x, y int) { x = sum * 4 / 9 y = sum - x return } // å¯å˜å‚æ•° func sum(nums ...int) int { total := 0 for _, num := range nums { total += num } return total } 3.2 æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type Rectangle struct { Width float64 Height float64 } // å€¼æ¥æ”¶è€… func (r Rectangle) Area() float64 { return r.Width * r.Height } // æŒ‡é’ˆæ¥æ”¶è€… func (r *Rectangle) Scale(factor float64) { r.Width *= factor r.Height *= factor } 3.3 æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 type Shape interface { Area() float64 Perimeter() float64 } type Circle struct { Radius float64 } func (c Circle) Area() float64 { return math.Pi * c.Radius * c.Radius } func (c Circle) Perimeter() float64 { return 2 * math.Pi * c.Radius } // Circle éšå¼å®ç°äº† Shape æ¥å£ func PrintShapeInfo(s Shape) { fmt.Printf(\u0026#34;Area: %.2f, Perimeter: %.2f\\n\u0026#34;, s.Area(), s.Perimeter()) } å››ã€å¹¶å‘ç¼–ç¨‹ 4.1 Goroutine 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func main() { // å¯åŠ¨ä¸€ä¸ª Goroutine go func() { fmt.Println(\u0026#34;Hello from Goroutine!\u0026#34;) }() // ä½¿ç”¨ WaitGroup ç­‰å¾… Goroutine å®Œæˆ var wg sync.WaitGroup for i := 0; i \u0026lt; 5; i++ { wg.Add(1) go func(id int) { defer wg.Done() fmt.Printf(\u0026#34;Goroutine %d\\n\u0026#34;, id) }(i) } wg.Wait() } 4.2 Channel 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func main() { // æ— ç¼“å†² Channel ch := make(chan int) go func() { ch \u0026lt;- 42 }() value := \u0026lt;-ch fmt.Println(value) // å¸¦ç¼“å†² Channel buffered := make(chan string, 3) buffered \u0026lt;- \u0026#34;one\u0026#34; buffered \u0026lt;- \u0026#34;two\u0026#34; buffered \u0026lt;- \u0026#34;three\u0026#34; fmt.Println(\u0026lt;-buffered) fmt.Println(\u0026lt;-buffered) fmt.Println(\u0026lt;-buffered) } 4.3 Select è¯­å¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func main() { ch1 := make(chan string) ch2 := make(chan string) go func() { time.Sleep(1 * time.Second) ch1 \u0026lt;- \u0026#34;one\u0026#34; }() go func() { time.Sleep(2 * time.Second) ch2 \u0026lt;- \u0026#34;two\u0026#34; }() for i := 0; i \u0026lt; 2; i++ { select { case msg1 := \u0026lt;-ch1: fmt.Println(\u0026#34;Received:\u0026#34;, msg1) case msg2 := \u0026lt;-ch2: fmt.Println(\u0026#34;Received:\u0026#34;, msg2) case \u0026lt;-time.After(3 * time.Second): fmt.Println(\u0026#34;Timeout\u0026#34;) } } } äº”ã€é”™è¯¯å¤„ç† 5.1 error æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func readFile(filename string) ([]byte, error) { data, err := os.ReadFile(filename) if err != nil { return nil, fmt.Errorf(\u0026#34;failed to read file %s: %w\u0026#34;, filename, err) } return data, nil } func main() { data, err := readFile(\u0026#34;config.json\u0026#34;) if err != nil { log.Fatal(err) } fmt.Println(string(data)) } 5.2 è‡ªå®šä¹‰é”™è¯¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 type ValidationError struct { Field string Message string } func (e *ValidationError) Error() string { return fmt.Sprintf(\u0026#34;validation error on %s: %s\u0026#34;, e.Field, e.Message) } func validateAge(age int) error { if age \u0026lt; 0 { return \u0026amp;ValidationError{Field: \u0026#34;age\u0026#34;, Message: \u0026#34;cannot be negative\u0026#34;} } if age \u0026gt; 150 { return \u0026amp;ValidationError{Field: \u0026#34;age\u0026#34;, Message: \u0026#34;unrealistic value\u0026#34;} } return nil } 5.3 panic å’Œ recover 1 2 3 4 5 6 7 8 9 10 11 12 13 func safeDivide(a, b int) (result int, err error) { defer func() { if r := recover(); r != nil { err = fmt.Errorf(\u0026#34;panic recovered: %v\u0026#34;, r) } }() if b == 0 { panic(\u0026#34;division by zero\u0026#34;) } return a / b, nil } å…­ã€å¸¸ç”¨æ ‡å‡†åº“ 6.1 fmt - æ ¼å¼åŒ– I/O 1 2 3 4 5 name := \u0026#34;Go\u0026#34; version := 1.21 fmt.Printf(\u0026#34;Language: %s, Version: %.2f\\n\u0026#34;, name, version) fmt.Sprintf(\u0026#34;Hello, %s!\u0026#34;, name) 6.2 net/http - HTTP æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 func main() { http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { fmt.Fprintf(w, \u0026#34;Hello, World!\u0026#34;) }) http.HandleFunc(\u0026#34;/api/users\u0026#34;, func(w http.ResponseWriter, r *http.Request) { w.Header().Set(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;) json.NewEncoder(w).Encode(map[string]string{\u0026#34;status\u0026#34;: \u0026#34;ok\u0026#34;}) }) log.Fatal(http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil)) } 6.3 encoding/json - JSON å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type User struct { ID int `json:\u0026#34;id\u0026#34;` Name string `json:\u0026#34;name\u0026#34;` Email string `json:\u0026#34;email,omitempty\u0026#34;` CreatedAt time.Time `json:\u0026#34;created_at\u0026#34;` } func main() { // åºåˆ—åŒ– user := User{ID: 1, Name: \u0026#34;Alice\u0026#34;} data, _ := json.Marshal(user) fmt.Println(string(data)) // ååºåˆ—åŒ– jsonStr := `{\u0026#34;id\u0026#34;: 2, \u0026#34;name\u0026#34;: \u0026#34;Bob\u0026#34;}` var u User json.Unmarshal([]byte(jsonStr), \u0026amp;u) fmt.Printf(\u0026#34;%+v\\n\u0026#34;, u) } ä¸ƒã€é¡¹ç›®ç»“æ„æœ€ä½³å®è·µ 7.1 æ ‡å‡†é¡¹ç›®å¸ƒå±€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 myproject/ â”œâ”€â”€ cmd/ # åº”ç”¨å…¥å£ â”‚ â””â”€â”€ myapp/ â”‚ â””â”€â”€ main.go â”œâ”€â”€ internal/ # ç§æœ‰åŒ… â”‚ â”œâ”€â”€ config/ â”‚ â”œâ”€â”€ handler/ â”‚ â”œâ”€â”€ service/ â”‚ â””â”€â”€ repository/ â”œâ”€â”€ pkg/ # å…¬å…±åŒ… â”‚ â””â”€â”€ utils/ â”œâ”€â”€ api/ # API å®šä¹‰ â”œâ”€â”€ configs/ # é…ç½®æ–‡ä»¶ â”œâ”€â”€ scripts/ # è„šæœ¬ â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â””â”€â”€ README.md 7.2 ä¾èµ–ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 # åˆå§‹åŒ–æ¨¡å— go mod init github.com/username/project # æ·»åŠ ä¾èµ– go get github.com/gin-gonic/gin # æ•´ç†ä¾èµ– go mod tidy # ä¸‹è½½ä¾èµ– go mod download å…«ã€æ€§èƒ½ä¼˜åŒ– 8.1 æ€§èƒ½åˆ†æ 1 2 3 4 5 6 7 8 9 import _ \u0026#34;net/http/pprof\u0026#34; func main() { go func() { log.Println(http.ListenAndServe(\u0026#34;localhost:6060\u0026#34;, nil)) }() // åº”ç”¨ä»£ç  } 1 2 3 4 5 6 7 8 # CPU åˆ†æ go tool pprof http://localhost:6060/debug/pprof/profile # å†…å­˜åˆ†æ go tool pprof http://localhost:6060/debug/pprof/heap # Goroutine åˆ†æ go tool pprof http://localhost:6060/debug/pprof/goroutine 8.2 å¸¸è§ä¼˜åŒ–æŠ€å·§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // 1. é¢„åˆ†é…åˆ‡ç‰‡å®¹é‡ slice := make([]int, 0, 1000) // 2. ä½¿ç”¨ sync.Pool å¤ç”¨å¯¹è±¡ var bufferPool = sync.Pool{ New: func() interface{} { return new(bytes.Buffer) }, } // 3. é¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é… // ä¸å¥½ func concat(a, b string) string { return a + b } // å¥½ func concat(a, b string) string { var builder strings.Builder builder.WriteString(a) builder.WriteString(b) return builder.String() } æ€»ç»“ Go è¯­è¨€ä»¥å…¶ç®€æ´çš„è¯­æ³•ã€å¼ºå¤§çš„å¹¶å‘æ”¯æŒå’Œå‡ºè‰²çš„æ€§èƒ½ï¼Œæˆä¸ºäº†ç°ä»£åç«¯å¼€å‘å’Œäº‘åŸç”Ÿåº”ç”¨çš„é¦–é€‰è¯­è¨€ã€‚æŒæ¡ Go è¯­è¨€çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå°†ä¸ºä½ æ‰“å¼€é«˜æ€§èƒ½ç¼–ç¨‹çš„å¤§é—¨ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“ ç®€æ´çš„è¯­æ³•ï¼Œå¿«é€Ÿä¸Šæ‰‹ âš¡ Goroutine + Channel å®ç°é«˜æ•ˆå¹¶å‘ ğŸ”§ ä¸°å¯Œçš„æ ‡å‡†åº“ ğŸš€ ç¼–è¯‘é€Ÿåº¦å¿«ï¼Œè¿è¡Œæ•ˆç‡é«˜ ğŸŒ é€‚åˆæ„å»ºå¾®æœåŠ¡å’Œäº‘åŸç”Ÿåº”ç”¨ ","date":"2024-11-11T00:00:00Z","permalink":"https://zpf-zero.github.io/p/go-programming-guide/","title":"Go è¯­è¨€å…¥é—¨åˆ°è¿›é˜¶ï¼šé«˜æ€§èƒ½ç¼–ç¨‹è¯­è¨€çš„æ ¸å¿ƒç‰¹æ€§ä¸å®è·µ"},{"content":"å‰è¨€ Pinia æ˜¯ Vue 3 å®˜æ–¹æ¨èçš„çŠ¶æ€ç®¡ç†åº“ï¼Œæ˜¯ Vuex çš„ç»§ä»»è€…ã€‚å®ƒæä¾›äº†æ›´ç®€æ´çš„ APIã€å®Œæ•´çš„ TypeScript æ”¯æŒï¼Œå¹¶ä¸”å®Œç¾é€‚é… Vue 3 çš„ç»„åˆå¼ APIã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£… 1 npm install pinia 1.2 åˆ›å»º Pinia å®ä¾‹ 1 2 3 4 5 6 7 8 9 10 // main.ts import { createApp } from \u0026#39;vue\u0026#39; import { createPinia } from \u0026#39;pinia\u0026#39; import App from \u0026#39;./App.vue\u0026#39; const app = createApp(App) const pinia = createPinia() app.use(pinia) app.mount(\u0026#39;#app\u0026#39;) 1.3 å®šä¹‰ Store 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // stores/counter.ts import { defineStore } from \u0026#39;pinia\u0026#39; // Option Storeï¼ˆé€‰é¡¹å¼ï¼‰ export const useCounterStore = defineStore(\u0026#39;counter\u0026#39;, { state: () =\u0026gt; ({ count: 0, name: \u0026#39;Counter\u0026#39;, }), getters: { doubleCount: (state) =\u0026gt; state.count * 2, // ä½¿ç”¨ this è®¿é—®å…¶ä»– getter doubleCountPlusOne(): number { return this.doubleCount + 1 }, }, actions: { increment() { this.count++ }, async fetchData() { const data = await fetch(\u0026#39;/api/data\u0026#39;) this.count = await data.json() }, }, }) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // Setup Storeï¼ˆç»„åˆå¼ï¼‰- æ¨è import { defineStore } from \u0026#39;pinia\u0026#39; import { ref, computed } from \u0026#39;vue\u0026#39; export const useCounterStore = defineStore(\u0026#39;counter\u0026#39;, () =\u0026gt; { // state const count = ref(0) const name = ref(\u0026#39;Counter\u0026#39;) // getters const doubleCount = computed(() =\u0026gt; count.value * 2) // actions function increment() { count.value++ } async function fetchData() { const response = await fetch(\u0026#39;/api/data\u0026#39;) count.value = await response.json() } return { count, name, doubleCount, increment, fetchData, } }) äºŒã€State çŠ¶æ€ 2.1 è®¿é—®å’Œä¿®æ”¹çŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;Count: {{ counter.count }}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Double: {{ counter.doubleCount }}\u0026lt;/p\u0026gt; \u0026lt;button @click=\u0026#34;counter.increment()\u0026#34;\u0026gt;+1\u0026lt;/button\u0026gt; \u0026lt;button @click=\u0026#34;counter.count++\u0026#34;\u0026gt;ç›´æ¥ä¿®æ”¹\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { useCounterStore } from \u0026#39;@/stores/counter\u0026#39; const counter = useCounterStore() // ç›´æ¥è®¿é—® console.log(counter.count) // ç›´æ¥ä¿®æ”¹ counter.count++ // ä½¿ç”¨ $patch æ‰¹é‡ä¿®æ”¹ counter.$patch({ count: counter.count + 1, name: \u0026#39;New Name\u0026#39;, }) // ä½¿ç”¨å‡½æ•°å½¢å¼çš„ $patch counter.$patch((state) =\u0026gt; { state.count++ state.name = \u0026#39;New Name\u0026#39; }) // é‡ç½®çŠ¶æ€ counter.$reset() \u0026lt;/script\u0026gt; 2.2 è§£æ„ä¿æŒå“åº”æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;script setup lang=\u0026#34;ts\u0026#34;\u0026gt; import { storeToRefs } from \u0026#39;pinia\u0026#39; import { useCounterStore } from \u0026#39;@/stores/counter\u0026#39; const counter = useCounterStore() // âŒ é”™è¯¯ï¼šç›´æ¥è§£æ„ä¼šä¸¢å¤±å“åº”æ€§ // const { count, name } = counter // âœ… æ­£ç¡®ï¼šä½¿ç”¨ storeToRefs const { count, name, doubleCount } = storeToRefs(counter) // actions å¯ä»¥ç›´æ¥è§£æ„ const { increment, fetchData } = counter \u0026lt;/script\u0026gt; 2.3 è®¢é˜…çŠ¶æ€å˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 const counter = useCounterStore() // è®¢é˜… state å˜åŒ– counter.$subscribe((mutation, state) =\u0026gt; { console.log(\u0026#39;mutation type:\u0026#39;, mutation.type) console.log(\u0026#39;mutation storeId:\u0026#39;, mutation.storeId) console.log(\u0026#39;new state:\u0026#39;, state) // æŒä¹…åŒ–åˆ° localStorage localStorage.setItem(\u0026#39;counter\u0026#39;, JSON.stringify(state)) }, { detached: true }) // ç»„ä»¶å¸è½½åç»§ç»­ç›‘å¬ // è®¢é˜… action è°ƒç”¨ counter.$onAction(({ name, store, args, after, onError }) =\u0026gt; { console.log(`Action ${name} called with args:`, args) after((result) =\u0026gt; { console.log(`Action ${name} finished with result:`, result) }) onError((error) =\u0026gt; { console.error(`Action ${name} failed:`, error) }) }) ä¸‰ã€Getters è®¡ç®—å±æ€§ 3.1 åŸºç¡€ Getters 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // Option Store export const useUserStore = defineStore(\u0026#39;user\u0026#39;, { state: () =\u0026gt; ({ firstName: \u0026#39;John\u0026#39;, lastName: \u0026#39;Doe\u0026#39;, age: 25, }), getters: { // åŸºæœ¬ getter fullName: (state) =\u0026gt; `${state.firstName} ${state.lastName}`, // ä½¿ç”¨ this è®¿é—®å…¶ä»– getter greeting(): string { return `Hello, ${this.fullName}!` }, // å¸¦å‚æ•°çš„ getter isAdult: (state) =\u0026gt; { return (minAge: number) =\u0026gt; state.age \u0026gt;= minAge }, }, }) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // Setup Store export const useUserStore = defineStore(\u0026#39;user\u0026#39;, () =\u0026gt; { const firstName = ref(\u0026#39;John\u0026#39;) const lastName = ref(\u0026#39;Doe\u0026#39;) const age = ref(25) // åŸºæœ¬ getter const fullName = computed(() =\u0026gt; `${firstName.value} ${lastName.value}`) // ä½¿ç”¨å…¶ä»– getter const greeting = computed(() =\u0026gt; `Hello, ${fullName.value}!`) // å¸¦å‚æ•°çš„ getter const isAdult = computed(() =\u0026gt; { return (minAge: number) =\u0026gt; age.value \u0026gt;= minAge }) return { firstName, lastName, age, fullName, greeting, isAdult, } }) 3.2 è®¿é—®å…¶ä»– Store çš„ Getter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import { useUserStore } from \u0026#39;./user\u0026#39; export const useCartStore = defineStore(\u0026#39;cart\u0026#39;, () =\u0026gt; { const items = ref\u0026lt;CartItem[]\u0026gt;([]) // è®¿é—®å…¶ä»– store const userStore = useUserStore() const totalWithDiscount = computed(() =\u0026gt; { const total = items.value.reduce((sum, item) =\u0026gt; sum + item.price, 0) // æ ¹æ®ç”¨æˆ·ç­‰çº§è®¡ç®—æŠ˜æ‰£ return userStore.isVip ? total * 0.8 : total }) return { items, totalWithDiscount } }) å››ã€Actions æ“ä½œ 4.1 åŒæ­¥å’Œå¼‚æ­¥ Actions 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 export const useUserStore = defineStore(\u0026#39;user\u0026#39;, () =\u0026gt; { const user = ref\u0026lt;User | null\u0026gt;(null) const loading = ref(false) const error = ref\u0026lt;string | null\u0026gt;(null) // åŒæ­¥ action function setUser(newUser: User) { user.value = newUser } function clearUser() { user.value = null } // å¼‚æ­¥ action async function login(username: string, password: string) { loading.value = true error.value = null try { const response = await fetch(\u0026#39;/api/login\u0026#39;, { method: \u0026#39;POST\u0026#39;, body: JSON.stringify({ username, password }), }) if (!response.ok) { throw new Error(\u0026#39;Login failed\u0026#39;) } user.value = await response.json() return user.value } catch (e) { error.value = (e as Error).message throw e } finally { loading.value = false } } async function logout() { await fetch(\u0026#39;/api/logout\u0026#39;, { method: \u0026#39;POST\u0026#39; }) user.value = null } return { user, loading, error, setUser, clearUser, login, logout, } }) 4.2 è°ƒç”¨å…¶ä»– Store çš„ Action 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 import { useAuthStore } from \u0026#39;./auth\u0026#39; export const useCartStore = defineStore(\u0026#39;cart\u0026#39;, () =\u0026gt; { const items = ref\u0026lt;CartItem[]\u0026gt;([]) async function checkout() { const authStore = useAuthStore() // æ£€æŸ¥ç™»å½•çŠ¶æ€ if (!authStore.isLoggedIn) { throw new Error(\u0026#39;Please login first\u0026#39;) } // æäº¤è®¢å• const response = await fetch(\u0026#39;/api/orders\u0026#39;, { method: \u0026#39;POST\u0026#39;, body: JSON.stringify({ items: items.value }), }) if (response.ok) { items.value = [] } } return { items, checkout } }) äº”ã€æ’ä»¶ç³»ç»Ÿ 5.1 æŒä¹…åŒ–æ’ä»¶ 1 npm install pinia-plugin-persistedstate 1 2 3 4 5 6 // main.ts import { createPinia } from \u0026#39;pinia\u0026#39; import piniaPluginPersistedstate from \u0026#39;pinia-plugin-persistedstate\u0026#39; const pinia = createPinia() pinia.use(piniaPluginPersistedstate) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // stores/user.ts export const useUserStore = defineStore(\u0026#39;user\u0026#39;, () =\u0026gt; { const token = ref(\u0026#39;\u0026#39;) const user = ref\u0026lt;User | null\u0026gt;(null) return { token, user } }, { persist: true, // å¯ç”¨æŒä¹…åŒ– }) // è‡ªå®šä¹‰æŒä¹…åŒ–é…ç½® export const useSettingsStore = defineStore(\u0026#39;settings\u0026#39;, () =\u0026gt; { const theme = ref(\u0026#39;light\u0026#39;) const language = ref(\u0026#39;zh-CN\u0026#39;) return { theme, language } }, { persist: { key: \u0026#39;app-settings\u0026#39;, storage: localStorage, paths: [\u0026#39;theme\u0026#39;, \u0026#39;language\u0026#39;], // åªæŒä¹…åŒ–éƒ¨åˆ†çŠ¶æ€ }, }) 5.2 è‡ªå®šä¹‰æ’ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // plugins/logger.ts import type { PiniaPluginContext } from \u0026#39;pinia\u0026#39; export function loggerPlugin({ store }: PiniaPluginContext) { // ç›‘å¬æ‰€æœ‰ state å˜åŒ– store.$subscribe((mutation, state) =\u0026gt; { console.log(`[${mutation.storeId}] ${mutation.type}`) console.log(\u0026#39;Payload:\u0026#39;, mutation.payload) console.log(\u0026#39;New state:\u0026#39;, JSON.parse(JSON.stringify(state))) }) // ç›‘å¬æ‰€æœ‰ action è°ƒç”¨ store.$onAction(({ name, store, args, after, onError }) =\u0026gt; { const startTime = Date.now() console.log(`[${store.$id}] Action \u0026#34;${name}\u0026#34; started`) after((result) =\u0026gt; { console.log( `[${store.$id}] Action \u0026#34;${name}\u0026#34; finished in ${Date.now() - startTime}ms` ) }) onError((error) =\u0026gt; { console.error(`[${store.$id}] Action \u0026#34;${name}\u0026#34; failed:`, error) }) }) } // ä½¿ç”¨æ’ä»¶ const pinia = createPinia() pinia.use(loggerPlugin) 5.3 æ·»åŠ å…±äº«å±æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // plugins/api.ts import type { PiniaPluginContext } from \u0026#39;pinia\u0026#39; import { api } from \u0026#39;@/utils/api\u0026#39; declare module \u0026#39;pinia\u0026#39; { export interface PiniaCustomProperties { $api: typeof api } } export function apiPlugin({ store }: PiniaPluginContext) { store.$api = api } // åœ¨ store ä¸­ä½¿ç”¨ export const useUserStore = defineStore(\u0026#39;user\u0026#39;, () =\u0026gt; { async function fetchUser(id: number) { // é€šè¿‡ this è®¿é—® const user = await this.$api.get(`/users/${id}`) return user } return { fetchUser } }) å…­ã€ç»„åˆå¼ Store æ¨¡å¼ 6.1 Store ç»„åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // stores/useAuth.ts export const useAuthStore = defineStore(\u0026#39;auth\u0026#39;, () =\u0026gt; { const token = ref\u0026lt;string | null\u0026gt;(null) const user = ref\u0026lt;User | null\u0026gt;(null) const isLoggedIn = computed(() =\u0026gt; !!token.value) async function login(credentials: LoginCredentials) { const response = await api.post(\u0026#39;/auth/login\u0026#39;, credentials) token.value = response.token user.value = response.user } function logout() { token.value = null user.value = null } return { token, user, isLoggedIn, login, logout } }) // stores/useProfile.ts export const useProfileStore = defineStore(\u0026#39;profile\u0026#39;, () =\u0026gt; { const authStore = useAuthStore() const profile = ref\u0026lt;Profile | null\u0026gt;(null) // åªæœ‰ç™»å½•åæ‰èƒ½è·å– profile async function fetchProfile() { if (!authStore.isLoggedIn) { throw new Error(\u0026#39;Not logged in\u0026#39;) } profile.value = await api.get(\u0026#39;/profile\u0026#39;) } // ç›‘å¬ç™»å½•çŠ¶æ€ï¼Œè‡ªåŠ¨è·å– profile watch(() =\u0026gt; authStore.isLoggedIn, async (loggedIn) =\u0026gt; { if (loggedIn) { await fetchProfile() } else { profile.value = null } }) return { profile, fetchProfile } }) 6.2 å…±äº« Composables 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // composables/useLoading.ts export function useLoading() { const loading = ref(false) const error = ref\u0026lt;Error | null\u0026gt;(null) async function withLoading\u0026lt;T\u0026gt;(fn: () =\u0026gt; Promise\u0026lt;T\u0026gt;): Promise\u0026lt;T\u0026gt; { loading.value = true error.value = null try { return await fn() } catch (e) { error.value = e as Error throw e } finally { loading.value = false } } return { loading, error, withLoading } } // åœ¨ Store ä¸­ä½¿ç”¨ export const useUserStore = defineStore(\u0026#39;user\u0026#39;, () =\u0026gt; { const { loading, error, withLoading } = useLoading() const users = ref\u0026lt;User[]\u0026gt;([]) async function fetchUsers() { users.value = await withLoading(() =\u0026gt; api.get(\u0026#39;/users\u0026#39;)) } return { users, loading, error, fetchUsers } }) ä¸ƒã€TypeScript æ”¯æŒ 7.1 ç±»å‹å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // types/store.ts export interface User { id: number name: string email: string role: \u0026#39;admin\u0026#39; | \u0026#39;user\u0026#39; } export interface AuthState { user: User | null token: string | null } // stores/auth.ts import type { User, AuthState } from \u0026#39;@/types/store\u0026#39; export const useAuthStore = defineStore(\u0026#39;auth\u0026#39;, () =\u0026gt; { const state = reactive\u0026lt;AuthState\u0026gt;({ user: null, token: null, }) // ä½¿ç”¨ç±»å‹ function setUser(user: User | null) { state.user = user } return { ...toRefs(state), setUser } }) 7.2 Store ç±»å‹æ¨æ–­ 1 2 3 4 5 6 7 8 9 10 // è·å– store ç±»å‹ import type { StoreDefinition } from \u0026#39;pinia\u0026#39; type AuthStore = ReturnType\u0026lt;typeof useAuthStore\u0026gt; // è·å– state ç±»å‹ type AuthState = AuthStore[\u0026#39;$state\u0026#39;] // åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ const authStore: AuthStore = useAuthStore() å…«ã€æµ‹è¯• 8.1 å•å…ƒæµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // stores/__tests__/counter.test.ts import { setActivePinia, createPinia } from \u0026#39;pinia\u0026#39; import { useCounterStore } from \u0026#39;../counter\u0026#39; import { beforeEach, describe, it, expect } from \u0026#39;vitest\u0026#39; describe(\u0026#39;Counter Store\u0026#39;, () =\u0026gt; { beforeEach(() =\u0026gt; { setActivePinia(createPinia()) }) it(\u0026#39;increments count\u0026#39;, () =\u0026gt; { const counter = useCounterStore() expect(counter.count).toBe(0) counter.increment() expect(counter.count).toBe(1) }) it(\u0026#39;computes double count\u0026#39;, () =\u0026gt; { const counter = useCounterStore() counter.count = 5 expect(counter.doubleCount).toBe(10) }) it(\u0026#39;resets state\u0026#39;, () =\u0026gt; { const counter = useCounterStore() counter.count = 10 counter.$reset() expect(counter.count).toBe(0) }) }) 8.2 ç»„ä»¶æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // components/__tests__/Counter.test.ts import { mount } from \u0026#39;@vue/test-utils\u0026#39; import { createTestingPinia } from \u0026#39;@pinia/testing\u0026#39; import Counter from \u0026#39;../Counter.vue\u0026#39; describe(\u0026#39;Counter Component\u0026#39;, () =\u0026gt; { it(\u0026#39;displays count from store\u0026#39;, () =\u0026gt; { const wrapper = mount(Counter, { global: { plugins: [ createTestingPinia({ initialState: { counter: { count: 10 }, }, }), ], }, }) expect(wrapper.text()).toContain(\u0026#39;10\u0026#39;) }) it(\u0026#39;calls increment action\u0026#39;, async () =\u0026gt; { const wrapper = mount(Counter, { global: { plugins: [createTestingPinia()], }, }) const store = useCounterStore() await wrapper.find(\u0026#39;button\u0026#39;).trigger(\u0026#39;click\u0026#39;) expect(store.increment).toHaveBeenCalled() }) }) æ€»ç»“ Pinia æ˜¯ Vue 3 ç”Ÿæ€ä¸­æœ€ä¼˜ç§€çš„çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæä¾›äº†ç®€æ´çš„ API å’Œå®Œæ•´çš„ TypeScript æ”¯æŒã€‚\næ ¸å¿ƒä¼˜åŠ¿ï¼š\nğŸ“¦ è½»é‡çº§ï¼Œä½“ç§¯å° ğŸ¯ å®Œæ•´çš„ TypeScript æ”¯æŒ ğŸ”§ æ”¯æŒ Vue DevTools âš¡ æ¨¡å—åŒ–è®¾è®¡ï¼ŒæŒ‰éœ€åŠ è½½ ğŸ§© å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿ Incoming (Background Agent changes)\n","date":"2024-11-06T00:00:00Z","permalink":"https://zpf-zero.github.io/p/pinia-guide/","title":"Pinia å®æˆ˜æŒ‡å—ï¼šVue 3 çŠ¶æ€ç®¡ç†æœ€ä½³é€‰æ‹©"},{"content":"å‰è¨€ Gin æ˜¯ Go è¯­è¨€ä¸­æœ€æµè¡Œçš„ Web æ¡†æ¶ä¹‹ä¸€ï¼Œä»¥å…¶é«˜æ€§èƒ½å’Œç®€æ´çš„ API è‘—ç§°ã€‚å®ƒåŸºäº httprouter æ„å»ºï¼Œæ€§èƒ½æ¯”å…¶ä»–æ¡†æ¶å¿«è¿‘ 40 å€ï¼Œæ˜¯æ„å»º RESTful API çš„ç»ä½³é€‰æ‹©ã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£… 1 go get -u github.com/gin-gonic/gin 1.2 Hello World 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package main import \u0026#34;github.com/gin-gonic/gin\u0026#34; func main() { r := gin.Default() r.GET(\u0026#34;/ping\u0026#34;, func(c *gin.Context) { c.JSON(200, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;pong\u0026#34;, }) }) r.Run(\u0026#34;:8080\u0026#34;) } äºŒã€è·¯ç”±ç³»ç»Ÿ 2.1 åŸºæœ¬è·¯ç”± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func main() { r := gin.Default() // HTTP æ–¹æ³• r.GET(\u0026#34;/get\u0026#34;, getHandler) r.POST(\u0026#34;/post\u0026#34;, postHandler) r.PUT(\u0026#34;/put\u0026#34;, putHandler) r.DELETE(\u0026#34;/delete\u0026#34;, deleteHandler) r.PATCH(\u0026#34;/patch\u0026#34;, patchHandler) r.OPTIONS(\u0026#34;/options\u0026#34;, optionsHandler) // åŒ¹é…æ‰€æœ‰æ–¹æ³• r.Any(\u0026#34;/any\u0026#34;, anyHandler) // 404 å¤„ç† r.NoRoute(func(c *gin.Context) { c.JSON(404, gin.H{\u0026#34;message\u0026#34;: \u0026#34;page not found\u0026#34;}) }) r.Run(\u0026#34;:8080\u0026#34;) } 2.2 è·¯ç”±å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // è·¯å¾„å‚æ•° r.GET(\u0026#34;/users/:id\u0026#34;, func(c *gin.Context) { id := c.Param(\u0026#34;id\u0026#34;) c.JSON(200, gin.H{\u0026#34;user_id\u0026#34;: id}) }) // é€šé…ç¬¦å‚æ•° r.GET(\u0026#34;/files/*filepath\u0026#34;, func(c *gin.Context) { filepath := c.Param(\u0026#34;filepath\u0026#34;) c.JSON(200, gin.H{\u0026#34;path\u0026#34;: filepath}) }) // æŸ¥è¯¢å‚æ•° r.GET(\u0026#34;/search\u0026#34;, func(c *gin.Context) { keyword := c.Query(\u0026#34;keyword\u0026#34;) page := c.DefaultQuery(\u0026#34;page\u0026#34;, \u0026#34;1\u0026#34;) c.JSON(200, gin.H{ \u0026#34;keyword\u0026#34;: keyword, \u0026#34;page\u0026#34;: page, }) }) 2.3 è·¯ç”±åˆ†ç»„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func main() { r := gin.Default() // API v1 åˆ†ç»„ v1 := r.Group(\u0026#34;/api/v1\u0026#34;) { v1.GET(\u0026#34;/users\u0026#34;, getUsers) v1.POST(\u0026#34;/users\u0026#34;, createUser) v1.GET(\u0026#34;/users/:id\u0026#34;, getUser) v1.PUT(\u0026#34;/users/:id\u0026#34;, updateUser) v1.DELETE(\u0026#34;/users/:id\u0026#34;, deleteUser) } // API v2 åˆ†ç»„ v2 := r.Group(\u0026#34;/api/v2\u0026#34;) { v2.GET(\u0026#34;/users\u0026#34;, getUsersV2) } r.Run(\u0026#34;:8080\u0026#34;) } ä¸‰ã€è¯·æ±‚å¤„ç† 3.1 è·å–è¯·æ±‚æ•°æ® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // è·å–è¡¨å•æ•°æ® r.POST(\u0026#34;/form\u0026#34;, func(c *gin.Context) { username := c.PostForm(\u0026#34;username\u0026#34;) password := c.DefaultPostForm(\u0026#34;password\u0026#34;, \u0026#34;\u0026#34;) c.JSON(200, gin.H{ \u0026#34;username\u0026#34;: username, \u0026#34;password\u0026#34;: password, }) }) // è·å– JSON æ•°æ® r.POST(\u0026#34;/json\u0026#34;, func(c *gin.Context) { var json struct { Name string `json:\u0026#34;name\u0026#34;` Email string `json:\u0026#34;email\u0026#34;` } if err := c.ShouldBindJSON(\u0026amp;json); err != nil { c.JSON(400, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } c.JSON(200, gin.H{\u0026#34;data\u0026#34;: json}) }) 3.2 å‚æ•°ç»‘å®šä¸éªŒè¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type CreateUserRequest struct { Username string `json:\u0026#34;username\u0026#34; binding:\u0026#34;required,min=3,max=20\u0026#34;` Email string `json:\u0026#34;email\u0026#34; binding:\u0026#34;required,email\u0026#34;` Age int `json:\u0026#34;age\u0026#34; binding:\u0026#34;required,gte=0,lte=130\u0026#34;` Password string `json:\u0026#34;password\u0026#34; binding:\u0026#34;required,min=6\u0026#34;` } r.POST(\u0026#34;/users\u0026#34;, func(c *gin.Context) { var req CreateUserRequest if err := c.ShouldBindJSON(\u0026amp;req); err != nil { c.JSON(400, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;validation failed\u0026#34;, \u0026#34;details\u0026#34;: err.Error(), }) return } // å¤„ç†ä¸šåŠ¡é€»è¾‘ c.JSON(201, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;user created\u0026#34;, \u0026#34;user\u0026#34;: req, }) }) 3.3 è‡ªå®šä¹‰éªŒè¯å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 import ( \u0026#34;github.com/go-playground/validator/v10\u0026#34; ) // è‡ªå®šä¹‰éªŒè¯å‡½æ•° var validateBookableDate validator.Func = func(fl validator.FieldLevel) bool { date, ok := fl.Field().Interface().(time.Time) if ok { today := time.Now() if date.After(today) { return true } } return false } func main() { r := gin.Default() // æ³¨å†Œè‡ªå®šä¹‰éªŒè¯å™¨ if v, ok := binding.Validator.Engine().(*validator.Validate); ok { v.RegisterValidation(\u0026#34;bookabledate\u0026#34;, validateBookableDate) } r.Run(\u0026#34;:8080\u0026#34;) } å››ã€ä¸­é—´ä»¶ 4.1 å†…ç½®ä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 func main() { // åˆ›å»ºæ— ä¸­é—´ä»¶çš„å¼•æ“ r := gin.New() // æ—¥å¿—ä¸­é—´ä»¶ r.Use(gin.Logger()) // æ¢å¤ä¸­é—´ä»¶ï¼ˆpanic æ¢å¤ï¼‰ r.Use(gin.Recovery()) r.Run(\u0026#34;:8080\u0026#34;) } 4.2 è‡ªå®šä¹‰ä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 // æ—¥å¿—ä¸­é—´ä»¶ func LoggerMiddleware() gin.HandlerFunc { return func(c *gin.Context) { start := time.Now() path := c.Request.URL.Path // å¤„ç†è¯·æ±‚ c.Next() // è®°å½•æ—¥å¿— latency := time.Since(start) status := c.Writer.Status() log.Printf(\u0026#34;[%d] %s %s %v\u0026#34;, status, c.Request.Method, path, latency) } } // è®¤è¯ä¸­é—´ä»¶ func AuthMiddleware() gin.HandlerFunc { return func(c *gin.Context) { token := c.GetHeader(\u0026#34;Authorization\u0026#34;) if token == \u0026#34;\u0026#34; { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;unauthorized\u0026#34;}) c.Abort() return } // éªŒè¯ token userID, err := validateToken(token) if err != nil { c.JSON(401, gin.H{\u0026#34;error\u0026#34;: \u0026#34;invalid token\u0026#34;}) c.Abort() return } // è®¾ç½®ç”¨æˆ·ä¿¡æ¯ c.Set(\u0026#34;userID\u0026#34;, userID) c.Next() } } // CORS ä¸­é—´ä»¶ func CORSMiddleware() gin.HandlerFunc { return func(c *gin.Context) { c.Writer.Header().Set(\u0026#34;Access-Control-Allow-Origin\u0026#34;, \u0026#34;*\u0026#34;) c.Writer.Header().Set(\u0026#34;Access-Control-Allow-Methods\u0026#34;, \u0026#34;GET, POST, PUT, DELETE, OPTIONS\u0026#34;) c.Writer.Header().Set(\u0026#34;Access-Control-Allow-Headers\u0026#34;, \u0026#34;Content-Type, Authorization\u0026#34;) if c.Request.Method == \u0026#34;OPTIONS\u0026#34; { c.AbortWithStatus(204) return } c.Next() } } // ä½¿ç”¨ä¸­é—´ä»¶ func main() { r := gin.Default() // å…¨å±€ä¸­é—´ä»¶ r.Use(LoggerMiddleware()) r.Use(CORSMiddleware()) // è·¯ç”±ç»„ä¸­é—´ä»¶ api := r.Group(\u0026#34;/api\u0026#34;) api.Use(AuthMiddleware()) { api.GET(\u0026#34;/profile\u0026#34;, getProfile) api.PUT(\u0026#34;/profile\u0026#34;, updateProfile) } r.Run(\u0026#34;:8080\u0026#34;) } 4.3 é™æµä¸­é—´ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 import \u0026#34;golang.org/x/time/rate\u0026#34; func RateLimitMiddleware(rps int) gin.HandlerFunc { limiter := rate.NewLimiter(rate.Limit(rps), rps) return func(c *gin.Context) { if !limiter.Allow() { c.JSON(429, gin.H{\u0026#34;error\u0026#34;: \u0026#34;too many requests\u0026#34;}) c.Abort() return } c.Next() } } äº”ã€å“åº”å¤„ç† 5.1 å¤šç§å“åº”æ ¼å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // JSON å“åº” r.GET(\u0026#34;/json\u0026#34;, func(c *gin.Context) { c.JSON(200, gin.H{ \u0026#34;status\u0026#34;: \u0026#34;success\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Hello, World!\u0026#34;, }) }) // XML å“åº” r.GET(\u0026#34;/xml\u0026#34;, func(c *gin.Context) { c.XML(200, gin.H{ \u0026#34;status\u0026#34;: \u0026#34;success\u0026#34;, }) }) // YAML å“åº” r.GET(\u0026#34;/yaml\u0026#34;, func(c *gin.Context) { c.YAML(200, gin.H{ \u0026#34;status\u0026#34;: \u0026#34;success\u0026#34;, }) }) // å­—ç¬¦ä¸²å“åº” r.GET(\u0026#34;/string\u0026#34;, func(c *gin.Context) { c.String(200, \u0026#34;Hello, %s!\u0026#34;, \u0026#34;World\u0026#34;) }) // HTML å“åº” r.GET(\u0026#34;/html\u0026#34;, func(c *gin.Context) { c.HTML(200, \u0026#34;index.html\u0026#34;, gin.H{ \u0026#34;title\u0026#34;: \u0026#34;Gin Demo\u0026#34;, }) }) // æ–‡ä»¶ä¸‹è½½ r.GET(\u0026#34;/download\u0026#34;, func(c *gin.Context) { c.File(\u0026#34;./files/document.pdf\u0026#34;) }) // é‡å®šå‘ r.GET(\u0026#34;/redirect\u0026#34;, func(c *gin.Context) { c.Redirect(302, \u0026#34;/new-path\u0026#34;) }) 5.2 ç»Ÿä¸€å“åº”æ ¼å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 type Response struct { Code int `json:\u0026#34;code\u0026#34;` Message string `json:\u0026#34;message\u0026#34;` Data interface{} `json:\u0026#34;data,omitempty\u0026#34;` } func Success(c *gin.Context, data interface{}) { c.JSON(200, Response{ Code: 0, Message: \u0026#34;success\u0026#34;, Data: data, }) } func Error(c *gin.Context, code int, message string) { c.JSON(200, Response{ Code: code, Message: message, }) } // ä½¿ç”¨ r.GET(\u0026#34;/users/:id\u0026#34;, func(c *gin.Context) { id := c.Param(\u0026#34;id\u0026#34;) user, err := userService.GetByID(id) if err != nil { Error(c, 1001, \u0026#34;user not found\u0026#34;) return } Success(c, user) }) å…­ã€æ–‡ä»¶ä¸Šä¼  6.1 å•æ–‡ä»¶ä¸Šä¼  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 r.POST(\u0026#34;/upload\u0026#34;, func(c *gin.Context) { file, err := c.FormFile(\u0026#34;file\u0026#34;) if err != nil { c.JSON(400, gin.H{\u0026#34;error\u0026#34;: \u0026#34;file required\u0026#34;}) return } // ä¿å­˜æ–‡ä»¶ dst := \u0026#34;./uploads/\u0026#34; + file.Filename if err := c.SaveUploadedFile(file, dst); err != nil { c.JSON(500, gin.H{\u0026#34;error\u0026#34;: \u0026#34;failed to save file\u0026#34;}) return } c.JSON(200, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;file uploaded\u0026#34;, \u0026#34;filename\u0026#34;: file.Filename, \u0026#34;size\u0026#34;: file.Size, }) }) 6.2 å¤šæ–‡ä»¶ä¸Šä¼  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 r.POST(\u0026#34;/uploads\u0026#34;, func(c *gin.Context) { form, err := c.MultipartForm() if err != nil { c.JSON(400, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } files := form.File[\u0026#34;files\u0026#34;] var uploadedFiles []string for _, file := range files { dst := \u0026#34;./uploads/\u0026#34; + file.Filename if err := c.SaveUploadedFile(file, dst); err != nil { continue } uploadedFiles = append(uploadedFiles, file.Filename) } c.JSON(200, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;files uploaded\u0026#34;, \u0026#34;files\u0026#34;: uploadedFiles, }) }) ä¸ƒã€æ¨¡æ¿æ¸²æŸ“ 7.1 HTML æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func main() { r := gin.Default() // åŠ è½½æ¨¡æ¿ r.LoadHTMLGlob(\u0026#34;templates/*\u0026#34;) // æˆ–è€… // r.LoadHTMLFiles(\u0026#34;templates/index.html\u0026#34;, \u0026#34;templates/about.html\u0026#34;) r.GET(\u0026#34;/\u0026#34;, func(c *gin.Context) { c.HTML(200, \u0026#34;index.html\u0026#34;, gin.H{ \u0026#34;title\u0026#34;: \u0026#34;é¦–é¡µ\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;æ¬¢è¿ä½¿ç”¨ Gin æ¡†æ¶\u0026#34;, }) }) r.Run(\u0026#34;:8080\u0026#34;) } 7.2 è‡ªå®šä¹‰æ¨¡æ¿å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func main() { r := gin.Default() // æ³¨å†Œè‡ªå®šä¹‰å‡½æ•° r.SetFuncMap(template.FuncMap{ \u0026#34;formatDate\u0026#34;: func(t time.Time) string { return t.Format(\u0026#34;2006-01-02\u0026#34;) }, \u0026#34;upper\u0026#34;: strings.ToUpper, }) r.LoadHTMLGlob(\u0026#34;templates/*\u0026#34;) r.Run(\u0026#34;:8080\u0026#34;) } å…«ã€é”™è¯¯å¤„ç† 8.1 å…¨å±€é”™è¯¯å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func ErrorHandler() gin.HandlerFunc { return func(c *gin.Context) { c.Next() // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ if len(c.Errors) \u0026gt; 0 { err := c.Errors.Last() // æ ¹æ®é”™è¯¯ç±»å‹è¿”å›ä¸åŒå“åº” switch e := err.Err.(type) { case *ValidationError: c.JSON(400, gin.H{\u0026#34;error\u0026#34;: e.Error()}) case *NotFoundError: c.JSON(404, gin.H{\u0026#34;error\u0026#34;: e.Error()}) default: c.JSON(500, gin.H{\u0026#34;error\u0026#34;: \u0026#34;internal server error\u0026#34;}) } } } } 8.2 Panic æ¢å¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func CustomRecovery() gin.HandlerFunc { return func(c *gin.Context) { defer func() { if err := recover(); err != nil { // è®°å½•æ—¥å¿— log.Printf(\u0026#34;Panic recovered: %v\\n%s\u0026#34;, err, debug.Stack()) c.JSON(500, gin.H{ \u0026#34;error\u0026#34;: \u0026#34;internal server error\u0026#34;, }) c.Abort() } }() c.Next() } } ä¹ã€é¡¹ç›®ç»“æ„ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 gin-project/ â”œâ”€â”€ cmd/ â”‚ â””â”€â”€ main.go # åº”ç”¨å…¥å£ â”œâ”€â”€ internal/ â”‚ â”œâ”€â”€ config/ # é…ç½® â”‚ â”‚ â””â”€â”€ config.go â”‚ â”œâ”€â”€ handler/ # å¤„ç†å™¨ â”‚ â”‚ â”œâ”€â”€ user.go â”‚ â”‚ â””â”€â”€ task.go â”‚ â”œâ”€â”€ middleware/ # ä¸­é—´ä»¶ â”‚ â”‚ â”œâ”€â”€ auth.go â”‚ â”‚ â”œâ”€â”€ cors.go â”‚ â”‚ â””â”€â”€ logger.go â”‚ â”œâ”€â”€ model/ # æ•°æ®æ¨¡å‹ â”‚ â”‚ â””â”€â”€ user.go â”‚ â”œâ”€â”€ repository/ # æ•°æ®è®¿é—®å±‚ â”‚ â”‚ â””â”€â”€ user.go â”‚ â”œâ”€â”€ router/ # è·¯ç”±é…ç½® â”‚ â”‚ â””â”€â”€ router.go â”‚ â””â”€â”€ service/ # ä¸šåŠ¡é€»è¾‘ â”‚ â””â”€â”€ user.go â”œâ”€â”€ pkg/ # å…¬å…±åŒ… â”‚ â””â”€â”€ response/ â”‚ â””â”€â”€ response.go â”œâ”€â”€ configs/ # é…ç½®æ–‡ä»¶ â”‚ â””â”€â”€ config.yaml â”œâ”€â”€ go.mod â””â”€â”€ go.sum åã€æ€§èƒ½ä¼˜åŒ– 10.1 ä½¿ç”¨å¯¹è±¡æ±  1 2 3 4 5 6 7 8 9 10 11 12 13 14 var jsonPool = sync.Pool{ New: func() interface{} { return new(bytes.Buffer) }, } func JSONResponse(c *gin.Context, data interface{}) { buf := jsonPool.Get().(*bytes.Buffer) defer jsonPool.Put(buf) buf.Reset() json.NewEncoder(buf).Encode(data) c.Data(200, \u0026#34;application/json\u0026#34;, buf.Bytes()) } 10.2 ç¦ç”¨è°ƒè¯•æ¨¡å¼ 1 2 3 4 5 func main() { gin.SetMode(gin.ReleaseMode) r := gin.New() r.Run(\u0026#34;:8080\u0026#34;) } æ€»ç»“ Gin æ¡†æ¶ä»¥å…¶ç®€æ´çš„ API å’Œå“è¶Šçš„æ€§èƒ½ï¼Œæˆä¸º Go Web å¼€å‘çš„é¦–é€‰æ¡†æ¶ã€‚\næ ¸å¿ƒä¼˜åŠ¿ï¼š\nğŸš€ æ€§èƒ½å“è¶Šï¼ŒåŸºäº httprouter ğŸ“ ç®€æ´çš„ API è®¾è®¡ ğŸ”§ çµæ´»çš„ä¸­é—´ä»¶æœºåˆ¶ âœ… å†…ç½®å‚æ•°éªŒè¯ ğŸ“Š å®Œå–„çš„é”™è¯¯å¤„ç† ","date":"2024-11-05T00:00:00Z","permalink":"https://zpf-zero.github.io/p/gin-framework-guide/","title":"Gin æ¡†æ¶å®æˆ˜æŒ‡å—ï¼šé«˜æ€§èƒ½ Go Web å¼€å‘åˆ©å™¨"},{"content":"å‰è¨€ GORM æ˜¯ Go è¯­è¨€ä¸­æœ€æµè¡Œçš„ ORM æ¡†æ¶ï¼Œæä¾›äº†å¼€å‘è€…å‹å¥½çš„ APIï¼Œæ”¯æŒå¤šç§æ•°æ®åº“ï¼ŒåŒ…æ‹¬ MySQLã€PostgreSQLã€SQLite å’Œ SQL Serverã€‚å®ƒç®€åŒ–äº†æ•°æ®åº“æ“ä½œï¼Œè®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚\nä¸€ã€å¿«é€Ÿå¼€å§‹ 1.1 å®‰è£… 1 2 go get -u gorm.io/gorm go get -u gorm.io/driver/mysql 1.2 è¿æ¥æ•°æ®åº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package main import ( \u0026#34;gorm.io/driver/mysql\u0026#34; \u0026#34;gorm.io/gorm\u0026#34; \u0026#34;gorm.io/gorm/logger\u0026#34; ) func main() { dsn := \u0026#34;user:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4\u0026amp;parseTime=True\u0026amp;loc=Local\u0026#34; db, err := gorm.Open(mysql.Open(dsn), \u0026amp;gorm.Config{ Logger: logger.Default.LogMode(logger.Info), }) if err != nil { panic(\u0026#34;failed to connect database\u0026#34;) } // è·å–åº•å±‚ *sql.DB sqlDB, _ := db.DB() sqlDB.SetMaxIdleConns(10) sqlDB.SetMaxOpenConns(100) sqlDB.SetConnMaxLifetime(time.Hour) } äºŒã€æ¨¡å‹å®šä¹‰ 2.1 åŸºæœ¬æ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type User struct { ID uint `gorm:\u0026#34;primaryKey\u0026#34;` Name string `gorm:\u0026#34;size:100;not null\u0026#34;` Email string `gorm:\u0026#34;uniqueIndex;size:255\u0026#34;` Age int `gorm:\u0026#34;default:18\u0026#34;` Birthday *time.Time CreatedAt time.Time UpdatedAt time.Time DeletedAt gorm.DeletedAt `gorm:\u0026#34;index\u0026#34;` } // è‡ªå®šä¹‰è¡¨å func (User) TableName() string { return \u0026#34;users\u0026#34; } 2.2 å¸¸ç”¨æ ‡ç­¾ 1 2 3 4 5 6 7 8 9 10 type Product struct { ID uint `gorm:\u0026#34;primaryKey;autoIncrement\u0026#34;` Code string `gorm:\u0026#34;column:product_code;size:50;uniqueIndex\u0026#34;` Name string `gorm:\u0026#34;size:200;not null;index\u0026#34;` Price float64 `gorm:\u0026#34;type:decimal(10,2);default:0\u0026#34;` Stock int `gorm:\u0026#34;check:stock \u0026gt;= 0\u0026#34;` Description string `gorm:\u0026#34;type:text\u0026#34;` Status int `gorm:\u0026#34;default:1;comment:çŠ¶æ€ 1-ä¸Šæ¶ 0-ä¸‹æ¶\u0026#34;` CategoryID uint `gorm:\u0026#34;index\u0026#34;` } 2.3 è‡ªåŠ¨è¿ç§» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // è‡ªåŠ¨åˆ›å»ºè¡¨ db.AutoMigrate(\u0026amp;User{}, \u0026amp;Product{}) // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ db.Migrator().HasTable(\u0026amp;User{}) // åˆ›å»ºè¡¨ db.Migrator().CreateTable(\u0026amp;User{}) // åˆ é™¤è¡¨ db.Migrator().DropTable(\u0026amp;User{}) // æ·»åŠ åˆ— db.Migrator().AddColumn(\u0026amp;User{}, \u0026#34;Avatar\u0026#34;) // é‡å‘½ååˆ— db.Migrator().RenameColumn(\u0026amp;User{}, \u0026#34;name\u0026#34;, \u0026#34;full_name\u0026#34;) ä¸‰ã€CRUD æ“ä½œ 3.1 åˆ›å»º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // åˆ›å»ºå•æ¡è®°å½• user := User{Name: \u0026#34;Alice\u0026#34;, Email: \u0026#34;alice@example.com\u0026#34;, Age: 25} result := db.Create(\u0026amp;user) // user.ID ä¼šè¢«è‡ªåŠ¨å¡«å…… // result.RowsAffected è¿”å›åˆ›å»ºçš„è®°å½•æ•° // æ‰¹é‡åˆ›å»º users := []User{ {Name: \u0026#34;Bob\u0026#34;, Email: \u0026#34;bob@example.com\u0026#34;}, {Name: \u0026#34;Charlie\u0026#34;, Email: \u0026#34;charlie@example.com\u0026#34;}, } db.Create(\u0026amp;users) // æ‰¹é‡åˆ›å»ºï¼ˆåˆ†æ‰¹ï¼‰ db.CreateInBatches(\u0026amp;users, 100) // ä½¿ç”¨ Map åˆ›å»º db.Model(\u0026amp;User{}).Create(map[string]interface{}{ \u0026#34;Name\u0026#34;: \u0026#34;David\u0026#34;, \u0026#34;Email\u0026#34;: \u0026#34;david@example.com\u0026#34;, }) // é€‰æ‹©å­—æ®µåˆ›å»º db.Select(\u0026#34;Name\u0026#34;, \u0026#34;Email\u0026#34;).Create(\u0026amp;user) // å¿½ç•¥å­—æ®µåˆ›å»º db.Omit(\u0026#34;Age\u0026#34;).Create(\u0026amp;user) 3.2 æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 // æŸ¥è¯¢å•æ¡ var user User db.First(\u0026amp;user) // æŒ‰ä¸»é”®æ’åºï¼Œè·å–ç¬¬ä¸€æ¡ db.Last(\u0026amp;user) // æŒ‰ä¸»é”®æ’åºï¼Œè·å–æœ€åä¸€æ¡ db.Take(\u0026amp;user) // ä¸æ’åºï¼Œè·å–ä¸€æ¡ db.First(\u0026amp;user, 10) // æ ¹æ®ä¸»é”®æŸ¥è¯¢ db.First(\u0026amp;user, \u0026#34;id = ?\u0026#34;, 10) // æ ¹æ®æ¡ä»¶æŸ¥è¯¢ // æŸ¥è¯¢å¤šæ¡ var users []User db.Find(\u0026amp;users) db.Find(\u0026amp;users, []int{1, 2, 3}) // æ ¹æ®ä¸»é”®åˆ—è¡¨æŸ¥è¯¢ // æ¡ä»¶æŸ¥è¯¢ db.Where(\u0026#34;name = ?\u0026#34;, \u0026#34;Alice\u0026#34;).First(\u0026amp;user) db.Where(\u0026#34;age \u0026gt; ?\u0026#34;, 18).Find(\u0026amp;users) db.Where(\u0026#34;name LIKE ?\u0026#34;, \u0026#34;%ali%\u0026#34;).Find(\u0026amp;users) db.Where(\u0026#34;name IN ?\u0026#34;, []string{\u0026#34;Alice\u0026#34;, \u0026#34;Bob\u0026#34;}).Find(\u0026amp;users) db.Where(\u0026#34;created_at BETWEEN ? AND ?\u0026#34;, startDate, endDate).Find(\u0026amp;users) // ç»“æ„ä½“æ¡ä»¶ db.Where(\u0026amp;User{Name: \u0026#34;Alice\u0026#34;, Age: 25}).Find(\u0026amp;users) // Map æ¡ä»¶ db.Where(map[string]interface{}{\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 25}).Find(\u0026amp;users) // Or æ¡ä»¶ db.Where(\u0026#34;name = ?\u0026#34;, \u0026#34;Alice\u0026#34;).Or(\u0026#34;name = ?\u0026#34;, \u0026#34;Bob\u0026#34;).Find(\u0026amp;users) // Not æ¡ä»¶ db.Not(\u0026#34;name = ?\u0026#34;, \u0026#34;Alice\u0026#34;).Find(\u0026amp;users) // é€‰æ‹©å­—æ®µ db.Select(\u0026#34;name\u0026#34;, \u0026#34;email\u0026#34;).Find(\u0026amp;users) // æ’åº db.Order(\u0026#34;age desc, name\u0026#34;).Find(\u0026amp;users) // åˆ†é¡µ db.Limit(10).Offset(20).Find(\u0026amp;users) // åˆ†ç»„ db.Model(\u0026amp;User{}).Select(\u0026#34;age, count(*) as total\u0026#34;).Group(\u0026#34;age\u0026#34;).Find(\u0026amp;results) // å»é‡ db.Distinct(\u0026#34;name\u0026#34;).Find(\u0026amp;users) 3.3 æ›´æ–° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // ä¿å­˜æ‰€æœ‰å­—æ®µ user.Name = \u0026#34;New Name\u0026#34; db.Save(\u0026amp;user) // æ›´æ–°å•ä¸ªå­—æ®µ db.Model(\u0026amp;user).Update(\u0026#34;name\u0026#34;, \u0026#34;Alice\u0026#34;) // æ›´æ–°å¤šä¸ªå­—æ®µ db.Model(\u0026amp;user).Updates(User{Name: \u0026#34;Alice\u0026#34;, Age: 26}) db.Model(\u0026amp;user).Updates(map[string]interface{}{\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 26}) // æ‰¹é‡æ›´æ–° db.Model(\u0026amp;User{}).Where(\u0026#34;age \u0026lt; ?\u0026#34;, 18).Update(\u0026#34;status\u0026#34;, 0) // é€‰æ‹©å­—æ®µæ›´æ–° db.Model(\u0026amp;user).Select(\u0026#34;Name\u0026#34;, \u0026#34;Age\u0026#34;).Updates(User{Name: \u0026#34;Alice\u0026#34;, Age: 26}) // å¿½ç•¥å­—æ®µæ›´æ–° db.Model(\u0026amp;user).Omit(\u0026#34;Age\u0026#34;).Updates(User{Name: \u0026#34;Alice\u0026#34;, Age: 26}) // ä½¿ç”¨è¡¨è¾¾å¼æ›´æ–° db.Model(\u0026amp;product).Update(\u0026#34;stock\u0026#34;, gorm.Expr(\u0026#34;stock - ?\u0026#34;, 1)) db.Model(\u0026amp;product).UpdateColumn(\u0026#34;stock\u0026#34;, gorm.Expr(\u0026#34;stock + ?\u0026#34;, 10)) 3.4 åˆ é™¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // åˆ é™¤å•æ¡ db.Delete(\u0026amp;user) db.Delete(\u0026amp;user, 10) // æ ¹æ®ä¸»é”®åˆ é™¤ // æ‰¹é‡åˆ é™¤ db.Delete(\u0026amp;User{}, []int{1, 2, 3}) db.Where(\u0026#34;email LIKE ?\u0026#34;, \u0026#34;%test%\u0026#34;).Delete(\u0026amp;User{}) // è½¯åˆ é™¤ï¼ˆéœ€è¦æ¨¡å‹æœ‰ DeletedAt å­—æ®µï¼‰ db.Delete(\u0026amp;user) // UPDATE users SET deleted_at = NOW() WHERE id = 1 // æŸ¥è¯¢åŒ…å«è½¯åˆ é™¤çš„è®°å½• db.Unscoped().Find(\u0026amp;users) // æ°¸ä¹…åˆ é™¤ db.Unscoped().Delete(\u0026amp;user) å››ã€å…³è”æŸ¥è¯¢ 4.1 ä¸€å¯¹ä¸€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type User struct { gorm.Model Name string Profile Profile ProfileID uint } type Profile struct { gorm.Model Bio string Avatar string } // åˆ›å»º db.Create(\u0026amp;User{ Name: \u0026#34;Alice\u0026#34;, Profile: Profile{Bio: \u0026#34;Developer\u0026#34;}, }) // é¢„åŠ è½½æŸ¥è¯¢ db.Preload(\u0026#34;Profile\u0026#34;).Find(\u0026amp;users) // å¸¦æ¡ä»¶çš„é¢„åŠ è½½ db.Preload(\u0026#34;Profile\u0026#34;, \u0026#34;avatar IS NOT NULL\u0026#34;).Find(\u0026amp;users) 4.2 ä¸€å¯¹å¤š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 type User struct { gorm.Model Name string Orders []Order } type Order struct { gorm.Model UserID uint Amount float64 } // é¢„åŠ è½½ db.Preload(\u0026#34;Orders\u0026#34;).Find(\u0026amp;users) // åµŒå¥—é¢„åŠ è½½ db.Preload(\u0026#34;Orders.Items\u0026#34;).Find(\u0026amp;users) // å…³è”åˆ›å»º db.Create(\u0026amp;User{ Name: \u0026#34;Alice\u0026#34;, Orders: []Order{ {Amount: 100}, {Amount: 200}, }, }) // å…³è”è¿½åŠ  db.Model(\u0026amp;user).Association(\u0026#34;Orders\u0026#34;).Append(\u0026amp;Order{Amount: 300}) // å…³è”æ›¿æ¢ db.Model(\u0026amp;user).Association(\u0026#34;Orders\u0026#34;).Replace(\u0026amp;orders) // å…³è”åˆ é™¤ db.Model(\u0026amp;user).Association(\u0026#34;Orders\u0026#34;).Delete(\u0026amp;order) // å…³è”æ¸…ç©º db.Model(\u0026amp;user).Association(\u0026#34;Orders\u0026#34;).Clear() // å…³è”è®¡æ•° count := db.Model(\u0026amp;user).Association(\u0026#34;Orders\u0026#34;).Count() 4.3 å¤šå¯¹å¤š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 type User struct { gorm.Model Name string Roles []Role `gorm:\u0026#34;many2many:user_roles;\u0026#34;` } type Role struct { gorm.Model Name string Users []User `gorm:\u0026#34;many2many:user_roles;\u0026#34;` } // é¢„åŠ è½½ db.Preload(\u0026#34;Roles\u0026#34;).Find(\u0026amp;users) // å…³è”æ“ä½œ db.Model(\u0026amp;user).Association(\u0026#34;Roles\u0026#34;).Append(\u0026amp;roles) db.Model(\u0026amp;user).Association(\u0026#34;Roles\u0026#34;).Replace(\u0026amp;roles) äº”ã€äº‹åŠ¡å¤„ç† 5.1 è‡ªåŠ¨äº‹åŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 err := db.Transaction(func(tx *gorm.DB) error { // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ if err := tx.Create(\u0026amp;user).Error; err != nil { return err // è¿”å›é”™è¯¯ä¼šå›æ»šäº‹åŠ¡ } if err := tx.Create(\u0026amp;order).Error; err != nil { return err } return nil // è¿”å› nil æäº¤äº‹åŠ¡ }) 5.2 æ‰‹åŠ¨äº‹åŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // å¼€å§‹äº‹åŠ¡ tx := db.Begin() // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ if err := tx.Create(\u0026amp;user).Error; err != nil { tx.Rollback() return err } if err := tx.Create(\u0026amp;order).Error; err != nil { tx.Rollback() return err } // æäº¤äº‹åŠ¡ tx.Commit() 5.3 åµŒå¥—äº‹åŠ¡ 1 2 3 4 5 6 7 8 9 10 db.Transaction(func(tx *gorm.DB) error { tx.Create(\u0026amp;user1) tx.Transaction(func(tx2 *gorm.DB) error { tx2.Create(\u0026amp;user2) return nil }) return nil }) 5.4 SavePoint 1 2 3 4 5 6 7 8 tx := db.Begin() tx.Create(\u0026amp;user1) tx.SavePoint(\u0026#34;sp1\u0026#34;) tx.Create(\u0026amp;user2) tx.RollbackTo(\u0026#34;sp1\u0026#34;) // å›æ»šåˆ°ä¿å­˜ç‚¹ tx.Commit() å…­ã€é«˜çº§æŸ¥è¯¢ 6.1 åŸç”Ÿ SQL 1 2 3 4 5 6 7 8 9 // åŸç”ŸæŸ¥è¯¢ var users []User db.Raw(\u0026#34;SELECT * FROM users WHERE age \u0026gt; ?\u0026#34;, 18).Scan(\u0026amp;users) // åŸç”Ÿæ‰§è¡Œ db.Exec(\u0026#34;UPDATE users SET age = ? WHERE name = ?\u0026#34;, 25, \u0026#34;Alice\u0026#34;) // å‘½åå‚æ•° db.Raw(\u0026#34;SELECT * FROM users WHERE name = @name\u0026#34;, sql.Named(\u0026#34;name\u0026#34;, \u0026#34;Alice\u0026#34;)).Scan(\u0026amp;users) 6.2 å­æŸ¥è¯¢ 1 2 3 4 5 6 7 // å­æŸ¥è¯¢ subQuery := db.Model(\u0026amp;Order{}).Select(\u0026#34;AVG(amount)\u0026#34;).Where(\u0026#34;user_id = users.id\u0026#34;) db.Model(\u0026amp;User{}).Select(\u0026#34;users.*, (?) as avg_amount\u0026#34;, subQuery).Find(\u0026amp;users) // FROM å­æŸ¥è¯¢ subQuery := db.Table(\u0026#34;users\u0026#34;).Select(\u0026#34;name\u0026#34;, \u0026#34;age\u0026#34;) db.Table(\u0026#34;(?) as u\u0026#34;, subQuery).Where(\u0026#34;u.age \u0026gt; ?\u0026#34;, 18).Find(\u0026amp;users) 6.3 Joins æŸ¥è¯¢ 1 2 3 4 5 6 7 8 // Inner Join db.Model(\u0026amp;User{}).Select(\u0026#34;users.name, orders.amount\u0026#34;). Joins(\u0026#34;left join orders on orders.user_id = users.id\u0026#34;). Scan(\u0026amp;results) // Joins é¢„åŠ è½½ db.Joins(\u0026#34;Profile\u0026#34;).Find(\u0026amp;users) db.Joins(\u0026#34;Profile\u0026#34;, db.Where(\u0026amp;Profile{Avatar: \u0026#34;default.png\u0026#34;})).Find(\u0026amp;users) 6.4 Scopes 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // å®šä¹‰ Scope func Active(db *gorm.DB) *gorm.DB { return db.Where(\u0026#34;status = ?\u0026#34;, 1) } func AgeGreaterThan(age int) func(db *gorm.DB) *gorm.DB { return func(db *gorm.DB) *gorm.DB { return db.Where(\u0026#34;age \u0026gt; ?\u0026#34;, age) } } func Paginate(page, pageSize int) func(db *gorm.DB) *gorm.DB { return func(db *gorm.DB) *gorm.DB { offset := (page - 1) * pageSize return db.Offset(offset).Limit(pageSize) } } // ä½¿ç”¨ Scope db.Scopes(Active, AgeGreaterThan(18), Paginate(1, 10)).Find(\u0026amp;users) ä¸ƒã€é’©å­å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 type User struct { gorm.Model Name string Password string } // åˆ›å»ºå‰ func (u *User) BeforeCreate(tx *gorm.DB) error { u.Password = hashPassword(u.Password) return nil } // åˆ›å»ºå func (u *User) AfterCreate(tx *gorm.DB) error { // å‘é€æ¬¢è¿é‚®ä»¶ return nil } // æ›´æ–°å‰ func (u *User) BeforeUpdate(tx *gorm.DB) error { if tx.Statement.Changed(\u0026#34;Password\u0026#34;) { u.Password = hashPassword(u.Password) } return nil } // åˆ é™¤å‰ func (u *User) BeforeDelete(tx *gorm.DB) error { // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ é™¤ return nil } // æŸ¥è¯¢å func (u *User) AfterFind(tx *gorm.DB) error { // è§£å¯†æ•æ„Ÿå­—æ®µ return nil } å…«ã€æ€§èƒ½ä¼˜åŒ– 8.1 é¢„åŠ è½½ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 // ä½¿ç”¨ Preload é¿å… N+1 é—®é¢˜ db.Preload(\u0026#34;Orders\u0026#34;).Preload(\u0026#34;Profile\u0026#34;).Find(\u0026amp;users) // ä½¿ç”¨ Joins å‡å°‘æŸ¥è¯¢æ¬¡æ•° db.Joins(\u0026#34;Profile\u0026#34;).Find(\u0026amp;users) // é¢„åŠ è½½æ¡ä»¶ db.Preload(\u0026#34;Orders\u0026#34;, func(db *gorm.DB) *gorm.DB { return db.Order(\u0026#34;orders.amount DESC\u0026#34;).Limit(5) }).Find(\u0026amp;users) 8.2 æ‰¹é‡æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 // æ‰¹é‡æ’å…¥ db.CreateInBatches(\u0026amp;users, 100) // æ‰¹é‡æ›´æ–° db.Model(\u0026amp;User{}).Where(\u0026#34;status = ?\u0026#34;, 0).Updates(map[string]interface{}{\u0026#34;status\u0026#34;: 1}) // FindInBatches db.Where(\u0026#34;status = ?\u0026#34;, 1).FindInBatches(\u0026amp;users, 100, func(tx *gorm.DB, batch int) error { for _, user := range users { // å¤„ç†æ¯æ¡è®°å½• } return nil }) 8.3 ç´¢å¼•ä¼˜åŒ– 1 2 3 4 5 6 7 type User struct { ID uint `gorm:\u0026#34;primaryKey\u0026#34;` Name string `gorm:\u0026#34;index\u0026#34;` // å•åˆ—ç´¢å¼• Email string `gorm:\u0026#34;uniqueIndex\u0026#34;` // å”¯ä¸€ç´¢å¼• Age int `gorm:\u0026#34;index:idx_age_status,priority:1\u0026#34;` // å¤åˆç´¢å¼• Status int `gorm:\u0026#34;index:idx_age_status,priority:2\u0026#34;` } 8.4 è¿æ¥æ± é…ç½® 1 2 3 4 5 6 7 8 9 10 sqlDB, _ := db.DB() // è®¾ç½®ç©ºé—²è¿æ¥æ± ä¸­è¿æ¥çš„æœ€å¤§æ•°é‡ sqlDB.SetMaxIdleConns(10) // è®¾ç½®æ‰“å¼€æ•°æ®åº“è¿æ¥çš„æœ€å¤§æ•°é‡ sqlDB.SetMaxOpenConns(100) // è®¾ç½®è¿æ¥å¯å¤ç”¨çš„æœ€å¤§æ—¶é—´ sqlDB.SetConnMaxLifetime(time.Hour) ä¹ã€æ’ä»¶æ‰©å±• 9.1 è‡ªå®šä¹‰æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 11 12 13 newLogger := logger.New( log.New(os.Stdout, \u0026#34;\\r\\n\u0026#34;, log.LstdFlags), logger.Config{ SlowThreshold: time.Second, LogLevel: logger.Info, IgnoreRecordNotFoundError: true, Colorful: true, }, ) db, _ := gorm.Open(mysql.Open(dsn), \u0026amp;gorm.Config{ Logger: newLogger, }) 9.2 Prometheus æ’ä»¶ 1 2 3 4 5 6 7 8 9 import \u0026#34;gorm.io/plugin/prometheus\u0026#34; db.Use(prometheus.New(prometheus.Config{ DBName: \u0026#34;mydb\u0026#34;, RefreshInterval: 15, MetricsCollector: []prometheus.MetricsCollector{ \u0026amp;prometheus.MySQL{}, }, })) æ€»ç»“ GORM æ˜¯ Go è¯­è¨€ä¸­åŠŸèƒ½æœ€å…¨é¢çš„ ORM æ¡†æ¶ï¼Œæä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½æ¥ç®€åŒ–æ•°æ®åº“æ“ä½œã€‚\næ ¸å¿ƒä¼˜åŠ¿ï¼š\nğŸ“ å¼€å‘è€…å‹å¥½çš„ API ğŸ”— å®Œæ•´çš„å…³è”æ”¯æŒ âš¡ è‡ªåŠ¨è¿ç§»åŠŸèƒ½ ğŸ”§ çµæ´»çš„é’©å­æœºåˆ¶ ğŸš€ ä¼˜ç§€çš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§ ","date":"2024-09-22T00:00:00Z","permalink":"https://zpf-zero.github.io/p/gorm-guide/","title":"GORM å®æˆ˜æŒ‡å—ï¼šGo è¯­è¨€ ORM æ¡†æ¶è¯¦è§£"},{"content":"å‰è¨€ MySQL æ˜¯ä¸–ç•Œä¸Šæœ€æµè¡Œçš„å¼€æºå…³ç³»å‹æ•°æ®åº“ï¼Œè¢«å¹¿æ³›åº”ç”¨äºå„ç§è§„æ¨¡çš„åº”ç”¨ç³»ç»Ÿä¸­ã€‚MySQL 8.0 å¸¦æ¥äº†è®¸å¤šæ–°ç‰¹æ€§ï¼ŒåŒ…æ‹¬çª—å£å‡½æ•°ã€CTEã€JSON å¢å¼ºç­‰ï¼Œè®©æ•°æ®åº“æ“ä½œæ›´åŠ é«˜æ•ˆå’Œçµæ´»ã€‚\nä¸€ã€MySQL åŸºç¡€ 1.1 æ•°æ®åº“æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 -- åˆ›å»ºæ•°æ®åº“ CREATE DATABASE mydb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; -- æŸ¥çœ‹æ•°æ®åº“ SHOW DATABASES; -- ä½¿ç”¨æ•°æ®åº“ USE mydb; -- åˆ é™¤æ•°æ®åº“ DROP DATABASE mydb; 1.2 è¡¨æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 -- åˆ›å»ºè¡¨ CREATE TABLE users ( id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY, username VARCHAR(50) NOT NULL UNIQUE, email VARCHAR(100) NOT NULL, password VARCHAR(255) NOT NULL, age TINYINT UNSIGNED DEFAULT 0, status TINYINT DEFAULT 1 COMMENT \u0026#39;çŠ¶æ€ï¼š1-æ­£å¸¸ 0-ç¦ç”¨\u0026#39;, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, deleted_at TIMESTAMP NULL, INDEX idx_email (email), INDEX idx_status_created (status, created_at) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;ç”¨æˆ·è¡¨\u0026#39;; -- æŸ¥çœ‹è¡¨ç»“æ„ DESC users; SHOW CREATE TABLE users; -- ä¿®æ”¹è¡¨ ALTER TABLE users ADD COLUMN phone VARCHAR(20) AFTER email; ALTER TABLE users MODIFY COLUMN username VARCHAR(100) NOT NULL; ALTER TABLE users DROP COLUMN phone; ALTER TABLE users ADD INDEX idx_phone (phone); ALTER TABLE users DROP INDEX idx_phone; -- é‡å‘½åè¡¨ RENAME TABLE users TO members; -- åˆ é™¤è¡¨ DROP TABLE IF EXISTS users; äºŒã€CRUD æ“ä½œ 2.1 æ’å…¥æ•°æ® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 -- æ’å…¥å•æ¡ INSERT INTO users (username, email, password, age) VALUES (\u0026#39;alice\u0026#39;, \u0026#39;alice@example.com\u0026#39;, \u0026#39;hash123\u0026#39;, 25); -- æ’å…¥å¤šæ¡ INSERT INTO users (username, email, password, age) VALUES (\u0026#39;bob\u0026#39;, \u0026#39;bob@example.com\u0026#39;, \u0026#39;hash456\u0026#39;, 30), (\u0026#39;charlie\u0026#39;, \u0026#39;charlie@example.com\u0026#39;, \u0026#39;hash789\u0026#39;, 28); -- æ’å…¥æˆ–æ›´æ–° INSERT INTO users (username, email, password) VALUES (\u0026#39;alice\u0026#39;, \u0026#39;new@example.com\u0026#39;, \u0026#39;newhash\u0026#39;) ON DUPLICATE KEY UPDATE email = VALUES(email), password = VALUES(password); -- æ’å…¥å¿½ç•¥é‡å¤ INSERT IGNORE INTO users (username, email, password) VALUES (\u0026#39;alice\u0026#39;, \u0026#39;alice@example.com\u0026#39;, \u0026#39;hash123\u0026#39;); -- ä»æŸ¥è¯¢ç»“æœæ’å…¥ INSERT INTO users_backup SELECT * FROM users WHERE status = 1; 2.2 æŸ¥è¯¢æ•°æ® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 -- åŸºæœ¬æŸ¥è¯¢ SELECT * FROM users; SELECT id, username, email FROM users; -- æ¡ä»¶æŸ¥è¯¢ SELECT * FROM users WHERE age \u0026gt; 20 AND status = 1; SELECT * FROM users WHERE age BETWEEN 20 AND 30; SELECT * FROM users WHERE username IN (\u0026#39;alice\u0026#39;, \u0026#39;bob\u0026#39;); SELECT * FROM users WHERE email LIKE \u0026#39;%@gmail.com\u0026#39;; SELECT * FROM users WHERE deleted_at IS NULL; -- æ’åº SELECT * FROM users ORDER BY created_at DESC, id ASC; -- åˆ†é¡µ SELECT * FROM users LIMIT 10 OFFSET 0; -- ç¬¬ä¸€é¡µ SELECT * FROM users LIMIT 10 OFFSET 10; -- ç¬¬äºŒé¡µ -- å»é‡ SELECT DISTINCT status FROM users; -- èšåˆå‡½æ•° SELECT COUNT(*) as total FROM users; SELECT AVG(age) as avg_age FROM users WHERE status = 1; SELECT MAX(age), MIN(age), SUM(age) FROM users; -- åˆ†ç»„ SELECT status, COUNT(*) as count FROM users GROUP BY status HAVING count \u0026gt; 10; -- è”åˆæŸ¥è¯¢ SELECT username FROM users WHERE status = 1 UNION SELECT username FROM admins WHERE status = 1; 2.3 æ›´æ–°æ•°æ® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -- æ›´æ–°å•æ¡ UPDATE users SET email = \u0026#39;newemail@example.com\u0026#39; WHERE id = 1; -- æ›´æ–°å¤šä¸ªå­—æ®µ UPDATE users SET status = 0, updated_at = NOW() WHERE age \u0026lt; 18; -- æ‰¹é‡æ›´æ–° UPDATE users SET age = age + 1 WHERE YEAR(created_at) = 2024; -- ä½¿ç”¨ CASE æ›´æ–° UPDATE users SET status = CASE WHEN age \u0026lt; 18 THEN 0 WHEN age \u0026gt;= 60 THEN 2 ELSE 1 END; 2.4 åˆ é™¤æ•°æ® 1 2 3 4 5 6 7 8 9 10 11 -- åˆ é™¤å•æ¡ DELETE FROM users WHERE id = 1; -- æ‰¹é‡åˆ é™¤ DELETE FROM users WHERE status = 0; -- æ¸…ç©ºè¡¨ TRUNCATE TABLE users; -- è½¯åˆ é™¤ï¼ˆæ¨èï¼‰ UPDATE users SET deleted_at = NOW() WHERE id = 1; ä¸‰ã€JOIN æŸ¥è¯¢ 3.1 è¡¨å…³è” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 -- åˆ›å»ºè®¢å•è¡¨ CREATE TABLE orders ( id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY, user_id BIGINT UNSIGNED NOT NULL, amount DECIMAL(10,2) NOT NULL, status TINYINT DEFAULT 0, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, INDEX idx_user_id (user_id) ); -- INNER JOIN SELECT u.username, o.amount FROM users u INNER JOIN orders o ON u.id = o.user_id; -- LEFT JOIN SELECT u.username, o.amount FROM users u LEFT JOIN orders o ON u.id = o.user_id; -- RIGHT JOIN SELECT u.username, o.amount FROM users u RIGHT JOIN orders o ON u.id = o.user_id; -- å¤šè¡¨è”æŸ¥ SELECT u.username, o.amount, p.name as product FROM users u JOIN orders o ON u.id = o.user_id JOIN order_items oi ON o.id = oi.order_id JOIN products p ON oi.product_id = p.id; -- è‡ªè¿æ¥ SELECT e1.name as employee, e2.name as manager FROM employees e1 LEFT JOIN employees e2 ON e1.manager_id = e2.id; å››ã€å­æŸ¥è¯¢ 4.1 æ ‡é‡å­æŸ¥è¯¢ 1 2 3 -- æŸ¥è¯¢æ¶ˆè´¹æœ€é«˜çš„ç”¨æˆ· SELECT * FROM users WHERE id = (SELECT user_id FROM orders GROUP BY user_id ORDER BY SUM(amount) DESC LIMIT 1); 4.2 åˆ—å­æŸ¥è¯¢ 1 2 3 4 5 -- æŸ¥è¯¢æœ‰è®¢å•çš„ç”¨æˆ· SELECT * FROM users WHERE id IN (SELECT DISTINCT user_id FROM orders); -- æŸ¥è¯¢æ²¡æœ‰è®¢å•çš„ç”¨æˆ· SELECT * FROM users WHERE id NOT IN (SELECT DISTINCT user_id FROM orders); 4.3 è¡Œå­æŸ¥è¯¢ 1 2 3 -- æŸ¥è¯¢ä¸ Alice å¹´é¾„å’ŒçŠ¶æ€ç›¸åŒçš„ç”¨æˆ· SELECT * FROM users WHERE (age, status) = (SELECT age, status FROM users WHERE username = \u0026#39;alice\u0026#39;); 4.4 EXISTS å­æŸ¥è¯¢ 1 2 3 -- æŸ¥è¯¢æœ‰è®¢å•çš„ç”¨æˆ· SELECT * FROM users u WHERE EXISTS (SELECT 1 FROM orders o WHERE o.user_id = u.id); äº”ã€MySQL 8.0 æ–°ç‰¹æ€§ 5.1 çª—å£å‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 -- ROW_NUMBERï¼šè¡Œå· SELECT username, age, ROW_NUMBER() OVER (ORDER BY age DESC) as row_num FROM users; -- RANKï¼šæ’åï¼ˆæœ‰å¹¶åˆ—ï¼‰ SELECT username, age, RANK() OVER (ORDER BY age DESC) as rank_num FROM users; -- DENSE_RANKï¼šå¯†é›†æ’å SELECT username, age, DENSE_RANK() OVER (ORDER BY age DESC) as dense_rank_num FROM users; -- åˆ†ç»„æ’å SELECT username, status, age, ROW_NUMBER() OVER (PARTITION BY status ORDER BY age DESC) as rank_in_status FROM users; -- LAG / LEADï¼šå‰åè¡Œå€¼ SELECT username, age, LAG(age, 1) OVER (ORDER BY id) as prev_age, LEAD(age, 1) OVER (ORDER BY id) as next_age FROM users; -- ç´¯è®¡æ±‚å’Œ SELECT username, amount, SUM(amount) OVER (ORDER BY created_at) as running_total FROM orders; 5.2 CTEï¼ˆå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 -- åŸºæœ¬ CTE WITH active_users AS ( SELECT * FROM users WHERE status = 1 ) SELECT * FROM active_users WHERE age \u0026gt; 20; -- å¤šä¸ª CTE WITH user_orders AS ( SELECT user_id, COUNT(*) as order_count, SUM(amount) as total_amount FROM orders GROUP BY user_id ), vip_users AS ( SELECT user_id FROM user_orders WHERE total_amount \u0026gt; 10000 ) SELECT u.*, uo.order_count, uo.total_amount FROM users u JOIN user_orders uo ON u.id = uo.user_id WHERE u.id IN (SELECT user_id FROM vip_users); -- é€’å½’ CTE WITH RECURSIVE category_tree AS ( SELECT id, name, parent_id, 1 as level FROM categories WHERE parent_id IS NULL UNION ALL SELECT c.id, c.name, c.parent_id, ct.level + 1 FROM categories c JOIN category_tree ct ON c.parent_id = ct.id ) SELECT * FROM category_tree; 5.3 JSON æ”¯æŒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 -- åˆ›å»ºå¸¦ JSON å­—æ®µçš„è¡¨ CREATE TABLE products ( id BIGINT PRIMARY KEY, name VARCHAR(100), attributes JSON ); -- æ’å…¥ JSON æ•°æ® INSERT INTO products VALUES (1, \u0026#39;iPhone\u0026#39;, \u0026#39;{\u0026#34;color\u0026#34;: \u0026#34;black\u0026#34;, \u0026#34;storage\u0026#34;: 256, \u0026#34;features\u0026#34;: [\u0026#34;5G\u0026#34;, \u0026#34;Face ID\u0026#34;]}\u0026#39;); -- æŸ¥è¯¢ JSON å­—æ®µ SELECT name, attributes-\u0026gt;\u0026gt;\u0026#39;$.color\u0026#39; as color FROM products; SELECT name, JSON_EXTRACT(attributes, \u0026#39;$.storage\u0026#39;) as storage FROM products; -- JSON æ¡ä»¶æŸ¥è¯¢ SELECT * FROM products WHERE attributes-\u0026gt;\u0026gt;\u0026#39;$.color\u0026#39; = \u0026#39;black\u0026#39;; SELECT * FROM products WHERE JSON_CONTAINS(attributes, \u0026#39;\u0026#34;5G\u0026#34;\u0026#39;, \u0026#39;$.features\u0026#39;); -- æ›´æ–° JSON UPDATE products SET attributes = JSON_SET(attributes, \u0026#39;$.price\u0026#39;, 999) WHERE id = 1; UPDATE products SET attributes = JSON_REMOVE(attributes, \u0026#39;$.features\u0026#39;) WHERE id = 1; å…­ã€ç´¢å¼•ä¼˜åŒ– 6.1 ç´¢å¼•ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 -- B+Tree ç´¢å¼•ï¼ˆé»˜è®¤ï¼‰ CREATE INDEX idx_username ON users(username); -- å”¯ä¸€ç´¢å¼• CREATE UNIQUE INDEX idx_email ON users(email); -- å¤åˆç´¢å¼• CREATE INDEX idx_status_created ON users(status, created_at); -- å‰ç¼€ç´¢å¼• CREATE INDEX idx_email_prefix ON users(email(10)); -- å…¨æ–‡ç´¢å¼• CREATE FULLTEXT INDEX idx_content ON articles(content); -- æŸ¥çœ‹ç´¢å¼• SHOW INDEX FROM users; 6.2 ç´¢å¼•ä¼˜åŒ–åŸåˆ™ 1 2 3 4 5 6 7 8 9 10 11 12 13 -- æœ€å·¦å‰ç¼€åŸåˆ™ -- å¤åˆç´¢å¼• (a, b, c) å¯ä»¥ç”¨äºï¼š -- WHERE a = 1 -- WHERE a = 1 AND b = 2 -- WHERE a = 1 AND b = 2 AND c = 3 -- ä½†ä¸èƒ½ç”¨äº WHERE b = 2 æˆ– WHERE c = 3 -- è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰ SELECT id, username FROM users WHERE username = \u0026#39;alice\u0026#39;; -- å¦‚æœæœ‰ç´¢å¼• (username)ï¼ŒåŒ…å«äº†æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ— -- ç´¢å¼•ä¸‹æ¨ï¼ˆICPï¼‰ -- MySQL 5.6+ æ”¯æŒï¼Œåœ¨ç´¢å¼•å±‚é¢è¿›è¡Œæ¡ä»¶è¿‡æ»¤ 6.3 EXPLAIN åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 -- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ EXPLAIN SELECT * FROM users WHERE username = \u0026#39;alice\u0026#39;; -- è¯¦ç»†æ ¼å¼ EXPLAIN FORMAT=JSON SELECT * FROM users WHERE status = 1; -- å…³é”®å­—æ®µè§£é‡Šï¼š -- type: ALL(å…¨è¡¨) \u0026gt; index \u0026gt; range \u0026gt; ref \u0026gt; eq_ref \u0026gt; const \u0026gt; system -- key: ä½¿ç”¨çš„ç´¢å¼• -- rows: æ‰«æçš„è¡Œæ•° -- Extra: é¢å¤–ä¿¡æ¯ï¼ˆUsing index, Using filesort, Using temporaryï¼‰ ä¸ƒã€äº‹åŠ¡å¤„ç† 7.1 äº‹åŠ¡åŸºç¡€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 -- å¼€å§‹äº‹åŠ¡ START TRANSACTION; -- æˆ– BEGIN; -- æ‰§è¡Œæ“ä½œ UPDATE accounts SET balance = balance - 100 WHERE id = 1; UPDATE accounts SET balance = balance + 100 WHERE id = 2; -- æäº¤äº‹åŠ¡ COMMIT; -- å›æ»šäº‹åŠ¡ ROLLBACK; -- è®¾ç½®ä¿å­˜ç‚¹ SAVEPOINT sp1; ROLLBACK TO sp1; 7.2 äº‹åŠ¡éš”ç¦»çº§åˆ« 1 2 3 4 5 6 7 8 9 10 11 -- æŸ¥çœ‹éš”ç¦»çº§åˆ« SELECT @@transaction_isolation; -- è®¾ç½®éš”ç¦»çº§åˆ« SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; -- éš”ç¦»çº§åˆ«ï¼š -- READ UNCOMMITTED: è¯»æœªæäº¤ï¼ˆè„è¯»ï¼‰ -- READ COMMITTED: è¯»å·²æäº¤ï¼ˆä¸å¯é‡å¤è¯»ï¼‰ -- REPEATABLE READ: å¯é‡å¤è¯»ï¼ˆé»˜è®¤ï¼Œå¹»è¯»ï¼‰ -- SERIALIZABLE: ä¸²è¡ŒåŒ–ï¼ˆæœ€ä¸¥æ ¼ï¼‰ 7.3 é”æœºåˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 -- å…±äº«é”ï¼ˆè¯»é”ï¼‰ SELECT * FROM users WHERE id = 1 LOCK IN SHARE MODE; -- MySQL 8.0+ SELECT * FROM users WHERE id = 1 FOR SHARE; -- æ’ä»–é”ï¼ˆå†™é”ï¼‰ SELECT * FROM users WHERE id = 1 FOR UPDATE; -- è·³è¿‡é”å®šçš„è¡Œ SELECT * FROM users WHERE status = 1 FOR UPDATE SKIP LOCKED; -- ä¸ç­‰å¾…é” SELECT * FROM users WHERE id = 1 FOR UPDATE NOWAIT; å…«ã€æ€§èƒ½ä¼˜åŒ– 8.1 æŸ¥è¯¢ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 -- é¿å… SELECT * SELECT id, username FROM users; -- å¥½ SELECT * FROM users; -- é¿å… -- é¿å…åœ¨ WHERE ä¸­ä½¿ç”¨å‡½æ•° WHERE YEAR(created_at) = 2024; -- é¿å… WHERE created_at \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND created_at \u0026lt; \u0026#39;2025-01-01\u0026#39;; -- å¥½ -- ä½¿ç”¨ LIMIT SELECT * FROM users ORDER BY id LIMIT 100; -- æ‰¹é‡æ’å…¥ INSERT INTO users VALUES (...), (...), (...); -- å¥½ -- é¿å…å¤šæ¬¡å•æ¡æ’å…¥ -- ä½¿ç”¨ UNION ALL æ›¿ä»£ UNIONï¼ˆå½“ä¸éœ€è¦å»é‡æ—¶ï¼‰ SELECT ... UNION ALL SELECT ...; 8.2 é…ç½®ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # my.cnf å…³é”®é…ç½® # InnoDB ç¼“å†²æ± ï¼ˆå»ºè®®ä¸ºç‰©ç†å†…å­˜çš„ 70-80%ï¼‰ innodb_buffer_pool_size = 4G # æ—¥å¿—æ–‡ä»¶å¤§å° innodb_log_file_size = 256M # è¿æ¥æ•° max_connections = 500 # æŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL 8.0 å·²ç§»é™¤ï¼‰ # query_cache_type = 1 # query_cache_size = 64M # ä¸´æ—¶è¡¨ tmp_table_size = 64M max_heap_table_size = 64M # æ’åºç¼“å†² sort_buffer_size = 4M # è¿æ¥ç¼“å†² join_buffer_size = 4M 8.3 æ…¢æŸ¥è¯¢åˆ†æ 1 2 3 4 5 6 7 8 9 -- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— SET GLOBAL slow_query_log = 1; SET GLOBAL long_query_time = 1; -- æŸ¥çœ‹æ…¢æŸ¥è¯¢ SHOW VARIABLES LIKE \u0026#39;slow_query_log%\u0026#39;; -- ä½¿ç”¨ pt-query-digest åˆ†æ -- pt-query-digest /var/log/mysql/slow.log ä¹ã€é«˜å¯ç”¨æ¶æ„ 9.1 ä¸»ä»å¤åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 -- ä¸»åº“é…ç½® [mysqld] server-id = 1 log-bin = mysql-bin binlog-format = ROW -- åˆ›å»ºå¤åˆ¶ç”¨æˆ· CREATE USER \u0026#39;repl\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;password\u0026#39;; GRANT REPLICATION SLAVE ON *.* TO \u0026#39;repl\u0026#39;@\u0026#39;%\u0026#39;; -- æŸ¥çœ‹ä¸»åº“çŠ¶æ€ SHOW MASTER STATUS; -- ä»åº“é…ç½® CHANGE MASTER TO MASTER_HOST=\u0026#39;master_host\u0026#39;, MASTER_USER=\u0026#39;repl\u0026#39;, MASTER_PASSWORD=\u0026#39;password\u0026#39;, MASTER_LOG_FILE=\u0026#39;mysql-bin.000001\u0026#39;, MASTER_LOG_POS=154; START SLAVE; SHOW SLAVE STATUS\\G 9.2 è¯»å†™åˆ†ç¦» 1 2 3 4 5 -- åº”ç”¨å±‚å®ç°è¯»å†™åˆ†ç¦» -- å†™æ“ä½œ -\u0026gt; ä¸»åº“ -- è¯»æ“ä½œ -\u0026gt; ä»åº“ -- ä½¿ç”¨ä¸­é—´ä»¶ï¼ˆå¦‚ ProxySQLã€MaxScaleï¼‰å®ç°é€æ˜è¯»å†™åˆ†ç¦» æ€»ç»“ MySQL æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”æˆç†Ÿçš„å…³ç³»å‹æ•°æ®åº“ï¼ŒæŒæ¡å…¶æ ¸å¿ƒçŸ¥è¯†å¯¹äºåç«¯å¼€å‘è‡³å…³é‡è¦ã€‚\næ ¸å¿ƒè¦ç‚¹ï¼š\nğŸ“ ç†Ÿç»ƒæŒæ¡ SQL è¯­æ³• ğŸ” ç†è§£ç´¢å¼•åŸç†å’Œä¼˜åŒ– ğŸ”’ æŒæ¡äº‹åŠ¡å’Œé”æœºåˆ¶ âš¡ å­¦ä¼šæŸ¥è¯¢æ€§èƒ½ä¼˜åŒ– ğŸ—ï¸ äº†è§£é«˜å¯ç”¨æ¶æ„è®¾è®¡ ","date":"2024-01-25T00:00:00Z","permalink":"https://zpf-zero.github.io/p/mysql-guide/","title":"MySQL 8.0 å®æˆ˜æŒ‡å—ï¼šä»å…¥é—¨åˆ°æ€§èƒ½ä¼˜åŒ–"},{"content":"ä½œä¸ºä¸€åç¨‹åºå‘˜ï¼Œæˆ‘ä»¬å¾€å¾€è¿‡äºä¸“æ³¨äºæŠ€æœ¯æœ¬èº«â€”â€”å­¦ä¹ æ–°æ¡†æ¶ã€æŒæ¡æ–°è¯­è¨€ã€ç ”ç©¶æ–°ç®—æ³•ã€‚ç„¶è€Œï¼ŒçœŸæ­£ä¼˜ç§€çš„ç¨‹åºå‘˜ï¼Œä¸ä»…ä»…æ˜¯ä»£ç çš„æ¬è¿å·¥ï¼Œæ›´æ˜¯å…·å¤‡å…¨é¢ç´ å…»çš„æŠ€æœ¯äººæ‰ã€‚ä»Šå¤©ï¼Œè®©æˆ‘ä»¬èŠèŠé‚£äº›ä»£ç ä¹‹å¤–çš„ã€Œè‡ªæˆ‘ä¿®å…»ã€ã€‚\nğŸ§  æŒç»­å­¦ä¹ ï¼šä¿æŒé¥¥é¥¿æ„Ÿ åœ¨è¿™ä¸ªè¡Œä¸šé‡Œï¼Œå”¯ä¸€ä¸å˜çš„å°±æ˜¯å˜åŒ–æœ¬èº«ã€‚\næŠ€æœ¯æ›´æ–°è¿­ä»£çš„é€Ÿåº¦ä»¤äººå’‹èˆŒã€‚åå¹´å‰æµè¡Œçš„æŠ€æœ¯æ ˆï¼Œä»Šå¤©å¯èƒ½å·²ç»æ— äººé—®æ´¥ã€‚ä½œä¸ºç¨‹åºå‘˜ï¼Œæˆ‘ä»¬å¿…é¡»ä¿æŒæŒç»­å­¦ä¹ çš„çŠ¶æ€ï¼š\nå¹¿åº¦ä¸æ·±åº¦å¹¶é‡ï¼šæ—¢è¦äº†è§£è¡Œä¸šè¶‹åŠ¿ï¼Œä¹Ÿè¦åœ¨æŸä¸ªé¢†åŸŸæ·±è€• å­¦ä¼šå­¦ä¹ ï¼šæŒæ¡é«˜æ•ˆçš„å­¦ä¹ æ–¹æ³•æ¯”å­¦ä¹ å…·ä½“æŠ€æœ¯æ›´é‡è¦ è¾“å‡ºå€’é€¼è¾“å…¥ï¼šå†™åšå®¢ã€åšåˆ†äº«ï¼Œç”¨è¾“å‡ºæ¥æ£€éªŒå’Œå·©å›ºå­¦ä¹ æˆæœ ğŸ“ ä»£ç ä¹‹å¤–çš„æ²Ÿé€šèƒ½åŠ› å¾ˆå¤šäººè®¤ä¸ºç¨‹åºå‘˜åªéœ€è¦å’Œç”µè„‘æ‰“äº¤é“ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„è¯¯è§£ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ï¼š\nä¸äººæ²Ÿé€š ç†è§£äº§å“ç»ç†çš„éœ€æ±‚ï¼ˆå³ä½¿æœ‰æ—¶å€™ä»–ä»¬è‡ªå·±éƒ½ä¸æ¸…æ¥šï¼‰ ä¸è®¾è®¡å¸ˆåä½œï¼Œç¡®ä¿æŠ€æœ¯å®ç°ä¸è®¾è®¡æ„å›¾ä¸€è‡´ å‘éæŠ€æœ¯äººå‘˜è§£é‡Šå¤æ‚çš„æŠ€æœ¯æ¦‚å¿µ ä¸ä»£ç æ²Ÿé€š å†™å‡ºè‡ªæ–‡æ¡£åŒ–çš„ä»£ç ï¼Œè®©ä»£ç æœ¬èº«å°±èƒ½è¯´æ˜æ„å›¾ ç¼–å†™æ¸…æ™°çš„æ³¨é‡Šå’Œæ–‡æ¡£ Code Review æ—¶ç»™å‡ºå»ºè®¾æ€§çš„åé¦ˆ 1 2 3 4 5 6 7 8 # ä¸å¥½çš„å‘½å def calc(a, b): return a * b * 0.8 # å¥½çš„å‘½å def calculate_discounted_price(original_price, quantity, discount_rate=0.8): \u0026#34;\u0026#34;\u0026#34;è®¡ç®—æŠ˜æ‰£åçš„æ€»ä»·\u0026#34;\u0026#34;\u0026#34; return original_price * quantity * discount_rate ğŸ”§ å·¥ç¨‹æ€ç»´ï¼šä¸åªæ˜¯å†™ä»£ç  ä¼˜ç§€çš„ç¨‹åºå‘˜å…·å¤‡å·¥ç¨‹æ€ç»´ï¼Œä»–ä»¬å…³æ³¨çš„ä¸ä»…ä»…æ˜¯åŠŸèƒ½å®ç°ï¼š\nç»´åº¦ å…³æ³¨ç‚¹ å¯ç»´æŠ¤æ€§ ä»£ç æ˜¯å¦æ˜“äºç†è§£å’Œä¿®æ”¹ï¼Ÿ å¯æ‰©å±•æ€§ ç³»ç»Ÿèƒ½å¦é€‚åº”æœªæ¥çš„éœ€æ±‚å˜åŒ–ï¼Ÿ æ€§èƒ½ æ˜¯å¦æ»¡è¶³æ€§èƒ½è¦æ±‚ï¼Ÿæœ‰æ— ä¼˜åŒ–ç©ºé—´ï¼Ÿ å®‰å…¨æ€§ æ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´ï¼Ÿ å¯æµ‹è¯•æ€§ ä»£ç æ˜¯å¦ä¾¿äºæµ‹è¯•ï¼Ÿ ğŸ¯ è§£å†³é—®é¢˜è€Œéå †ç ŒæŠ€æœ¯ è®°ä½è¿™ä¸ªé»„é‡‘æ³•åˆ™ï¼š\næŠ€æœ¯æ˜¯æ‰‹æ®µï¼Œè§£å†³é—®é¢˜æ‰æ˜¯ç›®çš„ã€‚\nä¸è¦ä¸ºäº†ç”¨æ–°æŠ€æœ¯è€Œç”¨æ–°æŠ€æœ¯ã€‚é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶åº”è¯¥è€ƒè™‘ï¼š\nå›¢é˜Ÿç†Ÿæ‚‰ç¨‹åº¦ï¼šæ–°æŠ€æœ¯çš„å­¦ä¹ æˆæœ¬ ç¤¾åŒºæ´»è·ƒåº¦ï¼šé‡åˆ°é—®é¢˜èƒ½å¦æ‰¾åˆ°è§£å†³æ–¹æ¡ˆ é¡¹ç›®é€‚é…æ€§ï¼šæ˜¯å¦çœŸçš„é€‚åˆå½“å‰é¡¹ç›® é•¿æœŸç»´æŠ¤æˆæœ¬ï¼šæŠ€æœ¯å€ºåŠ¡çš„å½±å“ ğŸ’ª èº«å¿ƒå¥åº·ï¼šå¯æŒç»­å‘å±• ç¨‹åºå‘˜çš„å·¥ä½œå¼ºåº¦å¾€å¾€å¾ˆå¤§ï¼Œä½†é€æ”¯å¥åº·æ¢æ¥çš„æ•ˆç‡æ˜¯ä¸å¯æŒç»­çš„ï¼š\nä¿æŠ¤çœ¼ç›ï¼šéµå¾ª 20-20-20 æ³•åˆ™ï¼ˆæ¯20åˆ†é’Ÿçœ‹20è‹±å°ºå¤–20ç§’ï¼‰ ä¿æŒè¿åŠ¨ï¼šä¹…åæ˜¯å¥åº·çš„å¤§æ•Œï¼Œå®šæœŸç«™èµ·æ¥æ´»åŠ¨ ä¿è¯ç¡çœ ï¼šç¡çœ ä¸è¶³ä¼šä¸¥é‡å½±å“è®¤çŸ¥èƒ½åŠ›å’Œåˆ›é€ åŠ› å¿ƒç†å¥åº·ï¼šå­¦ä¼šæ’è§£å‹åŠ›ï¼Œä¿æŒå·¥ä½œä¸ç”Ÿæ´»çš„å¹³è¡¡ ğŸŒŸ åŸ¹å…»äº§å“æ„è¯† ä¼˜ç§€çš„ç¨‹åºå‘˜ä¸åªæ˜¯æ‰§è¡Œè€…ï¼Œæ›´æ˜¯åˆ›é€ è€…ï¼š\nç«™åœ¨ç”¨æˆ·è§’åº¦æ€è€ƒé—®é¢˜ ç†è§£ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸ä»…ä»…æ˜¯æŠ€æœ¯å®ç° ä¸»åŠ¨æå‡ºæ”¹è¿›å»ºè®®ï¼Œè€Œä¸æ˜¯è¢«åŠ¨æ¥å—éœ€æ±‚ ğŸ“š æ¨èé˜…è¯» å¦‚æœä½ æƒ³è¿›ä¸€æ­¥æå‡è‡ªå·±çš„ä¿®å…»ï¼Œè¿™äº›ä¹¦ç±å€¼å¾—ä¸€è¯»ï¼š\nã€Šç¨‹åºå‘˜ä¿®ç‚¼ä¹‹é“ã€‹- ä»å°å·¥åˆ°ä¸“å®¶çš„å®è·µæŒ‡å— ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹- å†™å‡ºä¼˜é›…ä»£ç çš„è‰ºæœ¯ ã€Šé‡æ„ã€‹- æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ ã€Šäººæœˆç¥è¯ã€‹- è½¯ä»¶å·¥ç¨‹çš„ç»å…¸ä¹‹ä½œ ã€Šè½¯æŠ€èƒ½ï¼šä»£ç ä¹‹å¤–çš„ç”Ÿå­˜æŒ‡å—ã€‹- ç¨‹åºå‘˜çš„å…¨é¢æˆé•¿æ‰‹å†Œ å†™åœ¨æœ€å ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼Œæœ¬è´¨ä¸Šæ˜¯å¯¹ã€Œæˆä¸ºæ›´å¥½çš„è‡ªå·±ã€çš„è¿½æ±‚ã€‚æŠ€æœ¯ä¼šè¿‡æ—¶ï¼Œä½†è§£å†³é—®é¢˜çš„èƒ½åŠ›ã€å­¦ä¹ çš„èƒ½åŠ›ã€æ²Ÿé€šçš„èƒ½åŠ›ï¼Œè¿™äº›è½¯å®åŠ›ä¼šä¼´éšæˆ‘ä»¬çš„æ•´ä¸ªèŒä¸šç”Ÿæ¶¯ã€‚\nå…±å‹‰ï¼ğŸš€\nå¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚\n","date":"2023-12-23T00:00:00Z","permalink":"https://zpf-zero.github.io/p/programmer-self-cultivation/","title":"ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»"},{"content":"ç‹¬è‡ªä¸€äººåœ¨é™Œç”Ÿçš„åŸå¸‚æ‰“æ‹¼ï¼Œæ˜¯å¾ˆå¤šå¹´è½»äººçš„çœŸå®å†™ç…§ã€‚è¿œç¦»å®¶ä¹¡ã€è¿œç¦»çˆ¶æ¯ã€è¿œç¦»ç†Ÿæ‚‰çš„ä¸€åˆ‡ï¼Œé‚£ç§æ¼‚æ³Šæ„Ÿå’Œä¸å®‰å…¨æ„Ÿï¼Œåªæœ‰ç»å†è¿‡çš„äººæ‰èƒ½çœŸæ­£ä½“ä¼šã€‚\nä½†å®‰å…¨æ„Ÿè¿™ä»¶äº‹ï¼Œä»æ¥éƒ½ä¸æ˜¯åˆ«äººç»™çš„ï¼Œè€Œæ˜¯è‡ªå·±ä¸€ç‚¹ç‚¹å»ºç«‹èµ·æ¥çš„ã€‚\nğŸ’° ç»æµç‹¬ç«‹æ˜¯å®‰å…¨æ„Ÿçš„åŸºçŸ³ é’±ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä½†æ²¡æœ‰é’±æ˜¯ä¸‡ä¸‡ä¸èƒ½çš„ã€‚\nè¿™å¥è¯è™½ç„¶ä¿—ï¼Œä½†ç¡®å®æ˜¯çœŸç†ã€‚åœ¨å¤–æ‰“æ‹¼ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯è®©è‡ªå·±ç»æµç‹¬ç«‹ï¼š\nå»ºç«‹åº”æ€¥èµ„é‡‘ ç›®æ ‡ï¼šå­˜å¤Ÿ 3-6 ä¸ªæœˆçš„ç”Ÿæ´»è´¹ä½œä¸ºåº”æ€¥èµ„é‡‘ ä½œç”¨ï¼šå¤±ä¸šã€ç”Ÿç—…ã€çªå‘çŠ¶å†µæ—¶ä¸è‡³äºæ‰‹è¶³æ— æª æ–¹æ³•ï¼šæ¯æœˆå·¥èµ„åˆ°è´¦åï¼Œå…ˆå­˜ 10%-20%ï¼Œå‰©ä¸‹çš„æ‰æ˜¯å¯æ”¯é…æ”¶å…¥ å­¦ä¼šç†è´¢ èµ„é‡‘ç±»å‹ å»ºè®®æ¯”ä¾‹ å­˜æ”¾ä½ç½® åº”æ€¥èµ„é‡‘ 10-20% è´§å¸åŸºé‡‘/æ´»æœŸ æ—¥å¸¸å¼€é”€ 50-60% é“¶è¡Œå¡ æŠ•èµ„ç†è´¢ 20-30% åŸºé‡‘/å®šæœŸ æå‡èµšé’±èƒ½åŠ› ä¸»ä¸šä¸Šç²¾è¿›ï¼Œäº‰å–å‡èŒåŠ è–ª å‘å±•å‰¯ä¸šï¼Œå¢åŠ æ”¶å…¥æ¥æº æŒç»­å­¦ä¹ ï¼Œè®©è‡ªå·±æ›´å€¼é’± ğŸ  ç»™è‡ªå·±ä¸€ä¸ªèˆ’é€‚çš„ä½æ‰€ æˆ¿å­æ˜¯ç§Ÿçš„ï¼Œä½†ç”Ÿæ´»æ˜¯è‡ªå·±çš„ã€‚\nå³ä½¿æ˜¯ç§Ÿæˆ¿ï¼Œä¹Ÿè¦è®©è‡ªå·±ä½å¾—èˆ’æœï¼š\nä¿æŒæ•´æ´ï¼šå¹²å‡€çš„ç¯å¢ƒèƒ½å¸¦æ¥å¥½å¿ƒæƒ… æ·»ç½®æ¸©é¦¨å°ç‰©ï¼šä¸€ç›å°ç¯ã€ä¸€æ ªç»¿æ¤ã€å‡ å¼ ç…§ç‰‡ é€‰æ‹©å®‰å…¨çš„å°åŒºï¼šé—¨ç¦ã€ç›‘æ§ã€ç‰©ä¸šæœåŠ¡éƒ½è¦è€ƒè™‘ è®¤è¯†é‚»å±…ï¼šè™½ç„¶ä¸å¿…æ·±äº¤ï¼Œä½†çŸ¥é“éš”å£ä½ç€è°ä¼šè®©äººå®‰å¿ƒ ğŸ¤ å»ºç«‹è‡ªå·±çš„ç¤¾äº¤åœˆ ä¸€ä¸ªäººåœ¨å¤–ï¼Œä¸ä»£è¡¨è¦å­¤å†›å¥‹æˆ˜ã€‚\nå·¥ä½œä¸­çš„äººè„‰ å’ŒåŒäº‹ä¿æŒè‰¯å¥½å…³ç³»ï¼Œåˆé¥­æ—¶é—´å¤šèŠèŠ å‚åŠ å…¬å¸å›¢å»ºæ´»åŠ¨ï¼Œèå…¥é›†ä½“ ç”Ÿæ´»ä¸­çš„æœ‹å‹ åŠ å…¥å…´è¶£ç¤¾ç¾¤ï¼šè¯»ä¹¦ä¼šã€è·‘æ­¥ç¾¤ã€æ¸¸æˆåœˆ å‚åŠ çº¿ä¸‹æ´»åŠ¨ï¼šå‘¨æœ«å¾’æ­¥ã€æŠ€æœ¯æ²™é¾™ã€æ‰‹å·¥è¯¾ç¨‹ è€ä¹¡ç¾¤/æ ¡å‹ç¾¤ï¼šç†Ÿæ‚‰çš„å£éŸ³èƒ½å¸¦æ¥å½’å±æ„Ÿ ä¿æŒä¸å®¶äººçš„è”ç³» å®šæœŸç»™çˆ¶æ¯æ‰“ç”µè¯ã€è§†é¢‘ é‡è¦èŠ‚æ—¥è®°å¾—é—®å€™ æœ‰å›°éš¾æ—¶ä¸è¦ç¡¬æ‰›ï¼Œå®¶æ°¸è¿œæ˜¯åç›¾ ğŸ’ª ç…§é¡¾å¥½è‡ªå·±çš„èº«ä½“ èº«ä½“æ˜¯é©å‘½çš„æœ¬é’±ï¼Œç‹¬è‡ªåœ¨å¤–æ›´è¦é‡è§†å¥åº·ã€‚\næ—¥å¸¸å¥åº·ä¹ æƒ¯ âœ… æŒ‰æ—¶åƒé¥­ï¼Œå°‘ç‚¹å¤–å– âœ… ä¿è¯ç¡çœ ï¼Œå°½é‡ä¸ç†¬å¤œ âœ… å®šæœŸè¿åŠ¨ï¼Œå“ªæ€•åªæ˜¯æ•£æ­¥ âœ… æ¯å¹´ä½“æ£€ï¼Œé˜²æ‚£äºæœªç„¶ å»ºç«‹å°±åŒ»æ„è¯† äº†è§£é™„è¿‘åŒ»é™¢/è¯Šæ‰€çš„ä½ç½® ä¹°å¥½åŒ»ç–—ä¿é™©ï¼ˆå…¬å¸ç¤¾ä¿+å•†ä¸šè¡¥å……ï¼‰ å®¶ä¸­å¸¸å¤‡æ„Ÿå†’è¯ã€é€€çƒ§è¯ã€åˆ›å¯è´´ç­‰ æ‰‹æœºå­˜å¥½ç´§æ€¥è”ç³»äºº ğŸ§  åŸ¹å…»å†…å¿ƒçš„åŠ›é‡ å®‰å…¨æ„Ÿçš„æœ€é«˜å¢ƒç•Œï¼Œæ˜¯å†…å¿ƒçš„ç¬ƒå®šã€‚\nå­¦ä¼šç‹¬å¤„ å­¤ç‹¬æ˜¯ä¸€ç§èƒ½åŠ›ï¼Œè€Œä¸æ˜¯ä¸€ç§ç¼ºé™·ã€‚\näº«å—ä¸€ä¸ªäººçœ‹ç”µå½±ã€åƒé¥­ã€æ—…è¡Œ åŸ¹å…»å¯ä»¥ç‹¬è‡ªè¿›è¡Œçš„çˆ±å¥½ï¼šé˜…è¯»ã€å†™ä½œã€ç»˜ç”»ã€ç¼–ç¨‹ ä¸å› ä¸ºå­¤ç‹¬è€Œå°†å°±ï¼Œä¸å› ä¸ºå¯‚å¯è€Œå¦¥å å»ºç«‹è‡ªæˆ‘è®¤åŒ è®°å½•è‡ªå·±çš„æˆé•¿å’Œè¿›æ­¥ ä¸ºè‡ªå·±è®¾ç«‹ç›®æ ‡å¹¶è¾¾æˆ å­¦ä¼šè‡ªæˆ‘è‚¯å®šï¼Œä¸è¿‡åˆ†ä¾èµ–å¤–ç•Œè¯„ä»· æ¥çº³ä¸ç¡®å®šæ€§ äººç”Ÿæœ¬å°±å……æ»¡å˜æ•°ï¼Œè¿™å¾ˆæ­£å¸¸ ä¸å…¶ç„¦è™‘æœªæ¥ï¼Œä¸å¦‚åšå¥½å½“ä¸‹ ç›¸ä¿¡è‡ªå·±æœ‰åº”å¯¹å›°éš¾çš„èƒ½åŠ› ğŸ“‹ å®ç”¨æ¸…å•ï¼šç‹¬å±…å®‰å…¨æŒ‡å— æœ€ååˆ†äº«ä¸€äº›å®ç”¨çš„å®‰å…¨å°å»ºè®®ï¼š\nå±…å®¶å®‰å…¨\nç¡®ä¿é—¨é”ç‰¢å›ºï¼Œè€ƒè™‘å®‰è£…æ™ºèƒ½é—¨é” ä¸éšæ„ç»™é™Œç”Ÿäººå¼€é—¨ å¿«é€’å†™å…¬å¸åœ°å€æˆ–é©¿ç«™è‡ªå– å¤–å‡ºæ—¶ç•™ä¸€ç›ç¯ï¼Œåˆ¶é€ æœ‰äººåœ¨å®¶çš„å‡è±¡ å¤–å‡ºå®‰å…¨\næ™šå½’æ—¶èµ°äººå¤šçš„è·¯ï¼Œä¿æŒè­¦è§‰ æ‰“è½¦æ—¶åˆ†äº«è¡Œç¨‹ç»™æœ‹å‹ å­¦ä¹ ä¸€äº›åŸºæœ¬çš„é˜²èº«çŸ¥è¯† ä¿¡æ¯å®‰å…¨\nä¸åœ¨ç¤¾äº¤åª’ä½“æš´éœ²è¯¦ç»†ä½å€ é‡è¦è¯ä»¶æ‹ç…§å¤‡ä»½ å®šæœŸæ›´æ¢å¯†ç ï¼Œå¼€å¯ä¸¤æ­¥éªŒè¯ å†™åœ¨æœ€å ä¸€ä¸ªäººåœ¨å¤–æ‰“æ‹¼ï¼Œç¡®å®ä¼šæœ‰å­¤ç‹¬ã€è¿·èŒ«ã€ä¸å®‰çš„æ—¶åˆ»ã€‚ä½†è¿™äº›éƒ½æ˜¯æˆé•¿çš„å¿…ç»ä¹‹è·¯ã€‚\nå®‰å…¨æ„Ÿä¸æ˜¯æ‰¾ä¸€ä¸ªäººæ¥ä¾é ï¼Œè€Œæ˜¯è‡ªå·±æˆä¸ºè‡ªå·±æœ€åšå®çš„ä¾é ã€‚\nå½“ä½ æœ‰äº†ç¨³å®šçš„æ”¶å…¥ã€èˆ’é€‚çš„ä½æ‰€ã€æ¸©æš–çš„æœ‹å‹ã€å¥åº·çš„èº«ä½“ï¼Œå½“ä½ å­¦ä¼šäº†ç‹¬å¤„ã€æ¥çº³äº†è‡ªå·±ï¼Œå®‰å…¨æ„Ÿå°±ä¼šä»å†…å¿ƒæ·±å¤„ç”Ÿé•¿å‡ºæ¥ã€‚\né‚£æ—¶å€™ä½ ä¼šå‘ç°ï¼ŒåŸæ¥ä¸€ä¸ªäººï¼Œä¹Ÿå¯ä»¥æ´»å¾—å¾ˆè¸å®ã€‚\nåŠ æ²¹ï¼Œæ¯ä¸€ä¸ªåœ¨å¤–æ‰“æ‹¼çš„ä½  ğŸŒŸ\nå¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åˆ†äº«ç»™åŒæ ·åœ¨å¤–å¥‹æ–—çš„æœ‹å‹ã€‚\n","date":"2023-12-13T00:00:00Z","permalink":"https://zpf-zero.github.io/p/build-security-sense-alone/","title":"ä¸€ä¸ªäººåœ¨å¤–æ‰“æ‹¼ï¼Œå¦‚ä½•å»ºç«‹å†…å¿ƒçš„å®‰å…¨æ„Ÿ"},{"content":"æ­£æ–‡æµ‹è¯• è€Œè¿™äº›å¹¶ä¸æ˜¯å®Œå…¨é‡è¦ï¼Œæ›´åŠ é‡è¦çš„é—®é¢˜æ˜¯ï¼Œ å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å®¡è§†ä¸€ä¸‹å­¦ç”Ÿä¼šé€€ä¼šã€‚ æ—¢ç„¶å¦‚ä½•ï¼Œ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ æˆ‘ä»¬ä¸å¾—ä¸é¢å¯¹ä¸€ä¸ªéå¸¸å°´å°¬çš„äº‹å®ï¼Œé‚£å°±æ˜¯ï¼Œ å¯æ˜¯ï¼Œå³ä½¿æ˜¯è¿™æ ·ï¼Œå­¦ç”Ÿä¼šé€€ä¼šçš„å‡ºç°ä»ç„¶ä»£è¡¨äº†ä¸€å®šçš„æ„ä¹‰ã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œå‘ç”Ÿäº†ä¼šå¦‚ä½•ï¼Œä¸å‘ç”Ÿåˆä¼šå¦‚ä½•ã€‚ ç»è¿‡ä¸Šè¿°è®¨è®ºï¼Œ ç”Ÿæ´»ä¸­ï¼Œè‹¥å­¦ç”Ÿä¼šé€€ä¼šå‡ºç°äº†ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸è€ƒè™‘å®ƒå‡ºç°äº†çš„äº‹å®ã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•åº”è¯¥å¦‚ä½•å®ç°ã€‚ è¿™æ ·çœ‹æ¥ï¼Œ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ å°±æˆ‘ä¸ªäººæ¥è¯´ï¼Œå­¦ç”Ÿä¼šé€€ä¼šå¯¹æˆ‘çš„æ„ä¹‰ï¼Œä¸èƒ½ä¸è¯´éå¸¸é‡å¤§ã€‚ èå£«æ¯”äºšæ›¾ç»æåˆ°è¿‡ï¼Œäººçš„ä¸€ç”Ÿæ˜¯çŸ­çš„ï¼Œä½†å¦‚æœå‘åŠ£åœ°è¿‡è¿™ä¸€ç”Ÿï¼Œå°±å¤ªé•¿äº†ã€‚è¿™ä¼¼ä¹è§£ç­”äº†æˆ‘çš„ç–‘æƒ‘ã€‚ è«æ‰ç‰¹è¯´è¿‡ä¸€å¥å¯Œæœ‰å“²ç†çš„è¯ï¼Œè°å’Œæˆ‘ä¸€æ ·ç”¨åŠŸï¼Œè°å°±ä¼šå’Œæˆ‘ä¸€æ ·æˆåŠŸã€‚è¿™å¯å‘äº†æˆ‘ï¼Œ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œå­¦ç”Ÿä¼šé€€ä¼šä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡å¤§çš„äº‹ä»¶ï¼Œè¿˜å¯èƒ½ä¼šæ”¹å˜æˆ‘çš„äººç”Ÿã€‚ å­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•åº”è¯¥å¦‚ä½•å®ç°ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œ ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œ è¿™ç§äº‹å®å¯¹æœ¬äººæ¥è¯´æ„ä¹‰é‡å¤§ï¼Œç›¸ä¿¡å¯¹è¿™ä¸ªä¸–ç•Œä¹Ÿæ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ äº†è§£æ¸…æ¥šå­¦ç”Ÿä¼šé€€ä¼šåˆ°åº•æ˜¯ä¸€ç§æ€ä¹ˆæ ·çš„å­˜åœ¨ï¼Œæ˜¯è§£å†³ä¸€åˆ‡é—®é¢˜çš„å…³é”®ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œ ç”Ÿæ´»ä¸­ï¼Œè‹¥å­¦ç”Ÿä¼šé€€ä¼šå‡ºç°äº†ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸è€ƒè™‘å®ƒå‡ºç°äº†çš„äº‹å®ã€‚ é—®é¢˜çš„å…³é”®ç©¶ç«Ÿä¸ºä½•ï¼Ÿ è€Œè¿™äº›å¹¶ä¸æ˜¯å®Œå…¨é‡è¦ï¼Œæ›´åŠ é‡è¦çš„é—®é¢˜æ˜¯ã€‚\nå¥¥æ–¯ç‰¹æ´›å¤«æ–¯åŸºæ›¾ç»è¯´è¿‡ï¼Œå…±åŒçš„äº‹ä¸šï¼Œå…±åŒçš„æ–—äº‰ï¼Œå¯ä»¥ä½¿äººä»¬äº§ç”Ÿå¿å—ä¸€åˆ‡çš„åŠ›é‡ã€‚ã€€å¸¦ç€è¿™å¥è¯ï¼Œæˆ‘ä»¬è¿˜è¦æ›´åŠ æ…é‡çš„å®¡è§†è¿™ä¸ªé—®é¢˜ï¼š ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»åŠ¡å¿…æ…é‡çš„è€ƒè™‘è€ƒè™‘ã€‚ æ—¢ç„¶å¦‚æ­¤ï¼Œ è¿™ç§äº‹å®å¯¹æœ¬äººæ¥è¯´æ„ä¹‰é‡å¤§ï¼Œç›¸ä¿¡å¯¹è¿™ä¸ªä¸–ç•Œä¹Ÿæ˜¯æœ‰ä¸€å®šæ„ä¹‰çš„ã€‚ å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å®¡è§†ä¸€ä¸‹å­¦ç”Ÿä¼šé€€ä¼šã€‚ æˆ‘è®¤ä¸ºï¼Œ æˆ‘è®¤ä¸ºï¼Œ åœ¨è¿™ç§å›°éš¾çš„æŠ‰æ‹©ä¸‹ï¼Œæœ¬äººæ€æ¥æƒ³å»ï¼Œå¯é£Ÿéš¾å®‰ã€‚ é—®é¢˜çš„å…³é”®ç©¶ç«Ÿä¸ºä½•ï¼Ÿ æ¯ä¸ªäººéƒ½ä¸å¾—ä¸é¢å¯¹è¿™äº›é—®é¢˜ã€‚ åœ¨é¢å¯¹è¿™ç§é—®é¢˜æ—¶ï¼Œ è¦æƒ³æ¸…æ¥šï¼Œå­¦ç”Ÿä¼šé€€ä¼šï¼Œåˆ°åº•æ˜¯ä¸€ç§æ€ä¹ˆæ ·çš„å­˜åœ¨ã€‚ æˆ‘è®¤ä¸ºï¼Œ æ—¢ç„¶å¦‚æ­¤ï¼Œ æ¯ä¸ªäººéƒ½ä¸å¾—ä¸é¢å¯¹è¿™äº›é—®é¢˜ã€‚ åœ¨é¢å¯¹è¿™ç§é—®é¢˜æ—¶ï¼Œ é‚£ä¹ˆï¼Œ æˆ‘è®¤ä¸ºï¼Œ å­¦ç”Ÿä¼šé€€ä¼šå› ä½•è€Œå‘ç”Ÿã€‚\nå¼•ç”¨ æ€å¿µæ˜¯æœ€æš–çš„å¿§ä¼¤åƒä¸€åŒç¿…è†€\nè®©æˆ‘åœä¸äº†é£ä¸è¿œåœ¨è¿‡å¾€æ¸¸è¡\nä¸å‘Šè€Œåˆ«çš„ä½  å°±ç®—ä¸ºäº†æˆ‘ç€æƒ³\nè¿™ä¹ˆæ²‰ç—›çš„å‘µæŠ¤ æˆ‘æ€ä¹ˆèƒ½ç¿±ç¿”\næœ€æš–çš„æ†‚å‚· - ç”°é¦¥ç”„\nå›¾ç‰‡ 1 2 3 ![Photo by Florian Klauer on Unsplash](florian-klauer-nptLmg6jqDo-unsplash.jpg) ![Photo by Luca Bravo on Unsplash](luca-bravo-alS7ewQ41M8-unsplash.jpg) ![Photo by Helena Hertz on Unsplash](helena-hertz-wWZzXlDpMog-unsplash.jpg) ![Photo by Hudai Gayiran on Unsplash](hudai-gayiran-3Od_VKcDEAA-unsplash.jpg) ç›¸å†Œè¯­æ³•æ¥è‡ª Typlog\n","date":"2023-09-09T00:00:00Z","image":"https://zpf-zero.github.io/p/test-chinese/helena-hertz-wWZzXlDpMog-unsplash_hu_2307260c751d0e0b.jpg","permalink":"https://zpf-zero.github.io/p/test-chinese/","title":"Chinese"},{"content":"Emoji can be enabled in a Hugo project in a number of ways.\nThe emojify function can be called directly in templates or Inline Shortcodes.\nTo enable emoji globally, set enableEmoji to true in your site\u0026rsquo;s configuration and then you can type emoji shorthand codes directly in content files; e.g.\nğŸ™ˆ :see_no_evil: ğŸ™‰ :hear_no_evil: ğŸ™Š :speak_no_evil:\nThe Emoji cheat sheet is a useful reference for emoji shorthand codes.\nN.B. The above steps enable Unicode Standard emoji characters and sequences in Hugo, however the rendering of these glyphs depends on the browser and the platform. To style the emoji you can either use a third party emoji font or a font stack; e.g.\n1 2 3 .emoji { font-family: Apple Color Emoji, Segoe UI Emoji, NotoColorEmoji, Segoe UI Symbol, Android Emoji, EmojiSymbols; } ","date":"2023-03-05T00:00:00Z","image":"https://zpf-zero.github.io/p/emoji-support/the-creative-exchange-d2zvqp3fpro-unsplash_hu_27b8954607cdb515.jpg","permalink":"https://zpf-zero.github.io/p/emoji-support/","title":"Emoji Support"}]